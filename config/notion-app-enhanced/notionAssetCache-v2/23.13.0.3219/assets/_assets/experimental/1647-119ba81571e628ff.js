"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[1647],{943172:(e,t,n)=>{n.d(t,{m:()=>ye});n(610931),n(362833),n(725707),n(491955),n(500234),n(403517);var r=n(242343),a=()=>n(237385),s=()=>n(803290),i=()=>n(174114),o=()=>n(228138),l=()=>n(354377),d=()=>n(83043),c=()=>n(162901),u=()=>n(680369),p=n(163643);const g={viewBox:"0 0 20 20",svg:(0,p.jsx)("path",{d:"m7.006 16.267 8.523-4.971a1.5 1.5 0 0 0 0-2.592L7.006 3.733A1.5 1.5 0 0 0 4.75 5.028v9.944a1.5 1.5 0 0 0 2.256 1.295"})},f=(0,u().wt)("mediaPlayFill",g);var y=()=>n(263873),m=()=>n(172746),h=()=>n(403508),x=()=>n(653998),v=()=>n(975392),j=()=>n(818369),b=()=>n(421338),S=()=>n(209684),C=()=>n(535906),k=()=>n(273520),T=()=>n(559637),A=()=>n(356813),I=()=>n(59175),w=()=>n(966789),M=()=>n(935091),O=()=>n(858023),K=()=>n(88271),N=()=>n(103151),P=()=>n(640979),z=()=>n(907721),L=()=>n(963395),W=()=>n(356499),F=()=>n(580290);n(324989);const B={viewBox:"0 0 16 16",svg:(0,p.jsx)("path",{d:"M3.25 1.375c-1.036 0-1.875.84-1.875 1.875v6c0 1.036.84 1.875 1.875 1.875h1.625v1.625c0 1.036.84 1.875 1.875 1.875h6c1.036 0 1.875-.84 1.875-1.875v-6c0-1.036-.84-1.875-1.875-1.875h-1.625V3.25c0-1.036-.84-1.875-1.875-1.875zM2.625 3.25c0-.345.28-.625.625-.625h6c.345 0 .625.28.625.625v1.625H6.75c-1.036 0-1.875.84-1.875 1.875v3.125H3.25a.625.625 0 0 1-.625-.625zm3.5 3.5c0-.345.28-.625.625-.625h6c.345 0 .625.28.625.625v6c0 .345-.28.625-.625.625h-6a.625.625 0 0 1-.625-.625z"})},D=(0,u().wt)("duplicateSmall",B);var E=()=>n(32901),q=()=>n(91472),$=()=>n(518397),_=()=>n(906230);const R=(0,x().YK)({copy:{id:"aiInferenceTranscript.debug.copy",defaultMessage:"Copy"},copyTooltip:{id:"aiInferenceTranscript.debug.copyTooltip",defaultMessage:"Copy..."},input:{id:"aiInferenceTranscript.debug.copyInput",defaultMessage:"Input"},output:{id:"aiInferenceTranscript.debug.copyOutput",defaultMessage:"Output"},metadata:{id:"aiInferenceTranscript.debug.copyMetadata",defaultMessage:"Metadata"},tool:{id:"aiInferenceTranscript.debug.copyTool",defaultMessage:"Tool input"}});function J(e){const{inference:t}=e,n=(0,a().v3)(),s=(0,x().tz)(),i="transcript"in t.input&&Array.isArray(t.input.transcript)?t.input.transcript:void 0,o=(0,r.useMemo)((()=>v().oE(null==i?void 0:i.flatMap((e=>{if("agent-inference"===e.type&&Array.isArray(e.value))return e.value.filter((e=>"tool_use"===e.type)).map((e=>({tool:e.name,input:e.content})))})))),[i]),l=async e=>{const t=await q().R.clipboardActions.load();t.copyString({environment:n,stringValue:e,copiedMessage:t.clipboardMessages.copiedToClipboard})},d=[(0,E().gy)({key:"copy",render:e=>(0,p.jsx)(K().A,{...e}),actions:v().oE([(0,E().Ls)({key:"input",displayName:R.input,analyticsName:R.input.defaultMessage,action:()=>l(JSON.stringify(t.input,null,2)),validators:[],closeParentMenu:!0,render:e=>(0,p.jsx)(C().A,{...e,title:s.formatMessage(R.input)})}),(0,E().Ls)({key:"output",displayName:R.output,analyticsName:R.output.defaultMessage,action:()=>l(JSON.stringify(t.expected,null,2)),validators:[],closeParentMenu:!0,render:e=>(0,p.jsx)(C().A,{...e,title:s.formatMessage(R.output)})}),(0,E().Ls)({key:"metadata",displayName:R.metadata,analyticsName:R.metadata.defaultMessage,action:()=>l(JSON.stringify(t.metadata,null,2)),validators:[],closeParentMenu:!0,render:e=>(0,p.jsx)(C().A,{...e,title:s.formatMessage(R.metadata)})}),o.length>0&&(0,E().uk)({key:"tools",displayName:R.tool,analyticsName:"tools",validators:[],initialFocus:void 0,subActions:()=>[(0,E().gy)({key:"tools",render:e=>(0,p.jsx)(K().A,{...e}),actions:o.map((e=>({key:e.tool,displayName:e.tool,searchName:e.tool,shortcuts:void 0,analyticsName:e.tool,action:()=>l(e.input),validators:[],closeParentMenu:!0,render:t=>(0,p.jsx)(C().A,{...t,title:e.tool})})))})]})])})];return(0,p.jsx)(k().Ay,{popupType:k().z7.Popup,placementToOrigin:k().sx.Bottom,alignmentToOrigin:k().yP.Start,renderOrigin:e=>(0,p.jsx)(N().A,{renderTooltip:()=>(0,p.jsx)("div",{children:s.formatMessage(R.copyTooltip)}),placement:z().W.Top,render:t=>(0,p.jsx)(A().A,{...(0,_().A)(e,t),icon:D,ariaLabel:s.formatMessage(R.copy)})}),render:e=>(0,p.jsx)(M().A,{menuType:P().gu.Popup,minWidth:220,children:(0,p.jsx)($().A,{context:{blocks:[],environment:n,publicEditMode:void 0},sections:d,initialFocus:void 0})})})}var Y=()=>n(725494),G=()=>n(794484),V=()=>n(701270);const X=(0,x().YK)({debugOptions:{id:"aiInferenceTranscript.debugOverrides.title",defaultMessage:"Debug options"},showErrors:{id:"aiInferenceTranscript.debugOverrides.showErrors",defaultMessage:"Show errors"},skipFunctionTests:{id:"aiInferenceTranscript.debugOverrides.skipFunctionTests",defaultMessage:"Skip function tests"},promptCache:{id:"aiInferenceTranscript.debugOverrides.promptCache",defaultMessage:"Prompt cache"},none:{id:"aiInferenceTranscript.debugOverrides.none",defaultMessage:"None"},redis:{id:"aiInferenceTranscript.debugOverrides.redis",defaultMessage:"Redis"},s3:{id:"aiInferenceTranscript.debugOverrides.s3",defaultMessage:"S3"}});function H(e){const{clientStore:t}=e,n=(0,a().v3)(),o=(0,x().tz)(),l=(0,i().IS)((e=>({iconButton:{width:20,height:20,fill:e.icon.primary}})),[]),d=(0,s().K8)((()=>t.state.debugOverrides),[t]),c=(0,r.useCallback)((()=>{t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,emitDebugErrors:!t.state.debugOverrides.emitDebugErrors}})}),[t]),u=(0,r.useCallback)((()=>{t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,fastWorkflowBuilds:!t.state.debugOverrides.fastWorkflowBuilds}})}),[t]),g=(0,r.useCallback)((e=>{t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,usePromptCache:"none"===e?void 0:e}})}),[t]),f=d.usePromptCache||"none",y=[(0,E().gy)({key:"debug",render:e=>(0,p.jsx)(K().A,{...e}),actions:[(0,E().Ls)({key:"emitDebugErrors",displayName:X.showErrors,analyticsName:X.showErrors.defaultMessage,action:()=>c(),validators:[],closeParentMenu:!1,render:e=>(0,p.jsx)(C().A,{...e,title:o.formatMessage(X.showErrors),right:d.emitDebugErrors&&(0,Y().checkmarkIcon)({width:12,height:12})})}),(0,E().Ls)({key:"fastWorkflowBuilds",displayName:X.skipFunctionTests,analyticsName:X.skipFunctionTests.defaultMessage,action:()=>u(),validators:[],closeParentMenu:!1,render:e=>(0,p.jsx)(C().A,{...e,title:o.formatMessage(X.skipFunctionTests),right:d.fastWorkflowBuilds&&(0,Y().checkmarkIcon)({width:12,height:12})})}),(0,E().uk)({key:"promptCache",displayName:X.promptCache,analyticsName:"promptCache",validators:[],initialFocus:void 0,right:(0,p.jsx)(V().D,{colorName:"tertiary",children:"none"===f?(0,p.jsx)(x().sA,{...X.none}):"redis"===f?(0,p.jsx)(x().sA,{...X.redis}):(0,p.jsx)(x().sA,{...X.s3})}),subActions:()=>[(0,E().gy)({key:"cache",render:e=>(0,p.jsx)(K().A,{...e}),actions:[(0,E().Ls)({key:"none",displayName:X.none,analyticsName:X.none.defaultMessage,action:()=>g("none"),validators:[],closeParentMenu:!1,render:e=>(0,p.jsx)(C().A,{...e,title:o.formatMessage(X.none),right:"none"===f&&(0,Y().checkmarkIcon)({width:12,height:12})})}),(0,E().Ls)({key:"redis",displayName:X.redis,analyticsName:X.redis.defaultMessage,action:()=>g("redis"),validators:[],closeParentMenu:!1,render:e=>(0,p.jsx)(C().A,{...e,title:o.formatMessage(X.redis),right:"redis"===f&&(0,Y().checkmarkIcon)({width:12,height:12})})}),(0,E().Ls)({key:"s3",displayName:X.s3,analyticsName:X.s3.defaultMessage,action:()=>g("s3"),validators:[],closeParentMenu:!1,render:e=>(0,p.jsx)(C().A,{...e,title:o.formatMessage(X.s3),right:"s3"===f&&(0,Y().checkmarkIcon)({width:12,height:12})})})]})]})]})];return(0,p.jsx)(k().Ay,{popupType:k().z7.Popup,placementToOrigin:k().sx.Bottom,alignmentToOrigin:k().yP.Start,renderOrigin:e=>(0,p.jsx)(N().A,{renderTooltip:()=>(0,p.jsx)("div",{children:"Debug options"}),placement:z().W.Top,render:t=>(0,p.jsx)(A().A,{...(0,_().A)(e,t),icon:G().L,iconStyle:l.iconButton,ariaLabel:o.formatMessage(X.debugOptions)})}),render:e=>(0,p.jsx)(M().A,{menuType:P().gu.Popup,minWidth:220,children:(0,p.jsx)($().A,{context:{blocks:[],environment:n,publicEditMode:void 0},sections:y,initialFocus:void 0})})})}var U=()=>n(52531),Q=()=>n(435819);function Z(e){const[t,n]=(0,r.useState)(!1),{onFocus:a,onBlur:s,...i}=e,o=e=>{n(!0),null==a||a(e)},l=e=>{n(!1),null==s||s(e)};return(0,p.jsx)(Q().A,{capture:t,render:e=>(0,p.jsx)(I().A,{...i,...e,onFocus:o,onBlur:l})})}function ee(e){const t=(0,x().tz)(),{request:n,memory:s,clientStore:o,onChange:l}=e,d=(0,a().v3)(),[c,u]=(0,r.useState)(!1),g=(0,i().IS)((e=>({topbar:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8},inputWrap:{flexGrow:1},status:{marginRight:2}})),[]),f=(0,r.useCallback)((e=>{l({...s,feedback:e.target.value})}),[s,l]),y=(0,r.useCallback)((()=>{l(void 0)}),[l]),m=(0,r.useCallback)((async()=>{u(!0),await(0,F().Wd)({environment:d,request:n,memory:s,clientStore:o,onChange:l}),u(!1)}),[d,n,s,o,l]);return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsxs)("div",{style:g.topbar,children:[(0,p.jsx)(N().A,{renderTooltip:()=>(0,p.jsx)("div",{style:{width:300,whiteSpace:"normal"},children:"The text you type here is used as feedback to generate an InferenceMemory."}),placement:z().W.Top,render:e=>(0,p.jsx)("div",{...e,style:g.inputWrap,children:(0,p.jsx)(Z,{value:s.feedback,placeholder:"Set feedback",onChange:f,textarea:!0,autosize:!0})})}),(0,p.jsx)(S().p,{onClick:m,children:"Run"})]}),(0,p.jsx)(W().b,{label:"Memory",left:(0,p.jsxs)("div",{style:g.status,children:[" ",c?(0,p.jsx)(w().A,{}):s.verified?"✅":"❌"]}),children:(0,p.jsx)(L().X,{language:"json",value:JSON.stringify(s,null,2)})}),(0,p.jsx)(A().A,{icon:U().I,onClick:y,ariaLabel:t.formatMessage({id:"aiInferenceTranscript.memoryEditor.deleteMemory",defaultMessage:"Delete memory"})})]})}var te=()=>n(306131);const ne={viewBox:"0 0 16 16",svg:(0,p.jsx)("path",{d:"M8 2.125a.625.625 0 0 0-.625.625v7.128L5.378 7.881a.625.625 0 1 0-.884.884l3.064 3.064c.244.244.64.244.884 0l3.065-3.064a.625.625 0 0 0-.884-.884L8.625 9.878V2.75A.625.625 0 0 0 8 2.125m-4.403 10.5a.625.625 0 1 0 0 1.25h8.806a.625.625 0 1 0 0-1.25z"})},re=(0,u().wt)("arrowLineDownSmall",ne);var ae=()=>n(198654),se=()=>n(329911),ie=()=>n(401382),oe=()=>n(286404);function le(e){const{scopeKey:t,inference:n,defaultState:r}=e,a=(0,x().tz)();return(0,p.jsx)(k().Ay,{popupType:k().z7.Popup,placementToOrigin:k().sx.Bottom,alignmentToOrigin:k().yP.Start,renderOrigin:e=>(0,p.jsx)(N().A,{renderTooltip:()=>"Save to dataset",placement:z().W.Top,render:t=>(0,p.jsx)("div",{...(0,_().A)(t,e),children:(0,p.jsx)(A().A,{icon:re,ariaLabel:a.formatMessage({defaultMessage:"Retry",id:"aiInferenceTranscript.debug.retry"})})})}),render:e=>(0,p.jsx)(de,{scopeKey:t,inference:n,buttonPopupParent:e,defaultState:r})})}function de(e){const{scopeKey:t,inference:n,buttonPopupParent:s,defaultState:o}=e,l=(0,a().v3)(),d=(0,i().IS)((e=>({menuContent:{display:"flex",flexDirection:"column",gap:8,padding:8},label:{fontSize:12,color:e.text.primary}})),[]),c=(0,r.useMemo)((()=>function(e){const{environment:t,scopeKey:n,defaultState:r}=e,a=fe(n),s=se().K.get({userId:t.currentUser.id,key:a});if(!s&&r)return r;return s||{project:void 0,dataset:void 0,tags:[]}}({environment:l,scopeKey:t,defaultState:o})),[l,o,t]),[u,g]=(0,r.useState)(c),f=(0,r.useCallback)((e=>{g(e),function(e){const{environment:t,scopeKey:n,state:r}=e,a=fe(n);se().K.set({userId:t.currentUser.id,key:a,value:r})}({environment:l,scopeKey:t,state:e})}),[l,t]),y=(0,r.useCallback)((e=>{f({...u,project:e,dataset:void 0})}),[f,u]),m=(0,r.useCallback)((e=>{f({...u,dataset:e})}),[f,u]),h=(0,r.useCallback)((e=>{f({...u,tags:e})}),[f,u]),x=(0,r.useCallback)((()=>{const{project:e,dataset:t,tags:r}=u;e&&t&&(0,F().wm)({environment:l,inference:{...n,tags:r},project:e.name,dataset:t})}),[l,n,u]);return(0,p.jsx)(M().A,{menuType:P().gu.Popup,...s,children:(0,p.jsxs)("div",{style:d.menuContent,children:[(0,p.jsx)("div",{style:d.label,children:"Project"}),(0,p.jsx)(ce,{project:u.project,setProject:y}),u.project&&(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("div",{style:d.label,children:"Dataset"}),(0,p.jsx)(ue,{project:u.project.name,dataset:u.dataset,onChange:m})]}),u.project&&u.dataset&&(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("div",{style:d.label,children:"Tags"}),(0,p.jsx)(ge,{tags:u.tags,onChange:h}),(0,p.jsx)(oe().A,{size:"lg",onClick:x,children:"Save"})]})]})})}function ce(e){const t=e.project,[n,s]=(0,r.useState)([]),i=(0,a().v3)();return(0,c().Yb)((async()=>{const e=await j().callApi({eventName:"getBraintrustProjects",environment:i,data:{}});if("failed"===e.type)throw e.error;s(e.data.projects.map((e=>{let{id:t,name:n}=e;return{id:t,name:n}})))}),[i]),(0,p.jsx)(pe,{items:n.sort(((e,t)=>e.name.localeCompare(t.name))),selectedItem:t,onSelect:e.setProject,renderItem:e=>e.name,isFiltered:(e,t)=>e.name.toLowerCase().includes(t.toLowerCase()),placeholder:"Select project"})}function ue(e){const{project:t,dataset:n,onChange:s}=e,i=(0,a().v3)(),[o,l]=(0,r.useState)([]),d=(0,r.useCallback)((async()=>{if(!t)return;const e=await j().callApi({eventName:"getBraintrustDatasetsForProject",environment:i,data:{project:t}});if("failed"===e.type)throw e.error;const n=e.data.datasets.map((e=>e.name));n.sort(),l(n)}),[i,t]);return(0,c().Yb)((async()=>{await d()}),[d]),(0,p.jsx)(pe,{items:o,selectedItem:n,onSelect:s,renderItem:v().D_,isFiltered:(e,t)=>e.toLowerCase().includes(t.toLowerCase()),placeholder:"Select dataset"})}function pe(e){const{items:t,selectedItem:n,onSelect:a,renderItem:s,placeholder:o,isFiltered:l}=e,d=(0,i().IS)((e=>({chevron:{width:10,marginLeft:4,fill:e.lightIconColor},buttonWrapper:{display:"flex",alignItems:"center"}})),[]),[c,u]=(0,r.useState)(""),g=(0,r.useCallback)((e=>{u(e.target.value)}),[]),f=t.filter((e=>l(e,c)));return(0,p.jsx)(k().Ay,{popupType:k().z7.Popup,placementToOrigin:k().sx.Bottom,alignmentToOrigin:k().yP.Start,renderOrigin:e=>(0,p.jsx)(S().p,{...e,children:(0,p.jsxs)("div",{style:d.buttonWrapper,children:[n?s(n):o||"",(0,ae().b)(d.chevron)]})}),render:e=>(0,p.jsxs)(M().A,{menuType:P().gu.Popup,children:[(0,p.jsx)(ie().Ay,{value:c,onChange:g,autoFocus:!0}),(0,p.jsx)(O().Ay,{type:O().Oh.Vertical,initialFocus:0,sections:[{key:"items",render:e=>(0,p.jsx)(K().A,{...e}),items:f.map(((t,r)=>({key:r,action:()=>{a(t),e.close()},render:e=>(0,p.jsx)(C().A,{...e,title:s(t),isChecked:t===n})})))}]})]})})}function ge(e){const{tags:t,onChange:n}=e,a=(0,i().IS)((e=>({container:{display:"flex",flexDirection:"column",gap:4},tagsContainer:{display:"flex",flexWrap:"wrap",gap:8}})),[]),s=(0,r.useCallback)((e=>{const r=t.includes(e)?t.filter((t=>t!==e)):[...t,e];n(r)}),[n,t]);return(0,p.jsx)("div",{style:a.container,children:(0,p.jsx)("div",{style:a.tagsContainer,children:o().d7.map((e=>(0,p.jsxs)(S().p,{onClick:()=>s(e),style:{display:"flex",alignItems:"center",gap:4},children:[(0,p.jsx)(T().A,{checked:t.includes(e),size:14}),(0,p.jsx)("span",{children:e})]},e)))})})}function fe(e){return`ai-inference-transcript-save-to-dataset-${e}`}function ye(e){const{clientStore:t,threadStore:n}=e,a=(0,i().IS)((e=>({topBar:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8,fontSize:14},inferencesWrap:{display:"flex",flexDirection:"column",gap:12,fontSize:14},header:{fontSize:14}})),[]),o=(0,s().K8)((()=>null==n?void 0:n.id),[n]),l=(0,s().K8)((()=>o?t.getOrCreateClientAIChatThreadStore(o).state.inferences.length:0),[t,o]),d=(0,s().K8)((()=>Boolean(o&&t.getOrCreateClientAIChatThreadStore(o).state.loading||void 0!==(null==n?void 0:n.getCurrentInferenceId()))),[t,n,o]),c=(0,s().K8)((()=>o?t.getOrCreateClientAIChatThreadStore(o).state.inferences:[]),[t,o]),u=(0,s().K8)((()=>o?t.getOrCreateClientAIChatThreadStore(o).state.requestInfo:void 0),[t,o]),g=(0,r.useCallback)((()=>{if(!o)return;const e=t.getOrCreateClientAIChatThreadStore(o),{acceptedInferenceKeys:n}=e.state;n.length>0?e.setState({...e.state,acceptedInferenceKeys:[]}):e.setState({...e.state,acceptedInferenceKeys:e.state.inferences.map((e=>e.key))})}),[t,o]),f=(0,s().K8)((()=>t.state.configForNewTranscripts),[t]),y=(0,s().K8)((()=>t.state.debugOverrides),[t]),m=(0,s().K8)((()=>t.state.model),[t]),h=(0,r.useCallback)((e=>{t.setState({...t.state,model:e})}),[t]);return(0,p.jsxs)(b().Y1,{direction:"vertical",height:"fill",width:"fill",children:[(0,p.jsxs)(b().Y1,{direction:"horizontal",gap:8,padding:"8px 12px",height:46,align:"center",children:[d&&(0,p.jsx)(w().A,{}),n&&(0,p.jsx)(be,{clientStore:t,threadStore:n},n.id),(0,p.jsx)("div",{style:{flexGrow:1}}),(0,p.jsx)(te().Y,{model:m,setModel:h,format:"badge"}),(0,p.jsx)(H,{clientStore:t})]}),(0,p.jsxs)(b().Y1,{direction:"vertical",gap:16,padding:"8px 12px",height:"fill",style:{overflowY:"auto"},children:[u&&(0,p.jsx)(me,{requestInfo:u,clientStore:t,threadStore:n}),!n&&f&&(0,p.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:12},children:(0,p.jsx)(Se,{debugOverrides:y,clientStore:t,configType:f.type})}),(0,p.jsxs)("div",{style:a.inferencesWrap,children:[c.length>0&&(0,p.jsxs)("div",{style:a.topBar,children:[(0,p.jsx)("div",{style:a.header,children:"Inferences"}),(0,p.jsx)("div",{style:{flexGrow:1}}),l>0&&(0,p.jsx)("div",{children:`${l} inference${1===l?"":"s"}`}),!d&&l>0&&(0,p.jsx)(S().p,{onClick:g,children:"Toggle all"})]}),c.map(((e,r)=>(0,p.jsx)(xe,{inference:e,clientStore:t,threadStore:n},`${e.key}-${r}`)))]})]})]})}function me(e){const{requestInfo:t,clientStore:n,threadStore:a}=e,l=(0,s().K8)((()=>null==a?void 0:a.id),[a]),c=(0,i().IS)((e=>({wrap:{display:"flex",flexDirection:"column",gap:4,padding:"4px 2px",border:`1px solid ${e.regularDividerColor}`,borderRadius:8,whiteSpace:"pre-wrap",fontSize:14},header:{display:"flex",gap:4,alignItems:"center",padding:"0 6px"},toggle:{border:"none",padding:0,margin:0}})),[]),{request:u,response:g,memory:f}=t,m=u.transcript.find((e=>"config"===e.type)),h=(0,r.useCallback)((()=>{if(!g)throw new Error("Response is required");if(!l)return;const e=n.getOrCreateClientAIChatThreadStore(l);e.setState({...e.state,requestInfo:{...t,memory:{...o().s8,originalOutput:g}}})}),[n,t,g,l]),j=(0,r.useCallback)((e=>{if(!l)return;const r=n.getOrCreateClientAIChatThreadStore(l);r.setState({...r.state,requestInfo:{...t,memory:e}})}),[n,t,l]),b=(0,r.useMemo)((()=>({id:u.traceId,input:{type:d().uF,...u},expected:g,metadata:{memories:v().oE([f])}})),[u,g,f]),S=(0,r.useMemo)((()=>{if(!t.response)return;return{type:"inferenceTranscript",request:t.request,response:t.response}}),[t]),C=(0,x().tz)();return(0,p.jsxs)("div",{style:c.wrap,children:[(0,p.jsxs)("div",{style:c.header,children:[(0,p.jsx)("span",{style:{flexGrow:1},children:"Request"}),!f&&(0,p.jsx)(N().A,{renderTooltip:()=>"Add memory for this inference",placement:z().W.Top,render:e=>(0,p.jsx)("div",{...e,children:(0,p.jsx)(A().A,{icon:y().plusSmallIcon,onClick:h,ariaLabel:C.formatMessage({defaultMessage:"Add memory",id:"aiInferenceTranscript.debug.addMemory"})})})}),b&&(0,p.jsx)(le,{inference:b,scopeKey:`inferenceTranscript-${null==m?void 0:m.value.type}`})]}),(0,p.jsx)(W().b,{label:"Input",style:c.toggle,children:(0,p.jsx)(L().X,{language:"json",value:JSON.stringify(t.request,null,2)})}),t.response?(0,p.jsx)(W().b,{label:"Output",style:c.toggle,children:(0,p.jsx)(L().X,{value:JSON.stringify(t.response,null,2),language:"json"})}):null,S&&f&&(0,p.jsx)(ee,{request:S,memory:f,onChange:j,clientStore:n})]})}function he(e){const{inference:t,clientStore:n,threadStore:l}=e,c=t.key,u=(0,a().v3)(),g=(0,s().K8)((()=>null==l?void 0:l.id),[l]),m=(0,i().IS)((e=>({wrap:{display:"flex",flexDirection:"column",gap:4,padding:"4px 2px",border:`1px solid ${e.regularDividerColor}`,borderRadius:8,whiteSpace:"pre-wrap",fontSize:14},header:{padding:"0 6px",display:"flex",gap:4,alignItems:"center"},annotation:{padding:"0 6px"},toggle:{border:"none",padding:0,margin:0},typeLabel:{flexGrow:1,marginLeft:4,fontSize:12,fontFamily:"monospace"}})),[]),h=(0,s().K8)((()=>g?n.getOrCreateClientAIChatThreadStore(g).state.inferenceKeysToAnnotations[c]:void 0),[n,c,g]),j=(0,r.useCallback)((e=>{if(!g)return;const t=n.getOrCreateClientAIChatThreadStore(g),r=e.target.value,a={...t.state.inferenceKeysToAnnotations,[c]:r};t.setState({...t.state,inferenceKeysToAnnotations:a})}),[n,c,g]),b=(0,s().K8)((()=>{if(!g)return!1;const{acceptedInferenceKeys:e}=n.getOrCreateClientAIChatThreadStore(g).state;return e.includes(c)}),[n,c,g]),S=(0,r.useCallback)((e=>{if(!g)return;const t=n.getOrCreateClientAIChatThreadStore(g),{acceptedInferenceKeys:r,inferences:a}=t.state,s=e.shiftKey;if(r.includes(c))if(s){const e=a.findIndex((e=>e.key===c)),n=a.slice(0,e+1).map((e=>e.key));t.setState({...t.state,acceptedInferenceKeys:v().sb(r.filter((e=>!n.includes(e))))})}else t.setState({...t.state,acceptedInferenceKeys:r.filter((e=>e!==c))});else if(s){const e=a.findIndex((e=>e.key===c)),n=a.slice(0,e+1).map((e=>e.key)),s=v().sb([...r,...n]);t.setState({...t.state,acceptedInferenceKeys:s})}else t.setState({...t.state,acceptedInferenceKeys:v().sb([...r,c])})}),[n,c,g]),C=(0,r.useMemo)((()=>{const e=null==t?void 0:t.value.expected;if(!e)return"";if("string"!=typeof e)return JSON.stringify(e,null,2);try{return e.trim().startsWith("{")?JSON.stringify(JSON.parse(e),null,2):e}catch(n){return e}}),[t]),k=(0,s().K8)((()=>{if(g)return n.getOrCreateClientAIChatThreadStore(g).state.inferenceKeysToMemories[c]}),[n,c,g]),I=(0,r.useMemo)((()=>({type:"inference",inference:t.value})),[t]),w=(0,r.useCallback)((async()=>{g&&await(0,F().Ou)({environment:u,clientStore:n,inference:t,threadId:g})}),[n,u,t,g]),M=(0,r.useCallback)((e=>{if(!g)return;const t=n.getOrCreateClientAIChatThreadStore(g);t.setState({...t.state,inferenceKeysToMemories:{...t.state.inferenceKeysToMemories,[c]:e}})}),[n,c,g]),O=(0,r.useCallback)((()=>{if(!g)return;if(!t.value.expected)throw new Error("Expected output is required");const e=n.getOrCreateClientAIChatThreadStore(g);e.setState({...e.state,inferenceKeysToMemories:{...e.state.inferenceKeysToMemories,[c]:{...o().s8,originalOutput:t.value.expected}}})}),[n,c,t,g]),K=(0,r.useMemo)((()=>({...t.value,metadata:{...t.value.metadata,memories:v().oE([k])}})),[t,k]),P=(0,x().tz)();return t?(0,p.jsxs)("div",{style:m.wrap,children:[(0,p.jsxs)("div",{style:m.header,children:[(0,p.jsx)(N().A,{renderTooltip:()=>(0,p.jsx)("div",{style:{width:300,whiteSpace:"normal"},children:"Checking this will 'freeze' this inference. When the request is retried, instead of running the inference again, the original output will be used."}),placement:z().W.Top,render:e=>(0,p.jsx)("div",{...e,children:(0,p.jsx)(T().A,{checked:b,size:14,onClick:S})})}),(0,p.jsx)("span",{style:m.typeLabel,children:ve(t.value.input)}),(0,p.jsx)(N().A,{renderTooltip:()=>"Retry inference",placement:z().W.Top,render:e=>(0,p.jsx)("div",{...e,children:(0,p.jsx)(A().A,{icon:f,onClick:w,ariaLabel:P.formatMessage({defaultMessage:"Retry",id:"aiInferenceTranscript.debug.retry"})})})}),(0,p.jsx)(J,{inference:t.value}),!k&&(0,p.jsx)(N().A,{renderTooltip:()=>"Add memory for this inference",placement:z().W.Top,render:e=>(0,p.jsx)("div",{...e,children:(0,p.jsx)(A().A,{icon:y().plusSmallIcon,onClick:O,ariaLabel:P.formatMessage({defaultMessage:"Add memory",id:"aiInferenceTranscript.debug.addMemory"})})})}),(0,p.jsx)(le,{inference:K,scopeKey:`inference-${t.value.input.type}`,defaultState:{project:d().vK,dataset:t.value.input.type,tags:[]}})]}),(0,p.jsx)(je,{input:t.value.input}),(0,p.jsx)(N().A,{renderTooltip:()=>(0,p.jsx)("div",{style:{width:300,whiteSpace:"normal"},children:"The text you type here is passed as 'context.annotation' when this inference is retried. Typically, this is rendered as a final user step in the prompt used to 'nudge' the model."}),placement:z().W.Right,render:e=>(0,p.jsx)("div",{...e,style:m.annotation,children:(0,p.jsx)(Z,{value:h,placeholder:"Set annotation",onChange:j,textarea:!0,autosize:!0})})}),(0,p.jsx)(W().b,{label:"Input",style:m.toggle,children:(0,p.jsx)(L().X,{disabled:!0,language:"json",value:JSON.stringify({...t.value.input,examples:void 0},null,2)})}),t.value.expected?(0,p.jsx)(W().b,{label:"Output",style:m.toggle,children:(0,p.jsx)(L().X,{disabled:!0,value:C,language:"json"})}):null,t.value.metadata?(0,p.jsx)(W().b,{label:"Metadata",style:m.toggle,children:(0,p.jsx)(L().X,{disabled:!0,value:JSON.stringify(t.value.metadata,null,2),language:"json"})}):null,k&&(0,p.jsx)(ee,{request:I,memory:k,onChange:M,clientStore:n})]}):null}const xe=r.memo(he);function ve(e){let t=e.type;"fileName"in e&&(t+=` – ${e.fileName}`),"testName"in e&&(t+=` – ${e.testName}`),"functionKey"in e&&(t+=` – ${e.functionKey}`),"key"in e&&(t+=` – ${e.key}`);const n=["retries","validationRetries"];for(const r of n)if(r in e&&e[r].length>0){t+=` (${e[r].filter((e=>"assistant"!==e.type)).length} error steps)`}return t}function je(e){const{input:t}=e,n="transcript"in t&&Array.isArray(t.transcript)?t.transcript:void 0,a=(0,r.useMemo)((()=>v().oE(null==n?void 0:n.map((e=>"agent-tool-result"===e.type?e.toolName:void 0)))),[n]),s=(0,i().IS)((e=>({container:{fontSize:12,color:e.text.secondary,padding:"0 6px 4px 6px"}})),[]);return 0===a.length?null:(0,p.jsxs)("div",{style:s.container,children:["Tools: ",a.join(", ")]})}function be(e){const t=(0,x().tz)(),{clientStore:n,threadStore:o}=e,d=(0,s().K8)((()=>null==o?void 0:o.id),[o]),u=(0,a().v3)(),g=(0,i().IS)((e=>({button:{fontSize:14}})),[]),f=(0,s().K8)((()=>o.getSpaceId()),[o]),y=(0,s().K8)((()=>{const e=o.getMessageStores().map((e=>{const t=e.getStep();if(t&&"config"===t.type)return t.value.type}));return v().oE(e)[0]}),[o]),[{value:b},T]=(0,c().Yb)((async()=>{if(!f||!y)return;const e=(0,l().W)({environmentName:"production",suffix:y});return await j().callApi({eventName:"getBraintrustLogsForThread",environment:u,data:{project:e,threadId:o.id,spaceId:f}})}),[u,f,o,y]),I=(0,r.useMemo)((()=>{if(!b||"failed"===b.type)return;const e=b.data.logs,t=[],n=new Map;for(const r of e)if(r.span_id===r.root_span_id)t.push(r);else if(r.root_span_id){const e=n.get(r.root_span_id)||[];e.push(r),n.set(r.root_span_id,e)}for(const r of n.values())r.sort(((e,t)=>{var n,r;return((null===(n=e.metadata)||void 0===n?void 0:n.index)||0)-((null===(r=t.metadata)||void 0===r?void 0:r.index)||0)}));return t.sort(((e,t)=>{const n=new Date(e.created||"");return new Date(t.created||"").getTime()-n.getTime()})),{rootSpans:t,subSpanGroups:n}}),[b]),w=(0,r.useCallback)((e=>{if(!e.span_id)return;if(!d)return;const t=null==I?void 0:I.subSpanGroups.get(e.span_id);if(!t)return;const r=n.getOrCreateClientAIChatThreadStore(d);r.setState({...r.state,requestInfo:{request:e.input,response:e.output,memory:void 0},inferences:t.filter((e=>{var t;return"number"==typeof(null===(t=e.metadata)||void 0===t?void 0:t.index)})).map((e=>{var t;const n=null===(t=e.metadata)||void 0===t?void 0:t.index;if("number"!=typeof n)throw new Error("Index is not a number");return{type:"inference",key:(0,h().$A)(e.input),index:n,value:{id:e.id,input:e.input,expected:e.output,metadata:e.metadata}}}))})}),[n,I,d]),z=(0,r.useCallback)((()=>{var e;if(!d)return;const t=null===(e=n.getOrCreateClientAIChatThreadStore(d).state.requestInfo)||void 0===e||null===(e=e.request)||void 0===e?void 0:e.traceId;if(!y||!t)return;const r=(0,l().W)({environmentName:"production",suffix:y});window.open(`https://www.braintrust.dev/app/Notion/p/${r}/logs?r=${t}`,"_blank")}),[n,y,d]);return(0,p.jsx)(k().Ay,{popupType:k().z7.Popup,placementToOrigin:k().sx.Bottom,alignmentToOrigin:k().yP.Start,renderOrigin:e=>(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(S().p,{...e,style:g.button,children:"failed"===(null==b?void 0:b.type)?"Failed to load logs":I?`View logs (${I.rootSpans.length})`:"Loading logs"}),(0,p.jsx)(N().A,{renderTooltip:()=>(0,p.jsx)("span",{children:"Open in Braintrust"}),render:e=>(0,p.jsx)(A().A,{...e,icon:m().N,ariaLabel:t.formatMessage({id:"aiInferenceTranscript.openInBraintrust",defaultMessage:"Open in Braintrust"}),onClick:z})})]}),render:e=>(0,p.jsx)(M().A,{menuType:P().gu.Popup,children:(0,p.jsx)(O().Ay,{type:O().Oh.Vertical,initialFocus:0,sections:[{key:"refresh",render:e=>(0,p.jsx)(K().A,{...e}),items:[{key:"refresh",render:e=>(0,p.jsx)(C().A,{...e,title:"Refresh"}),action:()=>{T()}}]},{key:"dates",render:e=>(0,p.jsx)(K().A,{...e,shouldShowBottomDivider:!0}),items:((null==I?void 0:I.rootSpans)||[]).map((t=>({key:t.id,render:e=>(0,p.jsx)(C().A,{...e,title:t.created||"No date"}),action:()=>{e.close(),w(t)}})))||[]}]})})})}function Se(e){const{clientStore:t,configType:n,debugOverrides:a}=e,l=function(e){if("researcher"===e)return"researchModeDebugOptions"}(n),d=(0,s().K8)((()=>function(e){return"researcher"===e?o().vW:{}}(n)),[n]),c=(0,i().IS)((e=>({wrap:{margin:"12px 0",display:"flex",flexDirection:"column",gap:8},title:{fontSize:16,color:e.text.secondary,fontWeight:500},row:{display:"flex",alignItems:"center",gap:8,color:e.text.secondary,fontSize:12},input:{width:200,backgroundColor:e.contentBackground,border:`1px solid ${e.regularDividerColor}`,fontSize:12,color:e.text.secondary}})),[]),u=(0,r.useCallback)((e=>{l&&t.setState({...t.state,debugOverrides:{...t.state.debugOverrides,[l]:{...t.state.debugOverrides[l]??{},...e}}})}),[t,l]);if(!l)return null;const g=a[l]??{},f=Object.entries(d).filter((e=>{let[t,n]=e;return"type"!==t&&("boolean"==typeof n||"string"==typeof n||"number"==typeof n)})).map((e=>{let[t,n]=e;return[t,g[t]??n]}));if(0===f.length)return null;const y=f.map((e=>{let[t,n]=e;return((e,t)=>"boolean"==typeof t?(0,p.jsxs)("div",{style:c.row,children:[(0,p.jsx)("span",{children:e}),(0,p.jsx)(T().A,{checked:t,onClick:()=>u({[e]:!t}),size:12})]},e):"string"==typeof t?(0,p.jsxs)("div",{style:c.row,children:[(0,p.jsx)("span",{children:e}),(0,p.jsx)(I().A,{value:t.toString(),onChange:t=>{u({[e]:t.target.value})},style:{width:200}})]},e):"number"==typeof t?(0,p.jsxs)("div",{style:c.row,children:[(0,p.jsx)("span",{children:e}),(0,p.jsx)(I().A,{type:"number",value:t.toString(),onChange:t=>{u({[e]:Number(t.target.value)})},style:{...c.input,width:65}})]},e):null)(t,n)}));return y.length>0?(0,p.jsxs)("div",{style:c.wrap,children:[(0,p.jsx)("div",{style:c.title,children:"Debug overrides"}),(0,p.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:16},children:y})]}):null}}}]);