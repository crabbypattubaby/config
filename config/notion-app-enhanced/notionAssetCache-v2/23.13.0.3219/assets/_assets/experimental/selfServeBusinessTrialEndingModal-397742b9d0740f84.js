"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[31388],{490127:(e,t,n)=>{n.r(t),n.d(t,{SelfServeBusinessTrialEndingModal:()=>ye});n(403517);var a=()=>n(353420),i=n(242343),r=()=>n(237385),s=()=>n(269280),o=()=>n(803290),l=()=>n(174114),d=()=>n(162901),c=()=>n(214144),u=()=>n(409211),m=()=>n(647242),p=()=>n(653998),g=()=>n(975392),h=()=>n(23371),y=()=>n(818369),v=()=>n(658388),f=()=>n(741329),S=()=>n(421338),x=()=>n(701270),b=()=>n(539048),_=()=>n(686329),j=()=>n(137476),I=()=>n(965694),B=()=>n(740699),M=()=>n(689248),P=()=>n(485966),w=()=>n(985532),C=()=>n(836331),D=()=>n(413871),E=()=>n(111826),k=()=>n(355852),A=()=>n(844393),U=()=>n(847184),T=()=>n(556673),L=()=>n(82482),N=()=>n(905467),F=()=>n(670682),R=()=>n(505316),z=()=>n(702888),K=()=>n(338578);var $=()=>n(748780),q=()=>n(967772),O=()=>n(305043),X=()=>n(87365),Y=()=>n(342490),V=()=>n(634551),J=()=>n(885492),W=()=>n(299901),H=()=>n(331374),Z=()=>n(979255),G=()=>n(892663),Q=(n(725707),n(491955),n(500234),()=>n(486826)),ee=()=>n(678988),te=()=>n(423600),ne=()=>n(76394),ae=()=>n(153642),ie=()=>n(910200),re=()=>n(784473),se=()=>n(614893),oe=()=>n(713628),le=()=>n(879205);var de=()=>n(502140),ce=()=>n(421650),ue=()=>n(855827),me=()=>n(262230);var pe=n(163643);const ge=4,he=[];function ye(e){let{spaceStore:t,spaceViewStore:n,userSettingsStore:i}=e;const r=(0,R().useElementsOptions)({type:"setup",currency:"USD"}),s=(0,K().o)();return s.length?(0,pe.jsx)(a().Elements,{stripe:(0,R().getStripe)(),options:r,children:(0,pe.jsx)(ve,{spaceStore:t,spaceViewStore:n,userSettingsStore:i,prices:s})}):null}function ve(e){let{spaceStore:t,spaceViewStore:n,prices:R}=e;const K=(0,r().v3)(),ye=c().JW(),ve=(0,B().L)(),fe=(0,p().tz)(),[Se,xe]=(0,i.useState)({name:ve??"",businessName:""}),be=(0,F()._3)({spaceId:t.id}),[_e,je]=(0,i.useState)({}),[Ie,Be]=(0,i.useState)((0,m().q8)(be)??"month"),[Me,Pe]=(0,i.useState)(),[we,Ce]=i.useState(!1),[De,Ee]=i.useState(0),[ke,Ae]=i.useState(0),Ue=V().XX-De;i.useEffect((()=>{De&&ke&&Ce((e=>Ue<ke-(e?V().ej:0)))}),[De,ke,Ue]);const Te=e=>{Pe(void 0),e.name&&je((e=>({...e,name:void 0}))),xe((t=>({...t,...e})))},Le=i.useCallback((()=>{const e={};return(0,I().r)(Se.name)||(e.name=fe.formatMessage({id:"selfServeBusinessTrialEndingModal.name.required.error",defaultMessage:"Please enter a valid name."})),je((t=>({...t,...e}))),e}),[Se.name,fe]),Ne=(0,o().K8)((()=>{var e;return null===(e=P().default.state.currentUserStore)||void 0===e?void 0:e.id}),[]),Fe=(0,l().IS)((e=>({paymentFieldsContainer:{height:480,width:480,position:"relative",border:`1px solid ${e.stroke.secondary}`,borderRadius:10,display:"flex",justifyContent:"center",padding:20,overflow:"auto"},rightPanel:{padding:20,flex:1,position:"relative"},iconBackground:{backgroundColor:"dark"===e.mode?"#1A2027":e.marketplaceEditorial.border.blue},billingIntervalContainer:{marginBottom:20,width:"100%"},footerContainer:{display:"flex",width:"100%",padding:"20px 0px 24px 0px",flexDirection:"column",justifyContent:"flex-end",alignItems:"flex-start",gap:24,position:"absolute",bottom:0,background:e.surface.elevated,transition:"all 200ms ease-in-out",...we?{borderTop:`1px solid ${e.stroke.primary}`,boxShadow:"0px 0px 16px 0px rgba(0, 0, 0, 0.08)"}:{}},billingDetailsContainer:{display:"flex",paddingBottom:`${we?V().ej:0}px`,flexDirection:"column",gap:24}})),[we]),{open:Re,openedFrom:ze,recentPageStores:Ke,verifiedPageStores:$e,teamStores:qe,workspaceUserStores:Oe,connectedApps:Xe,trialEndData:Ye,modalState:Ve}=(0,o().O$)(q().L3),Je=(0,o().K8)((()=>{var e;return Boolean(null===(e=n.getSettings())||void 0===e?void 0:e.business_trial_ending_modal_last_shown_at)}),[n]),We=(0,a().useElements)(),{hasPaymentMethod:He,accountBalance:Ze,immediate:Ge,recurring:Qe,nextBillingDate:et,subscriptionItems:tt,monthlyUnitPrice:nt,yearlyUnitPrice:at}=function(e){var t,n;let{billingData:a,environment:r,spaceId:s,selectedBillingInterval:o,prices:l}=e;const d=(0,m().Ry)(a)??"USD",c=(0,ae().V)()??1,u=o??(0,m().q8)(a)??"month",p=(0,i.useMemo)((()=>[{price:(0,ee().vk)(l,{product:"business",interval:u,currency:d}),quantity:c}]),[l,u,d,c]),g=(0,i.useMemo)((()=>(0,re().Dd)(d,{items:p,trialEnd:void 0})),[d,p]),h=(0,i.useMemo)((()=>p.map((e=>(0,ie().Kz)(e))).filter(ne().O9)),[p]),{tax:y,isLoading:v}=(0,re().Fy)({environment:r,currencyCode:d,address:null==a?void 0:a.address,lineItems:h,taxableAmount:g,billingData:a}),f="admin"===(null==a?void 0:a.type)&&Boolean(a.paymentMethod),S=null==a||null===(t=a.accountBalances)||void 0===t?void 0:t.find((e=>e.currencyCode===d)),x=new(te().W)(d,(null==S?void 0:S.amount)??0),b={subtotal:g,tax:y,isLoading:v},_={subtotal:g,tax:y,isLoading:v},j="business",I={month:(0,se().H)({billingInterval:"month",priceStore:le().A,products:[j]}),year:(0,se().H)({billingInterval:"year",priceStore:le().A,products:[j]})},B=(0,oe()._)({asyncPrice:I.month[j]}),M=(0,oe()._)({asyncPrice:I.year[j]}),P=(null==a||null===(n=a.subscription)||void 0===n?void 0:n.currentPeriodEnd)??Q().c9.now().plus({months:1});return{currencyCode:d,subtotal:g,lineItems:h,tax:y,isTaxLoading:v,hasPaymentMethod:f,accountBalance:x,immediate:b,recurring:_,nextBillingDate:P,subscriptionItems:p,monthlyUnitPrice:B,yearlyUnitPrice:M}}({billingData:be,environment:K,spaceId:t.id,selectedBillingInterval:Ie,prices:R}),it=(0,a().useStripe)(),{handleUpgrade:rt,error:st}=function(e){let{stripe:t,elements:n,environment:a,spaceStore:r,subscriptionItems:s,hasPaymentMethod:o}=e;const[l,d]=(0,i.useState)(!1),[c,u]=(0,i.useState)(),m=(0,p().tz)();return{handleUpgrade:async()=>{if(d(!0),ce().wD(a,{modalId:"trial_ending_modal"}),!t||!n)return(0,de().log)({level:"error",from:"MidtermCheckoutModal",type:"StripeError",error:{miscDataString:"Stripe elements not initialized when user tried to upgrade"}}),u(m.formatMessage({id:"spaceSubscriptionUpgradeModal.stripeNotLoaded",defaultMessage:"We could not reach our payment processor. Please reload the page or try again later."})),d(!1),{success:!1,error:c};let e;if(!o){const{error:i}=await n.submit();if(i)return ce().$X(a,{error:"could not submit form",error_type:"payment_method"}),{success:!1,error:i};const r=await t.createPaymentMethod({elements:n});if(r.error)return ce().$X(a,{error:r.error.message,error_type:"payment_method"}),{success:!1,error:r.error.message};if(!r.paymentMethod)return ce().$X(a,{error:"could not create token",error_type:"payment_method"}),{success:!1,error:"could not create token"};e={type:"paymentMethodId",value:r.paymentMethod.id}}try{const n=await(0,me().updateSubscription)({environment:a,from:"business_trial_ending_modal",spaceStore:r,desiredState:{items:s,trialEnd:void 0},paymentData:e});return await(0,me().handlePaymentIntentNextActions)({paymentIntentData:n,stripe:t,onSuccess:()=>(0,me().refreshAllBillingData)({environment:a,spaceStore:r})}),await ue().A.awaitData(a,{spaceId:r.id}),{success:!0}}catch{return{success:!1,error:m.formatMessage({id:"spaceSubscriptionUpgradeModal.payment.genericError",defaultMessage:"Your payment could not be processed. Please try again."})}}finally{d(!1)}},isSubmitting:l,error:c}}({stripe:it,elements:We,environment:K,spaceStore:t,subscriptionItems:tt,hasPaymentMethod:He});(0,s().w)((()=>(0,j().u4)({environment:K,event:{eventName:"self_serve_business_trial_ending_modal_viewed",eventProperties:{from:ze??"trial_ended_notification"}}}))),(0,i.useEffect)((()=>{"trial_ended_notification"!==ze||Je||v().Z1(K)}),[K,Je,ze]);const ot=(0,o().K8)((()=>(0,f().wd)()),[]),lt=(0,k().U)(),dt=(0,$().a)(n),[{value:ct}]=(0,d().Yb)((async()=>{if(w().A.state.shouldUseEdgeCache&&C().default.checkGate({gateName:"edge_cache_helpers"})){const e=await y().callApi({eventName:"listUsers",environment:K,data:{cursor:void 0,membershipFilter:"members",limit:J().U,query:"",spaceId:t.id}});return"success"!==e.type?[]:(0,h().lX)(e.data.users,e.data.users.length,(async e=>{const n=D().LU.createChildStore(t,{table:u().oo,id:e.id});return await n.load(),n}))}{await O().subscriptionDataStoreInstance.waitUntilLoaded();const e=O().subscriptionDataStoreInstance.state,n=e?E().Ye(e):[];return(0,h().lX)(n.slice(0,J().U),J().U,(async e=>{const n=D().LU.createChildStore(t,{table:u().oo,id:e.userId});return await n.load(),n}))}}),[K,t]),ut=(0,i.useMemo)((()=>ct||[]),[ct]),mt=he,pt=function(e){let{spaceId:t,userId:n}=e;const a=(0,r().v3)(),[s,o]=(0,i.useState)(null);return(0,i.useEffect)((()=>{(async()=>{if(!n)return;const e=await y().callApi({environment:a,eventName:"getSpaceBusinessTrialEndData",data:{spaceId:t}});"failed"!==e.type&&o(e.data)})()}),[a,t,n]),s}({spaceId:t.id,userId:Ne}),gt=(0,i.useMemo)((()=>({connectedApps:Xe??ot,teamStores:qe??lt,userStores:Oe??ut,newPageStores:Ke??mt,verifiedPageStores:$e??dt,trialEndData:Ye??pt})),[Xe,ot,qe,lt,Oe,ut,Ke,mt,$e,dt,Ye,pt]),ht=(0,H().so)(gt),yt=(0,o().K8)((()=>(0,H().is)(ht,gt)),[gt,ht]),vt=(0,o().K8)((()=>{const e=["top-left","top-right","bottom-left","bottom-right"];return yt.map(((t,n)=>{const{component:a,getCount:i}=W().j[t],{trialEndData:r,...s}=gt;return(0,pe.jsx)(a,{placement:e[n],countFromUsageData:i(gt),...s},t)}))}),[gt,yt]),ft=(0,z().g)({spaceId:t.id}),St=vt.length<ge,{title:xt,highlightIndex:bt,timelineItems:_t}=(0,H().PA)(ft,be),jt=async()=>{if("initial"===Ve)q().L3.update((e=>({...e,modalState:"clickedPrimaryButton"})));else{Pe(void 0);const e=Le();if(!(0,g().Im)(e))return;const{success:t}=await rt();t&&(M().a(K,"self_serve_business_trial_ending_soon"),(0,A().closeSelfServeBusinessTrialEndingModal)())}},It=()=>{(0,A().closeSelfServeBusinessTrialEndingModal)(),"clickedPrimaryButton"===Ve&&(0,A().openSelfServeBusinessTrialLossAversionModal)({openedFrom:"business_trial_ending_modal",onSecondaryButtonClick:()=>(0,A().openSelfServeBusinessTrialEndingModal)({openedFrom:"self_serve_business_trial_loss_aversion_modal",modalState:"clickedPrimaryButton"})})},[Bt,Mt]=(0,i.useState)(!1);return(0,pe.jsx)(b().s,{isOpen:Re,onClosed:A().closeSelfServeBusinessTrialEndingModal,areaConstraint:{width:{type:"min",length:V().c4}},render:()=>(0,pe.jsx)("div",{style:{overflow:"auto",position:"relative"},children:(0,pe.jsx)(X().P,{handleClose:A().closeSelfServeBusinessTrialEndingModal,primaryButtons:[{label:"clickedPrimaryButton"===Ve?(0,pe.jsx)(p().sA,{id:"selfServeBusinessTrialEndingModal.button.confirm",defaultMessage:"Confirm upgrade"}):(0,pe.jsx)(p().sA,{id:"selfServeBusinessTrialEndingModal.button.submit",defaultMessage:"Keep using Business"}),onClick:jt}],secondaryButtons:[{label:"clickedPrimaryButton"===Ve?(0,pe.jsx)(p().sA,{id:"selfServeBusinessTrialEndingModal.button.nevermind",defaultMessage:"Never mind"}):(0,pe.jsx)(p().sA,{...Z().DZ.buttonClose}),onClick:It}],title:(0,pe.jsx)(p().sA,{...xt}),timeline:{highlight:{index:bt,color:"uiBluePrimary",backgroundColor:Fe.iconBackground.backgroundColor},timelineItems:_t},leftPanel:be&&"clickedPrimaryButton"===Ve?(0,pe.jsxs)("div",{style:{flex:1,position:"relative",height:Ue},children:[(0,pe.jsx)(_().EE,{onSizeChange:e=>{let{height:t}=e;return Ae(t)},children:(0,pe.jsx)("div",{style:Fe.billingDetailsContainer,children:He?(0,pe.jsx)(T().I,{billingData:be}):(0,pe.jsx)(x().D,{styleName:"UIRegular-14px/Regular",children:(0,pe.jsx)(p().sA,{id:"selfServeBusinessTrialEndingModal.noPaymentMethod",defaultMessage:"Add a payment method to continue using the Business plan"})})})}),(0,pe.jsx)(_().EE,{onSizeChange:e=>{let{height:t}=e;return Ee(t)},children:(0,pe.jsx)("div",{style:Fe.footerContainer,children:(0,pe.jsx)(L().J,{immediate:Ge,recurring:Qe,accountBalance:Ze,items:tt,nextBillingDate:et,chargeType:{chargeType:"immediate"},modalId:"trial_ending_modal",isExpanded:Bt,setIsExpanded:Mt})})})]}):null,rightPanel:(0,pe.jsx)("div",{style:Fe.rightPanel,children:He||"initial"===Ve?St?(0,pe.jsx)(G().O,{}):(0,pe.jsx)(Y().a,{gridTemplateAreas:'\n\t\t\t\t\t\t\t\t\t\t\t"top-left top-right"\n\t\t\t\t\t\t\t\t\t\t\t"bottom-left bottom-right"\n\t\t\t\t\t\t\t\t\t\t',children:vt}):(0,pe.jsx)("div",{style:Fe.paymentFieldsContainer,children:(0,pe.jsxs)(S().Y1,{gap:24,direction:"vertical",width:"fill",children:[(0,pe.jsx)("div",{style:Fe.billingIntervalContainer,children:(0,pe.jsx)(U().TJ,{selectedBillingInterval:Ie,onChange:Be,monthlyUnitPrice:nt,yearlyUnitPrice:at,direction:"horizontal"})}),(0,pe.jsx)(U().ck,{formData:Se,onChangeFormData:Te,errors:_e,modalId:ye}),(0,pe.jsx)(N().q,{modalId:ye,style:{paddingBottom:24}}),st?(0,pe.jsx)(x().D,{styleName:"Caption-12px/Regular",colorName:"uiRedPrimary",children:st}):null]})})})})})})}},905467:(e,t,n)=>{n.d(t,{q:()=>v});var a=()=>n(353420),i=(a(),n(242343),()=>n(237385)),r=()=>n(269280),s=()=>n(803290),o=()=>n(653998),l=()=>n(421650),d=()=>n(421338),c=()=>n(517198),u=()=>n(485966),m=()=>n(172553),p=()=>n(847184),g=()=>n(76513),h=()=>n(506806),y=n(163643);function v(e){const{modalId:t,style:n}=e,d=(0,s().O$)(h().D),c=(0,i().v3)();(0,r().w)((()=>{h().D.setState(!0)}));const v={defaultValues:{billingDetails:(0,s().K8)((()=>{const e=u().default.state.currentUserStore;return{email:null==e?void 0:e.getEmail(),name:null==e?void 0:e.getName()}}),[])},terms:{card:"never"}};return(0,y.jsxs)(p().iy,{title:d?(0,y.jsx)(g().y,{labelOnly:!0}):(0,y.jsx)(o().sA,{id:"subscriptions.checkout.paymentMethod.title",defaultMessage:"Payment method"}),style:n,children:[d?(0,y.jsx)(f,{}):null,(0,y.jsx)(a().PaymentElement,{options:v,onChange:e=>{l().C3(c,{event:e,modal_id:t}),m().A.update((e=>{if(!e.open)return e;const{paymentData:t,...n}=e;return n}))},onReady:()=>h().D.setState(!1)})]})}function f(){return(0,y.jsxs)(d().Y1,{gap:12,children:[(0,y.jsxs)(d().Y1,{direction:"horizontal",gap:12,children:[(0,y.jsx)(c().A,{style:{width:"50%",height:60,borderRadius:6}}),(0,y.jsx)(c().A,{style:{width:"50%",height:60,borderRadius:6}})]}),(0,y.jsx)(g().y,{}),(0,y.jsx)(g().y,{}),(0,y.jsx)(g().y,{}),(0,y.jsx)(g().y,{})]})}}}]);