"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[32503],{3766:(e,t,n)=>{n.d(t,{J:()=>A,w:()=>x});n(403517);var i=n(242343),o=()=>n(237385),r=()=>n(803290),s=()=>n(174114),a=()=>n(855470),c=()=>n(284594),d=()=>n(31448),l=()=>n(209684),u=()=>n(535906),p=()=>n(273520),m=()=>n(858023),f=()=>n(88271),g=()=>n(354148),v=()=>n(129978),h=()=>n(100308),S=()=>n(486588),y=()=>n(196940),b=()=>n(670896),k=n(163643);function A(e){const{languagePopupStore:t}=e,n=(0,o().v3)(),u=(0,r().K8)((()=>(0,y().FT)(n.currentUser.id)),[n.currentUser.id]);(0,i.useEffect)((()=>{h().Ay.updateMediaDevices()}),[]);const m=(0,s().IS)((e=>({container:{padding:"8px 0px",display:"flex",flexDirection:"column",alignItems:"flex-start",width:300,gap:8},microphoneText:{marginLeft:12,fontSize:12,fontWeight:d().Wy.medium,color:e.text.secondary},microphoneSection:{display:"flex",flexDirection:"column",width:"100%"},languageText:{fontSize:14,color:e.text.primary},languageSection:{padding:"0px 14px",display:"flex",alignItems:"center",width:"100%",justifyContent:"space-between"},rightChevronStyle:{width:13,height:13,opacity:.5,color:e.icon.secondary},line:{width:"100%",height:1,backgroundColor:e.icon.tertiary,opacity:.3},languageButtonStyle:{fontSize:14,display:"flex",alignItems:"center",gap:10,color:e.text.secondary},helpSection:{padding:"5px 14px",display:"flex",alignItems:"center",justifyContent:"flex-start",gap:4,cursor:"pointer"},helpText:{fontSize:12,color:e.text.tertiary},helpIcon:{width:16,height:16,color:e.icon.tertiary}})),[]),f=(0,i.useMemo)((()=>(0,a().V)(m.rightChevronStyle)),[m.rightChevronStyle]),S=(0,i.useMemo)((()=>(0,c().$)(m.helpIcon)),[m.helpIcon]),{value:A}=(0,v().fJ)(g().fM);if(!A)return null;const{motion:w}=A;return(0,k.jsxs)("div",{style:m.container,children:[(0,k.jsxs)("div",{style:m.microphoneSection,children:[(0,k.jsx)("div",{style:m.microphoneText,children:"Microphone"}),(0,k.jsx)(x,{})]}),(0,k.jsx)("div",{style:m.line}),(0,k.jsxs)("div",{style:m.languageSection,children:[(0,k.jsx)("div",{style:m.languageText,children:"Language"}),(0,k.jsx)(p().Ay,{buttonPopupStore:t,renderOrigin:e=>(0,k.jsxs)(l().p,{style:m.languageButtonStyle,...e,children:[u," ",f]}),stopClickPropagation:!0,popupType:p().z7.Popup,render:e=>(0,k.jsx)(b().Z,{parent:e})})]}),(0,k.jsx)("div",{style:m.line}),(0,k.jsxs)(w.div,{style:m.helpSection,onClick:()=>window.open("https://www.notion.so/help/audio-dictation","_blank"),variants:{hover:{opacity:.6},tap:{opacity:1}},whileHover:"hover",whileTap:"tap",transition:{duration:.2},children:[S,(0,k.jsx)("div",{style:m.helpText,children:"Learn about Dictation"})]})]})}function x(){const e=(0,r().O$)(h().X8),t=(0,r().O$)(h().dc),n=(0,r().K8)((()=>e.findIndex((e=>e.deviceId===(null==t?void 0:t.deviceId)))),[e,t]),i=[{key:"devices",render:e=>(0,k.jsx)(f().A,{...e,topBorder:0!==e.index}),items:e.map((e=>({key:e.deviceId,render:n=>(0,k.jsx)(u().A,{...n,title:e.label,isChecked:e.deviceId===(null==t?void 0:t.deviceId)}),action:()=>{S().d.setState(e)}})))}];return(0,k.jsx)("div",{style:{display:"flex",flexDirection:"column",width:"100%"},children:(0,k.jsx)(m().Ay,{type:m().Oh.Vertical,initialFocus:n,sections:i})})}},17476:(e,t,n)=>{n.d(t,{e:()=>a,x:()=>s});var i=()=>n(803290),o=()=>n(950347),r=()=>n(166318);function s(e){return a({...e,hasSeenNux:(0,i().K8)((()=>r().c.state.hasAckedNux),[])})}function a(e){const{environment:t,isOnline:n,canUse:i,state:r,hasSeenNux:s}=e;return!!(0,o().b8)(t.device)&&(!s&&(!!n&&(!!i&&(r.state,!1))))}},76239:(e,t,n)=>{n.r(t),n.d(t,{displayDictationGenericErrorSnackbar:()=>A,displayDictationPermissionSnackbar:()=>b,displayDictationUsageErrorSnackbar:()=>k,showTranscriptionErrorToast:()=>x});var i=n(242343),o=()=>n(308439),r=()=>n(653998),s=()=>n(76394),a=()=>n(575015),c=()=>n(773253),d=()=>n(137476),l=()=>n(485966),u=()=>n(413871),p=()=>n(237385),m=()=>n(865226),f=()=>n(13143),g=n(163643);function v(){const e=(0,p().v3)(),t=(0,i.useCallback)((()=>{m().oo({environment:e,url:"https://notion.so/help/audio-dictation"})}),[e]);return(0,g.jsx)(f().Ag,{onClick:t,children:(0,g.jsx)(r().sA,{defaultMessage:"Get help",id:"dictation.permission.snackbar.getHelpButton.title"})})}var h=()=>n(604322),S=()=>n(241887),y=()=>n(936765);h().JS,h().rP,h().JC;function b(e){var t;a().D6({label:(t=e,t===h().JS?(0,g.jsx)(r().sA,{defaultMessage:"No microphone permission. Allow access to your microphone in system settings",id:"dictation.permission.microphone.snackbar.error"}):t===h().rP?(0,g.jsx)(r().sA,{defaultMessage:"No microphone available. Connect your microphone in system settings",id:"dictation.unavailable.microphone.snackbar.error"}):t===h().JC?(0,g.jsx)(r().sA,{defaultMessage:"An unknown error occurred when trying to access the microphone.",id:"dictation.permission.unknown.snackbar.error"}):void(0,s().HB)(t)),right:(0,g.jsx)(v,{})})}function k(){a().D6({label:(0,g.jsx)(r().sA,{defaultMessage:"Audio usage limit reached. Try again later.",id:"dictation.usage.snackbar.error"})})}function A(){a().D6({label:(0,g.jsx)(r().sA,{defaultMessage:"Dictation failed. Please try again.",id:"dictation.generic.snackbar.error"})})}function x(e,t){const{pointer:n,tabId:i,title:s,message:a,name:p,canRestart:m}=t,f=l().AppStoreCurrentSpaceStore.state;if(!f)return;const v=u().Bv.createChildStore(f,n);if(!v.isTranscriptionBlock())return;const h={title:(0,g.jsx)(r().sA,{defaultMessage:"Go to meeting note",id:"dictation.error.toast.action.goToBlock"}),onAction:()=>{c().UW("transcription_error_notification"),(0,y().N)({environment:e,blockStore:v,tabId:i}),(0,d().u4)({environment:e,event:{eventName:"error_transcription_toast_navigation_button_clicked",eventProperties:{block_id:v.id,error_name:p}}})}};c().HK({id:"transcription_error_notification",icon:o().exclamationMarkTriangleIcon,presentationType:"persistent",variant:"error",title:s,message:a,onDismiss:()=>{(0,d().u4)({environment:e,event:{eventName:"error_transcription_toast_dismissed",eventProperties:{block_id:v.id,error_name:p}}})},actions:{primary:m?{title:(0,g.jsx)(r().sA,{defaultMessage:"Resume",id:"dictation.error.toast.action.resume"}),onAction:()=>{c().UW("transcription_error_notification"),(0,y().N)({environment:e,blockStore:v,tabId:i}),(0,S().startTranscription)({environment:e,blockStore:v,from:"transcription_error_toast"}),(0,d().u4)({environment:e,event:{eventName:"error_transcription_toast_resume_button_clicked",eventProperties:{block_id:v.id,error_name:p}}})}}:h,secondary:m?h:void 0}})}},100308:(e,t,n)=>{n.d(t,{Ay:()=>d,X8:()=>a,dc:()=>c});n(362833),n(725707),n(491955),n(500234),n(244387);var i=()=>n(496985),o=()=>n(795396);class r extends(()=>n(129044))().default{async updateMediaDevices(){try{const e=await async function(){const e=(0,o().E)();return(await e.enumerateDevices()).reduce(((e,t)=>{if(t.kind&&t.label&&t.deviceId&&t.groupId)switch(t.kind){case"videoinput":e.videoInput.push(t);break;case"audioinput":e.audioInput.push(t);break;case"audiooutput":e.audioOutput.push(t)}return e}),{videoInput:[],audioInput:[],audioOutput:[]})}();this.setState(e)}catch{}}constructor(){super();try{(0,o().E)().addEventListener("devicechange",(()=>{this.updateMediaDevices()}))}catch{}n(258555).Ay.addListener((()=>{this.updateMediaDevices()}))}getInitialState(){return{videoInput:[],audioInput:[],audioOutput:[]}}}const s=new r,a=new(i().default)((()=>{var e,t;return(null===(e=s.state)||void 0===e||null===(e=e.audioInput)||void 0===e||null===(t=e.filter)||void 0===t?void 0:t.call(e,(e=>null==e?void 0:e.label)))??[]}),{debugName:"AudioInputDevicesStore"}),c=new(i().default)((()=>{var e;const t=n(625083).A.state,i=null===(e=n(486588).d.state)||void 0===e?void 0:e.label,o=a.state.find((e=>e.label===i));return t||(o||a.state[0])}),{debugName:"SelectedAudioInputDeviceStore"}),d=s},130881:(e,t,n)=>{n.r(t),n.d(t,{createClient:()=>c,generateNewClientSessionId:()=>s,getCurrentClientSessionId:()=>a});var i=()=>n(214144),o=()=>n(927685);let r=i().JW();function s(){r=i().JW()}function a(){return r}function c(e){let t=o().A.audioProcessor.url;const{maxReconnectDelayMs:i,minReconnectDelayMs:s}=e,a=`${t}?sessionId=${encodeURIComponent(r)}`;return new(n(205474))(a,{reconnect:{max:i,min:s,"reconnect timeout":2500,retries:1e20},timeout:2500,credentials:!0,transport:{withCredentials:!0},transportOverrides:{transports:["websocket"]}})}},162450:(e,t,n)=>{n.d(t,{zz:()=>M,ZQ:()=>I,bH:()=>_,Ux:()=>w,L6:()=>T,$I:()=>C,Ep:()=>me,Ez:()=>ne,UC:()=>re,$g:()=>ce,rJ:()=>de,lW:()=>se});n(610931);var i=()=>n(502140),o=()=>n(214144),r=()=>n(496580),s=()=>n(450475),a=()=>n(23371),c=()=>n(141666),d=()=>n(44658),l=()=>n(927685),u=()=>n(649833),p=()=>n(722174),m=()=>n(710602),f=()=>n(485966);const g=!1;var v=()=>n(752597),h=()=>n(137476),S=()=>n(836331);function y(e,t){v().default.afterNextFlush((()=>{S().default.checkGate({gateName:"audio_processor_client_send_request_metric_enabled"})&&h().vd(e,"audio_processor.client.send_request",t)}))}var b=()=>n(130881),k=()=>n(627618);const A=k().union([k().object({required:{audioDuration:k().number(),id:k().string(),status:k().literal("complete"),text:k().string()},optional:{}}),k().object({required:{audioDuration:k().number(),id:k().string(),reason:k().string(),status:k().literal("error")},optional:{}}),k().object({required:{audioDuration:k().number(),id:k().string(),status:k().literal("ignore")},optional:{}}),k().object({required:{audioDuration:k().number(),id:k().string(),status:k().literal("pending")},optional:{}})]),x=k().union([k().object({required:{message:k().string(),name:k().literal("ForbiddenError"),status:k().literal(403),type:k().literal("forbidden")},optional:{}}),k().object({required:{message:k().string(),type:k().literal("openai_error")},optional:{status:k().number()}}),k().object({required:{requestId:k().string(),result:k().unknown(),status:k().literals("error","ok"),type:k().literal("response")},optional:{}}),k().object({required:{audioSessionId:k().string(),isAudioSessionComplete:k().boolean(),isSegmentComplete:k().boolean(),segmentId:k().string(),transcription:k().lazy((()=>A)),type:k().literal("transcription")},optional:{}}),k().object({required:{message:k().string(),name:k().literal("UserRateLimitResponse"),status:k().literal(429),type:k().literal("rate_limited")},optional:{}}),k().object({required:{talking:k().boolean(),type:k().literal("vad")},optional:{}})]),w="transcription",T="vad",_="rate_limited",M="forbidden",I="openai_error",C=(0,n(504639).A)(),B=async()=>Promise.all([n.e(2681),n.e(36733)]).then(n.bind(n,130881)),D=!1,R=90*c().TD;function j(e){return{_id:e,charactersSent:0,requestsSent:0,requestsTimedOut:0,responsesReceivedWithoutHandlers:0,successfulResponsesReceived:0,unsuccessfulResponsesReceived:0,invalidMessagesReceived:0,notificationsReceived:0,messagesReceived:0}}const E=new(n(725155).O)(20),P=new Map,N=(Date.now(),"audioProcessorInternals"),L=new(i().BatchedLogger)({from:N,type:"BulkDebug",level:"info",maxLength:250,logToConsole:D});let q,F=0,O=0,U=0,z=0,W=j(0),$=null,K=null,H=null,V=0,Y=n(438745).u,X=!1,Z="uninitialized";const G=!0;function J(e){L.log({level:"info",from:N,type:e})}function Q(){q=function(e){var t;const n=null==e||null===(t=e.socket)||void 0===t||null===(t=t.transport)||void 0===t||null===(t=t.query)||void 0===t?void 0:t.transport;if("websocket"===n||"polling"===n)return n}(this),J(`ping:${q}`),$=Date.now(),ge(`Incoming primus ping received from server via ${q}.`)}function ee(){return{...E.getStats()}}function te(e){switch(L.log({level:"info",from:N,type:"readyStateChange",data:{message:e}}),H=Date.now(),e){case"end":Z="closed";break;case"open":Z="open";break;case"opening":Z="opening"}}const ne=n(975392).Bj((e=>async function(e){if(g)return;F+=1;const{createClient:t}=await B(),o=t({minReconnectDelayMs:.5*c().TD,maxReconnectDelayMs:2*c().TD});return o.on("data",ue),o.on("open",(()=>{m().A.setState("connected"),J("open"),W=j(W._id+1),D&&function(){const e=Date.now(),t=20;function n(){const i=ee();if(0===i.queue&&0===i.running)return ge(`Queues emptied after ${Date.now()-e} ms`),void(ie=void 0);ie=window.setTimeout(n,t)}ie&&window.clearTimeout(ie),ge("Starting measurement of time until send queues are empty."),n()}()})),o.on("reconnected",(e=>{var t;(t=null==e?void 0:e.duration)&&t>1e4?ae():X=!1,L.log({level:"info",from:N,type:"reconnected",data:{message:`Reconnected in ${null==e?void 0:e.duration} ms`}})})),o.on("reconnect",(()=>{J("reconnect")})),o.on("reconnect scheduled",(e=>{(void 0===(null==e?void 0:e.attempt)||void 0===(null==e?void 0:e.duration)||e.attempt>2||e.duration>5e3||void 0===m().A.state)&&m().A.setState("disconnected"),L.log({level:"info",from:N,type:"reconnect scheduled",data:{message:`Reconnecting in ${null==e?void 0:e.scheduled} ms, attempt ${null==e?void 0:e.attempt} of ${null==e?void 0:e.retries}`}})})),o.on("reconnect timeout",(()=>{J("reconnect timeout")})),o.on("reconnect failed",(()=>{J("reconnect failed")})),o.on("timeout",(()=>{J("timeout")})),o.on("destroy",(()=>{J("destroy")})),o.on("close",(()=>{J("close")})),o.on("online",(()=>{J("online")})),o.on("offline",(()=>{J("offline")})),o.on("error",(e=>{let t;t="TransportError"===e.type?{level:"info",from:N,type:"primusTransportError",error:(0,s().convertErrorToLog)(e)}:{level:"error",from:N,type:"unknownPrimusError",error:(0,s().convertErrorToLog)(e)};(0,n(263512).rQ)(1)&&i().rateLimitedLog(t),L.log(t),U+=1})),o.on("incoming::ping",Q),o.on("readyStateChange",te),o.on("end",(()=>{J("end"),o.off("readyStateChange",te),O+=1,pe(o,e)})),window.__primusClient_audioProcessor=o,o}(e)),(function(){return"primus_audioProcessor"}));let ie,oe;function re(e){if(oe)throw new Error("Having more than one onRestartAudioProcessorConnectionHandler is not currently supported");oe=e}function se(){oe=void 0}function ae(){var e;X=!1,E.cancel(),function(){for(const e of P.values())window.clearTimeout(e.timeout);P.clear()}(),null===(e=oe)||void 0===e||e()}async function ce(e){var t,n;const{base64Audio:i,environment:o,language:r}=e,s=null===(t=f().default.state.currentUserStore)||void 0===t?void 0:t.id,a=null===(n=f().default.state.currentSpaceStore)||void 0===n?void 0:n.id;var c;if(s&&a)return null===(c=le({method:"audioData",request:{base64Audio:i,language:r,userId:s,spaceId:a},environment:o}))||void 0===c?void 0:c.response;{const e=s||a?s?"Space":"User":"Both";return await(0,u().stopDictation)({environment:o,error:new(p().eY)(e),from:"missing_user_or_space"})}}function de(e){var t;const{environment:n,rootBlockId:i}=e,o=null===(t=f().default.state.currentSpaceStore)||void 0===t?void 0:t.id;le({method:"transcriptionInfo",request:{rootBlockId:i,spaceId:(0,r().o9)(o)},environment:n})}function le(e){if(g)return;const{method:t,request:n,environment:r}=e;y(r,{status:"enqueued",endpoint:t});const c=E.enqueue((()=>{var c;const d=o().JW();!function(e,t){v().default.afterNextFlush((()=>{S().default.checkGate({gateName:"audio_processor_client_send_request_metric_enabled"})&&(h().vd(e,"audio_processor.client.send_request.queue_running_size",{value:t.running}),h().vd(e,"audio_processor.client.send_request.queue_backup_size",{value:t.queue}))}))}(r,E.getStats());const u=a().yX(),p=Date.now(),m=G?window.setTimeout((()=>{"open"===Z&&(W.requestsTimedOut+=1,L.log({level:"info",from:N,type:"requestTimeout",data:{requestId:d,time:Date.now()-p}}))}),R):void 0;P.set(d,{resolve:u.resolve,reject:u.reject,timeout:m,sendTime:p}),L.log({level:"info",from:N,type:"requestSent",data:{requestId:d,method:t}});const f={type:`${l().A.audioProcessor.api}/${t}`,requestId:d,...n};W.requestsSent+=1,async function(e){const{message:t,environment:n}=e,i=JSON.stringify(t);W.charactersSent+=i.length,V<i.length&&(V=i.length);const o=await ne(n);null==o||o.write(t)}({message:f,environment:r}),null===(c=e.onRequestSent)||void 0===c||c.call(e),u.promise.then((e=>{y(r,{status:"success",endpoint:t})})).catch((e=>{const n=E.getStats();y(r,{status:"failure",endpoint:t,queue_running_size:n.running,queue_backup_size:n.queue})}));const g=a().nQ(1e3,u.promise).then((e=>{let{timeout:n}=e;if(n){const e=E.getStats();y(r,{status:"failure",endpoint:t,queue_running_size:e.running,queue_backup_size:e.queue,queue_timeout:!0}),i().log({level:"error",from:"audioProcessorInternals",type:"requestTimeout",error:(0,s().convertErrorToLog)(new Error("Request timed out")),data:{miscDataToConvertToString:{requestId:d,method:t}}})}return{}}));return g}));return{response:c.catch((e=>{e instanceof fe&&!X?(X=!0,z+=1,J("connectionResetDueToFailedRequest"),ne(r).then((e=>{null==e||e.end()})),ge(`sendRequest() for ${t} returned server error (${e.message}), resetting connection`,n)):ge(`sendRequest() cancelled or errored for ${t} (${e.message})`,n)})),asyncQueuePromise:c}}function ue(e){W.messagesReceived+=1;const t=(0,d().tf)(x,e);if(t)return W.invalidMessagesReceived+=1,void i().rateLimitedLog({level:"warning",from:N,type:"ValidationError",data:{miscDataToConvertToString:e},error:(0,s().convertErrorToLog)(t)});const n=e;switch(n.type){case"response":{const{requestId:e,status:t,result:i}=n,o=P.get(e);let r;if(P.delete(e),n.result&&"object"==typeof n.result&&"internalProcessingTimeMs"in n.result&&"number"==typeof n.result.internalProcessingTimeMs&&(r=n.result.internalProcessingTimeMs),L.log({level:"info",from:N,type:"responseReceived",data:{requestId:e,response:t,time:o&&Date.now()-o.sendTime,internalProcessingTimeMs:r}}),!o)return void(W.responsesReceivedWithoutHandlers+=1);K=Date.now(),window.clearTimeout(o.timeout),"ok"===t?(W.successfulResponsesReceived+=1,o.resolve(i)):(W.unsuccessfulResponsesReceived+=1,o.reject(new fe(i)));break}case"transcription":C.emit(w,n);break;case"vad":C.emit(T,n);break;case"rate_limited":C.emit(_,n);break;case"forbidden":C.emit(M,n);break;case"openai_error":C.emit(I,n)}}function pe(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];var o,r;n&&i().log({level:"info",from:N,type:"audioProcessorEnd",error:{message:`SocketId: ${null==e||null===(o=e.socket)||void 0===o?void 0:o.id} Query:${null==e||null===(r=e.transport)||void 0===r?void 0:r.query}`}});Y.setTimeout((()=>{void 0!==e&&e.destroy()}),0),ne.cache.clear(),ae(),n&&Y.setTimeout((()=>{ne(t)}),2*c().TD)}async function me(e){if(e&&ne.cache.has("primus_audioProcessor")){const t=await ne(e);if(t){const n={type:`${l().A.audioProcessor.api}/destroySession`,requestId:o().JW()};t.write(n),t.removeAllListeners("end"),pe(t,e,!1),(0,b().generateNewClientSessionId)()}}}class fe extends Error{constructor(e){super(e),this.name="FailedAudioProcessorRequestError"}}function ge(){if(D){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];console.info("audioProcessorInternals:",...t)}}},196940:(e,t,n)=>{n.d(t,{$q:()=>l,FT:()=>v,Xy:()=>g,u1:()=>d});n(744688);var i=()=>n(907867),o=()=>n(329911),r=()=>n(577860),s=()=>n(952602),a=()=>n(485966),c=()=>n(692079);function d(){return Object.entries(i().Cu)}function l(e){return i().Cu[e][1]}function u(e){switch(e){case"en-US":default:return"English";case"de-DE":return"German";case"ko-KR":return"Korean";case"zh-CN":case"zh-TW":return"Chinese";case"ja-JP":return"Japanese";case"es-ES":case"es-LA":return"Spanish";case"pt-BR":return"Portuguese";case"fr-FR":return"French";case"da-DK":return"Danish";case"fi-FI":return"Finnish";case"nb-NO":return"Norwegian";case"nl-NL":return"Dutch";case"sv-SE":return"Swedish"}}class p extends(()=>n(129044))().default{constructor(){super(),this.lastLocalStorageRetrieval=void 0}syncLocalStorageIfNecessary(e){if(!this.lastLocalStorageRetrieval||e!==this.lastLocalStorageRetrieval[0]||Date.now()-this.lastLocalStorageRetrieval[1]>30*n(141666).TD){this.lastLocalStorageRetrieval=[e,Date.now()];const n=o().K.get({userId:e,key:f});if(Object.hasOwn(i().Cu,n))this.state!==n&&this.setState(n);else{var t;const n=u((null===(t=a().default.state.currentUserSettingsStore)||void 0===t||null===(t=t.getSettings())||void 0===t?void 0:t.preferred_locale)??r().q);n!==this.state&&this.setState(n),o().K.set({userId:e,key:f,value:this.state})}}}getInitialState(){var e;return u((null===(e=a().default.state.currentUserSettingsStore)||void 0===e||null===(e=e.getSettings())||void 0===e?void 0:e.preferred_locale)??r().q)}}const m=new p,f="DictationLanguage";function g(e,t){(0,c().K_)(e,{from_language:m.state,to_language:t,dictation_session_id:(0,s().qY)()}),m.setState(t),o().K.set({userId:e.currentUser.id,key:f,value:t})}function v(e){return m.syncLocalStorageIfNecessary(e),m.state}},241887:(e,t,n)=>{n.r(t),n.d(t,{ensureTranscriptionIsInActive:()=>D,pauseTranscription:()=>R,placeCursorInNotesTab:()=>L,runSummarization:()=>E,startTranscription:()=>C,stopTranscription:()=>B,updatePreferredSummarizationFormat:()=>P});n(358848),n(91270);var i=()=>n(524118),o=()=>n(220574),r=()=>n(409211),s=()=>n(23371),a=()=>n(3311),c=()=>n(76394),d=()=>n(927999),l=()=>n(349947),u=()=>n(575015),p=()=>n(384221),m=()=>n(773253),f=()=>n(84543),g=()=>n(165786),v=()=>n(952602),h=()=>n(137476),S=()=>n(477784),y=()=>n(485966),b=()=>n(604322),k=()=>n(722174),A=()=>n(950347),x=()=>n(196940),w=()=>n(166318),T=()=>n(649833),_=()=>n(358626),M=()=>n(289708);const I=(0,n(653998).YK)({transcriptTooShort:{id:"transcriptionBlockActions.transcriptTooShort",defaultMessage:"Transcript is too short to summarize"},genericError:{id:"transcriptionBlockActions.genericError",defaultMessage:"Something went wrong while summarizing your transcript."},failedToStartDictation:{id:"transcriptionBlockActions.failedToStartDictation",defaultMessage:"Unable to start transcription"}});async function C(e){var t;const{environment:n,blockStore:o}=e,a=null===(t=y().default.state.currentUserStore)||void 0===t?void 0:t.id;if(!a)return;m().UW("transcription_error_notification");const c=t=>{f().createAndCommit({userAction:"transcriptionBlockActions.failedToStartDictation",environment:n,canUndo:!1,perform:t=>{N({...e,transaction:t,state:{state:"paused"}})}}),t&&u().D6({label:S().A.formatMessage(I.failedToStartDictation),helpUrl:b().WQ})},{shouldShowSetupModal:d,shouldStartDictation:l}=await(0,M().HT)(n);if(d)return c(!1),w().c.openTranscriptionSetupModal(),void(0,h().u4)({environment:n,event:{eventName:"transcription_block_setup_modal_opened",eventProperties:{}}});if(!l)return void c(!0);w().c.setSettingsOpenForBlockId(void 0),m().UW("transcription_idle_notification");try{w().c.setLoadingState(o.id,!0);if((await(0,s().nQ)(5e3,T().DictationManager.startDictation({environment:n,blockStore:o,from:"transcription_block",includeSystemAudio:(0,M().u)(n)}))).timeout)throw new(k().Tn)}catch(g){return void((0,i().USz)(g)&&("DictationSystemAudioFailedError"===g.name||"DictationStartTimeoutError"===g.name)&&n.device.isElectronMac?(c(!1),w().c.openTranscriptionSetupModal()):c(!0))}finally{w().c.setLoadingState(o.id,!1)}const p={state:"transcribing",transcriber_id:a,transcriber_table:r().oo,session_id:(0,v().qY)()};f().createAndCommit({userAction:"transcriptionBlockActions.initializeTitleAndStartTranscription",environment:n,canUndo:!1,perform:t=>{N({...e,transaction:t,state:p})}})}async function B(e){const{environment:t,blockStore:n}=e,i=(0,A().Vc)(n);if(i<b().fn)return u().D6({label:S().A.formatMessage(I.transcriptTooShort)}),await R({...e,shouldStopDictation:!0}),void(0,h().u4)({environment:t,event:{eventName:"transcription_too_short_to_summarize_error_shown",eventProperties:{block_id:n.id,transcript_length:i}}});await j({...e,shouldStopDictation:!0})}async function D(e){var t;const{environment:n,blockStore:i,from:o}=e,r=null===(t=i.getFormat())||void 0===t?void 0:t.transcription_state;return r&&"transcribing"!==r.state?"initial"!==(null==r?void 0:r.state)&&"idle"!==(null==r?void 0:r.state)&&"paused"!==(null==r?void 0:r.state)&&"summarizing"!==r.state&&void(0,c().HB)(r):(await R({environment:n,blockStore:i,shouldStopDictation:!1,from:o}),!0)}async function R(e){await j({...e,disableSummarization:!0,state:{state:"paused"}})}async function j(e){const{environment:t,blockStore:n,state:i,disableSummarization:o,shouldStopDictation:r,from:s}=e;w().c.setSettingsOpenForBlockId(void 0),m().UW("transcription_idle_notification"),i&&N({environment:t,blockStore:n,state:i,from:s}),r&&T().DictationManager.stopDictation({environment:t,from:"transcription_block"}),o||await E({environment:t,blockStore:n})}async function E(e){const{environment:t,blockStore:n}=e;if(!y().default.state.mainEditorCurrentBlockStore)return;const i=n.pointer.spaceId;if(!i)return;N({environment:t,blockStore:n,state:{state:"summarizing",step:"thinking",thinkingSteps:[]},from:"summary_requested"});const r={...n.pointer,spaceId:i},s=w().c.getSummarizationAbortController(n.id);null==s||s.abort();const c=w().c.createSummarizationAbortController(n.id);try{let e=!1;await(0,g().gj)({environment:t,onResponse:i=>{if("summarize-transcript-error"===i.type)return void u().D6({label:S().A.formatMessage(I.genericError)});if("summarize-transcript-record-map"===i.type){const e=i.recordMap;l()._O({environment:t,recordMap:o().RecordMapWithRole.create(e),inMemoryRecordCache:t.defaultRecordCache.inMemoryRecordCache,debugSource:"transcriptionBlockActions.runSummarization"})}const r=w().c.getTabState(n.id),s=(0,A().y1)(n,"summary");s&&r!==(null==s?void 0:s.id)&&!e&&(e=!0,w().c.setTabState(n.id,s.id))},data:{transcript:[{id:(0,a().Ay)(),type:"config",value:{type:"summarize-transcript",transcriptPointer:r,language:(0,x().FT)(t.currentUser.id)}},{id:(0,a().Ay)(),type:"summarize-transcript"}],traceId:n.id,spaceId:i,generateTitle:!1},abortSignal:c.signal})}catch(d){if((0,g().zf)(c,d))return;throw N({environment:t,blockStore:n,state:{state:"idle"},from:"summary_error"}),d}}async function P(e){var t;const{environment:n,blockStore:i,format:o}=e;if((null===(t=i.getFormat())||void 0===t?void 0:t.transcription_summarization_format_type)===o)return;f().createAndCommit({userAction:"transcriptionBlockActions.updatePreferredSummarizationFormat",environment:n,canUndo:!0,perform:e=>{d().zA({stores:[i],update:{transcription_summarization_format_type:o},transaction:e})}});"idle"===(0,A().by)(i).state&&await E({environment:n,blockStore:i})}function N(e){const{environment:t,blockStore:n,state:i,transaction:o,from:r}=e;(0,_().K)({environment:t,blockStore:n,state:i,transaction:o}),(0,h().u4)({environment:t,event:{eventName:"transcription_state_updated",eventProperties:{from:r,block_id:n.id,space_id:n.pointer.spaceId,new_state:i.state}}})}function L(e){const{blockStore:t}=e,n=(0,A().y1)(t,"notes");if(!n)return;const i=n.getContentStores().at(-1),o=null==i?void 0:i.getTitleStore();o&&(p().setSelectionAtStart({store:o}),w().c.setTabState(t.id,n.id))}},258555:(e,t,n)=>{n.d(t,{Ay:()=>h,JS:()=>a,Kj:()=>f,a3:()=>s,nY:()=>u});n(610931);var i=()=>n(975392),o=()=>n(795396);const r="initial",s="allowed",a="denied",c="no_devices",d="insecure_context",l="unknown_error",u="NotAllowedError";function p(e){for(const t of e.getTracks())t.stop()}const m=(0,i().nF)((async function(){if(!window.isSecureContext)return d;try{const e=(0,o().E)();return p(await e.getUserMedia({video:!1,audio:!0})),s}catch(e){const{displayDictationPermissionSnackbar:t}=await Promise.resolve().then(n.bind(n,76239));if(e instanceof Error)switch(e.name){case u:return t(a),a;case"NotFoundError":case"OverconstrainedError":return t(c),c}return t(l),l}}),1e3);async function f(){if(!window.isSecureContext)return d;try{const e=(0,o().E)();return p(await e.getDisplayMedia({audio:!0,systemAudio:"include"})),s}catch(e){return l}}const g=(0,i().nF)(f,1e3);class v extends(()=>n(129044))().default{async checkPermissions(e){const t=await m(),n=e?await g():r;return this.setState({...this.state,audio:t,screenRecording:n}),{audio:t,screenRecording:n}}getHasAttemptedScreenRecordingPermissions(){return this.state.hasAttemptedScreenRecordingPermissions}setHasAttemptedScreenRecordingPermissions(e){this.setState({...this.state,hasAttemptedScreenRecordingPermissions:e})}getInitialState(){const e=window.isSecureContext?r:d;return{audio:e,screenRecording:e,hasAttemptedScreenRecordingPermissions:void 0}}}const h=new v},261334:(e,t,n)=>{n.d(t,{M:()=>c,X:()=>a});var i=()=>n(803290),o=()=>n(181301),r=()=>n(950347),s=()=>n(166318);function a(e){return c({...e,hasSeenCalendarNux:(0,i().K8)((()=>s().c.state.hasAckedCalendarNux),[]),hasConnectedCalendar:(0,i().K8)((()=>(0,o().mX)()),[])})}function c(e){const{environment:t,isOnline:n,canUse:i,state:o,hasSeenCalendarNux:s,hasConnectedCalendar:a}=e;return!!(0,r().b8)(t.device)&&(!a&&(!s&&(!!n&&(!!i&&(o.state,!1)))))}},289708:(e,t,n)=>{n.d(t,{HT:()=>S,MZ:()=>A,u:()=>x,xw:()=>h});n(610931),n(242343);var i=()=>n(653998),o=()=>n(818369),r=()=>n(437071),s=()=>n(865226),a=()=>n(773253),c=()=>n(11639),d=()=>n(28416),l=()=>n(189812),u=()=>n(216273),p=()=>n(836331),m=()=>n(258555),f=n(163643);const g=(0,i().YK)({latestVersionStepTitle:{id:"transcriptionSetupSteps.latestVersionStepTitle",defaultMessage:"Update the Notion app"},latestVersionStepDescription:{id:"transcriptionSetupSteps.latestVersionStepDescription",defaultMessage:"Update to the latest version of the Notion app to use AI Meeting Notes."},latestVersionStepActionText:{id:"transcriptionSetupSteps.latestVersionStepActionText",defaultMessage:"Update my Notion app"},microphoneStepTitle:{id:"transcriptionSetupSteps.microphoneStepTitle",defaultMessage:"Enable microphone access"},microphoneStepDescription:{id:"transcriptionSetupSteps.microphoneStepDescription",defaultMessage:"This allows Notion AI to transcribe what you say."},microphoneStepActionText:{id:"transcriptionSetupSteps.microphoneStepActionText",defaultMessage:"Enable microphone access"},systemAudioStepTitle:{id:"transcriptionSetupSteps.systemAudioStepTitle",defaultMessage:"Enable screen & system audio access"},systemAudioStepDescription:{id:"transcriptionSetupSteps.systemAudioStepDescription",defaultMessage:"This allows Notion AI to transcribe what everyone else is saying (even on headphones)."},systemAudioStepActionText:{id:"transcriptionSetupSteps.systemAudioStepActionText",defaultMessage:"Enable access"},restartAppStepTitle:{id:"transcriptionSetupSteps.restartAppStepTitle",defaultMessage:"Restart Notion"},restartAppStepDescription:{id:"transcriptionSetupSteps.restartAppStepDescription",defaultMessage:"Final step! Restart your Notion app to apply the permissions."},restartAppStepActionText:{id:"transcriptionSetupSteps.restartAppStepActionText",defaultMessage:"Restart Notion app"}}),v=[{id:"desktop-app-version",title:g.latestVersionStepTitle,description:g.latestVersionStepDescription,hasCompleted:e=>Promise.resolve(x(e.environment)),actionText:g.latestVersionStepActionText,action:async e=>{const t=await(0,l().a)(e.environment.device);t?await r().openExternalUrl(n(927685).A.domainBaseUrl+t):await r().openExternalUrl("https://www.notion.so/desktop")}},{id:"microphone",title:g.microphoneStepTitle,description:g.microphoneStepDescription,hasCompleted:async e=>{if(e.environment.device.isElectronWindows)return!0;if(e.environment.device.isElectron){if("granted"===await r().getMediaAccessStatus("microphone"))return!0;if(e.isConfirmation)try{return await b(),!0}catch{return!1}}return!1},actionText:g.microphoneStepActionText,action:async e=>{try{await b()}catch(t){t instanceof Error&&t.name===m().nY&&r().openSystemSettings("microphone")}}},{id:"system-audio",title:g.systemAudioStepTitle,description:g.systemAudioStepDescription,hasCompleted:async e=>{if(e.environment.device.isElectronWindows)return!0;if(e.isConfirmation){if(await k())return!0}return Promise.resolve(void 0!==m().Ay.getHasAttemptedScreenRecordingPermissions())},actionText:g.systemAudioStepActionText,action:async e=>{const t=await k();m().Ay.setHasAttemptedScreenRecordingPermissions(t?m().a3:m().JS),t&&t===m().a3||r().openSystemSettings("screen-recording")}},{id:"restart-app",title:g.restartAppStepTitle,description:g.restartAppStepDescription,hasCompleted:async e=>{if(e.environment.device.isElectron&&e.isConfirmation){if("allowed"===await k())return!0}return Promise.resolve(!1)},actionText:g.restartAppStepActionText,action:async()=>(r().relaunch(),Promise.resolve())}];function h(){return v}async function S(e){if(p().default.checkGate({gateName:"enable_transcription_on_browser_for_debug_enabled"}))return{shouldShowSetupModal:!1,shouldStartDictation:!0};if(e.device.isMobile)return{shouldShowSetupModal:!1,shouldStartDictation:!0};if(e.device.isBrowser)return{shouldShowSetupModal:!1,shouldStartDictation:!1};const t=await async function(e,t){for(const n of t)if(!(await n.hasCompleted({environment:e,isConfirmation:!1})))return n}(e,h());return"desktop-app-version"===(null==t?void 0:t.id)||"microphone"===(null==t?void 0:t.id)?{shouldShowSetupModal:!0,shouldStartDictation:!1}:{shouldShowSetupModal:!1,shouldStartDictation:!0}}function y(e){a().HK({presentationType:"persistent",id:"transcription_browser_toast",title:(0,f.jsx)(i().sA,{id:"transcriptionPermissionActions.transcriptionAppRequired.title",defaultMessage:"Notion app required"}),message:(0,f.jsx)(i().sA,{id:"transcriptionPermissionActions.transcriptionAppRequired.message",defaultMessage:"To begin transcription, you must use the Notion app."}),actions:{primary:{title:(0,f.jsx)(i().sA,{id:"transcriptionPermissionActions.transcriptionAppRequired.primaryAction",defaultMessage:"Download app"}),onAction:async()=>{await async function(e){const t=await(0,l().a)(e.device);if(!t)return;(0,c().u)({environment:e,event:{eventName:"download_app_for_transcription_clicked",eventProperties:{}}}),s().oo({environment:e,url:t,openInNew:"tab"})}(e),a().UW("transcription_browser_toast")}},secondary:{title:(0,f.jsx)(i().sA,{id:"transcriptionPermissionActions.transcriptionAppRequired.secondaryAction",defaultMessage:"Ignore"}),onAction:()=>{a().UW("transcription_browser_toast"),(0,c().u)({environment:e,event:{eventName:"transcription_native_app_required_toast_dismissed",eventProperties:{}}})}}}}),(0,c().u)({environment:e,event:{eventName:"transcription_native_app_required_toast_shown",eventProperties:{}}})}async function b(){const e=(0,n(795396).E)(),t=await e.getUserMedia({audio:!0});for(const n of t.getTracks())n.stop()}async function k(){try{const e=await(0,n(23371).nQ)(5e3,(0,m().Kj)());return e.timeout?m().JS:e.result}catch{return m().JS}}async function A(e){const t=e.device.os;if("mac"!==t&&"windows"!==t)return void y(e);const n=await o().callApi({eventName:"getDesktopAppRegistration",environment:e,data:{os:t}});if("data"in n&&n.data.isRegistered)return(0,c().u)({environment:e,event:{eventName:"open_transcription_block_in_desktop_app_clicked",eventProperties:{}}}),void(await s().eG({environment:e,url:(0,d().P)(window.location.href)}));y(e)}function x(e){const t=u().A.state.transcriptionSupportLevel;return Boolean(t)}},473616:(e,t,n)=>{n.d(t,{bd:()=>q,jZ:()=>V,wf:()=>Y});var i=n(242343),o=()=>n(237385),r=()=>n(803290),s=()=>n(174114),a=()=>n(740520),c=()=>n(653998),d=()=>n(76394),l=()=>n(31448),u=()=>n(126451),p=()=>n(209684),m=()=>n(345022),f=()=>n(966789),g=()=>n(951540),v=()=>n(103151),h=()=>n(610271),S=()=>n(137476),y=()=>n(906230),b=()=>n(313067),k=()=>n(485966),A=()=>n(836331),x=()=>n(241887),w=()=>n(289708),T=()=>n(950347),_=()=>n(642662),M=()=>n(261334),I=()=>n(17476),C=()=>n(377403),B=()=>n(486338),D=()=>n(166318),R=n(163643);const j=(0,c().YK)({transcribing:{id:"dictation.transcriptionBlock.recordingButton.stop",defaultMessage:"Stop"},summarizing:{id:"dictation.transcriptionBlock.recordingButton.summarizing",defaultMessage:"Summarizing"},paused:{id:"dictation.transcriptionBlock.recordingButton.paused",defaultMessage:"Resume"}}),E=(0,c().YK)({thinking:{id:"dictation.transcriptionBlock.recordingButton.summarizing.thinking",defaultMessage:"Thinking"},summarizing:{id:"dictation.transcriptionBlock.recordingButton.summarizing.summarizing",defaultMessage:"Summarizing"}}),P=(0,c().YK)({resume:{id:"dictation.transcriptionBlock.recordingButton.resume",defaultMessage:"Resume"}}),N=(0,c().YK)({noPermissionTooltip:{id:"dictation.transcriptionBlock.recordingButton.noPermissionTooltip",defaultMessage:"You do not have permission to transcribe"},transcriptionDisabledTooltip:{id:"dictation.transcriptionBlock.recordingButton.transcriptionDisabledTooltip",defaultMessage:"AI Meeting Notes is not available in this workspace"},offlineTooltip:{id:"dictation.transcriptionBlock.recordingButton.offlineTooltip",defaultMessage:"You must be online to start transcribing"},stopButtonTooltip:{id:"dictation.transcriptionBlock.recordingButton.stopButtonTooltip",defaultMessage:"Stop and summarize"},stopOfflineButtonTooltip:{id:"dictation.transcriptionBlock.recordingButton.stopOfflineButtonTooltip",defaultMessage:"Stop"}});function L(e,t,n){return t?e?n?void 0:(0,R.jsx)(c().sA,{...N.transcriptionDisabledTooltip}):(0,R.jsx)(c().sA,{...N.noPermissionTooltip}):(0,R.jsx)(c().sA,{...N.offlineTooltip})}function q(e){let{isOnline:t,store:n}=e;const i=(0,o().v3)(),s=(0,B().Z)(n),a=(0,_().d)({store:n}),l=(0,C().W)(),u=!a||!t||!l,p=l&&a,m=(0,I().x)({environment:i,isOnline:t,canUse:p,state:s}),g=(0,M().X)({environment:i,isOnline:t,canUse:p,state:s}),v=(0,r().K8)((()=>D().c.getIsLoading(n.id)),[n.id]),h=(0,o().Y0)(),S=(0,r().K8)((()=>{if(A().default.checkGate({gateName:"enable_transcription_on_browser_for_debug_enabled"}))return!0}),[]);return v?(0,R.jsx)(H,{disabled:!a,icon:(0,R.jsx)(f().A,{}),text:(0,R.jsx)(c().sA,{id:"transcriptionBlockControlButton.stopWhenLoading",defaultMessage:"Stop"}),onClick:()=>{(0,x().stopTranscription)({environment:i,blockStore:n,from:"stop_button"})}}):S||(0,T().b8)(h)||"initial"!==s.state&&"paused"!==s.state?"idle"===s.state?null:"transcribing"===s.state?(0,R.jsx)(H,{isActive:!0,disabled:!a,icon:(0,R.jsx)(Y,{disabled:!a}),text:(0,R.jsx)(c().sA,{...j.transcribing}),tooltipMessage:l?a?t?(0,R.jsx)(c().sA,{...N.stopButtonTooltip}):(0,R.jsx)(c().sA,{...N.stopOfflineButtonTooltip}):(0,R.jsx)(c().sA,{...N.noPermissionTooltip}):(0,R.jsx)(c().sA,{...N.transcriptionDisabledTooltip}),onClick:()=>{const e={environment:i,blockStore:n,from:"stop_button"};t?(0,x().stopTranscription)(e):(0,x().pauseTranscription)({...e,shouldStopDictation:!0})}}):"summarizing"===s.state?(0,R.jsx)(K,{state:s}):"paused"===s.state?(0,R.jsx)(H,{disabled:u,icon:(0,R.jsx)(V,{disabled:u}),text:(0,R.jsx)(c().sA,{...P.resume}),tooltipMessage:L(a,t,l),onClick:()=>{(0,x().startTranscription)({environment:i,blockStore:n,from:"resume"})}}):m?(0,R.jsx)(F,{}):g?(0,R.jsx)(O,{}):"initial"===s.state?(0,R.jsx)($,{disabled:u,store:n,tooltipMessage:L(a,t,l)}):(0,d().HB)(s):(0,R.jsx)(W,{disabled:u,tooltipMessage:L(a,t,l)})}function F(){const e=(0,i.useCallback)((()=>{D().c.setHasAckedNux(!0)}),[]);return(0,R.jsx)(g().A,{onClick:e,children:(0,R.jsx)(c().sA,{id:"transcriptionBlockControlButton.nux.startButton",defaultMessage:"Start AI Meeting Notes"})})}function O(){return(0,R.jsxs)(h().Ye,{gap:6,children:[(0,R.jsx)(U,{}),(0,R.jsx)(z,{})]})}function U(){const e=(0,o().v3)(),t=(0,i.useCallback)((()=>{D().c.setHasAckedCalendarNux(!0),(0,S().u4)({environment:e,event:{eventName:"transcription_calendar_nux_dismissed",eventProperties:{}}})}),[e]);return(0,R.jsx)(p().p,{onClick:t,children:(0,R.jsx)(c().sA,{id:"transcriptionBlockControlButton.calendarNux.dismiss",defaultMessage:"Dismiss"})})}function z(){const e=(0,o().v3)(),t=(0,r().O$)(k().AppStoreCurrentSpaceStore),n=(0,i.useCallback)((()=>{(0,b().Op)({environment:e,spaceStore:t,collectionViewStore:void 0,from:"transcriptionBlockCalendarNux"}),D().c.setHasAckedCalendarNux(!0)}),[e,t]);return(0,R.jsx)(g().A,{onClick:n,children:(0,R.jsx)(c().sA,{id:"transcriptionBlockControlButton.calendarNux.connect",defaultMessage:"Connect Calendar"})})}function W(e){const{disabled:t,tooltipMessage:n}=e,i=(0,o().v3)(),r=(0,s().IS)((e=>({icon:{width:16,height:16,borderRadius:"50%",fill:t?e.icon.tertiary:void 0}})),[t]);return(0,R.jsx)(H,{disabled:t,icon:(0,a().arrowDiagonalUpRightIcon)(r.icon),text:(0,R.jsx)(c().sA,{id:"transcriptionBlockControlButton.missingRequirement.openDesktopApp",defaultMessage:"Launch desktop app"}),tooltipMessage:n||(0,R.jsx)(c().sA,{id:"transcriptionBlockControlButton.missingRequirement.appRequiredTooltip",defaultMessage:"AI meeting transcription is not available on browser yet."}),onClick:()=>{(0,w().MZ)(i)}})}function $(e){const{store:t,disabled:n,tooltipMessage:r}=e,s=(0,o().v3)(),a=(0,i.useCallback)((()=>{(0,x().startTranscription)({environment:s,blockStore:t,from:"consent_affirmed"}),(0,S().u4)({environment:s,event:{eventName:"transcription_consent_affirmed",eventProperties:{block_id:t.id}}})}),[s,t]);return(0,R.jsx)(H,{disabled:n,icon:(0,R.jsx)(V,{disabled:n}),text:(0,R.jsx)(c().sA,{id:"transcriptionBlockControlButton.confirmConsent",defaultMessage:"Confirm consent"}),tooltipMessage:r,onClick:a})}function K(e){const{state:t}=e,n=(0,s().IS)((e=>({text:{fontSize:14,fontWeight:l().Wy.medium,color:e.text.tertiary}})),[]);return(0,R.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:6},children:[(0,R.jsx)(m().A,{isTriColored:!0}),(0,R.jsx)("span",{style:n.text,children:(0,R.jsx)(c().sA,{...E[t.step]})})]})}function H(e){const{icon:t,text:n,tooltipMessage:o,onClick:r,isActive:a,disabled:c}=e,[d,p]=(0,i.useState)(!1),m=function(e,t,n){return(0,s().IS)((i=>({container:{height:32,display:"flex",justifyContent:"center",alignItems:"center",gap:6,paddingTop:14,paddingBottom:14,paddingLeft:8,paddingRight:8,borderRadius:6,border:"none",cursor:n?"not-allowed":"pointer",background:t?i.tint.uiRed:i.fill.lightGrayPrimary},hoveredStyle:n?{background:t?i.tint.uiRedHover:i.tint.uiRed}:{},text:{fontSize:14,color:n?i.text.tertiary:e||t?i.text.uiRedPrimary:i.text.primary,fontWeight:l().Wy.medium}})),[e,t,n])}(d,a,c),f=e=>{const i={onClick:r};return c||(i.onMouseEnter=()=>p(!0),i.onMouseLeave=()=>p(!1)),(0,R.jsxs)(u().A,{...(0,y().A)(e,i),style:m.container,hoveredStyle:m.hoveredStyle,disabled:c,children:[t,(0,R.jsx)("span",{style:m.text,children:n})]})};return o?(0,R.jsx)(v().A,{render:e=>f(e),renderTooltip:()=>o}):f({})}function V(e){let{disabled:t}=e;const n=(0,s().IS)((e=>({icon:{width:12,height:12,borderRadius:"50%",backgroundColor:t?e.icon.tertiary:e.icon.uiRedPrimary}})),[t]);return(0,R.jsx)("div",{style:n.icon})}function Y(e){let{disabled:t}=e;const n=(0,s().IS)((e=>({icon:{width:12,height:12,borderRadius:3,backgroundColor:t?e.icon.tertiary:e.icon.uiRedPrimary}})),[t]);return(0,R.jsx)("div",{style:n.icon})}},486338:(e,t,n)=>{n.d(t,{Z:()=>r});var i=()=>n(803290),o=()=>n(950347);function r(e){return(0,i().K8)((()=>(0,o().by)(e)),[e])}},486588:(e,t,n)=>{n.d(t,{d:()=>i});const i=new(n(380123).R)({key:"preferred_audio_input_device",namespace:n(146325).cd,important:!0,trackingType:"preference"})},498348:(e,t,n)=>{n.r(t),n.d(t,{getActiveTranscriptionBlockStore:()=>o});var i=()=>n(210562);function o(){const e=i().ei.state;if(null!=e&&e.isTranscriptionBlock())return e}},625083:(e,t,n)=>{n.d(t,{A:()=>o});class i extends(()=>n(129044))().default{constructor(){super()}getInitialState(){}}const o=new i},642662:(e,t,n)=>{n.d(t,{d:()=>a});var i=()=>n(237385),o=()=>n(556078),r=()=>n(803290),s=()=>n(944498);function a(e){const{store:t}=e,n=(0,i().v3)(),a=(0,o().S)(),c=(0,r().K8)((()=>null==a?void 0:a.publicEditModeStore.state),[a]);return(0,r().K8)((()=>(0,s().p2L)({environment:n,blocks:[t],publicEditMode:c})),[n,t,c])}},649833:(e,t,n)=>{n.r(t),n.d(t,{AudioSessionBlockWriter:()=>W,DictationManager:()=>Z,StreamingDictationManager:()=>ne,smartToggleDictation:()=>G,startDictation:()=>J,stopDictation:()=>Q,updateActiveBlocks:()=>ee});n(610931),n(358848),n(362833),n(153350),n(1759),n(211883),n(91270),n(175799),n(778020),n(234093),n(52950),n(914784),n(545159),n(117826),n(725707),n(107652),n(491955),n(500234),n(771702),n(403517);var i=()=>n(762847),o=()=>n(502140),r=()=>n(34662),s=()=>n(496580),a=()=>n(725155),c=()=>n(704082),d=()=>n(450475),l=()=>n(76394),u=()=>n(795394),p=()=>n(759625),m=()=>n(448316),f=()=>n(384221),g=()=>n(84543),v=()=>n(952602),h=()=>n(162450),S=()=>n(189170),y=()=>n(782422),b=()=>n(459742),k=()=>n(477784),A=()=>n(378219),x=()=>n(485966),w=()=>n(638907),T=()=>n(692079);class _{constructor(e,t){this.id=void 0,this.text=void 0,this.isCompleteReceived=void 0,this.transcriptions=void 0,this.id=e,this.isCompleteReceived=Boolean(t),this.transcriptions=new Map}updateText(){let e;for(const t of this.transcriptions.values()){if("pending"===t.status)break;"complete"===t.status&&(e=t.text)}this.text=e}setTranscription(e,t){this.transcriptions.set(e,t),this.updateText()}setIsCompleteReceived(e){!this.isCompleteReceived&&e&&(this.isCompleteReceived=!0)}getId(){return this.id}getText(){return this.text}isSettled(){return this.isCompleteReceived&&this.transcriptions.values().every((e=>"pending"!==e.status))}}var M=()=>n(604322),I=()=>n(722174),C=()=>n(775041);function B(e){let t;const n=[];for(const o of e.segments){var i;const r=o.getText();if(!r)continue;const s=o.isSettled()||e.forceSettled||!1;(null===(i=t)||void 0===i?void 0:i.settled)!==s?(t&&n.push(t),t={text:r,settled:s,segmentId:o.getId()}):t.text=`${t.text} ${r}`}return t&&n.push(t),n.length>0&&e.indent&&(n[0].text=` ${n[0].text}`),n}n(113085);function D(e){return!!(0,r().BEe)(e)&&e[1].some(r().Si1)}const R=/([\?\!\.])\s/;function j(e){const t=e.split(R);for(let n=1;n<t.length;n++){const e=t[n];[".","?","!"].includes(e)&&(t[n-1]+=e,t[n]="")}return t.filter((function(e){return void 0!==e&&""!==e}))}var E,P=()=>n(950347),N=()=>n(258555),L=()=>n(210562),q=()=>n(196940),F=()=>n(76239);const O=[];function U(e){O.push(e)}class z{constructor(){this.segments=void 0,this.segments=new Map}setSegment(e){this.segments.set(e.getId(),e)}getSegment(e){return this.segments.get(e)}getSegments(){return this.segments.values()}deleteSegment(e){this.segments.delete(e)}isSettled(){return this.getSegments().every((e=>e.isSettled()))}}class W{constructor(e){this.id=void 0,this.env=void 0,this.isCompleteReceived=void 0,this.blockStore=void 0,this.onUpdateBlock=void 0,this.segmentManager=void 0;const{id:t,env:n,blockStore:i,onUpdateBlock:o}=e;this.id=t,this.env=n,this.isCompleteReceived=!1,this.blockStore=i,this.onUpdateBlock=o,this.segmentManager=new z}getOrCreateSegment(e){const t=this.segmentManager.getSegment(e);if(t)return t;const n=new _(e);return this.segmentManager.setSegment(n),n}getBlockStore(){return this.blockStore}setBlockStore(e){var t;this.blockStore=e,null===(t=this.onUpdateBlock)||void 0===t||t.call(this,e)}addInsertEvent(e){}addDeleteEvent(e){}setIsCompleteReceived(e){!this.isCompleteReceived&&e&&(this.isCompleteReceived=!0)}getId(){return this.id}isSettled(){return this.isCompleteReceived&&this.segmentManager.isSettled()}writeToBlock(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.blockStore.getParentBlockStore();if(!this.blockStore.isDictatableBlock()||!t)return;let n=!1;const i=[],o=[];for(const r of[...this.segmentManager.getSegments()])n||!e&&!r.isSettled()?(n=!0,o.push(r)):(i.push(r),this.segmentManager.deleteSegment(r.getId()));g().createAndCommit({userAction:"dictationActions.writeToBlock",environment:this.env,canUndo:!1,perform:n=>{let s,a=0;const c=this.blockStore.getBlockTitleStore(),d=(0,r().ooo)(c.getValue());for(let e=0;e<d.length;e++){if(D(d[e])){s=e;break}a+=(0,r().WWE)(d[e])}if(void 0!==s){if(0===i.length){const t=function(e){const{tokens:t,...n}=e,i=B(n);return i.length===t.length&&i.every(((e,n)=>{let{text:i,settled:o}=e;const s=t[n];return!(D(s)?o:!o)&&i===(0,r().N8A)(s)}))}({segments:o,tokens:d.slice(s),forceSettled:e,indent:a>0});if(t)return}this.addDeleteEvent({transactionId:n.id,index:a}),m().jQ({environment:this.env,store:c,selection:{startIndex:a,endIndex:1/0},transaction:n,updateSelection:!1})}const l=function(e){const{text:t,maxLength:n=1/0,initialLength:i=0}=e;if(0===n)throw new Error("Max length must be >0");let o=i,r="";const s=[];for(const a of t)r=""===r?a:`${r} ${a}`,o=r.length,o>=n&&(s.push(r),r="",o=0);return r&&s.push(r),s}({text:j(V([...i.values()])),initialLength:a,maxLength:250});for(const e of l){const i=a>0?` ${e}`:e;if(this.addInsertEvent({location:"combined settled segments",transactionId:n.id,index:a,text:i,settled:!0}),H({environment:this.env,audioSessionId:this.id,blockStore:this.blockStore,index:a,transcriptions:[{text:i,settled:!0}],transaction:n}),a+=i.length,a>250){const e=K({environment:this.env,parentBlockStore:t,siblingBlockStore:this.blockStore,transaction:n});this.setBlockStore(e),a=0}}const u=B({segments:o,forceSettled:e,indent:a>0});0!==u.length&&(u.forEach((e=>{let{text:t,settled:i}=e;this.addInsertEvent({text:t,settled:i,index:a,transactionId:n.id,location:"post-insert segments"})})),H({environment:this.env,audioSessionId:this.id,blockStore:this.blockStore,index:a,transcriptions:u,transaction:n}))}})}}function $(e){return g().createAndCommit({userAction:"dictationActions.createDictationBlock",environment:e.environment,canUndo:!1,perform:t=>K({...e,transaction:t})})}function K(e){var t,n;const{environment:o,parentBlockStore:r,siblingBlockStore:s,transaction:a}=e,c=(null==s?void 0:s.getDictationRoleModel())??i().xd.text,d=null===(t=L().ei.state)||void 0===t?void 0:t.isTranscriptionBlock();if(o.device.isMobile&&!d&&!r.isTranscriptionBlock()){const e=S().insertBlockBelow({environment:o,selection:s?[s]:[],createBlockItem:b().ry[c],transaction:a,analyticsFrom:"dictation",preventSetSelection:!0});return f().setSelectionAtEnd({store:e.getBlockTitleStore()}),e}const l=r.isTranscriptionBlock()?null===(n=r.getContentStores().find((e=>{const t=r.getFormat().transcription_transcript_id;return e.id===t})))||void 0===n?void 0:n.getContentStore():r.getContentStore();if(!l)throw new Error("No parent dictation content store found");const m=p().Wv({environment:o,type:c,inMemoryRecordCache:r.inMemoryRecordCache,transaction:a});return u().NI({parentStore:l,childStore:w().B.createChildStore(l,m.pointer),after:null==s?void 0:s.id,transaction:a}),m}function H(e){var t;const{environment:n,audioSessionId:i,blockStore:o,index:s,transcriptions:a,transaction:c}=e;if(!o.isDictatableBlock())return;const d=[],l=a.filter((e=>Boolean(e.text)));for(const[p,m]of l.entries()){const{text:e,settled:t}=m,n=p===l.length-1?e:`${e} `,o=t?(0,r().Ey_)(n):(0,r().Ey_)(n,[(0,r().lf7)(M().h5,i,m.segmentId)]);d.push(o)}m().yr({environment:n,index:s,store:o.getBlockTitleStore(),tokens:d,transaction:c,updateSelection:!1});const u=null===(t=L().ei.state)||void 0===t?void 0:t.isTranscriptionBlock();n.device.isMobile&&!u&&f().setSelectionAtEnd({store:o.getBlockTitleStore()})}function V(e){return e.map((e=>e.getText())).filter((e=>Boolean(e))).join(" ").trim()}function Y(e){return new Promise(((t,n)=>{try{const i=new Blob(e),o=new FileReader;o.readAsDataURL(i),o.onloadend=()=>{var e;const i=null===(e=o.result)||void 0===e?void 0:e.toString().split(",")[1];i?t(i):n(new Error("No base64Audio"))}}catch(i){n(i)}}))}function X(e,t,n){if((0,l().O9)(n)&&!n.pathIsDead()&&n.id!==t.id){const i=(0,A().Nq)(t),o=(0,A().Nq)(n);if((0,l().O9)(i)&&(0,l().O9)(o)&&i.id===o.id){const i=(0,A().g7)(n);if((()=>{for(const e of i)if(e instanceof w().B){if(e.id===t.id)return!0;if(e.id===o.id)return!1}return!1})()){const t=n.getParentBlockStore();if(n.isEmptyDictatableBlock()&&[...L().Ay.state.audioSessionBlockWriters.values()].every((e=>e.getBlockStore().id!==n.id)))return n;if(t)return $({environment:e,parentBlockStore:t,siblingBlockStore:n}).performResult}}}return $({environment:e,parentBlockStore:t}).performResult}class Z{static async getAllProcessableFramesAsBase64(e){const t=16*Math.max(1,e),n=Math.floor(this.audioBuffer.length/t);if(n>0){const e=n*t,i=this.audioBuffer.slice(0,e);return this.audioBuffer=this.audioBuffer.slice(e),this.audioEncoderQueue.enqueue((()=>Y([i])))}return!1}static getDictationAudioRecorder(e){const{environment:t,includeSystemAudio:n,blockStore:i}=e,r=L().Ay.state.audioRecorder;return r?(r.stop(),r):new(C().Nr)({onDataReceived:n=>{L().gZ.state&&(this.audioBuffer=new Float32Array([...this.audioBuffer,...n]),this.getAllProcessableFramesAsBase64(96).then((n=>{if(n){const r=(0,q().$q)((0,q().FT)(t.currentUser.id));(0,v().$g)({base64Audio:n,environment:t,language:r}).catch((e=>{o().log({level:"error",from:"dictationActions",type:"sendAudioDataFailed",error:(0,d().convertErrorToLog)(e),data:{miscDataToConvertToString:{rootBlockId:i.id}}})}));const s=L().ei.state;if(s&&s.isTranscriptionBlock()){"transcribing"!==(0,P().by)(s).state&&Q({environment:e.environment,from:"transcription_block_stopped"})}}})).catch((e=>{o().log({level:"error",from:"dictationActions",type:"audioRecorderFailed",error:(0,d().convertErrorToLog)(e),data:{miscDataToConvertToString:{rootBlockId:i.id}}})})))},onStop:e=>{e&&o().log({level:"error",from:"dictationActions",type:"audioRecorderStopped",error:(0,d().convertErrorToLog)(e),data:{miscDataToConvertToString:{rootBlockId:i.id}}}),Q({environment:t,error:e,from:"audio_recorder_stopped"})},includeSystemAudio:n})}static get dictationIsActive(){return Boolean(this.startController&&!this.startController.signal.aborted)}static async smartToggleDictation(e){var t;const n=(0,y().ao)();return this.dictationIsActive&&(null===(t=L().Ay.state.rootBlock)||void 0===t?void 0:t.id)===(null==n?void 0:n.id)?this.stopDictation(e):this.startDictation(e)}static async startDictation(e){const{environment:t,blockStore:i,from:r}=e,a=i??(0,y().ao)(),l=null==a?void 0:a.isTranscriptionBlock();try{await this.stopDictation({environment:t,from:r}),this.startController=new AbortController;const i=this.startController.signal;let m;if(L().Ay.setState({...L().Ay.state,environment:t,tabId:t.device.isElectron?n(714013).A.state.currentTab.id:void 0,loading:!0}),e.preCreateDictationBlock&&a){const{performResult:e}=$({environment:t,parentBlockStore:a});m=e,await n(752597).default.afterNextFlush((()=>{f().setSelectionAtStart({store:e.getBlockTitleStore()})}))}const g=(0,v().qY)();(0,T().uB)(t,{dictation_session_id:g,from:r});if(!((null==a?void 0:a.isPageBlock())||(null==a?void 0:a.isCollectionViewPageWithContent())||l)||!(0,n(150968).h)()&&!(0,n(944498).xIn)())throw new Error("Target is not dictatable.");const S=this.getDictationAudioRecorder({...e,blockStore:a});te.start();try{var u;await S.start();const e=N().Ay.state;if(N().Ay.setState({...e,audio:N().a3}),i.aborted)throw new Error("start dictation aborted");const o=l?null===(u=a.getContentStores().find((e=>e.id===a.getFormat().transcription_transcript_id)))||void 0===u?void 0:u.getContentStores().at(-1):n(182613).default.state.stores.slice(-1).pop();await(0,h().Ez)(t),L().Ay.setState({...L().Ay.state,audioRecorder:S,enabled:!0,talking:!1,rootBlock:a,block:m??X(t,a,o),lastReceivedTranscriptionAt:Date.now()}),(0,h().rJ)({environment:t,rootBlockId:(0,s().o9)(null==a?void 0:a.id)}),(0,h().UC)((()=>{(0,h().rJ)({environment:t,rootBlockId:(0,s().o9)(null==a?void 0:a.id)})})),(0,T().D_)(t,{dictation_session_id:g,block_id:a.id})}catch(p){if(!i.aborted)try{const{audio:n}=await N().Ay.checkPermissions(e.includeSystemAudio);(0,T().rP)(t,{type:"mic_permissions",dictation_session_id:g,reason:n})}catch(p){o().log({level:"error",from:"dictationActions",type:"checkPermissionsFailed",error:(0,d().convertErrorToLog)(p),data:{miscDataToConvertToString:{dictationSessionId:g,rootBlockId:a.id}}})}if(S.destroy((0,c().A)(p)),l){const{audio:t,screenRecording:n}=await N().Ay.checkPermissions(e.includeSystemAudio);throw o().log({level:"error",from:"dictationActions",type:"dictationFailedToStart",error:(0,d().convertErrorToLog)(p),data:{miscDataToConvertToString:{dictation_session_id:g,transcription_id:a.id,audioPermissions:t,screenRecordingPermissions:n}}}),p}}}catch(p){if(this.stopDictation({environment:t,from:"start_transcription_error",error:(0,c().A)(p)}),l)throw p}finally{L().Ay.setState({...L().Ay.state,loading:!1})}}static async stopDictation(e){const t=L().Ay.state.rootBlock;if((0,h().lW)(),this.startController&&!this.startController.signal.aborted){this.startController.abort();const{environment:r,error:s,from:a}=e,c=(0,v().qY)();(0,T().E_)(r,{dictation_session_id:c,from:a});const l=L().Ay.state.tabId;function u(e){const{canRestart:i,name:o,title:s,message:a,notificationBody:c}=e;null!=t&&t.isTranscriptionBlock()&&(n(437071).pushToastInMainTab({toastId:"transcription_error",pointer:t.pointer,tabId:l,title:s,message:a,name:o,canRestart:i}),(0,n(885218).sendNotificationForDictationInterrupted)({environment:r,blockStore:t,title:s,message:c||a,canRestart:i&&(null==t?void 0:t.isTranscriptionBlock()),tabId:l}))}const p=L().Ay.state.audioRecorder,m=L().Ay.state.enabled;L().Ay.setState({...L().Ay.state,audioRecorder:void 0,enabled:!1,loading:!1,rootBlock:void 0,block:void 0,tabId:void 0,lastReceivedTranscriptionAt:void 0}),null==p||p.destroy(s),s&&(o().log({level:"error",from:"dictationActions",type:"dictationError",error:(0,d().convertErrorToLog)(s),data:{miscDataToConvertToString:{dictation_session_id:c,block_id:(null==t?void 0:t.id)??""}}}),s instanceof I().XG?((0,T().rP)(r,{type:"throttle",dictation_session_id:c}),(0,F().displayDictationUsageErrorSnackbar)()):s instanceof I().eY?((0,T().rP)(r,{type:"missing_user_or_space",dictation_session_id:c,reason:s.message}),(0,F().displayDictationGenericErrorSnackbar)()):s instanceof I().d1?((0,T().rP)(r,{type:"mic_permissions",dictation_session_id:c,reason:N().Ay.state.audio}),(0,F().displayDictationPermissionSnackbar)(M().JS)):s instanceof I().Rv?((0,T().rP)(r,{type:"forbidden",dictation_session_id:c}),u({canRestart:!1,name:s.name,title:k().A.intl.formatMessage({id:"dictationActions.stopDictation.error.forbidden.title",defaultMessage:"Unable to transcribe"}),message:k().A.intl.formatMessage({id:"dictationActions.stopDictation.error.forbidden.message",defaultMessage:"You do not have permission to run transcription."})})):s instanceof I().E6?u({canRestart:!0,name:s.name,title:k().A.intl.formatMessage({id:"dictationActions.stopDictation.error.openAI.title",defaultMessage:"Transcription paused"}),message:k().A.intl.formatMessage({id:"dictationActions.stopDictation.error.openAI.message",defaultMessage:"We are experiencing high demand. Please wait and try again."}),notificationBody:k().A.intl.formatMessage({id:"dictationActions.stopDictation.error.openAI.notification",defaultMessage:"We are experiencing high demand. Please wait and click to resume."})}):s instanceof Error&&u({canRestart:!0,name:s.name,title:k().A.intl.formatMessage({id:"dictationActions.stopDictation.error.general.title",defaultMessage:"Transcription paused"}),message:k().A.intl.formatMessage({id:"dictationActions.stopDictation.error.general.message",defaultMessage:"Something went wrong. Please try again."}),notificationBody:k().A.intl.formatMessage({id:"dictationActions.stopDictation.error.general.notification",defaultMessage:"Something went wrong. Please click to resume."})}));try{await(0,h().Ep)(r)}catch(i){}finally{te.stop();const f=L().Ay.state.audioSessionBlockWriters;let g=!1;for(const S of f.values())S.writeToBlock(!0),f.delete(S.getId()),g=!0;g&&L().Ay.emit(),m&&(0,T().Im)(r,{dictation_session_id:c,block_id:(null==t?void 0:t.id)??""}),null!=t&&t.isTranscriptionBlock()&&e.environment&&n(848105).transcriptionBlockActions.ensureTranscriptionIsInActive({environment:e.environment,blockStore:t,from:e.from})}}}}async function G(e){return Z.smartToggleDictation(e)}async function J(e){return Z.startDictation(e)}async function Q(e){const{environment:t,error:n,from:i}=e;return Z.stopDictation({environment:t,error:n,from:i})}async function ee(e){const t=x().default.state.currentSpaceStore;if(!t)return;const n={};for(const o of e){var i;const e=o.pointer,r=w().B.createChildStore(t,e);if(await r.load(),!r.isTranscriptionBlock()||r.id===(null===(i=L().Ay.state.rootBlock)||void 0===i?void 0:i.id))continue;const s=(0,P().y1)(r,"transcript");if(!s)continue;await s.load();const a=s.getContentStores().at(-1);a&&(await a.load(),n[e.id]={rootBlockStore:r,dictatingBlockStore:a})}L().Ay.setState({...L().Ay.state,passiveBlockMap:{...L().Ay.state.passiveBlockMap,...n}})}Z.startController=void 0,Z.audioBuffer=new Float32Array,Z.audioEncoderQueue=new(a().O)(1);class te{constructor(){if(te.instance)return te.instance;te.instance=this}static start(){U({type:"start",ts:new Date}),this.listening||(this.listening=!0,h().$I.on(h().Ux,te.processTranscriptionResult),h().$I.on(h().L6,te.processVadEvent),h().$I.on(h().bH,te.processRateLimitEvent),h().$I.on(h().zz,te.processForbiddenEvent),h().$I.on(h().ZQ,te.processOpenAIErrorEvent))}static stop(){U({type:"end",ts:new Date}),this.listening&&(this.listening=!1,h().$I.off(h().Ux,te.processTranscriptionResult),h().$I.off(h().L6,te.processVadEvent),h().$I.off(h().bH,te.processRateLimitEvent),h().$I.off(h().zz,te.processForbiddenEvent),h().$I.off(h().ZQ,te.processOpenAIErrorEvent))}static processOpenAIErrorEvent(e){if(429===e.status||503===e.status){var t;const{environment:n}=L().Ay.state;n&&Q({environment:n,error:new(I().E6)(e.message,e.status),from:"transcription_error"}),o().log({level:"error",from:"dictationActions",type:"openAIError",error:(0,d().convertErrorToLog)(e),data:{miscDataToConvertToString:{rootBlockId:null===(t=L().Ay.state.rootBlock)||void 0===t?void 0:t.id}}})}}static processForbiddenEvent(e){var t;const{environment:n}=L().Ay.state;n&&Q({environment:n,error:new(I().Rv)("Not eligible for dictation"),from:"forbidden"}),o().log({level:"error",from:"dictationActions",type:"forbidden",error:(0,d().convertErrorToLog)(e),data:{miscDataToConvertToString:{rootBlockId:null===(t=L().Ay.state.rootBlock)||void 0===t?void 0:t.id}}})}static processRateLimitEvent(e){var t;const{environment:n}=L().Ay.state;n&&Q({environment:n,error:new(I().XG)("Audio usage limit reached"),from:"rate_limit"}),o().log({level:"error",from:"dictationActions",type:"rateLimit",error:(0,d().convertErrorToLog)(e),data:{miscDataToConvertToString:{rootBlockId:null===(t=L().Ay.state.rootBlock)||void 0===t?void 0:t.id}}})}static processVadEvent(e){L().Ay.setState({...L().Ay.state,talking:e.talking})}static updateDictationBlock(e){L().Ay.setState({...L().Ay.state,block:e})}static processTranscriptionResult(e){const{audioSessionId:t,segmentId:i,isSegmentComplete:o,isAudioSessionComplete:r}=e,{enabled:s,rootBlock:a,audioSessionBlockWriters:c,environment:d,block:l}=L().Ay.state;"complete"===e.transcription.status&&null!=a&&a.isTranscriptionBlock()&&d&&(0,n(11639).u)({environment:d,event:{eventName:"meeting_note_transcription_received",eventProperties:{block_id:a.id,audio_duration:e.transcription.audioDuration,text_length:e.transcription.text.length}}});let u=!1;if(!c.has(t)&&d&&s){const e=a?X(d,a,l):void 0;if(e){const n=new W({id:t,env:d,blockStore:e,onUpdateBlock:e=>{t===L().Ay.state.latestSessionId&&te.updateDictationBlock(e)}});c.set(t,n),u=!0,L().Ay.setState({...L().Ay.state,block:e,latestSessionId:t})}else Q({environment:d,from:"block_not_available"})}const p=c.get(t);if(p){p.setIsCompleteReceived(r);const t=p.getOrCreateSegment(i);t.setIsCompleteReceived(o),t.setTranscription(e.transcription.id,e.transcription)}for(const n of c.values())n.writeToBlock();for(const n of[...c.values()].filter((e=>e.isSettled())))c.delete(n.getId()),u=!0,s&&d&&a&&L().Ay.state.latestSessionId===n.getId()&&L().Ay.setState({...L().Ay.state,block:X(d,a,L().Ay.state.block)});s&&L().Ay.setState({...L().Ay.state,lastReceivedTranscriptionAt:Date.now()}),u&&L().Ay.emit()}}te.instance=void 0,te.listening=!1;class ne{static getAllProcessableFramesAsBase64(e){const t=16*Math.max(1,e),n=Math.floor(this.audioBuffer.length/t);if(n>0){const e=n*t,i=this.audioBuffer.slice(0,e);return this.audioBuffer=this.audioBuffer.slice(e),this.audioEncoderQueue.enqueue((()=>Y([i])))}return Promise.resolve(!1)}static async start(e){try{await this.stop(),this.startController=new AbortController,this.env=e.environment,this.isActive=!0,this.currentTranscript="",this.segments.clear(),this.transcriptionListener=e.onTranscription,this.onErrorListener=e.onError,this.streamingSessionId=(0,v().qY)(),this.audioRecorder=new(C().Nr)({onDataReceived:t=>{this.audioBuffer=new Float32Array([...this.audioBuffer,...t]),this.getAllProcessableFramesAsBase64(96).then((t=>{if(t){const n=(0,q().$q)((0,q().FT)(e.environment.currentUser.id));(0,v().$g)({base64Audio:t,environment:e.environment,language:n}).catch((()=>{}))}})).catch((()=>{}))},onStop:()=>{ne.stop()},includeSystemAudio:!1}),await this.audioRecorder.start(),h().$I.on(h().Ux,this.handleTranscriptionEvent)}catch(t){this.onErrorListener&&t instanceof Error&&this.onErrorListener(t),this.stop()}}static async stop(){if(this.isActive){var e;this.isActive=!1,this.startController&&!this.startController.signal.aborted&&this.startController.abort(),h().$I.off(h().Ux,this.handleTranscriptionEvent),null===(e=this.audioRecorder)||void 0===e||e.destroy();try{await(0,h().Ep)(this.env)}catch{}this.audioRecorder=void 0,this.streamingSessionId=void 0,this.env=void 0}}}E=ne,ne.startController=void 0,ne.env=void 0,ne.audioBuffer=new Float32Array,ne.audioEncoderQueue=new(a().O)(1),ne.audioRecorder=void 0,ne.streamingSessionId=void 0,ne.isActive=!1,ne.transcriptionListener=void 0,ne.onErrorListener=void 0,ne.segments=new Map,ne.currentTranscript="",ne.handleTranscriptionEvent=e=>{var t;const n=e.segmentId;let i=E.segments.get(n);i||(i=new _(n),E.segments.set(n,i)),i.setIsCompleteReceived(e.isSegmentComplete),i.setTranscription(e.transcription.id,e.transcription);const o=V(Array.from(E.segments.values()));E.currentTranscript=o,null===(t=E.transcriptionListener)||void 0===t||t.call(E,E.currentTranscript)}},670896:(e,t,n)=>{n.d(t,{Z:()=>p});n(403517),n(242343);var i=()=>n(237385),o=()=>n(803290),r=()=>n(907867),s=()=>n(535906),a=()=>n(858023),c=()=>n(88271),d=()=>n(983050),l=()=>n(196940),u=n(163643);function p(e){const t=(0,i().v3)(),{parent:n}=e,p=(0,o().K8)((()=>Object.keys(r().Cu).indexOf((0,l().FT)(t.currentUser.id))),[t.currentUser.id]),m=[{key:"languages",render:e=>(0,u.jsx)(c().A,{...e,topBorder:0!==e.index}),items:(0,l().u1)().map((e=>{let[i,[o]]=e;const r={key:i,render:e=>(0,u.jsx)(s().A,{...e,title:o}),action:()=>{(0,l().Xy)(t,i),n.close()}};return r}))}];return(0,u.jsx)("div",{className:d().OLz,style:{display:"flex",flexDirection:"column",width:150},children:(0,u.jsx)(a().Ay,{type:a().Oh.Vertical,initialFocus:p,sections:m})})}},692079:(e,t,n)=>{n.d(t,{D_:()=>s,E_:()=>r,Im:()=>a,K_:()=>d,rP:()=>c,uB:()=>o});var i=()=>n(137476);function o(e,t){e&&i().vd(e,"dictation_modal_open",t)}function r(e,t){e&&i().vd(e,"dictation_modal_close",t)}function s(e,t){e&&i().vd(e,"dictation_start",t)}function a(e,t){e&&i().vd(e,"dictation_end",t)}function c(e,t){e&&i().vd(e,"dictation_error",t)}function d(e,t){e&&i().vd(e,"update_dictation_language",t)}},708920:(e,t,n)=>{n.d(t,{Gj:()=>o,RN:()=>a,vZ:()=>r});n(362833),n(725707),n(107652),n(491955),n(500234);var i=()=>n(486826);function o(e){const t=i().c9.fromMillis(e.startUnixTimestampMS),n=e.endUnixTimestampMS?i().c9.fromMillis(e.endUnixTimestampMS):void 0,o=i().c9.fromMillis(e.startOfWeekUnixTimestampMS),r=i().c9.fromMillis(e.endOfWeekUnixTimestampMS),s=t.startOf("day"),a=i().c9.max(o,s),c=Math.ceil(a.diff(o,"days").get("days"));let d=1;if(n){const e=n.endOf("day"),t=i().c9.min(r,e);d=Math.ceil(t.diff(a,"days").get("days"))}return{start:t,end:n,startOfWeek:o,endOfWeek:r,startColumn:c,columnCount:d}}function r(e){const t=(e.attendees||[]).filter((e=>!e.self&&!e.resource));return e.hasParticipants&&t.length>0&&t.every((e=>"declined"===e.responseStatus))}const s={upcomingMinsThreshold:10,startingMinsThreshold:5,startedMinsThreshold:15};function a(e){const t=e.filter((e=>{var t;if(!e.conferencing)return!1;return!function(e){if("declined"===e)return!0;return!1}((null===(t=e.attendees)||void 0===t?void 0:t.find((e=>e.self)))?e.responseStatus??"accepted":"accepted")&&!e.isAllDay}));if(0===t.length)return;const{upcomingMinsThreshold:n,startingMinsThreshold:o,startedMinsThreshold:r}=s,a=[],d=[],l=[],u=[],p=[];for(const s of t){if(s.isAllDay)continue;const e=c(s),t=i().c9.now(),m=e.start.diff(t,"minutes").minutes;m>=0&&m<=n?a.push(s):-m>=o?l.push(s):-m>=r?u.push(s):e.contains(t)?d.push(s):p.push(s)}return[...a,...l,...u,...d,...p][0]}function c(e){const t=i().c9.fromISO(e.start.dateTime,{zone:e.start.timeZone}),n=i().c9.fromISO(e.end.dateTime,{zone:e.end.timeZone});return i().IX.fromDateTimes(t,n)}},713807:(e,t,n)=>{n.d(t,{Vj:()=>s,ax:()=>a});n(725707),n(491955),n(403517),n(113085);var i=()=>n(486826);const o="",r="";function s(e){let{start:t,end:n,locale:s,timeZone:c}=e;const d=i().c9.fromISO(t),l=i().c9.fromISO(n),u=function(e){let{start:t,end:n}=e;const i=n.diff(t);if(i.as("hours")>12)return!0;const o=t.hour<12,r=n.hour<12;return o!==r}({start:d,end:l}),p=a({time:d,showAmPm:u,locale:s,timeZone:c}),m=a({time:l,showAmPm:!0,locale:s,timeZone:c});return`${p}${r}${o}${r}${m}`}function a(e){let{time:t,showAmPm:n,locale:o,timeZone:s}=e;const a=function(e){return i().c9.fromObject({hour:13}).setLocale(e).toLocaleParts(i().c9.TIME_SIMPLE).some((e=>"dayPeriod"===e.type))}(o),c=0!==t.minute||!a,d={...i().c9.TIME_SIMPLE,hour:"numeric",minute:c?"2-digit":void 0,timeZone:s};return a&&!n?t.setLocale(o).toLocaleParts(d).filter((e=>"dayPeriod"!==e.type)).map((e=>e.value.trim())).join(""):t.toLocaleString({...d,hour12:a},{locale:o}).replace(" ",r)}},722174:(e,t,n)=>{n.d(t,{E6:()=>d,Rv:()=>c,Tn:()=>s,XG:()=>a,Yh:()=>r,d1:()=>o,eY:()=>l});var i=()=>n(524118);class o extends i().WXf{constructor(e){super({level:"error",status:500,name:"DictationAudioRecorderFailedError",message:e||"Audio recorder failed",retryable:!1})}}class r extends i().WXf{constructor(){super({level:"error",status:500,name:"DictationSystemAudioFailedError",message:"System audio failed",retryable:!1})}}class s extends i().WXf{constructor(){super({level:"error",status:500,name:"DictationStartTimeoutError",message:"Dictation start timeout",retryable:!0})}}class a extends i().WXf{constructor(e){super({level:"error",status:429,name:"DictationRateLimitError",message:e||"Rate limit exceeded",retryable:!1})}}class c extends i().WXf{constructor(e){super({level:"error",status:403,name:"DictationForbiddenError",message:e||"Access forbidden",retryable:!1})}}class d extends i().WXf{constructor(e,t){super({level:"error",status:t&&(0,n(325283).Mh)(t)?t:500,name:"DictationOpenAIError",message:e,retryable:!0})}}class l extends i().WXf{constructor(e){super({level:"error",status:400,name:"DictationMissingUserOrSpaceError",message:e||"Missing user or space information",retryable:!1})}}},775041:(e,t,n)=>{n.d(t,{Nr:()=>d,Q:()=>c});n(725707),n(107652),n(500234),n(324989),n(771702),n(403517),n(153350),n(1759),n(211883),n(175799),n(778020),n(234093),n(52950),n(914784),n(545159),n(117826);class i{constructor(e,t){this._inputSampleRate=void 0,this._outputSampleRate=void 0,this._inputSampleRate=e,this._outputSampleRate=t}downsample(e){return this.downSampleAudioFrame(e,this._inputSampleRate,this._outputSampleRate)}downSampleAudioFrame(e,t,n){if(n===t||n>t)return e;const i=t/n,o=Math.round(e.length/i),r=new Float32Array(o);let s=0,a=0;for(;a<o;){const t=Math.round((a+1)*i);let n=0,o=0;for(;s<t&&s<e.length;)n+=e[s++],o++;r[a++]=n/o}return r}}var o=()=>n(722174),r=()=>n(795396),s=()=>n(100308),a=()=>n(486588);n(875472),n(76509),n(863754);const c="ms_change";class d{constructor(e){this._mediaStreams=void 0,this._emitter=void 0,this.recorder=void 0,this.onDataReceived=void 0,this.onStop=void 0,this.startController=void 0,this._includeSystemAudio=void 0,this.handleDeviceChange=async()=>{var e;const t=null===(e=this.mediaStreams)||void 0===e||null===(e=e.flatMap((e=>e.getAudioTracks())))||void 0===e||null===(e=e.map((e=>e.getSettings())))||void 0===e?void 0:e.find((e=>void 0!==e)),i=this.getPreferredOrDefaultDevice();if(!t||i&&(i.deviceId!==t.deviceId||i.groupId!==t.groupId)){this.stop({triggerOnStop:!1});try{await this.start()}catch(o){this.destroy((0,n(704082).A)(o))}}},this._emitter=(0,n(504639).A)(),this.recorder=new l,this.onDataReceived=e.onDataReceived,this.onStop=e.onStop,this._includeSystemAudio=e.includeSystemAudio}get emitter(){return this._emitter}set mediaStreams(e){if(this._mediaStreams)for(const n of this._mediaStreams)for(const e of n.getTracks())e.stop();for(const i of e??[])for(const e of i.getTracks())e.addEventListener("ended",(async()=>{if(i.getTracks().every((e=>"ended"===e.readyState))){"denied"===(await n(258555).Ay.checkPermissions(this._includeSystemAudio)).audio&&this.stop({triggerOnStop:!0,error:new(o().d1)("Audio permission denied")})}}));for(const i of e??[]){var t;const e=null==i||null===(t=i.getAudioTracks()[0])||void 0===t?void 0:t.getSettings();n(625083).A.setState(s().X8.state.find((t=>t.deviceId===(null==e?void 0:e.deviceId))))}this._mediaStreams=e,this._emitter.emit(c)}get mediaStreams(){return this._mediaStreams}getPreferredOrDefaultDevice(){var e;return(null===(e=s().X8.state)||void 0===e?void 0:e.find((e=>{var t;return e.deviceId===(null===(t=a().d.state)||void 0===t?void 0:t.deviceId)})))??s().X8.state[0]}async start(){if(void 0===this.startController||this.startController.signal.aborted){this.startController=new AbortController;const t=this.startController.signal,i=this.getPreferredOrDefaultDevice(),c=(0,r().E)(),d=await c.getUserMedia({audio:{deviceId:i?{exact:i.deviceId}:void 0,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,channelCount:1}});if(await s().Ay.updateMediaDevices(),this._includeSystemAudio)try{const e=await c.getDisplayMedia({audio:!0,systemAudio:this._includeSystemAudio?"include":void 0});this.mediaStreams=[d,e]}catch(e){throw n(502140).log({level:"error",from:"audioRecorderHelpers",type:"getDisplayMediaFailed",error:(0,n(450475).convertErrorToLog)(e),data:{miscDataToConvertToString:{includeSystemAudio:this._includeSystemAudio}}}),new(o().Yh)}else this.mediaStreams=[d];if(t.aborted){for(const e of this.mediaStreams??[])for(const t of e.getTracks())t.stop();return}if(await this.recorder.record(this.mediaStreams??[],(e=>{t.aborted||this.onDataReceived(e)}),16e3),t.aborted)return this.recorder.releaseMediaResources(),void(this.mediaStreams=void 0);a().d.addListener(this.handleDeviceChange),s().X8.addListener(this.handleDeviceChange)}}stop(e){const{error:t,triggerOnStop:n=!0}=e||{};if(void 0!==this.startController&&!this.startController.signal.aborted){var i;if(this.startController.abort(),this.recorder.releaseMediaResources(),this.mediaStreams=void 0,n)null===(i=this.onStop)||void 0===i||i.call(this,t);a().d.removeListener(this.handleDeviceChange),s().X8.removeListener(this.handleDeviceChange)}}destroy(e){a().d.removeListener(this.handleDeviceChange),s().X8.removeListener(this.handleDeviceChange),this.stop({triggerOnStop:!0,error:e})}}class l{constructor(){this._audioWorkletNode=void 0,this._sourceNodes=void 0,this._audioContext=void 0}set sourceNodes(e){this._sourceNodes&&this._sourceNodes.forEach((e=>e.disconnect())),this._sourceNodes=e}set audioWorkletNode(e){this._audioWorkletNode&&this._audioWorkletNode.disconnect(),this._audioWorkletNode=e}set audioContext(e){this._audioContext&&this._audioContext.close(),this._audioContext=e}get audioContext(){return this._audioContext}async record(e,t,o){if(this.releaseMediaResources(),this.audioContext=(0,r().G)(o),Boolean(this.audioContext.audioWorklet))try{const r=new i(this.audioContext.sampleRate,o),s=this.audioContext,a=e.map((e=>s.createMediaStreamSource(e)));await this.audioContext.audioWorklet.addModule(new URL(n(938817),n.b));const c=new AudioWorkletNode(this.audioContext,"pcm-processor");c.port.onmessage=e=>{if(e.data){const n=e.data,i=r.downsample(n);t(i)}},a.forEach((e=>e.connect(c))),this._audioWorkletNode=c,this._sourceNodes=a}catch{console.info("unable to create worklet"),this.releaseMediaResources()}else this.releaseMediaResources()}releaseMediaResources(){this.sourceNodes=void 0,this.audioWorkletNode=void 0,this.audioContext=void 0}}},795396:(e,t,n)=>{n.d(t,{E:()=>i,G:()=>o});n(610931);function i(){const e=navigator.mediaDevices;if(e instanceof MediaDevices)return e;throw new Error("Media devices unavailable in current context.")}function o(e){const t=window.AudioContext||window.webkitAudioContext||!1;var n;if(Boolean(t))return new t({...(null===(n=navigator)||void 0===n||null===(n=n.mediaDevices)||void 0===n?void 0:n.getSupportedConstraints().sampleRate)&&{sampleRate:e}});throw new Error("Browser does not support Web Audio API (AudioContext is not available).")}},848105:(e,t,n)=>{n.r(t),n.d(t,{CurrentlyListeningTranscriptionBlockIndicator:()=>qe,DictationAvatar:()=>L,DictationBubble:()=>H,StopDictationButton:()=>se,StopDictationButtonMobile:()=>fe,StopDictationListener:()=>Ae,TranscriptionSetupModal:()=>Ee,activeTranscriptionHelpers:()=>a(),audioProcessDetectionActions:()=>s(),dictationActions:()=>o(),hooks:()=>b(),idleTranscriptionActions:()=>i,transcriptionBlockActions:()=>r(),transcriptionErrorActions:()=>y(),transcriptionNewPageActions:()=>c()});var i={};n.r(i),n.d(i,{showIdleTranscriptionToast:()=>S});var o=()=>n(649833),r=()=>n(241887),s=()=>n(885218),a=()=>n(498348),c=()=>n(617719),d=()=>n(242120),l=()=>n(220413),u=()=>n(773253),p=()=>n(137476),m=()=>n(477784),f=()=>n(485966),g=()=>n(413871),v=()=>n(950347),h=()=>n(936765);function S(e,t){const{pointer:n}=t,i=f().AppStoreCurrentSpaceStore.state;if(!i)return;const o=g().Bv.createChildStore(i,n);null!=o&&o.isTranscriptionBlock()&&"transcribing"===(0,v().by)(o).state&&((0,p().u4)({environment:e,event:{eventName:"idle_transcription_toast_shown",eventProperties:{block_id:o.id}}}),u().Iz({id:"transcription_idle_notification",icon:()=>(0,d().b)({color:l().Ay.invertedTextColor,height:16,width:16}),presentationType:"persistent",title:m().A.getIntl().formatMessage({id:"idleTranscriptionToast.title",defaultMessage:"Still there?"}),message:m().A.getIntl().formatMessage({id:"idleTranscriptionToast.message",defaultMessage:"Notion AI is recording your audio but hasn't heard from you in a while."}),onDismiss:()=>{(0,p().u4)({environment:e,event:{eventName:"idle_transcription_toast_dismissed",eventProperties:{block_id:o.id}}})},actions:{primary:{title:m().A.getIntl().formatMessage({id:"idleTranscriptionToast.action.stop",defaultMessage:"Stop"}),onAction:()=>{(0,h().K)({environment:e,blockStore:o}),(0,r().stopTranscription)({environment:e,blockStore:o,from:"transcription_idle_notification"}),u().UW("transcription_idle_notification"),(0,p().u4)({environment:e,event:{eventName:"idle_transcription_toast_stop_button_clicked",eventProperties:{block_id:o.id}}})}},secondary:{title:m().A.getIntl().formatMessage({id:"idleTranscriptionToast.action.goToBlock",defaultMessage:"Go to meeting note"}),onAction:()=>{u().UW("transcription_idle_notification"),(0,h().K)({environment:e,blockStore:o}),(0,p().u4)({environment:e,event:{eventName:"idle_transcription_toast_navigation_button_clicked",eventProperties:{block_id:o.id}}})}}}}))}var y=()=>n(76239),b=()=>n(73410),k=(n(403517),n(242343)),A=()=>n(803290),x=()=>n(975392),w=()=>n(354148),T=()=>n(129978),_=()=>n(210562),M=()=>n(237385),I=()=>n(174114),C=()=>n(653998),B=()=>n(111066),D=()=>n(476026),R=()=>n(126451),j=()=>n(103151),E=()=>n(907933),P=n(163643);const N=18;function L(e){let{enableClickToScroll:t=!1,rootStore:n,noMarginRight:i=!1,noOutline:o=!1,noTooltip:r=!1}=e;const s=(0,b().useIsDictatingToPage)(n),a=(0,M().v3)(),c=(0,k.useCallback)((e=>e.UIUserAvatarSelfBorder),[]),d=(0,E().XE)(c,!0),l=(0,I().IS)((e=>({tooltip:{color:e.text.contrastSecondary,minWidth:150,paddingTop:2,paddingBottom:2,lineHeight:1.3},avatarContainer:{width:N,height:N,borderRadius:N,backgroundColor:e.assistantCornerButtonBackground,display:"flex",alignItems:"center",justifyContent:"center"}})),[]),u=(0,A().K8)((()=>_().b.state),[]);return!s&&n?null:(0,P.jsx)(j().A,{textWrap:!0,disableTooltip:r,renderTooltip:()=>(0,P.jsxs)("div",{children:[(0,P.jsx)("div",{children:(0,P.jsx)(C().sA,{defaultMessage:"Transcribing your words",id:"topbar.presenceIndicator.dictation.tooltip.description"})}),(0,P.jsx)("div",{style:l.tooltip,children:(0,P.jsx)(C().sA,{defaultMessage:"Click to see where",id:"topbar.presenceIndicator.dictation.tooltip.action"})})]}),render:e=>{const n=(0,P.jsx)("div",{style:{...d.avatarOuterOutline,...o?{outline:"none"}:{},...i?{marginRight:0}:{},width:N,height:N},children:(0,P.jsx)("div",{style:{...d.avatarBorder,...l.avatarContainer},children:(0,P.jsx)(D().o,{variant:"avatar",wrapWithPadding:!1,shadowVariant:"none"})})});return t&&u?(0,P.jsx)(R().A,{...e,onClick:()=>B().BL([u],!0,a),style:d.button,hoveredStyle:d.buttonHovered,pressedStyle:d.buttonPressed,children:n}):(0,P.jsx)("div",{...e,style:{cursor:"default"},children:n})}})}n(362833),n(725707),n(771702);var q=()=>n(76394),F=()=>n(718542),O=()=>n(967454);function U(e){let t=[];return e.nodeType===Node.TEXT_NODE?t.push(e):e.childNodes.forEach((e=>{t=t.concat(U(e))})),t}function z(e){let{scrollerStore:t,blockId:n,children:i,framerMotion:o}=e;const r=(0,A().K8)((()=>t.state.elementRef??{current:null}),[t]),s=(0,O().yE)(r),[a,c]=(0,k.useState)(),[d,l]=(0,k.useState)(),u=(0,F().lB)(t),p=(0,F().ht)(t),m=null==u?void 0:u.getNode(),f=null==m?void 0:m.querySelector(".notion-page-content"),g=null==f?void 0:f.querySelector(`[data-block-id="${n}"]`);(0,k.useEffect)((()=>{if(f){let e;const t=new MutationObserver((t=>{(0,q().O9)(e)&&cancelAnimationFrame(e),e=requestAnimationFrame((()=>c(Date.now())))}));return t.observe(f,{subtree:!0,characterData:!0,childList:!0}),()=>{t.disconnect(),(0,q().O9)(e)&&cancelAnimationFrame(e)}}}),[f]),(0,k.useEffect)((()=>{if(m){let e;const t=new ResizeObserver((()=>{(0,q().O9)(e)&&cancelAnimationFrame(e),e=requestAnimationFrame((()=>c(Date.now())))}));return t.observe(m),()=>{t.disconnect(),(0,q().O9)(e)&&cancelAnimationFrame(e)}}}),[m]),(0,k.useLayoutEffect)((()=>{if(!g||!m){const e=setTimeout((()=>{l(void 0)}),200);return()=>{clearTimeout(e)}}{const e=document.createRange(),t=g.querySelector('[data-content-editable-leaf="true"]')??g,n=U(t),i=m.getBoundingClientRect();if(n.length>0){const t=n[n.length-1];e.selectNodeContents(t),e.collapse(!1);const o=e.getBoundingClientRect(),r=o.top+s-i.top,a=o.right-i.left+5;l({top:r,left:a})}else{const e=t.getBoundingClientRect(),n=window.getComputedStyle(t),o=parseInt(n.paddingTop,10),r=isNaN(o)?0:o,a=parseInt(n.paddingBottom,10),c=isNaN(a)?0:a,d=parseInt(n.paddingRight,10),u=isNaN(d)?0:d,p=e.top+r+c+s-i.top,m=e.left-i.left+u;l({top:p,left:m})}}}),[g,m,a,s]);const v=(0,q().O9)(d);(0,k.useEffect)((()=>{if(p&&v)switch(p){case"Page":return _().Ay.setState({..._().Ay.state,blockRenderedInPage:!0}),()=>{_().Ay.setState({..._().Ay.state,blockRenderedInPage:!1})};case"PeekView":return _().Ay.setState({..._().Ay.state,blockRenderedInPeekView:!0}),()=>{_().Ay.setState({..._().Ay.state,blockRenderedInPeekView:!1})}}}),[p,v]);const h=(0,k.useRef)(null),{motion:S}=o;return d?(0,P.jsx)(S.div,{ref:h,initial:{transform:`translate(${d.left}px, ${d.top}px)`},animate:{transform:`translate(${d.left}px, ${d.top}px)`},transition:{duration:.2},style:{display:"block",position:"absolute",top:0,left:3,width:0,height:0,zIndex:112},children:i}):null}function W(e){const{value:t}=(0,T().fJ)(w().fM);return t?(0,P.jsx)(z,{...e,framerMotion:t}):null}function $(e){const{framerMotion:t}=e,{motion:n}=t,i=(0,w().sM)(t);(0,k.useEffect)((()=>{(async()=>{await i.start((e=>({y:[0,-7,0],transition:{duration:.6,delay:.15*e,repeat:1/0,repeatDelay:1,ease:"easeInOut"}})))})()}),[i]);const o=(0,I().IS)((e=>({dotStyle:{width:6,height:6,flexShrink:0,backgroundColor:e.icon.quaternary,borderRadius:"50%"}})),[]);return(0,P.jsx)(n.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},style:{display:"flex",justifyContent:"center",alignItems:"center",gap:3},children:[...Array(3)].map(((e,t)=>(0,P.jsx)(n.div,{custom:t,animate:i,style:o.dotStyle},t)))})}function K(){const{value:e}=(0,T().fJ)(w().fM);return e?(0,P.jsx)($,{framerMotion:e}):null}function H(e){let{scrollerStore:t}=e;const n=(0,A().K8)((()=>{const e=_().Ay.state.block&&_().Ay.state.rootBlock?[{type:"active",rootBlockId:_().Ay.state.rootBlock.id,id:_().Ay.state.block.id}]:[],t=Object.values(_().Ay.state.passiveBlockMap).map((e=>{let{dictatingBlockStore:t,rootBlockStore:n}=e;return{type:"passive",rootBlockId:n.id,id:t.id}}));return x().hS([...e,...t],"id")}),[]),i=(0,A().O$)(_().Gq),{value:o}=(0,T().fJ)(w().fM);if(!o)return null;const{AnimatePresence:r}=o;return(0,P.jsx)(P.Fragment,{children:n.map((e=>(0,P.jsx)(W,{blockId:e.id,scrollerStore:t,children:(0,P.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:6},children:[(0,P.jsx)(L,{noMarginRight:!0,noOutline:!0,noTooltip:!0}),(0,P.jsx)(r,{children:i&&(0,P.jsx)(K,{})})]})},e.rootBlockId)))})}var V=n(535370),Y=()=>n(575681),X=()=>n(417653),Z=()=>n(273520),G=()=>n(637269),J=()=>n(917717),Q=()=>n(962373),ee=()=>n(216273),te=()=>n(141122),ne=()=>n(979458),ie=()=>n(3766);const oe=document.body;function re(e){let{rootStore:t,framerMotion:n}=e;const i=(0,M().WS)(),r=(0,b().useIsDictatingToPage)(t),s=(0,M().v3)(),a=(0,A().K8)((()=>_().Ay.state.audioRecorder),[]),c=(0,A().uB)(void 0,Q().A),d=(0,A().uB)(void 0,Q().A),l=(0,A().O$)(ee().b),u=(0,k.useCallback)((()=>{(0,o().stopDictation)({environment:s,from:"button"})}),[s]),p=(0,k.useCallback)((e=>{null==e||e.stopPropagation(),e&&(0,J().Vt)(e)||(d.state.open?d.reset():c.state.open?c.reset():c.setState({...c.state,open:!0}))}),[c,d]),m=(0,A().K8)((()=>"dark"===s.ThemeStore.state.mode),[s]),[f,g]=(0,k.useState)(!1),v=(0,k.useCallback)((()=>{g(!0)}),[]),h=(0,k.useCallback)((()=>{g(!1)}),[]),[S,y]=(0,k.useState)(!1),x=(0,k.useCallback)((()=>{y(!0)}),[]),w=(0,k.useCallback)((()=>{y(!1)}),[]),T=(0,I().IS)((e=>({dictationButtonStyle:{display:"flex",alignItems:"center",justifyContent:"center",borderRadius:25,gap:2,height:24,cursor:"pointer",padding:"6px 2px 6px 2px",backgroundColor:m?"#2D2D2D":"#F1F0EF",...(0,G().g)({noDrag:s.device.isElectron&&!l})},downChevronContainer:{display:"flex",alignItems:"center",justifyContent:"center",height:20,width:20,borderRadius:20},downIcon:{fill:S?e.icon.secondary:e.icon.tertiary,width:10,height:10},redSquare:{width:10,height:10,borderRadius:2,backgroundColor:f?m?e.accentColors.red[500]:"rgba(191, 67, 64, 1)":m?e.accentColors.red[700]:e.accentColors.red[500]},redSquareContainer:{width:20,height:20,borderRadius:20,display:"flex",alignItems:"center",justifyContent:"center"}})),[m,s.device.isElectron,l,S,f]),C=(0,k.useMemo)((()=>(0,Y()._)(T.downIcon)),[T.downIcon]),B=(0,A().K8)((()=>{var e;return te().default.isCenterPeekOpen()&&(null===(e=te().default.peekTargetStore.state)||void 0===e?void 0:e.id)!==(null==t?void 0:t.id)}),[null==t?void 0:t.id]),D=(0,k.useRef)(null),[R,j]=(0,k.useState)(null);(0,k.useEffect)((()=>{if(!D.current)return void j(null);const e=D.current.getBoundingClientRect();j({top:e.top+window.scrollY,left:e.left+window.scrollX})}),[B]);const N=(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(X().A,{style:T.redSquareContainer,onClick:u,onMouseEnter:v,onMouseLeave:h,children:(0,P.jsx)("div",{style:T.redSquare})}),(0,P.jsx)(ne().t,{}),(0,P.jsx)(X().A,{className:"notion-dictation-button-up-chevron",style:T.downChevronContainer,onClick:p,onMouseEnter:x,onMouseLeave:w,children:C})]}),L=(0,E().Uo)({environment:s,isShowingTabBar:l,isShowingInPostFeed:!1}),{motion:q}=n;return r&&a&&!i?(0,P.jsx)("div",{style:{marginLeft:L.marginLeft,marginTop:L.marginTop,marginRight:.5*Number(L.marginLeft)*-1},children:(0,P.jsx)(Z().Ay,{buttonPopupStore:c,renderOrigin:()=>(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(q.div,{ref:D,className:"notion-dictation-button",style:T.dictationButtonStyle,onClick:u,initial:{opacity:0,x:15},animate:{opacity:1,x:0},transition:{duration:.4},children:N}),B&&(0,V.createPortal)((0,P.jsx)("div",{className:"notion-dictation-button-duplicate",style:{...T.dictationButtonStyle,position:"fixed",top:(null==R?void 0:R.top)||0,left:(null==R?void 0:R.left)||0,zIndex:1e7},onClick:u,children:N}),oe)]}),stopClickPropagation:!0,popupType:s.device.isMobile?Z().z7.SlideUp:Z().z7.Popup,popupWrapStyle:{top:6},render:()=>(0,P.jsx)(ie().J,{languagePopupStore:d})})}):null}function se(e){const{value:t}=(0,T().fJ)(w().fM);return t?(0,P.jsx)(re,{...e,framerMotion:t}):null}const ae=(0,n(680369).wt)("stopDictation",{viewBox:"0 0 36 36",svg:(0,P.jsxs)("svg",{width:"36",height:"36",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,P.jsx)("rect",{width:"36",height:"36",rx:"18",fill:"#D34F43",fillOpacity:".1"}),(0,P.jsx)("path",{d:"M12.2 21.7v-8.3c0-.5.2-.9.5-1.2.3-.3.7-.4 1.2-.4h8.2c.5 0 .9.1 1.2.4.3.3.5.7.5 1.2v8.3c0 .5-.2.9-.5 1.2-.3.3-.7.4-1.2.4h-8.2c-.5 0-1-.1-1.2-.4-.3-.3-.5-.7-.5-1.2Z",fill:"#D44C47"})]})});var ce=()=>n(955885),de=()=>n(190094),le=()=>n(482936),ue=()=>n(400088),pe=()=>n(81421),me=()=>n(280272);function fe(){const e=(0,M().v3)(),{isMobileNative:t,isPhone:n}=(0,M().Y0)(),i=(0,A().K8)((()=>{const e=le().default.state.isOnboarding,t=ue().A.state.open;return e||t}),[]),r=(0,A().K8)((()=>{var e;return!i&&_().Ay.getState().enabled&&!_().Ay.getState().loading&&!(null!==(e=_().Ay.getState().rootBlock)&&void 0!==e&&e.isTranscriptionBlock())}),[i]),s=(0,k.useCallback)((()=>{(0,o().stopDictation)({environment:e,from:"mobile_bar_button"})}),[e]);return(0,k.useEffect)((()=>{i&&s()}),[i,s]),function(e){const t=(0,A().O$)(me().A);(0,k.useEffect)((()=>{t&&(e(),me().A.reset())}),[t,e])}(s),function(e){const t=(0,M().v3)(),n=(0,A().K8)((()=>{const e=_().kj.state;if(e)return!e.isDictatableBlock()||e.pathIsDead()}),[]),i=(0,A().K8)((()=>!_().Y$.state&&_().gZ.state),[]),o=(0,A().O$)(_().ei),r=(0,k.useRef)(!0),s=(0,A().K8)((()=>(0,pe().Xz)(t.TabbedRouterStore.state)),[t]);(0,k.useEffect)((()=>{(0,q().O9)(n)&&n&&e()}),[n,e]),(0,k.useEffect)((()=>{if(i&&(0,q().O9)(o)&&!o.isTranscriptionBlock()){const t=setTimeout((()=>{e()}),250);return()=>{clearTimeout(t)}}}),[i,e,o]),(0,k.useEffect)((()=>{t.device.isMobileNative&&s&&(r.current?r.current=!1:e())}),[t,s,r,e])}(s),r&&t&&n?(0,P.jsx)(ge,{handleClick:s}):null}function ge(e){const{handleClick:t}=e,n=(0,M().v3)(),i=(0,ce().A)(!0);!function(){const{mobileNative:e}=(0,M().v3)();(0,k.useEffect)((()=>(null==e||e.requestKeepScreenOn(!0),()=>{null==e||e.requestKeepScreenOn(!1)})),[e])}();const o=(0,de().o_)(),[r,s]=(0,A().K8)((()=>[n.WindowSizeStore.getSafePaddingLeftPx(16),n.WindowSizeStore.getSafePaddingRightPx(16)]),[n.WindowSizeStore]),a=(0,I().IS)((e=>({container:{position:"absolute",width:"100%",bottom:o,minHeight:50,paddingTop:"6px",paddingBottom:"6px",paddingRight:s,paddingLeft:r,border:`1px solid ${e.stroke.secondary}`,background:e.contentBackground},dictationButtonStyle:{display:"flex",justifyContent:"space-between",verticalAlign:"center",cursor:"pointer",gridAutoFlow:"column",placeItems:"center",gap:10,alignItems:"center"},icon:{color:e.redBadgeBackground}})),[o,r,s]),c=(0,k.useMemo)((()=>ae({width:36,height:36,...a.icon})),[a.icon]);return(0,P.jsx)("div",{style:{...a.container,zIndex:1e7},...i,children:(0,P.jsxs)("div",{className:"notion-dictation-button",style:{...a.dictationButtonStyle},children:[(0,P.jsx)("div",{style:{maxWidth:480,width:"100%",justifyContent:"center",display:"flex",verticalAlign:"middle"},children:(0,P.jsx)(ne().t,{fillWidth:!0})}),(0,P.jsx)("div",{onClick:t,children:c})]})})}var ve=()=>n(502140),he=()=>n(437071),Se=()=>n(643553),ye=()=>n(332440),be=()=>n(377403);const ke=(0,C().YK)({title:{id:"stopDictationListener.notification.title",defaultMessage:"Meeting note stopped due to inactivity"},body:{id:"stopDictationListener.notification.body",defaultMessage:"Notion AI could not detect your audio for a while"}});function Ae(){const e=(0,M().v3)(),t=(0,C().tz)(),n=(0,A().K8)((()=>_().Ay.state.tabId),[]),i=(0,A().O$)(_().ei),s=(0,A().K8)((()=>(0,q().O9)(i)&&i.isTranscriptionBlock()),[i]),a=(0,A().K8)((()=>{const e=_().kj.state;if(e&&e.isDefined())return!e.isDictatableBlock()||e.pathIsDead()}),[]),c=(0,A().K8)((()=>!_().Y$.state),[]);(0,k.useEffect)((()=>{var t,n,i,r;(0,q().O9)(a)&&a&&(ve().log({level:"info",from:"stopDictationListener",type:"block_not_dictatable",data:{miscDataToConvertToString:{rootBlockId:null===(t=_().ei.state)||void 0===t?void 0:t.id,dictationBlockId:null===(n=_().kj.state)||void 0===n?void 0:n.id,isDictatableBlock:(null===(i=_().kj.state)||void 0===i?void 0:i.isDictatableBlock())??"undefined",isDictationBlockPathDead:(null===(r=_().kj.state)||void 0===r?void 0:r.pathIsDead())??"undefined"}}}),(0,o().stopDictation)({environment:e,from:"block_not_dictatable"}))}),[a,e]),(0,k.useEffect)((()=>{if(c&&!s){const t=setTimeout((()=>{c||(0,o().stopDictation)({environment:e,from:"block_not_visible"})}),350);return()=>{clearTimeout(t)}}}),[c,s,e]);const d=function(){const e=(0,be().W)(),t=(0,A().O$)(_().ei),[n,i]=(0,k.useState)(void 0),o=(0,k.useCallback)((()=>{if(null==t||!t.isTranscriptionBlock())return;const e=_().Ay.state.lastReceivedTranscriptionAt;if(!e)return;const n=Date.now()-e;n>=15*Se().Xb?i("should_stop"):n>=Number(Se().Xb)?i("should_notify"):i(void 0)}),[t]);return(0,ye().n)(o,20*Se().TD,Boolean(e&&t)),n}();return(0,k.useEffect)((()=>{if(d&&null!=i&&i.isTranscriptionBlock()&&("should_notify"===d&&he().pushToastInMainTab({toastId:"transcription_idle",pointer:i.pointer}),"should_stop"===d)){(0,r().stopTranscription)({environment:e,blockStore:i,from:"transcription_idle"});new Notification(t.formatMessage(ke.title),{body:t.formatMessage(ke.body),silent:!1}).addEventListener("click",(()=>{(0,h().N)({environment:e,blockStore:i,tabId:n})}))}}),[d,e,n,i,t]),null}n(491955);var xe=()=>n(83544),we=()=>n(162901),Te=()=>n(135866),_e=()=>n(31448),Me=()=>n(435819),Ie=()=>n(392968),Ce=()=>n(922172),Be=()=>n(951540),De=()=>n(289708),Re=()=>n(166318);const je=(0,C().YK)({transcriptionSetupModal:{id:"transcriptionBlock.transcriptionSetupModal.ariaLabel",defaultMessage:"AI Meeting Notes Setup"},getStarted:{id:"transcriptionBlock.transcriptionSetupModal.getStarted",defaultMessage:"AI Meeting Notes Setup"},setupDescription:{id:"transcriptionBlock.transcriptionSetupModal.setupDescription",defaultMessage:"One-time setup to capture notes effortlessly."},imageAlt:{id:"transcriptionBlock.transcriptionSetupModal.imageAlt",defaultMessage:"AI Meeting Notes setup image"}});function Ee(){const e=(0,M().Y0)(),t=(0,A().K8)((()=>Re().c.state.transcriptionSetupModalOpen&&e.isElectron),[e]);return(0,P.jsx)(Ce().a,{ariaLabel:m().A.formatMessage(je.transcriptionSetupModal),open:t,render:()=>(0,P.jsx)(Pe,{}),transitionAppearance:"none",onDismiss:()=>{Re().c.closeTranscriptionSetupModal()}})}function Pe(){const e=(0,I().IS)((e=>({wrapper:{display:"flex",flexDirection:"column",width:"100%",maxWidth:480,border:`1px solid ${e.regularDividerColor}`,borderRadius:12},header:{display:"flex",flexDirection:"column",gap:4,padding:"20px 25px 5px",backgroundColor:e.fill.lightGrayTertiary},title:{display:"flex",flexDirection:"row",alignItems:"center",fontSize:24,fontWeight:600,color:e.text.primary},description:{marginBottom:15,fontSize:17,lineHeight:"24px",color:e.text.secondary},body:{display:"flex",flexDirection:"column",gap:8,padding:"25px 25px 20px",borderRadius:12,position:"relative"},controlRowContainerInvertedBorder:{backgroundColor:e.fill.lightGrayTertiary}})),[]),t=(0,M().v3)(),[n]=(0,k.useState)((0,De().xw)()),[i,o]=(0,k.useState)([]),[r,s]=(0,k.useState)(!1),[a]=(0,we().Yb)((async()=>{let e,r=i;const s=n.filter((e=>!i.includes(e.id)));for(const n of s){const o=await n.hasCompleted({environment:t,isConfirmation:!1});o&&!i.includes(n.id)&&(r=[...r,n.id]),o||e||(e=n)}return o(r),e}),[t,n,i]);return(0,k.useEffect)((()=>{if(a.value&&r){const e=setInterval((async()=>{const n=a.value;if(!n)return void clearInterval(e);await n.hasCompleted({environment:t,isConfirmation:!0})&&(o([...i,n.id]),clearInterval(e))}),3e3);return()=>{clearInterval(e)}}}),[a,t,r,i]),(0,P.jsx)(Me().A,{capture:!0,allowUndo:!1,allowEsc:!0,allowTabUntab:!1,render:o=>(0,P.jsxs)("div",{...o,style:e.wrapper,children:[(0,P.jsxs)("div",{style:e.header,children:[(0,P.jsx)("div",{style:e.title,children:(0,P.jsx)(C().sA,{...je.getStarted})}),(0,P.jsx)("div",{style:e.description,children:(0,P.jsx)(C().sA,{...je.setupDescription})})]}),(0,P.jsxs)("div",{style:e.body,children:[(0,P.jsx)("div",{style:{...e.controlRowContainerInvertedBorder,width:"16px",height:"16px",position:"absolute",top:0,left:0,clipPath:"path('M16 0C7.16344 0 0 7.16344 0 16V0H16Z')"}}),(0,P.jsx)("div",{style:{...e.controlRowContainerInvertedBorder,width:"16px",height:"16px",position:"absolute",top:0,right:0,clipPath:"path('M0 0C8.83656 0 16 7.16344 16 16V0H0Z')"}}),n.map((e=>{var n,o;return(0,P.jsx)(Ne,{step:e,isCompleted:i.includes(e.id),isFirstIncompleteStep:(null===(o=a.value)||void 0===o?void 0:o.id)===e.id,onAction:()=>{e.action({environment:t,isConfirmation:!1}),(0,p().u4)({environment:t,event:{eventName:"transcription_block_setup_modal_action_clicked",eventProperties:{step:e.id}}}),s(!0)}},`${e.id}-${null===(n=a.value)||void 0===n?void 0:n.id}`)}))]})]})})}function Ne(e){const{step:t,isFirstIncompleteStep:n,onAction:i,isCompleted:o}=e,r=(0,I().IS)((e=>({stepContainer:{display:"flex"},checkIcon:{width:24,height:24,marginRight:12,marginTop:3,fill:o?e.blueColor:e.icon.tertiary},content:{flex:1},stepTitle:{display:"flex",alignItems:"center",fontSize:19,fontWeight:_e().Wy.semibold,marginBottom:4,color:o?e.blueColor:e.text.primary},container:{display:"flex",flexDirection:"row",alignContent:"flex-start",alignItems:"flex-start",width:"100%",gap:20},image:{width:"135px",marginTop:8,flexShrink:0,borderRadius:4},description:{display:"flex",flexDirection:"column",marginBottom:5,marginTop:5,color:e.text.secondary},actionButton:{marginTop:12,alignSelf:"flex-start"}})),[o,n]);return(0,P.jsxs)("div",{style:r.stepContainer,children:[(0,Te().checkmarkCircleFillIcon)(r.checkIcon),(0,P.jsxs)("div",{style:r.content,children:[(0,P.jsx)("div",{style:r.stepTitle,children:(0,P.jsx)(C().sA,{...t.title})}),n?(0,P.jsxs)("div",{style:r.container,children:["microphone"===t.id||"system-audio"===t.id?(0,P.jsx)(Ie().Ay,{src:xe().A.images.aiMeetingNotes.setupPng,alt:m().A.formatMessage(je.imageAlt),style:r.image,placeholderLoadedStyle:{width:"auto"}}):null,(0,P.jsxs)("div",{style:r.description,children:[(0,P.jsx)(C().sA,{...t.description}),(0,P.jsx)(Be().A,{color:"uiBlue",style:r.actionButton,onClick:i,children:(0,P.jsx)(C().sA,{...t.actionText})})]})]}):null]})]})}var Le=()=>n(473616);function qe(){const e=(0,M().v3)(),t=(0,A().K8)((()=>{var e;const t=Object.values(_().Ay.state.passiveBlockMap).map((e=>{let{rootBlockStore:t}=e;return t})),n=_().ei.state,i=[];n&&n.isTranscriptionBlock()&&i.push(n);for(const r of t)r.isTranscriptionBlock()&&i.push(r);const o=null===(e=f().default.state.currentUserStore)||void 0===e?void 0:e.id;if(o)for(const r of i){const e=(0,v().by)(r);if(!r.pathIsDead()&&"transcribing"===e.state&&e.transcriber_id===o&&!Re().c.getVisibilityStatus(r.id))return r}}),[]),[n,i]=(0,k.useState)(!1),o=(0,I().IS)((e=>({wrapper:{borderRadius:34,background:e.buttonBackground},container:{display:"flex",alignItems:"center",justifyContent:"center",boxShadow:e.shadowSM,borderRadius:34,padding:"8px 14px 8px 12px",minWidth:100,background:e.buttonBackground,gap:6,transition:"background 0.3s ease-in-out"},hoveredStyle:{background:n?e.outlinefrontSecondaryButtonPressedBackground:e.buttonHoveredBackground}})),[n]),r=(0,k.useCallback)((()=>{t&&(0,h().K)({environment:e,blockStore:t})}),[e,t]),s=(0,A().O$)(_().gZ);return t?(0,P.jsx)(j().A,{renderTooltip:()=>n?(0,P.jsx)(C().sA,{defaultMessage:"Stop recording",id:"currentlyListeningTranscriptionBlockIndicator.stopRecording"}):(0,P.jsx)(C().sA,{defaultMessage:"Return to meeting note",id:"currentlyListeningTranscriptionBlockIndicator.returnToTranscription"}),render:e=>(0,P.jsx)("div",{style:o.wrapper,children:(0,P.jsxs)(R().A,{...e,style:o.container,hoveredStyle:o.hoveredStyle,onClick:r,children:[(0,P.jsx)(ne().t,{fillWidth:!0,fakeSoundwave:!s}),(0,P.jsx)(Fe,{store:t,setIsHovering:i})]})})}):null}function Fe(e){const{store:t,setIsHovering:n}=e,i=(0,M().v3)(),o=(0,k.useCallback)((()=>{(0,r().stopTranscription)({environment:i,blockStore:t,from:"currently_listening_transcription_block"}),(0,h().K)({environment:i,blockStore:t})}),[i,t]);return(0,P.jsx)(R().A,{onMouseEnter:()=>n(!0),onMouseLeave:()=>n(!1),onClick:o,children:(0,P.jsx)(Le().wf,{disabled:!1})})}},885218:(e,t,n)=>{n.r(t),n.d(t,{sendNotificationForDictationInterrupted:()=>A,sendNotificationForRunningAudioProcess:()=>k,upsertMeetingNote:()=>x});n(403517);var i=()=>n(486826),o=()=>n(16791),r=()=>n(427091),s=()=>n(653998),a=()=>n(865226),c=()=>n(137476),d=()=>n(708920),l=()=>n(477784),u=()=>n(427871),p=()=>n(713807),m=()=>n(707715),f=()=>n(836331),g=()=>n(241887),v=()=>n(936765),h=()=>n(617719);const S=(0,s().YK)({"us.zoom.xos":{id:"audioProcessDetectionActions.zoom",defaultMessage:"In a Zoom meeting?"},"com.apple.WebKit.GPU":{id:"audioProcessDetectionHelpers.audioProcess.safari",defaultMessage:"In a meeting?"},"com.google.Chrome.helper":{id:"audioProcessDetectionHelpers.audioProcess.chrome",defaultMessage:"In a meeting?"},"com.microsoft.teams2":{id:"audioProcessDetectionHelpers.audioProcess.teams",defaultMessage:"In a Teams meeting?"}}),y=(0,s().YK)({body:{id:"audioProcessDetectionActions.notification.body",defaultMessage:"Start AI Meeting Notes for this meeting"}}),b=(0,s().YK)({defaultEventTitle:{id:"calendarMeetingNoteNotification.defaultEventTitle",defaultMessage:"Meeting"},allDayTimeLabel:{id:"calendarMeetingNoteNotification.allDayTimeLabel",defaultMessage:"All-day"},takeNotes:{id:"calendarMeetingNoteNotification.takeNotesBody",defaultMessage:"{startTime}  Start AI Meeting Notes"}});function k(e,t){var n;if(e.device.isMobile||!f().default.checkGate({gateName:"meeting_notes_audio_process_notification"}))return;const s=null===(n=m().A.getStateForCurrentSpaceView())||void 0===n?void 0:n.botId,u=function(e){const t=(0,d().RN)(e);if(!t)return;if(t.isAllDay)return;const n=10,o=i().c9.fromISO(t.start.dateTime);if(o.diff(i().c9.now()).as("minutes")>n)return;return t}(m().A.getEvents()),g=function(e){const{processId:t,event:n}=e;if(n)return n.summary||l().A.formatMessage(b.defaultEventTitle);return l().A.formatMessage(S[t])}({processId:t,event:u}),v=function(e){const{event:t}=e;if(t){const e=t.isAllDay?l().A.formatMessage(b.allDayTimeLabel):(0,p().ax)({time:i().c9.fromISO(t.start.dateTime),showAmPm:!0,locale:o().locale,timeZone:(0,r().P)()});return l().A.formatMessage(b.takeNotes,{startTime:e})}return l().A.formatMessage(y.body)}({processId:t,event:u}),k=Notification.permission;(0,c().u4)({environment:e,event:{eventName:"audio_process_notification_sent",eventProperties:{permission:k,calendar_bot_id:s,process_id:t}}});new Notification(g,{body:v,silent:!0}).addEventListener("click",(()=>{null!=u&&u.meetingNote&&s?async function(e){const{environment:t}=e,n=await x(e);n?a().oo({environment:t,url:n,openInNew:"tab",makeTabActive:!0}):(0,h().createTranscriptionBlockInNewPage)({environment:t,from:"audio_process_detection"})}({environment:e,event:u,calendarBotId:s}):(0,h().createTranscriptionBlockInNewPage)({environment:e,from:"audio_process_detection"})}))}function A(e){const{environment:t,blockStore:n,title:i,message:o,canRestart:r,tabId:s}=e;if(t.device.isMobile)return;const a=new Notification(i,{body:o,silent:!1,requireInteraction:!0}),c=()=>{(0,v().N)({environment:t,blockStore:n,tabId:s})},d=r?()=>{c(),(0,g().startTranscription)({environment:t,blockStore:n,from:"resume_from_click_error_notification"})}:c;a.addEventListener("click",d)}async function x(e){const{environment:t,event:n,calendarBotId:i}=e;if(!n.meetingNote)return;const o=n.isAllDay?{uid:n.meetingNote.eventUid,title:n.summary??"",attendees:(n.attendees??[]).map((e=>({email:e.email??"",self:e.self}))),isAllDay:!0,start:{date:n.start.date},end:{date:n.end.date}}:{uid:n.meetingNote.eventUid,title:n.summary??"",attendees:(n.attendees??[]).map((e=>({email:e.email??"",self:e.self}))),isAllDay:!1,start:{dateTime:n.start.dateTime,timeZone:n.start.timeZone},end:{dateTime:n.end.dateTime,timeZone:n.end.timeZone}},r=await(0,u().NC)({environment:t,botId:i,data:{event:o,location:n.meetingNote.location,share:Boolean(n.meetingNote.share)}});return"success"===r.type?r.data.page.url:void 0}},907867:(e,t,n)=>{n.d(t,{Cu:()=>o});var i=()=>n(627618);const o={English:["English","en"],Chinese:["Chinese","zh"],Spanish:["Spanish","es"],French:["French","fr"],German:["German","de"],Japanese:["Japanese","ja"],Korean:["Korean","ko"],Portuguese:["Portuguese","pt"],Russian:["Russian","ru"],Thai:["Thai","th"],Vietnamese:["Vietnamese","vi"],Danish:["Danish","da"],Finnish:["Finnish","fi"],Norwegian:["Norwegian","no"],Dutch:["Dutch","nl"],Swedish:["Swedish","sv"]},r=i().union([i().number(),i().string(),i().boolean(),i().isNull(),i().array(i().string())]),s=i().undefinable(r),a=(i().union([r,i().record(i().string(),r)]),i().union([s,i().record(i().string(),s)]));i().union([a,i().record(i().string(),a)])},936765:(e,t,n)=>{n.d(t,{K:()=>u,N:()=>p});n(725707),n(500234),n(113085);var i=()=>n(712437),o=()=>n(437071),r=()=>n(191756),s=()=>n(111066),a=()=>n(37394),c=()=>n(714013),d=()=>n(498348);function l(e,t){const n=a().T.findScrollToSelectablesFromIds([t]);return 0!==n.length&&(s().pb({environment:e,handle:n[0],vertical:{reveal:"top"},horizontal:void 0,animate:!0}),!0)}function u(e){const{environment:t,blockStore:n}=e;if(l(t,n.id))return;const s=(0,d().getActiveTranscriptionBlockStore)();if((null==s?void 0:s.id)===n.id)return void r().uK({environment:t,store:n,pageVisitSource:i().y8.TranscriptionBlockPopup});const a=c().A.state.tabs.find((e=>{var t;return null===(t=e.activeBlocks)||void 0===t?void 0:t.some((e=>e.pointer.id===n.id))}));a&&o().navigateToBlockInTab({tabId:a.id,pointer:n.pointer,source:i().y8.TranscriptionBlockPopup})}function p(e){const{environment:t,blockStore:n,tabId:s}=e;l(t,n.id)||(s&&s!==c().A.state.currentTab.id?o().navigateToBlockInTab({tabId:s,pointer:n.pointer,source:i().y8.TranscriptionBlockPopup}):r().uK({environment:t,store:n,pageVisitSource:i().y8.TranscriptionBlockPopup}))}},938817:(e,t,n)=>{e.exports=n.p+"dbc10b469ee58d20.js"},952602:(e,t,n)=>{n.d(t,{$g:()=>i().$g,qY:()=>o().getCurrentClientSessionId});var i=()=>n(162450),o=()=>n(130881)},979458:(e,t,n)=>{n.d(t,{t:()=>A});n(362833),n(153350),n(1759),n(211883),n(175799),n(778020),n(234093),n(52950),n(914784),n(545159),n(117826),n(725707),n(771702),n(403517),n(244387);var i=n(242343),o=()=>n(237385),r=()=>n(803290),s=()=>n(174114),a=()=>n(76394),c=()=>n(686329),d=()=>n(836331),l=()=>n(775041);var u=()=>n(625083),p=()=>n(210562);class m extends(()=>n(129044))().default{constructor(){super()}getInitialState(){}setState(e){this.instanceState&&this.instanceState.close(),super.setState(e)}addListener(e){super.addListener(e),this.instanceState||this.setState((0,n(795396).G)(24e3))}removeListener(e){super.removeListener(e),0===this.listenerCount()&&this.setState(void 0)}}const f=new m;var g=n(163643);const v=50,h=7e3,S=50,y=14e3,b=1.5,k=1.3;function A(e){const{fillWidth:t=!1,forceRender:n=!1,fakeSoundwave:m=!1}=e,{isMobile:A,isIOS:x}=(0,o().Y0)(),w=(0,r().K8)((()=>{if(!A)return;const e=d().default.getConfigKey("mobile_dictation_visualizer","lowshelf_filter_gain");if(x){var t;const n=null===(t=u().A.state)||void 0===t?void 0:t.label;if((0,a().O9)(n)&&"iPhone Microphone"!==n)return;return e+6}return e}),[A,x]),T=(0,r().K8)((()=>A?S:v),[A]),_=(0,r().K8)((()=>A?y:h),[A]),M=(0,i.useMemo)((()=>function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:v,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:h;const n=(e+t)/2;return{frequencyRangeMin:e,frequencyRangeMax:t,frequencyLowerQuarter:(e+n)/2,frequencyUpperQuarter:(n+t)/2}}(T,_)),[T,_]),I=(0,r().K8)((()=>p().Ay.state.audioRecorder),[]),C=(0,r().O$)(f),B=(0,i.useRef)(null),[D,R]=(0,i.useState)(8),[j,E]=(0,i.useState)([]),P=t?2*b:b,N=t?3*k:k;!function(e){const{isEnabled:t,numBars:n,barHeights:o,setBarHeights:r}=e,s=(0,i.useRef)(null);(0,i.useEffect)((()=>{if(s.current&&cancelAnimationFrame(s.current),!t)return;o.length!==n&&r(new Array(n).fill(3));const e={lastFrameTime:Date.now(),isSpeaking:!0,speakingBlendFactor:1,nextStateChangeTime:Date.now()+3e3+3e3*Math.random(),lastStateChangeTime:Date.now(),activityLevel:.8+.4*Math.random(),currentHeights:Array(n).fill(3)},i=Array(n).fill(0).map((()=>Math.random()*Math.PI*2)),a=Array(n).fill(0).map((()=>.85+.3*Math.random())),c=Array(n).fill(0).map((()=>.8+.4*Math.random())),d=.6+.15*Math.random(),l=.9+.2*Math.random(),u=2.8+1.2*Math.random(),p=()=>{const t=Date.now(),o=Math.min(.05,(t-e.lastFrameTime)/1e3);if(e.lastFrameTime=t,t>e.nextStateChangeTime){e.isSpeaking?e.isSpeaking=Math.random()>.85:e.isSpeaking=!0,e.lastStateChangeTime=t;const n=e.isSpeaking?1400:200,i=e.isSpeaking?3800:500,o=n+Math.random()*(i-n);e.nextStateChangeTime=t+o,e.isSpeaking&&(e.activityLevel=.9+.6*Math.random())}const m=e.isSpeaking?e.speakingBlendFactor:Math.max(.35,.45*e.speakingBlendFactor),f=e.isSpeaking?1:.4,g=e.isSpeaking?5:4.5;Math.abs(e.speakingBlendFactor-f)>.01?e.speakingBlendFactor<f?e.speakingBlendFactor=Math.min(f,e.speakingBlendFactor+o*g):e.speakingBlendFactor=Math.max(f,e.speakingBlendFactor-o*g):e.speakingBlendFactor=f;const v=.25*Math.sin(6e-4*t)+.85,h=e.activityLevel*v,S=Math.max(0,.7*Math.sin(.001*t)+.3),y=S>.55&&m>.5,b=y?1+.8*(S-.55):1,k=Array(n).fill(0).map(((r,s)=>{const p=s/(n-1),f=1-2*Math.abs(p-.5),g=Math.pow(f,.5),v=.006*t,S=Math.sin(v*a[s]+i[s])*c[s]+.5*Math.sin(2.2*v*a[(s+3)%n]+i[(s+2)%n])+.3*Math.sin(v*u*a[(s+1)%n]+i[(s+5)%n]),k=.7+.45*Math.sin(v*d+.1*s)+.35*Math.sin(v*l+i[s]),A=3+(S+1.2)*(y?6:5.5)*g*k*(m*h*b),x=A>e.currentHeights[s],w=Math.min(1,o*(x?25:16));return e.currentHeights[s]=e.currentHeights[s]*(1-w)+A*w,Math.max(3,Math.min(15,e.currentHeights[s]))}));r(k),s.current=requestAnimationFrame(p)};return s.current=requestAnimationFrame(p),()=>{s.current&&cancelAnimationFrame(s.current)}}),[t,n,o.length,r])}({isEnabled:m,numBars:D,barHeights:j,setBarHeights:E});const L=(0,i.useCallback)((()=>{if(t&&(I||n||m)&&B.current){const e=B.current.clientWidth,t=P+N,n=Math.max(1,Math.floor(e/t));R(n),E(new Array(n).fill(3))}}),[t,I,n,m,P,N]),q=(0,c().wY)(B),F=null==q?void 0:q.width;(0,i.useEffect)((()=>{F&&L()}),[F,L]),(0,i.useEffect)((()=>{if(n&&!m)E(new Array(D).fill(3));else if(I&&C&&!m){const e=new AbortController,t=e.signal,n=()=>{const{mediaStreams:e}=I;if(e&&e.length>0){const n=C.createChannelMerger(e.length),i=C.createAnalyser();i.fftSize=2048;const o=e.map((t=>{const i=[],o=C.createMediaStreamSource(t);if(i.push(o),(0,a().O9)(w)){const t=C.createGain();t.gain.setValueAtTime(w/e.length,C.currentTime),i.push(t)}const r=C.createBiquadFilter();r.type="highpass",r.frequency.setValueAtTime(M.frequencyLowerQuarter,C.currentTime),i.push(r);const s=C.createBiquadFilter();return s.type="lowpass",s.frequency.setValueAtTime(M.frequencyUpperQuarter,C.currentTime),i.push(s),i.push(n),i}));n.connect(i),o.forEach((e=>{for(let t=0;t<e.length-1;t++)e[t].connect(e[t+1])}));const r=()=>{o.forEach((e=>{e.forEach((e=>e.disconnect()))})),n.disconnect(),i.disconnect()};C.resume();const s=new Uint8Array(i.frequencyBinCount),c=()=>{if(t.aborted)return void r();i.getByteFrequencyData(s);const e=C.sampleRate/2/i.frequencyBinCount,n=Math.round(M.frequencyRangeMin/e),o=Math.round(M.frequencyRangeMax/e),a=s.slice(n,o+1),d=Math.floor(a.length/D),l=[];for(let t=0;t<D;t++){const e=a.slice(t*d,t<D-1?(t+1)*d:a.length+1),n=e.reduce(((e,t)=>e+t),0)/e.length,i=Math.max(3,Math.min(12,n/3));l.push(i)}E(l),requestAnimationFrame(c)},d=requestAnimationFrame(c);return()=>{cancelAnimationFrame(d),r()}}};let i=n();const o=()=>{"function"==typeof i&&i(),i=n()};return I.emitter.on(l().Q,o),()=>{I.emitter.off(l().Q,o),"function"==typeof i&&i(),e.abort()}}}),[I,D,C,n,w,M,m]);const O=(0,s().IS)((e=>({barStyle:{flexShrink:0,bottom:"0",width:`${P}px`,backgroundColor:I||n||m?e.icon.tertiary:e.icon.redPrimary,borderRadius:t?"4px":"1px"}})),[I,n,P,t,m]);return(0,g.jsx)("div",{ref:B,style:{height:"20px",display:"flex",justifyContent:"center",alignItems:"center",position:"relative",gap:N,flex:t?1:void 0},children:j.map(((e,t)=>(0,g.jsx)("div",{style:{...O.barStyle,height:`${e}px`}},t)))})}}}]);