(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[90214],{45524:(e,t,o)=>{"use strict";o.d(t,{Ol:()=>c,ak:()=>p,bl:()=>u,xm:()=>d});o(725707),o(491955),o(403517);var n=()=>o(228138),r=()=>o(76394),i=()=>o(548694),a=()=>o(836331),l=()=>o(308265);function c(e){const{spaceStore:t,config:o}=e;if("researcher"===o.type){const e=a().default.checkGate({gateName:"ai_research_mode_web_search"});return{...o,useWebSearch:e&&!(0,i().Ar)(t)}}return o}function s(e){const{spaceStore:t,configs:o}=e;return o.map((e=>c({spaceStore:t,config:e}))).filter(r().O9)}function p(e){const{spaceStore:t}=e;return s({spaceStore:t,configs:(0,n().qG)({agentEnabled:(0,l().aj)()})})}function d(e){const{spaceStore:t}=e;return s({spaceStore:t,configs:n().hx})}function u(e){return n().Vf}},56432:(e,t,o)=>{"use strict";o.r(t),o.d(t,{addAutomationAction:()=>U,clearInvalidVariables:()=>Q,createAutomation:()=>W,deleteAutomation:()=>Y,disableAutomation:()=>X,duplicateAutomation:()=>z,duplicateAutomationAction:()=>G,enableAutomation:()=>H,insertEmptyTextInDuplicateBlockAction:()=>j,messages:()=>$,removeAutomationAction:()=>q,reorderAutomationActions:()=>L,restartAutomation:()=>D});o(610931),o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601),o(725707),o(491955),o(500234),o(771702),o(403517);var n=o.n(o(485359)),r=()=>o(486826),i=()=>o(752597),a=()=>o(911575),l=()=>o(779698),c=()=>o(889110),s=()=>o(114103),p=()=>o(100851),d=()=>o(262148),u=()=>o(807912),m=()=>o(582226),f=()=>o(293665),v=()=>o(711659),g=()=>o(385649),S=()=>o(66460),h=()=>o(34662),y=()=>o(975392),w=()=>o(728373),I=()=>o(204132),_=()=>o(76394),T=()=>o(551102),b=()=>o(795394),C=()=>o(759625),k=()=>o(384221),M=()=>o(84543),A=()=>o(927685),P=()=>o(425447),V=()=>o(137476),x=()=>o(213517),R=()=>o(754697),B=()=>o(37394),E=()=>o(271142),O=()=>o(459845),F=()=>o(909177),N=()=>o(113800);const $=(0,o(653998).YK)({genericErrorMessage:{id:"automations.buttonTrigger.genericErrorMessage",defaultMessage:"Button failed to execute"},open:{defaultMessage:"Open",id:"automations.buttonTrigger.open"},undo:{defaultMessage:"Undo",id:"automations.buttonTrigger.undo"},defaultConfirmationWorkflowText:{defaultMessage:"Are you sure you want to continue?",id:"automations.buttonTrigger.defaultConfirmationWorkflowText"},defaultContinueWorkflowMessage:{defaultMessage:"Continue",id:"automations.buttonTrigger.defaultContinueWorkflowMessage"},defaultStopWorkflowMessage:{defaultMessage:"Cancel",id:"automations.buttonTrigger.defaultStopWorkflowMessage"},errorQueryCollectionTooManyPages:{defaultMessage:"Button impacts too many pages",id:"automations.buttonTrigger.errorQueryCollectionTooManyPages"},errorRecordInTrash:{id:"automations.buttonTrigger.errorRecordInTrash",defaultMessage:"Button is editing a page in trash"}});function W(e){const{actionIds:t,automationId:o,automationName:r,environment:i,inMemoryRecordCache:a,parentPointer:l,transaction:c,trigger:s}=e,p=o??(0,R().Z1)({environment:i,table:v().yB,spaceId:l.spaceId}),d=C().eC({environment:i,inMemoryRecordCache:a??i.defaultRecordCache.inMemoryRecordCache,table:v().yB,transaction:c,value:{action_ids:t,alive:!0,id:p,parent_id:l.id,parent_table:l.table,properties:{name:r},space_id:l.spaceId,status:"active",trigger:s}});return n()(d.isTriggerType(s.type),"Trigger type mismatch"),d}function U(e){const{actionId:t,environment:o,intl:r,automationStore:a,actionType:c,transaction:s,insertionPoint:p,config:d,createDuplicateBlocksContainer:u=!0,builderType:m="sidebar"}=e,S=a.getSpaceId();if(!S)return;let y;if("duplicate_blocks"===c&&u){y=C().Wv({environment:o,inMemoryRecordCache:a.inMemoryRecordCache,transaction:s,type:"text"});const e=j({environment:o,contentStore:y.getContentStore(),transaction:s});i().default.afterNextFlush((()=>{const t=B().T.find((t=>f().L3.isEqual(t.props.store.pointer,e.pointer)));t&&k().setSelectionAtStart({store:t.props.store.getBlockTitleStore()})}))}const I=d??function(e){const{actionType:t,automationStore:o,intl:n}=e;if("modal_confirmation"===t)return{continue_button:{text:n.formatMessage($.defaultContinueWorkflowMessage)},cancel_button:{text:n.formatMessage($.defaultStopWorkflowMessage)},text:{type:"simple",value:(0,h().x9d)(n.formatMessage($.defaultConfirmationWorkflowText))}};if("define_variables"===t){const e=(0,w().Ay)();return{values:{[e]:{name:(0,F().v)(o.getActionStores(),n.formatMessage(g().xC)),value:{type:"simple",value:[[""]]}}},variableIds:[e]}}}({actionType:c,automationStore:a,intl:r})??{},b=C().eC({environment:o,inMemoryRecordCache:a.inMemoryRecordCache,table:g().SC,transaction:s,value:{id:t,type:c,parent_id:a.id,parent_table:v().yB,alive:!0,space_id:S,config:I,blocks:y?[y.id]:[]}});return y&&T().BC({transaction:s,parentStore:b.getKeyStore("blocks"),appendStore:y}),!p||"afterActionId"in p?T().BC({transaction:s,parentStore:a.getActionIdsStore(),appendStore:b,after:null==p?void 0:p.afterActionId}):"beforeActionId"in p?T().Hs({transaction:s,parentStore:a.getActionIdsStore(),prependStore:b,before:p.beforeActionId}):(0,_().HB)(p),Z({transaction:s,automationStore:a}),(0,O().CM)(((e,t,n)=>{const r=(0,V().ik)(o),i=(0,O().zc)({automationActionStore:b,formulaAnalyticsModule:t,formulasModule:e,simpleFormulasModule:n});(0,_().O9)(i)&&(0,l().dW)(r,{automation_action:i,automation_action_id:b.id,automation_id:b.getParentId(),builder_type:m}),b.isDefined()&&(0,l().c_)(r,{automation_action_id:b.id,automation_action_type:b.getType(),automation_id:a.id,builder_type:m})})),n()(b.isType(c),"Action type mismatch"),b}function D(e){var t,o;const{automationStore:n,transaction:i}=e,a=n.getRecurrence();if(!a)return;const l=r().c9.now().plus({day:1}).startOf("day"),c={...a,start_date:l.toMillis(),end_condition:"date"===(null===(t=a.end_condition)||void 0===t?void 0:t.type)?{type:"date",end_at:(0,s().getNewEndTimestamp)(l,a.start_date,null===(o=a.end_condition)||void 0===o?void 0:o.end_at).toMillis()}:a.end_condition};C().zv({store:n,transaction:i,data:{status:"active"}}),C().zv({store:n.getKeyStore("trigger"),transaction:i,data:{recurrence:(0,s().convertFromUnpersistedRecurrenceConfig)(c)}})}function z(e){const{actorPointer:t,environment:o,includeParenting:n,sourceAutomationStore:r,targetAutomationId:i,transaction:a}=e,l=r.getParentStore();if(!l||!l.isReady())throw new Error("Automation parent store not ready");const c=r.getValue(),s=r.getSpaceId();if(!(0,_().O9)(c)||!(0,_().O9)(s))throw new Error("Undefined automation value or space id");const p={},u={...(0,y().mg)(c),id:i??(0,R().Z1)({environment:o,table:v().yB,spaceId:(0,S().e)(s)})};p[r.id]=u.id,(0,_().O9)(u.action_ids)&&(0,_().EI)(u.action_ids)&&u.action_ids.forEach((e=>p[e]=(0,R().Z1)({environment:o,table:g().SC,spaceId:(0,S().e)(s)})));const m=e=>{let{requested:t}=e;const o=p[t.id];return(0,_().O9)(o)?{...t,id:o}:t};(0,d().i)({actor:t,duplicateRecord:u,options:{},mapper:m,originalRecord:c});const f=C().eC({environment:o,inMemoryRecordCache:r.inMemoryRecordCache,table:v().yB,transaction:a,value:u});n&&b().NI({childStore:f,parentStore:l,transaction:a});const h=r.getActionStores(),w=Promise.all(h.map((e=>{const t=p[e.id],{automationActionStore:n,onComplete:r}=G({environment:o,includeParenting:!1,mapper:m,sourceActionStore:e,targetAutomationActionId:t,transaction:a});return b().NI({childStore:n,parentStore:f,transaction:a}),r}))),I=w.then((e=>e.flat()));return{automationStore:f,onComplete:I}}function G(e){const{environment:t,includeParenting:o,insertionPoint:n,mapper:r,sourceActionStore:i,targetAutomationActionId:a,transaction:c}=e,s=i.getParentStore();if(!s||!s.isReady())throw new Error("Automation store is not ready");const d=i.getValue(),u=i.getSpaceId();if(!(0,_().O9)(d)||!(0,_().O9)(u))throw new Error("Undefined action value or space id");const m={...(0,y().mg)(d),id:a??(0,R().Z1)({environment:t,table:g().SC,spaceId:(0,S().e)(u)})},f=t.currentUser.id,v=i.inMemoryRecordCache.makeGetRecordRoleFn(f);(0,p().I)({duplicateRecord:m,getRecordRole:v,originalRecord:d,mapper:e=>(null==r?void 0:r(e))??e.requested,options:{},originOptions:{baseUrl:A().A.domainBaseUrl,publicDomainName:A().A.publicDomainName},duplicateBlocks:!1});const h=C().eC({environment:t,inMemoryRecordCache:i.inMemoryRecordCache,table:g().SC,transaction:c,value:m});o&&(!n||"afterActionId"in n?b().NI({after:null==n?void 0:n.afterActionId,childStore:h,parentStore:s,transaction:c}):"beforeActionId"in n?b().Ti({before:null==n?void 0:n.beforeActionId,childStore:h,parentStore:s,transaction:c}):(0,_().HB)(n),Z({transaction:c,automationStore:s}));const w=Promise.all(i.getBlockStores().map((e=>{const{blockStores:o,onComplete:n}=P().duplicateBlock({environment:t,preferDuplicateLocation:"local",stores:[e],targetSpaceId:(0,S().e)(e.pointer.spaceId),transaction:c,options:{addCopyName:!1,deepCopyTransclusionContainers:!1,resolveTemplateVariables:!1}}),r=o[0];return b().NI({childStore:r,parentStore:h,transaction:c}),n}))),I=h.getModel();return(0,_().O9)(I)&&(0,O().CM)(((e,o,n)=>{const r=(0,V().ik)(t),i=(0,O().zc)({automationActionStore:h,formulaAnalyticsModule:o,formulasModule:e,simpleFormulasModule:n});(0,_().O9)(i)&&(0,l().dW)(r,{automation_action:i,automation_action_id:I.id,automation_id:I.parent_id,from:"duplicate"}),(0,l().c_)(r,{automation_action_id:I.id,automation_action_type:I.type,automation_id:s.id,from:"duplicate"})})),{automationActionStore:h,onComplete:w}}function L(e){const{automationStore:t,automationTypecheckModule:o,contextType:n,environment:r,formulasModule:i,from:a,intl:l,isSubscribed:c,movedActionId:s,newActionIds:p,transaction:d}=e;C().zv({store:t,transaction:d,data:{action_ids:p}}),Z({automationStore:t,transaction:d});K({automationStore:t,transaction:d,typecheckResult:(0,N().Z)({environment:r,automationStore:t,automationTypecheckModule:o,contextType:n,formulasModule:i,intl:l,isSubscribed:c})}),(0,V().u4)({environment:r,event:{eventName:"automation_action_move",eventProperties:{automation_id:t.id,automation_action_id:s,from:a}}})}function q(e){const{actionStore:t,automationStore:o,automationTypecheckModule:n,contextType:r,environment:i,formulasModule:a,intl:c,isSubscribed:s,transaction:p}=e,d=(0,N().Z)({environment:i,automationStore:o,automationTypecheckModule:n,contextType:r,formulasModule:a,intl:c,isSubscribed:s});!function(e){const{automationActionStore:t,automationStore:o,environment:n,transaction:r,hasError:i=!1}=e;let a=t.getParentStore();if((0,_().O9)(o)){const e=t.getParentPointer();if(!(0,_().O9)(e))throw new Error("Automation action does not have a parent pointer");if(!f().L3.isEqual(e,o.pointer))throw new Error(`Automation action parent pointer does not match argument: ${f().L3.toKey(e)}, ${f().L3.toKey(o.pointer)}`);a=o}else if(!(0,_().O9)(a))throw new Error("Automation store is undefined");b().zz({childStore:t,parentStore:a,transaction:r});const c=t.getModel();(0,_().O9)(c)&&(0,O().CM)(((e,o,r)=>{const s=(0,V().ik)(n),p=(0,O().zc)({automationActionStore:t,formulaAnalyticsModule:o,formulasModule:e,simpleFormulasModule:r});(0,_().O9)(p)&&(0,l().YO)(s,{automation_action:p,automation_action_id:c.id,automation_id:c.parent_id,has_error:i}),(0,l().gW)(s,{automation_action_id:c.id,automation_action_type:c.type,automation_id:a.id,has_error:i})}))}({automationActionStore:t,environment:i,transaction:p,hasError:(I().Q.isSuccess(d)&&d.value.actionValidationFailures[t.id]||[]).length>0}),K({automationStore:o,transaction:p,typecheckResult:d})}function Q(e){const{environment:t,automationStore:o,automationTypecheckModule:n,contextType:r,formulasModule:i,intl:a,isSubscribed:l,transaction:c}=e;K({automationStore:o,transaction:c,typecheckResult:(0,N().Z)({environment:t,automationStore:o,automationTypecheckModule:n,contextType:r,formulasModule:i,intl:a,isSubscribed:l})})}function Z(e){const{automationStore:t,transaction:o}=e;t.getSpaceId()&&t.getActionStores().forEach(((e,t)=>{var n;if(!e.isDefined())return;const r=e.getModel();r.isType("open_page")&&"url"===(null===(n=r.getConfig())||void 0===n||null===(n=n.target)||void 0===n?void 0:n.type)&&!(0,a().cQ)(t)&&C().zv({store:e.getConfigStore(),transaction:o,data:{target:null}})}))}function K(e){const{automationStore:t,transaction:o,typecheckResult:n}=e,r=t.getSpaceId(),i=t.getModel();if(r&&i&&!I().Q.isFail(n))for(const a of i.getActionIds()){const e=t.getRecordStore(t,{table:g().SC,id:a,spaceId:r});if(!e.isDefined())continue;const i=e.getModel(),l=new Set(n.value.actionInputValueTypes[a].map((e=>{if(e.kind===u().FormulaContextValueKind.Binding||e.kind===u().FormulaContextValueKind.ContextValue)return e.id;e.kind!==u().FormulaContextValueKind.ThisRow&&(0,_().HB)(e)})).filter(_().O9)),{value:s}=(0,c().G)({automationActionModel:i,baseUrl:A().A.domainBaseUrl,preventClearingConfig:!0,publicDomainName:A().A.publicDomainName,sourceSpaceId:r,visitors:{visitCollectionProperty:void 0,visitCollectionPropertyPointer:void 0,visitFormulaContextValue:e=>l.has(e)?{type:"keep"}:{type:"replace",value:void 0},visitFormulaPageProperty:void 0,visitRecordPointer:void 0}}),p=m().op.update({pointer:e.pointer,path:["config"],args:s.getConfig()??{}});M().applyOperation({store:e,operation:p,transaction:o})}}function j(e){const{environment:t,contentStore:o,transaction:n}=e,r=C().Wv({environment:t,type:"text",inMemoryRecordCache:o.inMemoryRecordCache,transaction:n,spaceId:o.pointer.spaceId});return T().BC({parentStore:o,appendStore:r,transaction:n}).childStore}function H(e){const{automationStore:t,environment:o,transaction:n}=e;C().zv({store:t,data:{status:"active"},transaction:n});const r=t.getModel();(0,_().O9)(r)&&(0,O().CM)(((e,n,i)=>{const a=(0,E().To)(t);let c=[];a&&I().Q.isSuccess(a)&&(c=a.value.valueTypes);const s=(0,V().ik)(o),p=(0,l().sp)({automationModel:r,formulaAnalyticsModule:n,formulasModule:e,formulaTypecheckContextValues:c,getRecordModel:t.getRecordModel,featureGates:(0,x().i)(),simpleFormulasModule:i});(0,l().Ah)(s,p)}))}function X(e){const{automationStore:t,environment:o,status:n,transaction:r}=e,i=n??"disabled";C().zv({store:t,data:{status:i},transaction:r}),t.isTriggerType("recurrence")&&C().zv({store:t,data:{run_at:void 0},transaction:r});const a=t.getModel();(0,_().O9)(a)&&(0,O().CM)(((e,n,r)=>{const i=(0,E().To)(t);let c=[];i&&I().Q.isSuccess(i)&&(c=i.value.valueTypes);const s=(0,V().ik)(o),p=(0,l().sp)({automationModel:a,formulaAnalyticsModule:n,formulasModule:e,formulaTypecheckContextValues:c,getRecordModel:t.getRecordModel,featureGates:(0,x().i)(),simpleFormulasModule:r});(0,l().vN)(s,p)}))}function Y(e){const{automationStore:t,environment:o,transaction:n}=e;C().zv({store:t,data:{alive:!1},transaction:n});const r=t.getModel();(0,_().O9)(r)&&(0,O().CM)(((e,n,i)=>{const a=(0,E().To)(t);let c=[];a&&I().Q.isSuccess(a)&&(c=a.value.valueTypes);const s=(0,V().ik)(o),p=(0,l().sp)({automationModel:r,formulaAnalyticsModule:n,formulasModule:e,formulaTypecheckContextValues:c,getRecordModel:t.getRecordModel,featureGates:(0,x().i)(),simpleFormulasModule:i});(0,l().Iv)(s,p)}))}},132731:(e,t,o)=>{"use strict";o.d(t,{P:()=>l});var n=()=>o(89646),r=()=>o(34662),i=()=>o(432590),a=()=>o(963002);function l(e){var t;const{collectionStore:o}=e,l=(0,r().q4_)(o.getName())||"";return{type:"database",key:(0,n().L)(l),name:l,version:a().Nh.database.latestVersion,state:{collection:null===(t=o.getModel())||void 0===t?void 0:t.__IM_SORRY__getValue(),propertyKeyToIdMap:(0,i().jL)(o.getSchema()),pointer:o.getSpaceShardedPointer(),accessScope:(0,i().fX)(o.getRole()??"none")}}}},141479:(e,t,o)=>{"use strict";o.d(t,{N:()=>n,s:()=>r});const n=["pre_signup_build_with_ai"],r={select_and_customize_template:["templateSelection","features","viewsSelection"],customize_template:["features","viewsSelection"],select_and_build_with_ai:["templateSelection","setupGeneratorInput","setupGeneratorBuilding","features","viewsSelection"],build_with_ai:["setupGeneratorInput","setupGeneratorBuilding","features","viewsSelection"],new_user_template_onboarding:["templateSelection","setupGeneratorBuilding","features","viewsSelection"],pre_signup_build_with_ai:["setupGeneratorInput","setupGeneratorBuilding","features","viewsSelection"]}},165786:(e,t,o)=>{"use strict";o.d(t,{VG:()=>G,Vn:()=>O,aP:()=>R,fI:()=>Q,WF:()=>L,zf:()=>W,Wq:()=>x,hx:()=>F,WE:()=>$,gj:()=>z,kh:()=>q,GS:()=>E,g6:()=>B,D7:()=>N});o(610931),o(362833),o(725707),o(491955),o(500234),o(324989),o(403517);var n=()=>o(3311),r=()=>o(76394),i=()=>o(876096),a=()=>o(668337),l=()=>o(123047);function c(e){const{text:t,baseUrl:o}=e,c=new Map;let s=1;const p=t.replace(/\[(.*?)\]\(#citation:([^)]+)\)/g,((e,t,p)=>{try{const e=decodeURIComponent(p),t=i().tD.parseAssistantHref(e),d=t||((0,n().iv)(e)?{type:"block",blockId:(0,a().ew)(e)}:void 0);if(!d)return"";const u=function(e){const{citation:t,baseUrl:o,type:i}=e;if(!t)throw new Error(`Citation not found for search result of type: ${i}`);if("slack"===t.type)return(0,l().mQ)({...t});if("google-drive"===t.type||"github"===t.type||"helpdoc"===t.type||"helpdoc-section"===t.type||"webpage"===t.type||"gmail"===t.type||"jira"===t.type||"microsoftTeams"===t.type||"sharepoint"===t.type||"linear"===t.type)return t.url;if("block"===t.type)return`${o}/${(0,n().Xw)(t.blockId)}`;if("database_query_results"===t.type);else{if("citation_unsupported"===t.type)return;(0,r().HB)(t)}}({citation:d,baseUrl:o,type:d.type??"unknown"});if(!u)return"";let m=c.get(u);return void 0===m&&(m=s++,c.set(u,m)),` [[${m}]](${u})`}catch(d){return""}}));return p}var s=()=>o(971053),p=()=>o(83043),d=()=>o(519423),u=()=>o(905184),m=()=>o(939499),f=()=>o(403508),v=()=>o(543736),g=()=>o(975392),S=()=>o(818369),h=()=>o(402351),y=()=>o(91472),w=()=>o(145046),I=()=>o(759625),_=()=>o(84543),T=()=>o(927685),b=()=>o(754697),C=()=>o(485966),k=()=>o(92457),M=()=>o(442888),A=()=>o(45524),P=()=>o(312905),V=()=>o(137476);function x(e){const{clientStore:t,environment:o}=e,n=o.RouterStore.state.route,r="chat"===n.name?n.threadId:void 0;r&&t.getOrCreateClientAIChatThreadStore(r).resetState(),t.setState({...t.state,userSelectedConfig:void 0,isAIChatTranscriptSidePanelVisible:!1})}function R(e){const{environment:t,userStore:o,spaceStore:n,transcript:r,blockId:i,transaction:a,threadId:l}=e,c=I().vt({environment:t,table:u().To,args:{id:l??(0,b().Z1)({environment:t,table:u().To,spaceId:n.id}),parentPointer:n.pointer,space_id:n.id,messages:[],data:{workflow_block_id:i},createdByPointer:o.pointer},transaction:a,inMemoryRecordCache:n.inMemoryRecordCache});return r&&O({environment:t,spaceStore:n,threadStore:c,userStore:o,addSteps:r,transaction:a}),c}function B(e){var t;const{threadStore:o,transaction:n}=e;I().zv({store:o.getDataStore(),data:{shared_with_space:!Boolean(null===(t=o.getData())||void 0===t?void 0:t.shared_with_space)},transaction:n})}function E(e){var t;const{threadStore:o,transaction:n,clientStore:r}=e;null===(t=r.getOrCreateClientAIChatThreadStore(o.id).state.abortController)||void 0===t||t.abort(),I().zv({store:o,data:{current_inference_id:null,current_inference_lease_expiration:null},transaction:n})}function O(e){const{environment:t,spaceStore:o,threadStore:n,userStore:r,addSteps:i,transaction:a}=e,l=i.map((e=>I().vt({environment:t,table:m().mS,args:{id:e.id.toString(),parentPointer:n.pointer,space_id:o.id,step:e,createdByPointer:r.pointer},transaction:a,inMemoryRecordCache:o.inMemoryRecordCache})));return _().applyOperation({operation:{args:{ids:l.map((e=>e.id))},command:"listAfterMulti",path:["messages"],pointer:n.pointer},store:n,transaction:a}),l}function F(e){const{threadStore:t,stepIndex:o,transaction:n}=e,r=t.getMessages().slice(o+1);for(const i of r)_().applyOperation({operation:{args:{id:i},command:"listRemove",path:["messages"],pointer:t.pointer},store:t,transaction:n})}function N(e){const{threadStore:t,stepIndex:o,transaction:n,newValue:r}=e,i=t.getStepStoreAt(o);i&&I().zv({store:i,data:{value:r},transaction:n})}async function $(e){var t,o,r;const{clientStore:i,environment:a,threadStore:l,createThreadArgs:c,waitBeforeSending:s,analyticsArgs:f}=e,g=(null==l?void 0:l.getTranscript())??(null==c?void 0:c.transcript)??[];if(0===g.length)throw new Error("No transcript");const h=null===(t=C().default.state.currentSpaceStore)||void 0===t?void 0:t.id;if(!h)throw new Error("No space id");const y=C().default.state.currentSpaceViewStore;if(!y)throw new Error("No space view store");const T=(null==l?void 0:l.id)??(null==c?void 0:c.id);if(!T)throw new Error("No thread id");const{model:b}=i.state,{cachedInferences:A,annotationInferences:P}=(0,M().Hg)(i,T),x=new AbortController,R={};for(const n of A){if(!n.value.expected)throw new Error("No expected output for cached inference");if((0,p().Mt)(n.value.expected))throw new Error("Merged response not supported");R[n.key]=n.value.expected}const B={};for(const n of P)n.value.input.annotation&&(B[n.key]=n.value.input.annotation);const E=(0,n().Ay)(),O=i.getOrCreateClientAIChatThreadStore(T);O.setState({...O.state,inferences:[],temporarySteps:(null==c?void 0:c.transcript)??[],abortController:x,traceId:E,loading:!0}),O.state.stopInferencePromise&&(await O.state.stopInferencePromise,O.setState({...O.state,stopInferencePromise:void 0}));const F=Boolean(null==l||null===(o=l.getData())||void 0===o?void 0:o.title),N={traceId:E,spaceId:h,transcript:g,threadId:T,threadParentPointer:null==c?void 0:c.parentPointer,threadWorkflowBlockId:null==c?void 0:c.workflowBlockId,createThread:void 0===l,debugOverrides:{...i.state.debugOverrides,cachedInferences:R,annotationInferences:B,model:b,emitInferences:i.state.showDebug,agentModelConfig:i.state.agentModelConfig},generateTitle:!F,saveAllThreadOperations:"auto_accept"===(null===(r=y.getSettings())||void 0===r?void 0:r.agent_perist_strategy),analyticsArgs:f};i.state.showDebug&&O.setState({...O.state,requestInfo:{request:N,response:void 0,memory:void 0}});try{s&&await s,await async function(e){const{environment:t,abortController:o,clientStore:n,request:r}=e,i=await S().callStreamApi({eventName:"runInferenceTranscript",environment:t,data:r,abortSignal:o.signal,headers:(0,d().WS)({spaceId:r.spaceId})});if("failed"===i.type)throw i.error;const a=r.threadId?function(e){const{environment:t,threadId:o,transcript:n,traceId:r,analyticsArgs:i}=e,a=(0,M().JD)(n),l=a&&"search"===a.type?a.searchSessionId:void 0,c=Date.now();let s=n.filter((e=>"user"===e.type)).length>1,p=n.filter((e=>"user"===e.type)).length>1,d=!1,u=!1;return{deepFindResultsOnClient:()=>{s||((0,k().hp)({environment:t,assistantSessionId:void 0,searchSessionId:l,threadId:o,timeSinceTurnStartMs:Date.now()-c}),s=!0)},deepFindBeginAiAnswer:()=>{p||((0,k().S9)({environment:t,assistantSessionId:void 0,searchSessionId:l,threadId:o,timeSinceTurnStartMs:Date.now()-c}),p=!0)},beginInferenceTranscriptTurn:()=>{d||(!function(e){(0,V().u4)({environment:e.environment,event:{eventName:"inference_transcript_start_turn",eventProperties:{thread_id:e.threadId,trace_id:e.traceId,config:e.config,suggested_prompt:e.suggestedPrompt}}})}({environment:t,threadId:o,traceId:r,config:a,suggestedPrompt:null==i?void 0:i.suggestedPrompt}),d=!0)},endInferenceTranscriptTurn:e=>{let{isError:n}=e;u||(!function(e){(0,V().u4)({environment:e.environment,event:{eventName:"inference_transcript_end_turn",eventProperties:{thread_id:e.threadId,trace_id:e.traceId,is_error:e.isError}}})}({environment:t,threadId:o,traceId:r,isError:n}),u=!0)}}}({environment:t,threadId:r.threadId,transcript:r.transcript,traceId:r.traceId,analyticsArgs:r.analyticsArgs}):{deepFindResultsOnClient:()=>{},deepFindBeginAiAnswer:()=>{},beginInferenceTranscriptTurn:()=>{},endInferenceTranscriptTurn:()=>{}};if(v().hS.is(i.data)){a.beginInferenceTranscriptTurn();let e=!1;for await(const o of i.data)"error"===o.type&&(e=!0),D({environment:t,request:r,clientStore:n,value:o}),U({analyticsController:a,value:o});a.endInferenceTranscriptTurn({isError:e})}}({environment:a,abortController:x,clientStore:i,request:N})}catch($){W(x,$)?function(e){const{environment:t,clientStore:o,threadId:n,spaceId:r}=e,{currentUserStore:i}=C().default.state;if(!i)throw new Error("No current user root store");const a=o.getOrCreateClientAIChatThreadStore(n);_().createAndCommit({userAction:"inferenceTranscriptActions.handleAbort",environment:t,canUndo:!0,perform:e=>{for(const o of a.state.temporarySteps)I().vt({environment:t,table:m().mS,args:{id:o.id.toString(),parentPointer:{id:n,table:u().To,spaceId:r},space_id:r,step:o,createdByPointer:i.pointer},transaction:e,inMemoryRecordCache:i.inMemoryRecordCache})}})}({environment:a,clientStore:i,threadId:T,spaceId:h}):w().rG({message:$ instanceof Error?$.message:"Unknown error"})}O.setState({...O.state,abortController:void 0,loading:!1})}function W(e,t){return t instanceof Error&&"AbortError"===t.name&&e.signal.aborted}function U(e){const{analyticsController:t,value:o}=e;"search"===o.type&&"resultsPartial"===o.status&&t.deepFindResultsOnClient(),"search-chat"===o.type&&t.deepFindBeginAiAnswer()}function D(e){const{request:t,clientStore:o,value:n,environment:r}=e,i=r.currentUser.id,a=t.threadId;if(!a)return;const l=o.getOrCreateClientAIChatThreadStore(a);if(h().s({environment:r,eventName:"runInferenceTranscript",response:n,userId:i}),"queue-handoff"!==n.type&&"record-map"!==n.type&&"workflow"!==n.type)if("inference"===n.type){const e={type:"inference",key:(0,f().$A)(n.value.input),index:n.index,value:n.value},t=g().Ul([...l.state.inferences,e],(e=>e.index));l.setState({...l.state,inferences:t})}else{const e=(0,p().RM)(l.state.temporarySteps,n);if(l.setState({...l.state,temporarySteps:e}),o.state.showDebug){const o={transcript:e};l.setState({...l.state,requestInfo:{request:t,response:o,memory:void 0}})}}}async function z(e){const{environment:t,onResponse:o,data:n,userId:r,tracking:i,abortSignal:a}=e,l=await S().callStreamApi({eventName:"runInferenceTranscript",environment:t,data:n,userId:r,tracking:i,abortSignal:a,headers:(0,d().WS)({spaceId:n.spaceId})});if("success"!==l.type)return w().Qg(l),{error:{message:l.error.message,code:l.status}};const c=[];if(v().hS.is(l.data))for await(const s of l.data){if("error"===s.type)return{error:{message:s.message,code:s.errorCode}};null==o||o(s),c.push(s)}return{value:c}}async function G(e){const{environment:t,step:o}=e;let n;if("markdown-chat"===o.type||"fast-researcher-chat"===o.type)n=o.value;else if("search-chat"===o.type){n=c({text:(0,M().Jz)(o.value),baseUrl:T().A.domainBaseUrl})}else{if("workflow-inference"!==o.type&&"agent-inference"!==o.type)throw new Error("Unsupported step type");n=(0,s().lH)(o.value).flatMap((e=>"text"===e.type?[e.content]:[])).join("")}const r=await y().R.clipboardActions.load();await r.copyString({environment:t,stringValue:n,copiedMessage:r.clipboardMessages.copiedQnAMessageToClipboard})}function L(e){const{environment:t,threadStore:o,stepIndex:n,analyticsArgs:r}=e;_().createAndCommit({userAction:"AIChatTranscript.RunFromStepButton.handleClick",environment:t,canUndo:!0,perform:e=>{F({threadStore:o,stepIndex:n,transaction:e})}}),$({environment:t,threadStore:o,clientStore:P().Kd,analyticsArgs:r})}function q(e){const{threadStore:t,config:o,environment:n}=e;if(!t)return;const{currentSpaceStore:r,currentSpaceViewStore:i}=C().default.state;if(!r||!i)return;const a=t.getTranscript(),l=t.getMessageStores(),c=a.findIndex((e=>"config"===e.type)),s=a[c],p=l[c];if(c<0||!p||!s||"config"!==s.type)return;if(s.value.type!==o.type)return;const d={...s,value:o};_().createAndCommit({userAction:"AIChatTranscript.setConfigInThread",environment:n,canUndo:!0,perform:e=>{I().KY({store:p.getStepStore(),value:d,transaction:e})}})}function Q(e){const{spaceStore:t}=e;return(0,A().xm)({spaceStore:t}).find((e=>"researcher"===e.type))??{type:"researcher"}}},197562:(e,t,o)=>{"use strict";o.d(t,{A:()=>i});class n extends(()=>o(129044))().default{getInitialState(){return{open:!1,isShowingLoadingState:!1}}updateUserCustomizations(e,t){this.state.open&&this.state.collectionTemplate&&this.setState({...this.state,userCustomizations:{...this.state.userCustomizations,[e]:t}})}updateCollectionTemplate(e){this.state.open&&this.state.collectionTemplate&&this.setState({...this.state,collectionTemplate:e})}updatePreviewFocusViewTemplateId(e){this.state.open&&this.state.collectionTemplate&&this.state.previewCollectionInfo&&this.state.previewCollectionInfo.focusViewTemplateId!==e&&this.setState({...this.state,previewCollectionInfo:{...this.state.previewCollectionInfo,focusViewTemplateId:e}})}updatePreviewCollectionContextStore(e){this.state.open&&this.state.collectionTemplate&&this.state.previewCollectionInfo&&this.state.previewCollectionInfo.collectionContextStore!==e&&this.setState({...this.state,previewCollectionInfo:{...this.state.previewCollectionInfo,collectionContextStore:e}})}getPreviewCollectionContextStore(){if(this.state.open&&this.state.collectionTemplate&&this.state.previewCollectionInfo)return this.state.previewCollectionInfo.collectionContextStore}getParentStore(){return this.state.open?this.state.parentStore:void 0}getShouldShowExpandedTemplateList(){return this.state.open&&this.state.shouldShowExpandedTemplateList}setShouldShowExpandedTemplateList(e){this.state.open&&this.setState({...this.state,shouldShowExpandedTemplateList:e})}close(e){var t,o;this.state.open&&(null===(t=(o=this.state).onClose)||void 0===t||t.call(o,e),this.setState({open:!1,isShowingLoadingState:!1}))}reset(){this.setState(this.getInitialState())}}const r=new n;(0,o(996094).exposeDebugValue)("InitializeWorkflowTemplateModalStore",r);const i=r},271925:(e,t,o)=>{"use strict";o.d(t,{$h:()=>r,IA:()=>c,NW:()=>l,Q4:()=>a,bE:()=>s,sr:()=>i,xb:()=>n});o(610931),o(725707),o(500234);function n(e){const{pointer:t,module:o}=e;return{pointer:t,command:"keyedObjectListUpdate",path:["data","modules"],args:{key:"key",value:o}}}function r(e){const{pointer:t,module:o}=e;return{pointer:t,command:"keyedObjectListRemove",path:["data","modules"],args:{key:"key",remove:o}}}function i(e){const{pointer:t,functionPointer:o}=e;return{pointer:t,command:"keyedObjectListUpdate",path:["data","functionPointers"],args:{key:"id",value:o}}}function a(e){const{pointer:t,functionPointer:o}=e;return{pointer:t,command:"keyedObjectListRemove",path:["data","functionPointers"],args:{key:"id",remove:o}}}function l(e){const{pointer:t,trigger:o}=e;return{pointer:t,command:"keyedObjectListUpdate",path:["data","triggers"],args:{key:"key",value:o}}}function c(e){const{pointer:t,triggers:o}=e;return{pointer:t,command:"set",path:["data","triggers"],args:o}}function s(e){const{pointer:t,configVariable:o}=e;return{pointer:t,command:"update",path:["data","configVariables",o.key],args:o}}},368904:(e,t,o)=>{"use strict";o.d(t,{DF:()=>d,If:()=>p,Vd:()=>s,g2:()=>c,os:()=>a,ux:()=>l});var n=()=>o(809226),r=()=>o(137476),i=()=>o(836331);function a(e){let{environment:t,eventProperties:o}=e;const n="suggested_collection_template_clicked";(0,r().u4)({environment:t,event:{eventName:n,eventProperties:o}}),i().default.logEvent(n,o.collection_template_id,o)}function l(e){let{environment:t,eventProperties:o}=e;(0,r().u4)({environment:t,event:{eventName:"suggested_personal_school_template_clicked",eventProperties:o}})}function c(e){let{environment:t,eventProperties:o,modalState:a}=e;const l="workflow_template_onboarding_done";var c;((0,r().u4)({environment:t,event:{eventName:l,eventProperties:o}}),i().default.logEvent(l,o.collection_template_id,o),n().u4({name:"collection_created_from_workflow_template",args:{template_id:o.collection_template_id??"",origin:o.origin,experiment_group:"personalized"}}),a.collectionTemplate.isAiGenerated)&&(null===(c=a.setupGenerator)||void 0===c||c.trackSessionEnded({reason:"instantiated"}))}function s(e){let{environment:t,eventProperties:o}=e;const n="setup_generator_session_started";(0,r().u4)({environment:t,event:{eventName:n,eventProperties:o}}),i().default.logEvent(n,void 0,o)}function p(e){let{environment:t,eventProperties:o}=e;const n="setup_generator_generated_setup";(0,r().u4)({environment:t,event:{eventName:n,eventProperties:o}}),i().default.logEvent(n,void 0,o)}function d(e){let{environment:t,eventProperties:o}=e;const n="template_picker_opened";(0,r().u4)({environment:t,event:{eventName:n,eventProperties:o}}),i().default.logEvent(n,o.origin,o)}},376896:(e,t,o)=>{"use strict";o.d(t,{Kg:()=>c,Pg:()=>s,nN:()=>p,vW:()=>d});o(362833),o(725707),o(500234);var n=()=>o(505966),r=()=>o(564134),i=()=>o(975392),a=()=>o(76394),l=()=>o(901552);function c(e){var t;let{propertyId:o,propertyTemplate:n,firstTableViewInfo:r}=e;const i=null==r||null===(t=r.format.table_properties)||void 0===t?void 0:t.find((e=>e.property===o));if(i){const{property:e,...t}=i;n.tablePropertyFormat=t}}function s(e){const{type:t}=e;switch(t){case"title":case"text":case"checkbox":case"number":case"person":case"file":case"url":case"email":case"phone_number":case"created_time":case"created_by":case"last_edited_time":case"last_edited_by":case"last_visited_time":case"date":case"select":case"multi_select":case"status":case"formula":case"relation":case"auto_increment_id":case"button":return!0;case"rollup":case"location":case"verification":case"geo_point":return!1;default:(0,a().HB)(t)}}function p(e){if("relation"===e.type)return{type:"relation",name:e.name,autoRelate:e.autoRelate};const t=(0,i().mg)(e);if(delete t.workflow_template_instance,(0,r().DQ)(t)&&t.options)for(const o of t.options)delete o.collectionIds;return t}function d(e){let{propertyTemplateValue:t,mapper:o}=e;const r=[];if((0,n().$G)({object:t,callback:e=>{const t=e.property;r.push(t)}}),0===r.length)return;const i={};for(const n of r)o.populateDependencyMap((0,l().vO)({type:"property",id:n}),i);return i}},432590:(e,t,o)=>{"use strict";o.d(t,{KO:()=>c,fX:()=>m,jL:()=>s});o(610931),o(725707),o(500234),o(324989),o(771702),o(403517);var n=()=>o(3311),r=()=>o(627618),i=()=>o(446588),a=()=>o(145017),l=()=>o(39559);function c(){return{id:(0,n().Ay)(),parent_table:a().ev,parent_id:l().KB,space_id:l().KB,alive:!0,version:1}}function s(e){const t={};for(const[o,n]of Object.entries(e))n&&(t[u(n.name)]=o);return t}const p="userDefined:",d=["id","url"];function u(e){const t=e.toLowerCase();return d.includes(t)?`${p}${e}`:e}r().array(r().string());function m(e){return(0,i().p2)(e)?"write":"read"}},442888:(e,t,o)=>{"use strict";o.d(t,{A3:()=>d,Ft:()=>w,HS:()=>h,Hg:()=>p,JD:()=>u,Jz:()=>y,Ns:()=>m,Pp:()=>_,ZR:()=>g,_R:()=>f,l0:()=>I,o6:()=>S,tC:()=>v});o(754309),o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601),o(725707),o(491955),o(500234),o(324989),o(403517);var n=()=>o(712437),r=()=>o(34662),i=()=>o(975392),a=()=>o(76394),l=()=>o(29869),c=()=>o(638907),s=()=>o(644094);function p(e,t){if(!t)return{cachedInferences:[],annotationInferences:[]};const{inferences:o,inferenceKeysToAnnotations:n,acceptedInferenceKeys:r}=e.getOrCreateClientAIChatThreadStore(t).state,a=new Map;for(const i of o)a.set(i.key,i);return{cachedInferences:i().oE(r.map((e=>a.get(e)))),annotationInferences:i().oE(Object.entries(n).map((e=>{let[t,o]=e;const n=a.get(t);if(n)return{...n,value:{...n.value,input:{...n.value.input,annotation:o}}}})))}}function d(e){const{clientStore:t,threadStore:o}=e,n=null==o?void 0:o.id;if(!n)return[];const r=((null==o?void 0:o.getMessageStores())??[]).map((e=>e.getStep())).filter(a().O9)??[],i=new Set(r.map((e=>e.id))),l=t.getOrCreateClientAIChatThreadStore(n).state.temporarySteps;return[...r.map((e=>l.find((t=>t.id===e.id))??e)),...l.filter((e=>!i.has(e.id)))].filter((e=>"title"!==e.type))}function u(e){const t=e.find((e=>"config"===e.type));if(t)return t.value}function m(e){return u(e?e.getTranscript():[])}function f(e,t){const o=t.findIndex((t=>t.id===e.id));if(-1!==o)return t.slice(0,o).findLast((e=>"user"===e.type))}function v(e){return"helpdocs"===e?"helpdoc":e}function g(e){return"helpdoc"===e?"helpdocs":"all"===e?"notion":e}function S(e){const{searchStep:t,spaceStore:o,environment:i,traceId:p}=e;return e=>{if(!o)return{annotations:[e],status:"missing_citation"};if("resultsComplete"!==(null==t?void 0:t.status)&&"resultsBlended"!==(null==t?void 0:t.status))return{annotations:[e],status:"missing_citation"};const d=Object.entries(t.results).flatMap((e=>{let[t,o]=e;return o.map(((e,t)=>({...e,position:t})))}));return function(e){let{linkAnnotation:t,getRenderableSearchResultAndPositionById:o,environment:i}=e;const s=r().cQR(t);if(!s)return{annotations:[t],status:"other_link"};const p=s.indexOf("#citation:");if(-1===p)return{annotations:[t],status:"other_link"};const d=o(decodeURIComponent(s.slice(p+10)));return d?{annotations:[function(e){const t={resultId:e.id,positionWithinSource:e.positionWithinSource,traceId:e.traceId};return"notion"===e.type?r().X$({...t,href:(0,l().J8)({store:new(c().B)(i,{table:"block",id:e.id}),fullyQualified:!1,pageVisitSource:n().y8.AIQna}),blockId:e.id,type:"block"}):"slack"===e.type?r().X$({...t,href:e.href,threadHref:e.href,type:"slack",domain:e.domain,baseUrl:e.baseUrl,channelId:e.channelId,messageId:e.messageId,threadTs:e.threadTs}):"google-drive"===e.type?r().X$({...t,href:e.href,type:"google-drive",messageId:e.id,url:e.url}):"github"===e.type?r().X$({...t,href:e.href,type:"github",messageId:e.id,url:e.url}):"jira"===e.type?r().X$({...t,href:e.href,type:"jira",messageId:e.id,url:e.url}):"webpage"===e.type?r().X$({...t,href:e.href,type:"webpage",url:(null==e?void 0:e.url)||""}):"helpdoc-section"===e.type?r().X$({...t,type:"helpdoc-section",href:e.href,url:e.url,parentPageHref:e.parentPageHref}):"helpdocs"===e.type?r().X$({...t,type:"helpdoc",href:e.href,url:e.url}):"gmail"===e.type?r().X$({type:"gmail",href:e.href,url:e.url,messageId:e.id}):void(0,a().HB)(e)}(d)],status:"citation"}:{annotations:[t],status:"missing_citation"}}({linkAnnotation:e,getRenderableSearchResultAndPositionById:e=>{const t=d.find((t=>decodeURIComponent(t.key)===e));if(!t)return;const n=(0,s().K)(t.result,o);return n?{...n,positionWithinSource:t.position,traceId:p}:void 0},environment:i})}}const h=/\[\]\((.*?)\)/g;function y(e){return e.replace(/\[\]\((.*?)\)/g,((e,t)=>`[citation](#citation:${t})`))}function w(e){let{clientStore:t,threadStore:o}=e;return Boolean(void 0!==(null==o?void 0:o.getCurrentInferenceId())||(null==o?void 0:o.id)&&t.getOrCreateClientAIChatThreadStore(o.id).state.loading)}function I(e){return"resultsBlended"===e.status||"resultsComplete"===e.status||"resultsPartial"===e.status||"generatingQuery"!==e.status&&"searching"!==e.status&&void(0,a().HB)(e)}function _(e){return"resultsComplete"===e.status||"resultsBlended"===e.status||"resultsPartial"!==e.status&&"generatingQuery"!==e.status&&"searching"!==e.status&&void(0,a().HB)(e)}},459845:(e,t,o)=>{"use strict";o.d(t,{CM:()=>u,UB:()=>d,zc:()=>p});o(725707),o(491955),o(403517);var n=()=>o(779698),r=()=>o(204132),i=()=>o(76394),a=()=>o(73631),l=()=>o(137476),c=()=>o(213517),s=()=>o(271142);function p(e){const{automationActionStore:t,automationStore:o,formulaAnalyticsModule:a,formulasModule:l,simpleFormulasModule:p}=e,d=t.getModel(),u=o??t.getParentStore();if(!d||!u)return;const m=u.getActionStores().map((e=>e.getModel())).filter(i().O9),f=(0,s().To)(u);let v=[];return f&&r().Q.isSuccess(f)&&(v=f.value.valueTypes),(0,n()._f)({automationActionModel:d,automationActionModels:m,formulaAnalyticsModule:a,formulasModule:l,simpleFormulasModule:p,formulaTypecheckContextValues:v,getRecordModel:t.getRecordModel,featureGates:(0,c().i)()})}function d(e,t){const{automationStore:o,automationActionStore:n}=t;o.isTriggerType("event")||u(((t,r,i)=>{const a=p({automationActionStore:n,automationStore:o,formulaAnalyticsModule:r,formulasModule:t,simpleFormulasModule:i});a&&(0,l().pM)(e,"automation_action_update",n.id,1,{automation_action:a,automation_action_id:n.id,automation_id:o.id})}))}function u(e){return Promise.all([a().T.formulas.load(),a().T.formulaAnalytics.load(),a().T.simpleFormulas.load()]).then((t=>{let[o,n,r]=t;e(o,n,r)})).catch((e=>{console.error("Error sending analytics for automations",e)}))}},503780:(e,t,o)=>{"use strict";o.r(t),o.d(t,{addStepsToExistingThreadAndRun:()=>O,addTranscriptToNewThreadAndRun:()=>B,addTranscriptToNewThreadOnClientAndRun:()=>E,appendWorkflowSetupUpdate:()=>R,createEmptyWorkflowContainerAndBuild:()=>G,overrideWorkflowData:()=>L,removeModule:()=>D,requestEditWorkflowFunction:()=>Q,runWorkflowFunction:()=>q,saveConfigVariable:()=>N,saveFunction:()=>U,saveModule:()=>F,saveTrigger:()=>W,saveTriggers:()=>$});o(610931),o(725707),o(491955),o(403517);var n=()=>o(897376),r=()=>o(519423),i=()=>o(145017),a=()=>o(528762),l=()=>o(905184),c=()=>o(829629),s=()=>o(304459),p=()=>o(34662),d=()=>o(271925),u=()=>o(543736),m=()=>o(3311),f=()=>o(76394),v=()=>o(818369),g=()=>o(927999),S=()=>o(759625),h=()=>o(84543),y=()=>o(165786),w=()=>o(662861),I=()=>o(312905),_=()=>o(782422),T=()=>o(754697),b=()=>o(485966),C=()=>o(413871),k=()=>o(752414),M=()=>o(132731),A=()=>o(308265),P=()=>o(670298),V=()=>o(993054);function x(e){const{environment:t,threadStore:o,operations:n,transaction:i,blockStore:a}=e;if(0===n.length)return;const{currentUserStore:l,currentSpaceStore:c}=b().default.state;if(!l)throw new Error("No current user");const s=b().default.state.currentSpaceViewStore;if(!s)throw new Error("No current space view");if(!c)throw new Error("No current space");const p=[(0,P().dy)({operations:n})];if(o)(0,y().Vn)({threadStore:o,environment:t,spaceStore:c,userStore:l,addSteps:p,transaction:i});else{const e=(0,P().Y$)({environment:t,spaceStore:c,userStore:l,spaceViewStore:s,addSteps:p,store:a}),o=(0,y().aP)({environment:t,spaceStore:c,userStore:l,transaction:i,transcript:e,blockId:a.id});!async function(e){const{environment:t,threadStore:o,spaceId:n}=e;if(o.getDataStore().getKeyStore("title").getValue())return;const i=(null==o?void 0:o.getMessageStores())??[],a=i.map((e=>e.getStep())).filter(f().O9)??[],l={traceId:(0,m().lZ)(),spaceId:n,transcript:a,generateTitle:!0},c=await v().callStreamApi({eventName:"runInferenceTranscript",environment:t,data:l,headers:(0,r().WS)({spaceId:l.spaceId})});if("failed"===c.type)throw c.error;if(u().hS.is(c.data))for await(const r of c.data)"title"===r.type&&h().createAndCommit({userAction:"WorkflowActions.generateWorkflowTitle",environment:t,canUndo:!0,perform:e=>{S().zv({store:o.getDataStore(),data:{title:r.value},transaction:e})}})}({environment:t,threadStore:o,spaceId:c.id}),(0,V().showWorkflowEditor)({environment:t,chatSidebarState:{threadId:o.id},parentStore:a})}}function R(e){const{environment:t,threadStore:o,workflowOperations:r,operations:i,transaction:a}=e,l=b().default.state.currentUserStore;if(!l)throw new Error("No current user");const c=b().default.state.currentSpaceStore;if(!c)throw new Error("No current space");(0,y().Vn)({threadStore:o,environment:t,spaceStore:c,userStore:l,addSteps:[{id:(0,m().lZ)(),type:"workflow-operation",workflowOperations:r??[],threadOperations:(0,n().eB)(i??[])}],transaction:a})}function B(e){const{environment:t,spaceStore:o,transcript:n,threadId:r,blockId:i}=e,c=r??(0,T().Z1)({environment:t,table:l().To,spaceId:o.id});return(0,y().WE)({environment:t,clientStore:I().Kd,threadStore:void 0,createThreadArgs:{id:c,transcript:n,workflowBlockId:i,parentPointer:{table:a().NX,id:o.id,spaceId:o.id}}}),C().Ei.createChildStore(o,{id:c,spaceId:o.id,table:l().To})}function E(e){const{environment:t,spaceStore:o,clientStore:n,userStore:r,transcript:i,threadId:a,analyticsArgs:l}=e,{serverCommitResult:c,performResult:s}=h().createAndCommit({userAction:"WorkflowActions.addTranscriptToNewThreadAndRun",environment:t,canUndo:!0,perform:e=>(0,y().aP)({environment:t,spaceStore:o,userStore:r,transaction:e,transcript:i,threadId:a})});return(0,y().WE)({environment:t,clientStore:n,threadStore:s,waitBeforeSending:c,analyticsArgs:l}),s}function O(e){const{environment:t,userStore:o,spaceStore:n,threadStore:r,addSteps:i,waitForServerCommit:a}=e,{serverCommitResult:l}=h().createAndCommit({userAction:"WorkflowActions.addStepsToExistingThreadAndRun",environment:t,canUndo:!0,perform:e=>{(0,y().Vn)({threadStore:r,environment:t,spaceStore:n,userStore:o,addSteps:i,transaction:e})}});(0,y().WE)({environment:t,clientStore:I().Kd,threadStore:r,waitBeforeSending:a?l:void 0})}function F(e){const{module:t,workflowPointer:o,...n}=e;h().createAndCommit({userAction:"WorkflowActions.saveModule",environment:e.environment,canUndo:!0,perform:e=>{x({...n,transaction:e,operations:[d().xb({pointer:o,module:t})]})}})}function N(e){const{value:t,workflowPointer:o,...n}=e;h().createAndCommit({userAction:"WorkflowActions.saveConfigVariable",environment:e.environment,canUndo:!0,perform:e=>{x({...n,transaction:e,operations:[d().bE({pointer:o,configVariable:t})]})}})}function $(e){const{triggers:t,workflowPointer:o,...n}=e;h().createAndCommit({userAction:"WorkflowActions.saveTriggers",environment:e.environment,canUndo:!0,perform:e=>{x({...n,transaction:e,operations:[d().IA({pointer:o,triggers:t})]})}})}function W(e){const{trigger:t,workflowPointer:o,...n}=e;h().createAndCommit({userAction:"WorkflowActions.saveTrigger",environment:e.environment,canUndo:!0,perform:e=>{x({...n,transaction:e,operations:[d().NW({pointer:o,trigger:t})]})}})}function U(e){const{functionStore:t,fn:o,...n}=e,{environment:r}=n;h().createAndCommit({userAction:"WorkflowActions.saveFunction",environment:e.environment,canUndo:!0,perform:i=>{const a=t.getParentPointer();if(!a)throw new Error("No parent pointer");if(!a.spaceId)throw new Error("No parent space id");const l=S().vt({environment:e.environment,table:s().U6,args:{id:(0,m().lZ)(),type:"function",parentPointer:a,space_id:a.spaceId,data:o},inMemoryRecordCache:r.defaultRecordCache.inMemoryRecordCache,transaction:i});x({...n,operations:[d().Q4({pointer:n.workflowPointer,functionPointer:t.pointer}),d().sr({pointer:n.workflowPointer,functionPointer:l.pointer})],transaction:i})}})}function D(e){const{environment:t,module:o,threadStore:n,workflowPointer:r,blockStore:i}=e;h().createAndCommit({userAction:"WorkflowActions.removeModule",environment:e.environment,canUndo:!0,perform:e=>{x({environment:t,operations:[d().$h({pointer:r,module:o})],transaction:e,threadStore:n,blockStore:i})}})}function z(e){const{environment:t,transaction:o,parentStore:n}=e,{currentSpaceStore:r,currentSpaceViewStore:a}=b().default.state;if(!r||!a)throw new Error("No current space");const l=S().Wv({environment:t,type:"collection_view_page",transaction:o,inMemoryRecordCache:r.inMemoryRecordCache});(0,k().Ls)({environment:t,parentStore:n??r,collectionViewBlockStore:l,transaction:o,appendOrPrepend:"append",spaceViewStore:a});const s=function(e){const{environment:t,store:o,transaction:n}=e,r=function(e){const{store:t}=e,o=t.getCollectionPointers()??[],n=o.map((e=>{const o=C().md.createChildStore(t,e);return(0,M().P)({collectionStore:o})}));return{name:"",modules:n}}({store:o});return function(e){const{environment:t,store:o,transaction:n,workflowData:r}=e,a=S().vt({environment:t,table:c().C0,args:{id:(0,T().Z1)({environment:t,table:c().C0,spaceId:o.getSpaceId()}),data:r,parentPointer:{table:i().ev,id:o.id},space_id:o.getSpaceId()},inMemoryRecordCache:o.inMemoryRecordCache,transaction:n});return g().zA({stores:[o],update:{workflow_id:a.id},transaction:n}),a}({environment:t,transaction:n,store:o,workflowData:r})}({environment:t,store:l,transaction:o});return{workflowStore:s,collectionViewBlockStore:l}}async function G(e){const{environment:t,parentStore:o,userStep:n,onThreadChange:r}=e,i=b().default.state.currentSpaceStore;if(!i)throw new Error("No space store");const a=b().default.state.currentSpaceViewStore;if(!a)throw new Error("No current space view");const l=b().default.state.currentUserStore;if(!l)throw new Error("No user store");const{performResult:c,serverCommitResult:s}=h().createAndCommit({userAction:"SetupGenerator.handlePromptSubmit",environment:t,canUndo:!0,perform:e=>z({environment:t,transaction:e,parentStore:o})});await s;const{collectionViewBlockStore:p}=c,d=(0,P().Y$)({environment:t,spaceStore:i,spaceViewStore:a,userStore:l,store:p,addSteps:[n]}),u=B({environment:t,spaceStore:i,transcript:d,blockId:p.id});(0,A().aj)()?null==r||r(u):(0,V().showWorkflowEditor)({environment:t,parentStore:p,navigationState:{isOpen:!0,type:"configure"},chatSidebarState:{isOpen:!0,threadId:u.id}})}function L(e){const{workflowStore:t,transaction:o,workflow:n}=e;S().KY({store:t.getDataStore(),value:n,transaction:o})}function q(e){const{environment:t,workflowFunction:o,threadStore:n,functionArgs:r,parentStore:i}=e,a=(0,_()._m)(t);if(!a)throw new Error("Could not find valid user store");const l=b().default.state.currentSpaceViewStore;if(!l)throw new Error("No space view store");const c=b().default.state.currentSpaceStore;if(!c)throw new Error("No space store");const s=(0,w().nD)({environment:t,spaceStore:c,workflowFunction:o,functionArgs:r,from:"run-button"});if(n)O({environment:t,spaceStore:c,userStore:a,threadStore:n,addSteps:[s]});else{const e=B({environment:t,spaceStore:c,transcript:(0,P().Y$)({environment:t,spaceStore:c,userStore:a,spaceViewStore:l,store:i,addSteps:[s]})});(0,V().showWorkflowEditor)({environment:t,parentStore:i,chatSidebarState:{isOpen:!0,threadId:e.id}})}}function Q(e){const{environment:t,store:o,runStore:n,threadStore:r,isError:i,userFeedback:a}=e,l=b().default.state.currentSpaceStore;if(!l)throw new Error("WorkflowRunFeedbackButton: spaceStore is undefined");const c=b().default.state.currentSpaceViewStore;if(!c)throw new Error("WorkflowRunFeedbackButton: spaceViewStore is undefined");const s=b().default.state.currentUserStore;if(!s)throw new Error("WorkflowRunFeedbackButton: userStore is undefined");if(!i&&!a)return;if(!o)throw new Error("WorkflowRunFeedbackButton: store is undefined");const d=n.getData();if(!d)throw new Error("WorkflowRunFeedbackButton: runData is undefined");const u=(0,P().fw)({environment:t,spaceStore:l,runStore:n}),m=(0,w().XZ)({environment:t,spaceStore:l,functionKey:d.trigger_key,runId:n.id,message:a?(0,p().x9d)(a):void 0});if(r)O({environment:t,spaceStore:l,userStore:s,threadStore:r,addSteps:[u,m]});else{const e=B({environment:t,spaceStore:l,transcript:(0,P().Y$)({environment:t,spaceStore:l,userStore:s,spaceViewStore:c,store:o,addSteps:[u,m]})});(0,V().showWorkflowEditor)({environment:t,parentStore:o,chatSidebarState:{isOpen:!0,threadId:e.id}})}}},518022:(e,t,o)=>{"use strict";o.r(t),o.d(t,{createCollectionTemplateFromModalState:()=>ne,createMinimalCollectionTemplateWithoutModal:()=>te,createPlaceholderWorkflowTemplateBlock:()=>ce,getSetupGeneratorForTemplate:()=>X,getTemplateOnboardingVersion:()=>j,handleSelectTemplateFromOnboardingModal:()=>J,maybeAddAppTemplateMetadataForTasks:()=>ae,moveToNextOnboardingStep:()=>me,moveToPreviousOnboardingStep:()=>ue,onNavigateToPlaceholderWorkflowTemplateBlock:()=>se,openSelectedTemplateOnboardingModalForInAppFlows:()=>Y,openTemplateOnboardingModal:()=>K,retryAiSetup:()=>pe,setFollowUpInputFocused:()=>de,switchModalToTemplate:()=>ee,toggleFeatureSelectionInPreview:()=>le});o(610931),o(725707),o(491955),o(500234),o(403517);var n=()=>o(712437),r=()=>o(65866),i=()=>o(994966),a=()=>o(505966),l=()=>o(762847),c=()=>o(214144),s=()=>o(34662),p=()=>o(975392),d=()=>o(3311),u=()=>o(204132),m=()=>o(76394),f=()=>o(102659),v=()=>o(927999),g=()=>o(70989),S=()=>o(759625),h=()=>o(191756),y=()=>o(575015),w=()=>o(84543),I=()=>o(960442),_=()=>o(216143),T=()=>o(477784),b=()=>o(922563),C=(o(358848),o(754309),o(516176),o(91270),o(113085),()=>o(939499)),k=()=>o(812815),M=()=>o(137476),A=()=>o(754697),P=()=>o(368904);o(362833);class V{constructor(){this.root=new x}append(e){if(this.root.isEmpty())this.root.addChild(e);else{const t=this.toNodes().at(-1);if(!t)throw new Error("Last node not found");t.addChild(e)}}toNodes(){return this.root.getSelectedPath()}toValues(){return this.toNodes().map((e=>e.value))}removeLast(){const e=this.toNodes().at(-1);if(!e)return;const t=e.value;return e.remove(),t}removeLastMatching(e){const t=this.toNodes().findLastIndex((t=>e(t.value)));if(-1===t)return[];const o=[];for(;this.toNodes().length>t;){const e=this.removeLast();void 0!==e&&o.push(e)}return o}}class x{constructor(){this.children=[],this.selectedChild=void 0}addChild(e){const t=new R(e,this);return this.children.push(t),this.selectedChild=t,t}getSelectedPath(){var e;return(null===(e=this.selectedChild)||void 0===e?void 0:e.toSelectedPath())??[]}isEmpty(){return 0===this.children.length}getChildren(){return this.children}setSelectedChild(e){if(!this.children.includes(e))throw new Error("Cannot select a node that is not a child");this.selectedChild=e}removeChild(e){const t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),this.selectedChild===e&&(this.selectedChild=void 0))}}class R{constructor(e,t){this.value=void 0,this.children=[],this.selectedChild=void 0,this.parent=void 0,this.isRemoved=!1,this.value=e,this.parent=t}addChild(e){const t=new R(e,this);return this.children.push(t),this.selectedChild=t,t}toSelectedPath(){const e=[this];return this.selectedChild&&e.push(...this.selectedChild.toSelectedPath()),e}retry(e){if(this.isRemoved)throw new Error("Cannot retry on a removed node");this.parent.addChild(e)}select(e){if(this.isRemoved)throw new Error("Cannot select on a removed node");const t=this.parent.getChildren(),o=e(t.map((e=>e.value)),this.value);if(void 0===o)return!1;const n=t.find((e=>e.value===o));return n?this.parent.setSelectedChild(n):this.parent.addChild(o),!0}selectOrRetry(e){if(!this.select(e)){const t=e([],void 0);void 0!==t&&this.retry(t)}}remove(){if(this.children.length>0)throw new Error("Cannot remove a node that has children");if(this.isRemoved)throw new Error("Node is already removed");this.parent.removeChild(this),this.isRemoved=!0}getChildren(){return this.children}setSelectedChild(e){if(!this.children.includes(e))throw new Error("Cannot select a node that is not a child");this.selectedChild=e}removeChild(e){const t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),this.selectedChild===e&&(this.selectedChild=void 0),e.isRemoved=!0)}}class B extends(()=>o(129044))().default{getInitialState(){return{isBusy:!1,transcriptTree:new V}}setPrompt(e){this.setState({...this.state,prompt:e})}}class E{constructor(e){this.environment=void 0,this.generatedSetupCount=0,this.store=void 0,this.error=void 0,this.spaceId=void 0,this.eventBase=void 0,this.abortController=void 0,this.onSetupReady=void 0,this.setPrompt=e=>{this.store.setState({...this.store.state,prompt:e})},this.submitPrompt=async e=>{var t;const{from:n}=e,r="follow-up"===n,{isBusy:i,prompt:a}=this.store.state;if(i||!a)return!1;if(!this.spaceId)return!1;this.store.setState({...this.store.state,isBusy:!0}),null===(t=this.store.state.transcriptTree.toNodes().find((e=>"config"===e.value.type)))||void 0===t||t.selectOrRetry((e=>{const t=e.find((e=>"config"===e.type&&"setup-generator"===e.value.type));return t||{id:(0,A().Z1)({environment:this.environment,table:C().mS,spaceId:this.spaceId}),type:"config",value:{type:"setup-generator"}}}));try{var l;const e=this.store.state.transcriptTree.toNodes().find((e=>"user"===e.value.type));if(e&&!r)e.selectOrRetry((e=>{const t=e.find((e=>"user"===e.type&&(0,s().MTk)(a,e.value)));if(t)return t;{var o;const e=null===(o=this.environment.currentUser)||void 0===o?void 0:o.id;if(!e)throw new Error("Current user not found");return{id:(0,A().Z1)({environment:this.environment,table:C().mS,spaceId:this.spaceId}),type:"user",value:a,userId:e}}}));else{var c;const e=null===(c=this.environment.currentUser)||void 0===c?void 0:c.id;if(!e)throw new Error("Current user not found");this.store.state.transcriptTree.append({id:(0,A().Z1)({environment:this.environment,table:C().mS,spaceId:this.spaceId}),type:"user",value:a,userId:e})}const t=this.store.state.transcriptTree.toValues();if(!t.slice(t.findLastIndex((e=>"user"===e.type))+1).some((e=>"setup"===e.type))){const e=(0,d().Ay)(),n=new AbortController;this.abortController=n;let r=!1;try{const i=await(0,o(165786).gj)({environment:this.environment,abortSignal:n.signal,data:{traceId:e,generateTitle:!1,transcript:t,spaceId:this.spaceId},onResponse:e=>{"setup-operations"===e.type&&this.store.setState({...this.store.state,progress:e.progress}),"retry"!==e.type||r||(r=!0,y().D6({label:"This is taking a little longer than usual"}))}});if(this.abortController=void 0,this.store.setState({...this.store.state,progress:void 0,feedbackArgs:this.computeFeedbackArgs()}),!u().Q.isSuccess(i))return k().O8(i.error,{from:"fullPageTranslationActions.generateAndApplyTranslationMapToPage",type:"error"}),this.onSetupReady({error:i.error}),!1;const a=function(e){const t=new Map;for(const o of e){const e="string"==typeof o.id?o.id:String(o.id),n=t.get(e);n&&"setup-operations"===n.type&&"setup-operations"===o.type?t.set(e,{...n,operations:[...n.operations,...o.operations]}):t.set(e,o)}return Array.from(t.values())}(i.value.filter(o(582382).Vf));for(const e of a)this.store.state.transcriptTree.append(e)}finally{this.abortController=void 0}}const n=null===(l=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===l?void 0:l.setup;if(!n)throw new Error("Missing setup step");return this.generatedSetupCount++,this.store.setState({...this.store.state,setup:n,prompt:void 0}),this.trackGeneratedSetup(n),this.onSetupReady({value:n}),!0}catch(p){return p instanceof Error&&"AbortError"===p.name||(k().O8(p,{from:"setupGenerator.submitPrompt",type:"error"}),this.onSetupReady({error:{code:500,message:"Unknown error"}})),!1}finally{this.store.setState({...this.store.state,isBusy:!1,feedbackArgs:this.computeFeedbackArgs()})}},this.stopGenerating=()=>{var e;null===(e=this.abortController)||void 0===e||e.abort()},this.discardLatestSetup=()=>{var e,t;const o=null===(e=this.store.state.transcriptTree.toValues().findLast((e=>"user"===e.type)))||void 0===e?void 0:e.value;if(!o)return;this.store.state.transcriptTree.removeLastMatching((e=>"user"===e.type));const n=null===(t=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===t?void 0:t.setup;this.store.setState({...this.store.state,prompt:o,setup:n,feedbackArgs:this.computeFeedbackArgs()}),n&&this.onSetupReady({value:n}),(0,M().u4)({environment:this.environment,event:{eventName:"setup_generator_try_again_clicked",eventProperties:this.eventBase}})};const{environment:t,spaceId:n,onSetupReady:r,initialPrompt:i,analyticsArgs:a}=e;if(this.environment=t,this.spaceId=n,this.eventBase={flow_id:a.workflowTemplatesFlowId??(0,d().Ay)(),origin:a.origin,has_selection_modal_search_query:a.hadSelectionModalSearchEntered},this.store=new B,this.store.state.transcriptTree.append({id:(0,A().Z1)({environment:t,table:C().mS,spaceId:n}),type:"config",value:{type:"setup-generator"}}),i){var l;this.store.setState({...this.store.state,prompt:i});const e=null===(l=this.environment.currentUser)||void 0===l?void 0:l.id;e&&this.store.state.transcriptTree.append({id:(0,A().Z1)({environment:t,table:C().mS,spaceId:n}),type:"user",value:i,userId:e})}this.onSetupReady=r}computeFeedbackArgs(){const{setup:e}=this.store.state,t=null==e?void 0:e.metadata.setupId;if(t&&this.store.state.transcriptTree)return{spaceId:this.spaceId,traceId:t,transcript:this.store.state.transcriptTree.toValues()}}discardAllSetups(){var e;if(!this.store.state.transcriptTree)return;const t=this.store.state.transcriptTree.toNodes().findIndex((e=>"user"===e.value.type));if(-1===t)return;const o=this.store.state.transcriptTree.toValues().at(t);if(!o||"user"!==o.type)return;for(;this.store.state.transcriptTree.toNodes().length>t;)this.store.state.transcriptTree.removeLast();const n=null===(e=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===e?void 0:e.setup;this.store.setState({...this.store.state,prompt:o.value,setup:n,feedbackArgs:this.computeFeedbackArgs()}),n&&this.onSetupReady({value:n})}trackSessionStarted(){(0,P().Vd)({environment:this.environment,eventProperties:this.eventBase})}trackSessionEnded(e){const{reason:t}=e;(0,M().u4)({environment:this.environment,event:{eventName:"setup_generator_session_ended",eventProperties:{...this.eventBase,generated_setup_count:this.generatedSetupCount,reason:t}}})}trackGeneratedSetup(e){const{metadata:t}=e,{setupId:o,promptInfo:n}=t,r=e.allTemplates.filter((e=>(0,a().Xq)(e,"collection"))).length,i=e.allTemplates.filter((e=>(0,a().Xq)(e,"collection_view"))).length,l=e.allTemplates.filter((e=>(0,a().Xq)(e,"property"))).length;(0,P().If)({environment:this.environment,eventProperties:{...this.eventBase,setup_id:o,prompt_type:"custom",collection_count:r,collection_view_count:i,property_count:l,total_duration_ms:e.metadata.timing.total,warning_count:e.metadata.warnings.length,error_count:e.metadata.errors.length,use_case:null==n?void 0:n.useCase,prompt_specificity:null==n?void 0:n.specificity,prompt_language:null==n?void 0:n.language}})}}var O=()=>o(595922),F=()=>o(413871),N=()=>o(308265),$=()=>o(327816),W=()=>o(752414),U=()=>o(605845),D=()=>o(707299),z=()=>o(940445);function G(e){let{environment:t,parentStore:o,collectionTemplate:n}=e;if(!o.getSpaceId())throw new Error(`Space ID not found for ${o}`);const r=(0,a().bQ)(n).map((e=>z().globalWorkflowTemplates.fromId(e))).filter((e=>(0,a().Sz)(e))),i=[];for(const a of r){const{relatedCollectionTemplateId:e}=a,n=(0,z().getChildCollectionStoreByTemplateId)({environment:t,parentStore:o,collectionTemplateId:e});n&&i.push({type:"target",collectionStore:n,relationPropertyTemplate:a})}return i}var L=()=>o(727528),q=()=>o(126216),Q=()=>o(961397),Z=()=>o(197562);function K(e){let{template:t,parentStore:o,origin:n,version:r,existingCollectionInfo:i,relationInfos:a,navigateToOnFinish:l="created_collection",setupGenerator:c,flowId:s,onClose:p}=e;const d=t?(0,Q().C8)({collectionTemplate:t,origin:n,flowId:s,parentStore:o}):(0,Q().XM)({origin:n,flowId:s,parentStore:o});$().T_(),Z().A.setState({open:!0,isSaving:!1,currentStepIndex:0,version:r,existingCollectionInfo:i,relationInfos:a??[],navigateToOnFinish:l,setupGenerator:c,onClose:p,...d,parentStore:o})}function j(e){if(!e.template)return"select_and_customize_template";const{includeTemplateSelectionStep:t,hasSetupGenerator:o}=e;return o?t?"select_and_build_with_ai":"build_with_ai":t?"select_and_customize_template":"customize_template"}const H=(0,o(653998).YK)({setupGenerationError:{id:"setupGenerator.error.failedToGenerateSetup",defaultMessage:"Sorry, something went wrong while completing this request. Please try again."},setupGenerationRateLimitError:{id:"setupGenerator.error.rateLimited",defaultMessage:"Too many requests. Please try again later."}});function X(e){let{environment:t,parentStore:o,template:n,initialAiPrompt:r,analyticsArgs:i,isForInAppFlows:l}=e;const c=null==o?void 0:o.getSpaceId(),s=(0,a().cB)(n.templateId)?new E({environment:t,analyticsArgs:i,spaceId:c,initialPrompt:r,onSetupReady:e=>{const t=Z().A.state;if(!t.open)return;if(u().Q.isFail(e))return void(429===e.error.code?y().D6({label:T().A.formatMessage(H.setupGenerationRateLimitError)}):y().D6({label:T().A.formatMessage(H.setupGenerationError)}));const o=e.value;if(t.setupGenerator!==s)return;q().Z.append(o.allTemplates.filter((e=>e.isAiGenerated)));const n=o.allTemplates.find((e=>(0,a().Xq)(e,"collection")));if(!n)throw new Error("No collection template found");ee(n)}}):void 0;return s}function Y(e){var t;let{template:o,environment:n,aiPrompt:r,autoSubmit:i=!1,version:a,...l}=e;const{parentStore:c,relationInfos:s,origin:u,flowId:m=(0,d().Ay)()}=l,f=n.device.isPhone,v=G({environment:n,parentStore:c,collectionTemplate:o}),g=X({environment:n,template:o,parentStore:c,initialAiPrompt:r,analyticsArgs:{origin:u,hadSelectionModalSearchEntered:((null===(t=l.collectionTemplatesSearchQuery)||void 0===t?void 0:t.length)??0)>0,workflowTemplatesFlowId:m},isForInAppFlows:!0});K({...l,template:o,flowId:m,version:a??j({template:o,includeTemplateSelectionStep:!1,hasSetupGenerator:Boolean(g)}),relationInfos:p().hS([...s??[],...v],(e=>e.collectionStore.id)),setupGenerator:g}),g&&i&&(0,b().z)({setupGenerator:g,environment:n,parentStore:c,allowNavigateToAppBuilder:"new_user_onboarding"!==u&&"ai_chat"!==u,isPhone:f})}function J(e){var t,o;let{template:n,environment:r,analyticsArgs:l}=e;const c=Z().A.state;if(!c.open||!c.parentStore)return;const{parentStore:d,relationInfos:u,origin:m,flowId:f}=c,v=r.device.isPhone,g=c.collectionTemplatesSearchQuery?(0,s().x9d)(c.collectionTemplatesSearchQuery):void 0;if((0,N().Yf)({environment:r})&&(0,a().cB)(n.templateId)&&g&&"new_user_onboarding"!==m)return void(0,b().y)({environment:r,parentStore:d,prompt:g});const S=G({environment:r,parentStore:d,collectionTemplate:n}),h=p().hS([...u??[],...S],(e=>e.collectionStore.id)),y=X({environment:r,template:n,parentStore:d,analyticsArgs:{origin:m,hadSelectionModalSearchEntered:((null===(t=c.collectionTemplatesSearchQuery)||void 0===t?void 0:t.length)??0)>0,workflowTemplatesFlowId:f},initialAiPrompt:g,isForInAppFlows:!0}),w=j({template:n,includeTemplateSelectionStep:!0,hasSetupGenerator:Boolean(y)}),I={...c,open:!0,isSaving:!1,currentStepIndex:(0,Q().aO)(c,v),version:w,relationInfos:h??[],setupGenerator:c.setupGenerator??X({environment:r,template:z().globalWorkflowTemplates.fromIdOfType({templateId:i().MH,type:"collection"}),parentStore:c.parentStore,initialAiPrompt:[[""]],analyticsArgs:{origin:c.origin,workflowTemplatesFlowId:c.flowId,hadSelectionModalSearchEntered:!1},isForInAppFlows:!0}),isFollowUpInputFocused:!1,...(0,Q().C8)({collectionTemplate:n,origin:m,flowId:f,parentStore:d}),parentStore:c.parentStore};null!==(o=n.value.onboarding)&&void 0!==o&&o.isMinimal?ne({environment:r,modalState:I}):("suggested_template"===l.type&&(0,P().os)({environment:r,eventProperties:{from_modal_template_picker:!0,selected_index:l.allOrderedTemplateIds.indexOf(n.templateId),collection_template_ids_shown:l.allOrderedTemplateIds,...(0,Q().gM)({origin:m,parentStore:d,collectionTemplatesSearchQuery:c.collectionTemplatesSearchQuery,flowId:f,collectionTemplate:n})}}),Z().A.setState(I))}function ee(e){const t=Z().A.state;if(!t.open||!t.collectionTemplate||!t.parentStore)return;let o={...t,...(0,Q().C8)({collectionTemplate:e,origin:t.origin,flowId:t.flowId,parentStore:t.parentStore}),parentStore:t.parentStore,isSaving:!1};if(t.collectionTemplate.templateId===e.templateId){var n;const e=o.userCustomizations.featureTemplateSelections,r=t.userCustomizations.featureTemplateSelections,i=e.map((e=>{const t=r.find((t=>t.template.templateId===e.template.templateId));return"required"!==e.optionality&&t?{...e,selected:t.selected}:e}));o={...o,userCustomizations:{...o.userCustomizations,featureTemplateSelections:i,prevFeatureTemplateSelections:e},previewCollectionInfo:{collectionViewBlockStore:void 0,collectionContextStore:void 0,examplePageStores:void 0,focusViewTemplateId:null===(n=t.previewCollectionInfo)||void 0===n||null===(n=n.collectionContextStore)||void 0===n||null===(n=n.collectionViewStore())||void 0===n||null===(n=n.getFormat().workflow_template_instance)||void 0===n?void 0:n.template_id}}}Z().A.setState(o)}function te(e){let{environment:t,template:o,parentStore:n,existingCollectionInfo:r,relationInfos:i}=e;w().createAndCommit({userAction:"workflowTemplates.createMinimalCollectionTemplate",environment:t,canUndo:!0,perform:e=>{(0,W().mm)({environment:t,transaction:e,template:o,parentStore:n,existingCollectionInfo:r,inMemoryRecordCache:n.inMemoryRecordCache,relationInfos:i,logger:new(z().WorkflowTemplateLogger)})}})}function oe(e){var t;let{environment:o,modalState:r,collectionViewBlockStore:i,collectionStore:a,examplePageStores:l}=e;if(!a)return;(0,U().xN)({environment:o,collectionStore:a});const{existingCollectionInfo:c,userCustomizations:s,navigateToOnFinish:p}=r,d=(0,Q().gM)(r);!function(e){let{environment:t,eventProperties:o,collectionViewBlockStore:r,examplePageStores:i,navigateTo:a,result:l}=e;if("created_collection"===a)h().uK({environment:t,store:r,visitType:_().ig.Link,pageVisitSource:n().y8.WorkflowTemplateOnboarding,redirect:!0,callback:()=>{$().yQ({examplePageStores:i,collectionViewBlockStore:r,eventProperties:o})}});else if("skip"===a){var c;null!==(c=r.getModel())&&void 0!==c&&c.isFullPageCollectionView()&&$().yQ({examplePageStores:i,collectionViewBlockStore:r,eventProperties:o})}else(0,m().HB)(a);const s=Z().A.getState();!s.open&&s.isShowingLoadingState&&g().V();Z().A.close(l)}({environment:o,eventProperties:d,collectionViewBlockStore:i,examplePageStores:l,navigateTo:p,result:{type:"accepted_template",blockId:i.id,collectionId:a.id}}),(0,P().g2)({environment:o,modalState:r,eventProperties:{record_titles_is_empty:s.recordTitles.map((e=>0===e.length)),selected_feature_template_ids:s.featureTemplateSelections.filter((e=>"required"!==e.optionality&&e.selected)).map((e=>e.template.templateId)),step:(0,Q().hq)(r),target_page_ids:[i.id],collection_ids:[a.id],example_page_ids:l.map((e=>e.id)),existing_block_id:null==c||null===(t=c.collectionViewBlockStore)||void 0===t?void 0:t.id,...d}})}function ne(e){let{environment:t,modalState:o}=e;if(!o.collectionTemplate||o.isSaving||!o.parentStore)return;const{collectionTemplate:n,parentStore:r,existingCollectionInfo:i,relationInfos:a,userCustomizations:l}=o;Z().A.setState({...o,isSaving:!0});const{performResult:c}=w().createAndCommit({userAction:"WorkflowTemplatesOnboardingModal.getStarted",environment:t,canUndo:!0,perform:e=>{const{collectionStore:o,collectionViewStore:c,collectionViewBlockStore:s,examplePageStores:p}=(0,W().mm)({environment:t,transaction:e,template:n,parentStore:r,existingCollectionInfo:i,inMemoryRecordCache:r.inMemoryRecordCache,selectedFeatureTemplateIds:(0,z().getSelectedFeatureTemplateIds)(l),relationInfos:a,logger:new(z().WorkflowTemplateLogger)});return function(e){let{environment:t,transaction:o,collectionStore:n,collectionViewStore:r,collectionViewBlockStore:i,recordTitles:a}=e;const l=new(O().A)(t);l.setContext({type:"collectionView",collectionViewBlockStore:i,collectionStore:n,collectionViewStore:r,pageVisitSourceOverride:void 0});const c=a.filter((e=>e.length>0));for(const s of c)re({environment:t,transaction:o,collectionContextStore:l,title:s})}({environment:t,transaction:e,collectionStore:o,collectionViewStore:c,collectionViewBlockStore:s,recordTitles:l.recordTitles}),{collectionViewBlockStore:s,collectionStore:o,examplePageStores:p}}});return oe({environment:t,modalState:o,collectionViewBlockStore:c.collectionViewBlockStore,collectionStore:c.collectionStore,examplePageStores:c.examplePageStores}),c}function re(e){let{environment:t,transaction:o,collectionContextStore:n,title:r}=e;const{newStore:i}=(0,f().Q)({environment:t,collectionContextStore:n,groupsPointer:[],insertAtIndex:0,shouldCoerce:!0,templateStore:n.defaultPageTemplateStore.state,transaction:o,from:{createBlock:"workflow_template"},inMemoryRecordCache:t.defaultRecordCache.inMemoryRecordCache}),a=[r];return(0,I().L)({environment:t,store:i,properties:{title:[a]},transaction:o}),i}const ie={assigneeProperty:"notion://tasks/assign_property",statusProperty:"notion://tasks/status_property",dueDateProperty:"notion://tasks/due_date_property"};function ae(e){let{environment:t,transaction:o,collectionStore:n,collectionViewBlockStore:i}=e;const a=r().dC,l=r().d0,s=(0,L().Sl)({environment:t,collectionStore:n}),p={};for(const[r,c]of Object.entries(ie)){const e=s.find((e=>e.templateId.includes(r)));if(!e)return;p[c]=e.instancePointer.id}v().zA({stores:[n],update:{app_config_uri:a,app_uri_map:p},transaction:o}),v().zA({stores:[i],update:{app_id:c().JW(),app_config_uri:l,app_uri_map:{[a]:n.id,[l]:i.id}},transaction:o})}function le(e){let{template:t,environment:o}=e;const n=Z().A.state;n.open&&n.collectionTemplate&&Z().A.setState({...n,userCustomizations:(0,Q().Ll)({userCustomizations:n.userCustomizations,templateId:t.templateId})})}function ce(e){let{environment:t,transaction:o,parentStore:n,collectionTemplate:r,spaceViewStore:i}=e;const a=S().Wv({environment:t,type:l().xd.collectionViewPage,spaceId:n.getSpaceId(),format:{collection_view_sub_type:"workflow_template_placeholder",placeholder_workflow_template_id:r.templateId,page_icon:r.value.targetCollection.icon},properties:{title:(0,s().x9d)(r.value.targetCollection.name)},inMemoryRecordCache:n.inMemoryRecordCache,transaction:o});S().zv({store:a,data:{parent_id:n.id,parent_table:n.table,alive:!0},transaction:o});const c=F().Bv.createChildStore(n,a.pointer);return(0,W().Ls)({environment:t,parentStore:n,collectionViewBlockStore:c,transaction:o,appendOrPrepend:"append",spaceViewStore:i}),c}function se(e){let{environment:t,collectionTemplate:o,collectionViewBlockStore:r}=e;const i=r.getParentStore(),a=i&&(0,D().u)(i)?i:r;if(t.device.isMobile)return te({environment:t,template:o,parentStore:a,existingCollectionInfo:{collectionViewBlockStore:r,collectionStore:void 0,collectionViewStore:void 0},relationInfos:[]}),h().uK({environment:t,store:r,visitType:_().ig.Link,pageVisitSource:n().y8.WorkflowTemplateOnboarding}),{didOpenOnboardingModal:!1};const l="placeholder_block",c=(0,Q().gM)((0,Q().C8)({collectionTemplate:o,origin:l,flowId:void 0,parentStore:a}));return(0,P().os)({environment:t,eventProperties:{...c,from_modal_template_picker:!1,selected_index:0,collection_template_ids_shown:[o.templateId]}}),Y({environment:t,template:o,origin:l,parentStore:a,aiPrompt:void 0,flowId:c.flow_id,existingCollectionInfo:{collectionViewBlockStore:r,collectionStore:void 0,collectionViewStore:void 0}}),{didOpenOnboardingModal:!0}}function pe(e){const t=Z().A.state;if(!t.open)return;const o=t.setupGenerator;o&&(o.discardLatestSetup(),void 0===o.store.state.setup&&ue(e))}function de(e){const t=Z().A.state;t.open&&Z().A.setState({...t,isFollowUpInputFocused:e})}function ue(e){const t=Z().A.state;if(!t.open)return;const o=(0,Q().Wm)(t),n=(0,Q().gP)(t,e),r=o[n];if(n>=0){var a,l;if("setupGeneratorInput"===r||"templateSelection"===r)null==t||null===(a=t.setupGenerator)||void 0===a||a.discardAllSetups(),null==t||null===(l=t.setupGenerator)||void 0===l||l.stopGenerating();const e={...t,isFollowUpInputFocused:!1,currentStepIndex:n};"templateSelection"===r&&(e.collectionTemplate=i().XK,"land_on_app_from_new_user_onboarding"===t.origin&&(e.version="new_user_template_onboarding")),Z().A.setState(e)}}function me(e){const t=Z().A.state;if(!t.open)return;const o=(0,Q().aO)(t,e);o>=0&&Z().A.setState({...t,isFollowUpInputFocused:!1,currentStepIndex:o})}},540816:(e,t,o)=>{"use strict";o.d(t,{NU:()=>v,O:()=>f,Rf:()=>m,SU:()=>S,cV:()=>g,fn:()=>h});o(362833),o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601),o(725707),o(491955),o(403517);var n=()=>o(994966),r=()=>o(367950),i=()=>o(758989),a=()=>o(34662),l=()=>o(76394),c=()=>o(91338),s=()=>o(477784),p=()=>o(413871),d=()=>o(940445),u=()=>o(376896);function m(e){var t;const{collectionViewBlockStore:o,collectionStore:m,instanceMap:f}=e,v=m.id,g=(0,r()._)({table:"collection",id:v}),h=f[g]??{};if(!o.isReady()||!m.isReady())return;let y,w=!1;const I=o.getCollectionViewIds().map((e=>{const t=p().pS.createChildStore(o,{table:"collection_view",id:e}),r=t.getModel();if(!r)return void(w=!0);const i=t.getCollectionStore();if(!i)return void(w=!0);let a=!1;return y||"table"!==r.getType()||(y=e,a=!0),i.id===v?function(e){const{collectionViewStore:t,templateIdToInstancePointersMap:o,schema:r,isFirstTableView:i}=e,a=t.id;let l=t.getName();const p=t.getType(),u=S(o,"collection_view",a);let m;i&&!l&&(m=n().Gs,l=(0,d().getWorkflowTemplateName)(d().globalWorkflowTemplates.fromId(m)));!l&&p&&(l=s().A.intl.formatMessage(c().X[p]));return{type:"collection_view",name:l,id:a,viewType:p,format:t.getNormalizedFormat(r)??{},query:t.getRawQuery(),templateId:u,isFirstTableView:i,defaultBuiltinTemplateIdToMapTo:m}}({collectionViewStore:t,templateIdToInstancePointersMap:h,schema:i.getSchema(),isFirstTableView:a}):void 0})).filter(l().O9);if(w)return;const _=[];for(const n of I)if(n.isFirstTableView){const e=n.format;if(e.table_properties){for(const t of e.table_properties)t.visible&&_.push(t.property);if(_.length>0)break}}const T=m.getSchema(),b=Object.entries(T).map((e=>{let[t,o]=e;if(o)return function(e){const{propertyId:t,schema:o,instanceMap:n,templateIdToInstancePointersMap:i}=e,a="relation"===o.type&&o.collection_id?function(e,t){const o=(0,r()._)({table:"collection",id:t});return S(e[o]??{},"collection",t)}(n,o.collection_id):void 0;return{type:"property",id:t,name:o.name,schema:o,relatedCollectionTemplateId:a,templateId:S(i,"property",t),isSupported:u().Pg(o)}}({propertyId:t,schema:o,instanceMap:f,templateIdToInstancePointersMap:h})})).filter(l().O9),C=m.getLayoutStore();if(C&&!C.isReady())return;const k=null==C?void 0:C.getModel(),M=k?function(e){const{layoutModel:t,templateIdToInstancePointersMap:o}=e,n=S(o,"layout",t.id);let r;if(n){const e=d().globalWorkflowTemplates.fromId(n);"layout"===e.type&&(r=e.name)}return{id:t.id,type:"layout",templateId:n,name:r,layout:t.getRawModules(),spaceId:t.spaceId}}({layoutModel:k,templateIdToInstancePointersMap:h}):void 0,A=m.getAutomationStores().map((e=>e.pointer)),P=null===(t=m.getIcon())||void 0===t?void 0:t.icon,V=P&&(0,i().T8)(P)?P:void 0,x=m.getDescription();return{type:"collection",id:v,description:x,descriptionAsString:(0,a().q4_)(x),schema:T,templateId:S(h,"collection",v),name:(0,a().q4_)(m.getName()),pageTemplateIds:m.getTemplatePages(),format:m.getFormat(),icon:V,properties:b,collectionViews:I,firstTableViewId:y,layout:M,templateIdToInstancePointersMap:h,tableOrderPropertyIds:_,automationPointers:A}}function f(e){return"property"===e.type&&"title"===e.id}function v(e){return f(e)&&"Name"===e.schema.name}function g(e){const{collectionInfo:t,pageStore:o,instanceMap:n,recordMap:i}=e,l=(0,a().q4_)(o.getTitleValue())||"Untitled",c=n[(0,r()._)({table:"collection",id:t.id})]??{},s=new Set,p=o.getProperties();for(const r of Object.keys(p))"title"!==r&&s.add(r);return{type:"block",id:o.id,recordMap:i,templateId:S(c,"block",o.id),name:l,propertyIds:s,spaceId:o.getSpaceId()}}function S(e,t,o){var n;return null===(n=h(e,t,o))||void 0===n?void 0:n.templateId}function h(e,t,o){for(const[n,r]of Object.entries(e))for(const e of r)if(e.type===t&&e.id===o)return{...e,templateId:n}}},582382:(e,t,o)=>{"use strict";o.d(t,{Vf:()=>n});o(754309),o(362833),o(725707),o(491955),o(403517),o(113085);function n(e){return"inference"!==e.type&&"queue-handoff"!==e.type&&"record-map"!==e.type}},605845:(e,t,o)=>{"use strict";o.d(t,{ai:()=>te,xN:()=>ie,e_:()=>oe,Ix:()=>re,Z5:()=>ae});o(725707),o(500234);var n=()=>o(505966),r=()=>o(769884),i=()=>o(289765),a=()=>o(968410),l=()=>o(975392),c=()=>o(76394),s=()=>o(154956),p=()=>o(84543),d=()=>o(731827),u=()=>o(960442),m=()=>o(413871),f=(o(491955),()=>o(940445)),v=()=>o(727528);function g(e){var t;let{environment:o,collectionStore:r,collectionViewValue:i,dependencyMap:a,logger:l}=e;if((0,f().remapPropertyIds)({collectionStore:r,object:i,dependencyMap:a}),function(e){let{environment:t,spaceId:o,collectionViewValue:n,logger:r}=e;for(const l of(null===(i=n.format)||void 0===i?void 0:i.collection_groups)??[]){var i,a;const{value:e}=l;if(("created_by"===e.type||"last_edited_by"===e.type)&&"notion_user"===(null===(a=e.value)||void 0===a?void 0:a.table)){const n=t.currentUser.id;if(!n){r.warn("No current user ID, unable to remap collection group user to current user!");continue}r.log(`Remapping user ID ${e.value.id} to ${n} in collection view group.`),e.value.id=n,e.value.spaceId=o}}}({environment:o,spaceId:r.getSpaceId(),collectionViewValue:i,logger:l}),i.query2&&function(e){let{collectionStore:t,query2:o,dependencyMap:r}=e;for(const i of n().Nf){const e=o[i];e&&(o[i]=(0,v().CB)({collectionStore:t,sourceTemplateType:"property",dependencyMap:r,sourcePrimitiveId:e}))}}({collectionStore:r,query2:i.query2,dependencyMap:a}),"object"==typeof(null===(t=i.format)||void 0===t?void 0:t.collection_view_default_template)){const e=(0,v().fI)({collectionStore:r,sourceTemplateType:"block",dependencyMap:a,sourcePrimitiveId:i.format.collection_view_default_template.template_page_id});e?i.format.collection_view_default_template={template_page_id:e}:(l.warn("Unable to resolve collection_view default template, omitting it."),delete i.format.collection_view_default_template)}}function S(e){let{collectionViewFormat:t}=e;const o=null==t?void 0:t.table_properties;o&&(t.table_properties=o.filter((e=>!(0,v().TE)(e.property))))}var h=()=>o(775781),y=(o(403517),o.n(o(485359))),w=()=>o(889110),I=()=>o(465546),_=()=>o(214144),T=()=>o(45462),b=()=>o(293665),C=()=>o(711659),k=()=>o(385649),M=()=>o(145017),A=()=>o(21164),P=()=>o(409211),V=()=>o(56432),x=()=>o(927685),R=()=>o(754697),B=()=>o(477784);function E(e){let{collectionStore:t,environment:o,logger:n,template:i,transaction:a}=e;const l=function(e){let{environment:t,logger:o,parentStore:n,template:i,transaction:a}=e;const l=(0,R().zP)({environment:t,spaceId:n.getSpaceId(),table:C().yB}),c=t.currentUser.id,s=r().Bj6.fromAutomation({alive:!0,created_by_id:c??"",created_by_table:P().oo,created_time:Date.now(),id:l.id,parent_id:n.pointer.id,parent_table:n.pointer.table,space_id:n.getSpaceId(),trigger:{...i.value.trigger,id:_().JW()},version:0,last_edited_by_id:c??"",last_edited_by_table:P().oo,last_edited_time:Date.now(),status:"active"}),p=O({actionPlaceholderIdToActionId:new Map,collectionStore:n,dependencyMap:i.dependencyMap,logger:o}),{value:d}=(0,w().n)({automationModel:s,visitors:p}),u=d.getTrigger(),m=V().createAutomation({actionIds:[],environment:t,automationId:l.id,automationName:i.value.name,parentPointer:n.getSpaceShardedPointer(),transaction:a,trigger:u});return m}({environment:o,logger:n,parentStore:t,template:i,transaction:a}),c=new Map;return i.value.actions.map((e=>function(e){let{actionPlaceholderIdToActionId:t,actionTemplate:o,collectionStore:n,environment:r,logger:i,parentStore:a,parentTemplate:l,transaction:c}=e;const s=(0,R().zP)({environment:r,spaceId:a.getSpaceId(),table:k().SC}),{config:p,placeholderId:d,type:u}=o,{model:m}=T().RU.create({alive:!0,config:p,id:s.id,parent_id:a.pointer.id,parent_table:a.pointer.table,space_id:n.getSpaceId(),type:u,version:0}),f=O({actionPlaceholderIdToActionId:t,collectionStore:n,dependencyMap:l.dependencyMap,logger:i}),{value:v}=(0,w().G)({automationActionModel:m,baseUrl:x().A.domainBaseUrl,preventClearingConfig:!0,publicDomainName:x().A.publicDomainName,sourceSpaceId:n.getSpaceId(),visitors:f}),g=v.getConfig(),S=V().addAutomationAction({actionId:s.id,actionType:o.type,automationStore:a,config:g,createDuplicateBlocksContainer:!0,environment:r,intl:B().A.getIntl(),transaction:c});return y()(S,"Failed to create automation action"),t.set(d,S.id),S}({actionPlaceholderIdToActionId:c,actionTemplate:e,collectionStore:t,environment:o,logger:n,parentStore:l,parentTemplate:i,transaction:a}))),l.isTriggerType("event")&&p().applyOperation({store:t,operation:{pointer:t.pointer,path:["format","automation_ids"],command:"listAfter",args:{id:l.id}},transaction:a}),{id:l.id,spaceId:t.getSpaceId(),type:"automation"}}function O(e){const{actionPlaceholderIdToActionId:t,collectionStore:o,dependencyMap:n,logger:r}=e;function a(e){const o=(0,I().y5)(e);if("action"===o.source){const e=t.get(o.action_id)??o.action_id;return(0,I().$y)({...o,action_id:e})}if("global"===o.source)return e;(0,c().HB)(o)}function s(e){if(!n)return;if("title"===e)return e;const t=(0,v().fI)({collectionStore:o,sourceTemplateType:"property",sourcePrimitiveId:e,dependencyMap:n});return t||r.warn(`Failed to remap property ID ${e} in automation template`),t}return{visitCollectionProperty:e=>n?{type:"replace",value:s(e)}:{type:"keep"},visitCollectionPropertyPointer:e=>{if(!n)return{type:"keep"};const t=s(e.propertyId);if(!t)return{type:"replace",value:void 0};const i=(0,v().fI)({collectionStore:o,sourceTemplateType:"collection",sourcePrimitiveId:e.id,dependencyMap:n});return i?{type:"replace",value:{id:i,propertyId:t,spaceId:o.getSpaceId(),table:A().Vl}}:(r.warn(`Failed to remap collection ID ${e.id} in automation template`),{type:"replace",value:void 0})},visitFormulaContextValue:e=>({type:"replace",value:a(e)}),visitFormulaPageProperty:e=>{if(!n)return{type:"keep"};const t=(0,l().mg)(e),i=s(e.property);if(!i)return{type:"replace",value:void 0};if(t.property=i,"collection"in t&&t.collection){const e=(0,v().fI)({collectionStore:o,sourceTemplateType:A().Vl,sourcePrimitiveId:t.collection.id,dependencyMap:n});if(!e)return r.warn(`Failed to remap collection ID ${t.collection.id} in automation template`),{type:"replace",value:void 0};t.collection=b().L3.fromSpaceShardRecordId({id:e,spaceId:o.getSpaceId()},A().Vl)}else"contextValueId"in t&&t.contextValueId&&(t.contextValueId=a(t.contextValueId));return{type:"replace",value:t}},visitRecordPointer:e=>{if(!n)return{type:"keep"};if(e.table===M().ev||e.table===A().Vl||e.table===C().yB||e.table===i().Gy){const t=(0,v().fI)({collectionStore:o,sourceTemplateType:e.table,sourcePrimitiveId:e.id,dependencyMap:n});return t?{type:"replace",value:b().L3.fromSpaceShardRecordId({id:t,spaceId:o.getSpaceId()},e.table)}:(r.warn(`Failed to remap record pointer ${b().L3.toKey(e)} in automation template`),{type:"replace",value:void 0})}return{type:"keep"}}}}o(610931);var F=()=>o(220574),N=()=>o(551102),$=()=>o(795394),W=()=>o(425447);var U=()=>o(752414),D=(o(362833),o(771702),()=>o(759625));function z(e){let{environment:t,transaction:o,collectionStore:n,template:r,logger:a,preserveCollectionFeatureOrdering:l}=e;const c=n.getParentBlockStore();if(!c)throw new Error("Collection view block store not found");const{value:s,dependencyMap:p}=r;if(!p)throw new Error("Dependency map not defined on view template");g({environment:t,collectionStore:n,collectionViewValue:s,dependencyMap:p,logger:a}),function(e){var t;let{collectionStore:o,collectionViewValue:n}=e;const r=null===(t=n.format)||void 0===t?void 0:t.table_properties;if(!r)return;const i=r.map((e=>e.property)),a=Object.keys(o.getSchema()).filter((e=>!i.includes(e)));for(const l of a)r.push({property:l,visible:!1})}({collectionStore:n,collectionViewValue:s});const d=D().eC({environment:t,table:i().Gy,inMemoryRecordCache:c.inMemoryRecordCache,value:{...s,parent_id:c.id,parent_table:c.table,space_id:c.getSpaceId(),format:{...s.format,collection_pointer:n.pointer},alive:!0},transaction:o}),u=m().pS.createChildStore(c,d.pointer),f=c.getCollectionViewsStore();if(l){const e=function(e){let t,{collectionTemplate:o,collectionViewStores:n,collectionViewTemplate:r}=e,i=-1;const a=o.value.templateItems.findIndex((e=>e.pointer===r.templateId));return n.forEach((e=>{var n;const r=null===(n=e.getFormat().workflow_template_instance)||void 0===n?void 0:n.template_id;if(!r)return;const l=o.value.templateItems.findIndex((e=>e.pointer===r));l>a||l>i&&(i=l,t=e.id)})),t}({collectionTemplate:l,collectionViewStores:c.getCollectionViewStores(),collectionViewTemplate:r});e?N().BC({parentStore:f,appendStore:u,transaction:o,after:e}):N().Hs({parentStore:f,prependStore:u,transaction:o})}else N().BC({parentStore:f,appendStore:u,transaction:o});return{type:"collection_view",id:u.id}}var G=()=>o(3311);var L=()=>o(496580),q=()=>o(760813);var Q=()=>o(994966),Z=()=>o(187058),K=()=>o(86280),j=()=>o(728373),H=()=>o(745859);function X(e){const{environment:t,logger:o,transaction:r,collectionStore:i,template:a}=e,c=function(e){if("title"===e.value.type)return"title";if(e.templateId===Q().RE)return K()._e.Verification;if(e.templateId===Q().dr)return K()._e.Owner;return(0,j().Ay)()}(a);if((0,n().PC)(a,"formula"))Y({...e,template:a});else if((0,n().Ox)(a)){const t=f().globalWorkflowTemplates.featureFromId(a.buttonAutomationId);o.log(`Instantiating dependency "${t.templateId}" of button property template "${a.templateId}".`);const n=oe({...e,template:t});if(!n)throw new Error(`Failed to create instance of automation template "${t.templateId}"`);if("automation"!==n.type)throw new Error(`Unexpected instance pointer. Expected "automation" but got "${n.type}"`);a.value.automation_id=n.id}const s=(0,l().mg)(a.value);return s.workflow_template_instance={template_id:a.templateId},(0,H().F)({environment:t,collectionStore:i,update:{[c]:s},transaction:r}),{type:"property",id:c,collectionId:i.id}}function Y(e){let{template:t,collectionStore:o}=e;const{value:n,dependencyMap:r}=t;if(!r)return;if(!n.formula2)return;const{value:i}=(0,Z().RI)({baseUrl:x().A.domainBaseUrl,formula:n.formula2.code,publicDomainName:x().A.publicDomainName,spaceId:o.getSpaceId(),visitors:{visitFormulaContextValue:void 0,visitFormulaPageProperty:e=>{const t={...e};return t.property=(0,v().CB)({dependencyMap:r,collectionStore:o,sourcePrimitiveId:e.property,sourceTemplateType:"property"}),"collection"in t&&t.collection&&(t.collection=o.pointer),{type:"replace",value:t}},visitRecordPointer:void 0}});n.formula2.code=i}var J=()=>o(823301),ee=()=>o(863977);function te(e){let{environment:t,transaction:o,collectionStore:n,template:r,logger:i,origin:a,examplePageStores:l,preserveCollectionFeatureOrdering:c}=e;const s=oe({transaction:o,environment:t,collectionStore:n,template:r,logger:i,origin:a,preserveCollectionFeatureOrdering:c}),p=(0,f().getPropertyTemplates)([r]);return(0,ee().My)({transaction:o,collectionStore:n,propertyTemplates:p}),(0,ee().Bi)({transaction:o,collectionStore:n,propertyTemplates:p}),re({environment:t,transaction:o,collectionStore:n,template:r,logger:i,examplePageStores:l}),s}function oe(e){const{collectionStore:t,template:o,transaction:r}=e;!function(e){const{template:t,logger:o}=e,r=(0,n().Z6)({template:t,logger:o}),{environment:i,collectionStore:a}=e;for(const n of r){(0,v().Zp)({environment:i,scopeStore:a,templateId:n.templateId})||(o.log(`Template "${t.templateId}" has implicit dependency "${n.templateId}" (source: ${n.debugSource}), instantiating it.`),oe({...e,template:f().globalWorkflowTemplates.featureFromId(n.templateId)}))}}(e);const i=function(e){const{logger:t}=e,o=l().mg(e.template),{type:r}=o;switch(t.log(`Instantiating ${r} template "${o.templateId}".`),r){case"property":return X({...e,template:o});case"collection_view":return z({...e,template:o});case"layout":return function(e){let{environment:t,transaction:o,collectionStore:n,template:r}=e;if(!r.dependencyMap)throw new Error("Dependency map not defined on layout template");const i=(0,h().f)({collectionStore:n,modules:{page_layout_schema:void 0,page_info_layout_schema:void 0,form_layout_schema:void 0,person_profile_page_main:void 0,person_profile_page_details:void 0,...r.value},dependencyMap:r.dependencyMap}),{model:a}=(0,q().$L)({environment:t,transaction:o,collectionStore:n,userId:(0,L().o9)(t.currentUser.id),modules:i});return{type:"layout",id:a.id,spaceId:n.getSpaceId()}}({...e,template:o});case"compound":return function(e){const{environment:t,template:o,collectionStore:r,logger:i}=e,a=[],l=e=>{if(!(0,v().DM)(e)||"compound"===e.type)throw new Error(`Template in compound template generated a non-feature instance pointer of an illegal type: ${e.type}`);a.push(e)};for(const c of o.value.templateItems){const{optionality:a,pointer:s}=c;if("optionalDefaultOff"===a)continue;const p=(0,v().Zp)({environment:t,scopeStore:r,templateId:c.pointer});if(p){l(p);continue}const d=f().globalWorkflowTemplates.fromId(s);if(!(0,n().$K)(d))throw new Error(`${d.templateId} in compound template is of an illegal type: ${d.type}`);i.log(`Instantiating dependency "${d.templateId}" of compound template "${o.templateId}".`);const u=te({...e,template:d});u&&l(u)}return{type:"compound",id:(0,G().Ay)(),instancePointers:a,collectionId:r.id}}({...e,template:o});case"block":return function(e){let{environment:t,transaction:o,collectionStore:n,template:r}=e;const i=(0,R().zP)({environment:t,spaceId:n.getSpaceId(),table:M().ev});if("block"!==r.type)throw new Error(`Expected block template, got ${r.type} template: ${r.templateId}`);if(!r.dependencyMap)throw new Error(`Dependency map not defined on block template: ${r.templateId}`);const{dependencyMap:a}=r,l=F().RecordMap.create(r.value.recordMap),c=l.getModel(r.value.blockPointer);if(c){const e=c.getProperties();for(const[t,o]of Object.entries(e)){const r=(0,v().CB)({collectionStore:n,sourceTemplateType:"property",sourcePrimitiveId:t,dependencyMap:a});r&&(delete e[t],e[r]=o)}}const{targetBlockStore:s}=W().localDuplicate({environment:t,sourceBlockId:r.value.blockPointer.id,targetBlockPointer:i,sourceBlockSubtree:l,transaction:o,targetInMemoryRecordCache:n.inMemoryRecordCache,options:{deepCopyTransclusionContainers:!1,resolveTemplateVariables:!1}});return $().X$({childStore:s,parentStore:n,transaction:o}),s.isTemplate()&&N().BC({parentStore:n.getTemplatePagesStore(),appendStore:s,transaction:o}),{type:"block",id:s.id,spaceId:n.getSpaceId()}}({...e,template:o});case"automation":return E({...e,template:o});default:(0,c().HB)(r)}}(e);return i&&(0,J().ZQ)({transaction:r,collectionStore:t,templateId:o.templateId,instance:i,logger:e.logger}),i}function ne(e){let{environment:t,transaction:o,collectionStore:n,template:r,instancePointer:i,examplePageStores:a}=e;if(a&&"property"===i.type)for(const l of a){const e=(0,U().gv)({collectionStore:n,dependencyMap:r.dependencyMap??{},exampleRow:{properties:l.getProperties()}});(0,u().L)({environment:t,store:l,properties:e.properties,transaction:o})}}function re(e){let{environment:t,transaction:o,collectionStore:n,template:l,logger:c,examplePageStores:s}=e;const d=(0,v().Sl)({environment:t,collectionStore:n});for(const{instancePointer:u,templateId:v}of d){if("collection"===u.type)continue;const e=f().globalWorkflowTemplates.fromId(v),d=e.dependencyMap&&Object.values(e.dependencyMap).includes(l.templateId);if(!("dependencyMap"in e)||!e.dependencyMap||!d){ne({environment:t,transaction:o,collectionStore:n,template:l,examplePageStores:s,instancePointer:u});continue}c.log(`Remapping dependency "${l.templateId}" in "${v}".`);const S={};if("layout"===u.type){const e=m().rN.createChildStore(n,{table:a().zx,id:u.id,spaceId:u.spaceId}),t=e.getRawModules();if(t){const i=(0,h().f)({collectionStore:n,modules:t,dependencyMap:S});p().applyOperation({transaction:o,store:e,operation:r().N4X.updateModules(e.pointer,i)})}}else if("collection_view"===u.type){const e=m().pS.createChildStore(n,{table:i().Gy,id:u.id}),o=e.getType();if(!o)continue;g({environment:t,collectionStore:n,collectionViewValue:{type:o,name:e.getName(),format:e.getFormat(),query2:e.getRawQuery()},dependencyMap:S,logger:c})}else c.warn(`Don't know how to remap instance type "${u.type}"!`)}}function ie(e){let{environment:t,collectionStore:o}=e;const n=(0,v().Sl)({environment:t,collectionStore:o});for(const{instancePointer:r}of n)if("collection_view"===r.type){const e=m().pS.createChildStore(o,{table:i().Gy,id:r.id});if(!e.getType())continue;S({collectionViewFormat:e.getFormat()})}}function ae(e){let{environment:t,transaction:o,collectionViewBlockStore:n,collectionStore:r,instancePointer:i}=e;const a=i.type;switch(a){case"property":s().BJ({environment:t,collectionStore:r,schema:r.getSchema(),property:i.id,transaction:o,permanentlyDelete:!1});break;case"collection_view":if(!n)return;const e=n.getCollectionViewStores().find((e=>e.id===i.id));e&&(0,d().T)({collectionViewBlockStore:n,collectionViewStore:e,transaction:o});break;case"layout":case"block":case"automation":break;default:(0,c().HB)(a)}}},644094:(e,t,o)=>{"use strict";o.d(t,{K:()=>s});o(610931),o(725707),o(500234),o(403517);var n=o.n(o(62006)),r=()=>o(876096),i=()=>o(145017),a=()=>o(32194),l=()=>o(975392),c=()=>o(413871);function s(e,t){if("page"===e.type||"block"===e.type||"properties"===e.type){const o=e.pageId??("page"===e.type?e.id:void 0);if(!o)return;return{type:"notion",citationLevel:e.type,store:c().Bv.createChildStore(t,{table:i().ev,id:e.id,spaceId:t.id}),id:e.id,pageId:o,title:e.title,path:e.path,text:e.text,lastEdited:e.lastEdited,badges:"page"===e.type?e.badges:void 0,highlight:"page"===e.type?e.highlight:void 0}}const o=r().tD.parseAssistantHref(e.id);if(o){if("slack"===e.type){if("slack"!==o.type)throw new Error(`Expected Slack result, but got ${o.type}`);const t=`slack://?${n().stringify({base_url:o.baseUrl,channel_id:o.channelId,message_id:o.messageId,thread_ts:o.threadTs})}`,{user:r,text:i}=function(e){let t,o=e.text;if("slack"===e.type){var n;null!==(n=e.highlight)&&void 0!==n&&n.text&&(o=e.highlight.text);const r=e.messages.find((t=>t.messageId===e.id));t=null==r?void 0:r.user;const i=l().sb(e.messages.map((e=>e.user))),c=": ";if(o.includes(c)){const[e,...n]=o.split(c);if(e){const r=e.replace(new RegExp(`${a().$8}(.*?)${a()._x}`,"g"),"$1");if(0===i.length)o=n.join(c);else{const e=i.findIndex((e=>e===r));-1!==e&&(t=i[e],o=n.join(c))}}}}return{user:t??"",text:o}}(e);return{id:e.pageId,type:"slack",href:t,threadHref:t,title:e.title,text:i,user:r,lastEdited:e.lastEdited,domain:o.domain,baseUrl:o.baseUrl,channelId:o.channelId,messageId:o.messageId,threadTs:o.threadTs,threadMessages:e.messages.map((e=>e.messageId)),highlight:{...e.highlight,text:i}}}if("helpdoc"===e.type){if("helpdoc"!==o.type)throw new Error(`Expected helpdocs result, but got ${o.type}`);return{type:"helpdocs",href:e.id,id:e.id,title:e.title,text:e.text,lastEdited:e.lastEdited,url:o.url}}if("helpdoc-section"===e.type){if("helpdoc-section"!==o.type)throw new Error(`Expected helpdoc-section result, but got ${o.type}`);return{type:"helpdoc-section",href:e.id,id:e.id,parentPageHref:o.parentPageHref,title:e.title,text:e.text,lastEdited:e.lastEdited,url:o.url}}if("google-drive"===e.type){if("google-drive"!==o.type)throw new Error(`Expected google-drive result, but got ${o.type}`);return{type:"google-drive",href:e.id,id:e.pageId,title:e.title,text:e.text,lastEdited:e.lastEdited,fileType:e.fileType,url:o.url,highlight:e.highlight}}if("webpage"===e.type){if("webpage"!==o.type)throw new Error(`Expected webpage result, but got ${o.type}`);return{type:"webpage",href:e.id,id:e.id,title:e.title,text:e.text,lastEdited:e.lastEdited,url:o.url}}if("github"===e.type){if("github"!==o.type)throw new Error(`Expected github result, but got ${o.type}`);return{type:"github",href:e.id,id:e.pageId,title:e.title,text:e.text,lastEdited:e.lastEdited,authorName:e.authorName,statusTag:e.statusTag,githubRepoName:e.githubRepoName,fileType:e.fileType,url:o.url,highlight:e.highlight}}if("jira"===e.type){if("jira"!==o.type)throw new Error(`Expected jira result, but got ${o.type}`);return{type:"jira",href:e.id,id:e.pageId,title:e.title,text:e.text,lastEdited:e.lastEdited,url:o.url,highlight:e.highlight}}if("gmail"===e.type){if("gmail"!==o.type)throw new Error(`Expected gmail result, but got ${o.type}`);return{type:"gmail",href:e.id,id:e.pageId,title:e.title,text:e.text,lastEdited:e.lastEdited,emailAddress:e.emailAddress,url:o.url}}}}},662861:(e,t,o)=>{"use strict";o.d(t,{Kf:()=>f,WM:()=>d,XZ:()=>v,Xd:()=>S,nD:()=>g,r6:()=>m});o(362833),o(725707),o(491955);var n=()=>o(486826),r=()=>o(427091),i=()=>o(939499),a=()=>o(34662),l=()=>o(3311),c=()=>o(76394),s=()=>o(754697),p=()=>o(836331);function d(e){const{environment:t,userStore:o,spaceStore:a,spaceViewStore:l,blockStore:c,surface:d}=e,u=(0,s().Z1)({environment:t,table:i().mS,spaceId:a.id}),m={...c&&c.isCollectionView()?{collectionViewBlockId:c.id}:void 0,...c&&!c.isCollectionView()&&"personal_home_page"!==c.getType()?{blockId:c.id}:void 0};return p().default.checkGate({gateName:"workflows_inference_replay"})?{id:u,type:"context",value:{timezone:"America/Los_Angeles",userName:"Test User",userId:"test-user-id",spaceName:"Test Space",spaceId:a.id,spaceViewId:l.id,currentDatetime:"2024-01-01T00:00:00.000Z",surface:d,...m}}:{id:u,type:"context",value:{timezone:(0,r().P)(),userName:o.getName(),userId:o.id,spaceName:a.getName(),spaceId:a.id,spaceViewId:l.id,currentDatetime:n().c9.now().toISO(),surface:d,...m}}}function u(e){const{environment:t,spaceStore:o,config:n}=e;return{id:(0,s().Z1)({environment:t,table:i().mS,spaceId:o.id}),type:"config",value:n}}function m(e){let{environment:t,spaceStore:o,userAction:n}=e;return{id:(0,s().Z1)({environment:t,table:i().mS,spaceId:o.id}),type:"agent-user-action",userAction:n}}function f(e){const{environment:t,spaceStore:o,value:r,userStore:l}=e,c=(0,a().bBR)(r);return{id:(0,s().Z1)({environment:t,table:i().mS,spaceId:o.id}),type:"user",value:c,userId:l.id,createdAt:n().c9.now().toISO()}}function v(e){const{environment:t,spaceStore:o,functionKey:n,runId:r,message:a}=e;return{id:(0,s().Z1)({environment:t,table:i().mS,spaceId:o.id}),type:"workflow-function-edit-request",functionKey:n,runId:r,message:a,traceId:(0,l().lZ)()}}function g(e){const{environment:t,spaceStore:o,workflowFunction:n,functionArgs:r,from:a}=e;return{id:(0,s().Z1)({environment:t,table:i().mS,spaceId:o.id}),type:"workflow-function-call-request",functionLabel:n.name,functionCall:{toolCallId:(0,l().lZ)(),key:n.key,args:r},from:a,traceId:(0,l().lZ)()}}function S(e){const{environment:t,spaceStore:o,userStore:n,config:r,addSteps:i,blockStore:a,spaceViewStore:l,surface:s}=e,p=[u({environment:t,spaceStore:o,config:r}),d({environment:t,userStore:n,spaceStore:o,spaceViewStore:l,blockStore:a,surface:s})];return i&&p.push(...i),p.filter(c().O9)}},670298:(e,t,o)=>{"use strict";o.d(t,{Y$:()=>d,dy:()=>p,fw:()=>u});o(610931);var n=()=>o(897376),r=()=>o(939499),i=()=>o(3311),a=()=>o(662861),l=()=>o(754697),c=()=>o(485966),s=()=>o(267711);function p(e){const{operations:t}=e;return{id:(0,i().lZ)(),type:"workflow-operation",workflowOperations:[],threadOperations:(0,n().eB)(t??[])}}function d(e){const{environment:t,spaceStore:o,userStore:n,addSteps:r=[],spaceViewStore:i,store:l}=e;return(0,a().Xd)({environment:t,userStore:n,spaceStore:o,spaceViewStore:i,config:(0,s().K)({store:l}),addSteps:r,blockStore:c().default.state.mainEditorCurrentBlockStore,surface:"workflows"})}function u(e){const{environment:t,spaceStore:o,runStore:n}=e,a=n.getData();if(!a)throw new Error("Run data is undefined");const c=n.getCreatedAt();return{id:(0,l().Z1)({environment:t,table:r().mS,spaceId:o.id}),type:"workflow-runs",value:[{id:n.id,created_at:c,data:a}],traceId:(0,i().lZ)()}}},752414:(e,t,o)=>{"use strict";o.d(t,{Ls:()=>G,mm:()=>W,my:()=>U,gv:()=>D});o(610931),o(362833),o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601),o(403517);var n=()=>o(505966),r=()=>o(145017),i=()=>o(289765),a=()=>o(528762),l=()=>o(218357),c=()=>o(34662),s=()=>o(76394),p=()=>o(197881),d=()=>o(102659),u=()=>o(373122),m=()=>o(927999),f=()=>o(551102),v=()=>o(795394),g=()=>o(759625),S=()=>o(163875),h=()=>o(578553),y=()=>o(84543),w=()=>o(285060),I=()=>o(731827),_=()=>o(715741),T=()=>o(960442),b=()=>o(900921),C=()=>o(477784),k=()=>o(934807),M=()=>o(485966),A=()=>o(595922),P=()=>o(413871),V=()=>o(518022),x=()=>o(707299),R=()=>o(940445),B=()=>o(727528),E=()=>o(605845),O=(o(725707),o(491955),()=>o(626911)),F=()=>o(823301);function N(e){const{environment:t,transaction:o,collectionStore:r,template:i,targetCollectionStore:a,logger:l}=e,{value:c}=i,s=(0,E().ai)(e);if(!s)throw new Error(`relationPropertyPointer not created for ${i.templateId}`);if("property"!==s.type)throw new Error(`Instance pointer returned is not of property type: ${s.type}`);const p=new(A().A)(t);p.setContext({type:"collectionPage",collectionStore:r});const{inverseRelationPropertyId:d}=O().cT({environment:t,transaction:o,intl:C().A.getIntl(),collectionContextStore:p,collectionStore:r,property:s.id,targetCollectionStore:a,hasInverseRelation:!0,inverseName:void 0,propertyName:c.name,autoRelate:c.autoRelate,propertyLimit:1===c.limit?"1":"no_limit"});if(d){const e=function(e){let{environment:t,sourceCollectionStore:o,targetCollectionStore:r}=e;const i=(0,B().tY)({environment:t,collectionStore:o}),a=(0,B().tY)({environment:t,collectionStore:r});if(!i||!a)return;const l=(0,n().bQ)(a).map((e=>R().globalWorkflowTemplates.fromId(e))).filter((e=>(0,n().Sz)(e)));for(const n of l)if(n.relatedCollectionTemplateId===i.templateId)return n}({environment:t,sourceCollectionStore:r,targetCollectionStore:a});e&&(l.log(`Instantiating relation property template "${e.templateId}" because it is the inverse of "${i.templateId}".`),(0,F().ZQ)({transaction:o,collectionStore:a,templateId:e.templateId,instance:{type:"property",id:d,collectionId:a.id},logger:l}))}return s}var $=()=>o(863977);function W(e){var t;let{environment:o,transaction:r,template:a,parentStore:l,existingCollectionInfo:s,inMemoryRecordCache:f,selectedFeatureTemplateIds:v,collectionViewBlockType:S="collection_view_page",relationInfos:h,logger:y}=e;y.log(`Instantiating collection template "${a.templateId}".`);const{collectionStore:k,collectionViewBlockStore:O}=function(e){var t;let o,{environment:n,transaction:r,template:i,parentStore:a,existingCollectionInfo:l,collectionViewBlockType:s="collection_view_page",inMemoryRecordCache:p,logger:d}=e;if(!(0,x().u)(a))throw new Error(`Parent store is not a valid  collection template parent store ${a.table}`);if(l){const{collectionStore:e,collectionViewStore:t}=l;o=l.collectionViewBlockStore,t&&(0,I().T)({collectionViewBlockStore:o,collectionViewStore:t,transaction:r}),e&&(0,_().h)({collectionViewBlockStore:o,collectionStore:e,transaction:r})}else o=z({environment:n,transaction:r,parentStore:a,collectionViewBlockType:s,inMemoryRecordCache:p});const{name:u,icon:m,description:f}=i.value.targetCollection,v=(0,w().E)({environment:n,collectionViewBlockStore:o,transaction:r,collectionValue:{name:(0,c().x9d)(u),icon:m,description:f,format:{item_name_config:i.value.targetCollection.itemName,item_name_config_v2:null===(t=i.value.targetCollection.format)||void 0===t?void 0:t.item_name_config_v2},schema:{title:{name:C().A.formatMessage(b().n4.namePropertyTitle),type:"title"}}}});if(!M().default.state.currentSpaceStore)throw new Error("No current space store");return{collectionStore:v,collectionViewBlockStore:o}}({environment:o,transaction:r,template:a,parentStore:l,existingCollectionInfo:s,collectionViewBlockType:S,inMemoryRecordCache:f,logger:y});(0,F().ZQ)({transaction:r,collectionStore:k,templateId:a.templateId,instance:{type:"collection",id:k.id},logger:y});const{allFeatureTemplates:W,nonRelationPropertyTemplates:U}=function(e){let{template:t,selectedFeatureTemplateIds:o}=e;if(o){const e=new Set((0,n().bQ)(t));for(const n of o)if(!e.has(n))throw new Error(`Feature template ID ${n} is not part of collection template ${t.templateId}`)}const{templateItems:r}=t.value,i=(0,n().b2)(r,"required"),a=(0,n().b2)(r,"optionalDefaultOn"),l=new Set([...i,...o??a]),c=Array.from(l).map(R().globalWorkflowTemplates.featureFromId),s=[],p=[];for(const d of c)(0,n().Sz)(d)?s.push(d):p.push(d);return{allFeatureTemplates:c,relationPropertyTemplates:s,nonRelationPropertyTemplates:p}}({template:a,selectedFeatureTemplateIds:v}),G=[];for(const n of U){const e=(0,E().e_)({environment:o,transaction:r,collectionStore:k,template:n,logger:y,origin:"collection_creation"});"collection_view"===(null==e?void 0:e.type)&&G.push(e),(0,E().Ix)({environment:o,transaction:r,collectionStore:k,template:n,logger:y})}if(0===G.length)throw new Error("No collection view templates to create");const q=P().pS.createChildStore(O,{table:i().Gy,id:G[0].id});h&&function(e){let{environment:t,transaction:o,currentCollectionStore:n,relationInfos:r,logger:i}=e;for(const a of r){const{sourceCollectionStore:e,targetCollectionStore:r}=L({currentCollectionStore:n,relationInfo:a});N({environment:t,transaction:o,origin:"collection_creation",collectionStore:e,targetCollectionStore:r,template:a.relationPropertyTemplate,logger:i})}}({environment:o,transaction:r,currentCollectionStore:k,relationInfos:h,logger:y});const Q=(0,R().getPropertyTemplates)(W);(0,$().My)({transaction:r,collectionStore:k,propertyTemplates:Q}),(0,$().Bi)({transaction:r,collectionStore:k,propertyTemplates:Q}),function(e){const{transaction:t,collectionStore:o,template:n,logger:r}=e,{format:i}=n.value.targetCollection;if("object"!=typeof(null==i?void 0:i.collection_default_template))return;const a=(0,B().fI)({collectionStore:o,sourceTemplateType:"block",dependencyMap:n.dependencyMap??{},sourcePrimitiveId:i.collection_default_template.template_page_id});a?m().zA({stores:[o],update:{collection_default_template:{template_page_id:a}},transaction:t}):r.warn("Unable to resolve collection default template, omitting it.")}({transaction:r,template:a,collectionStore:k,logger:y}),"tasks"===a.category&&(0,V().maybeAddAppTemplateMetadataForTasks)({environment:o,collectionStore:k,collectionViewBlockStore:O,transaction:r}),function(e){let{transaction:t,collectionViewBlockStore:o}=e;const n=o.getFormat();("workflow_template_placeholder"===n.collection_view_sub_type||n.placeholder_workflow_template_id)&&m().zA({stores:[o],update:{placeholder_workflow_template_id:void 0,collection_view_sub_type:void 0},transaction:t})}({transaction:r,collectionViewBlockStore:O});let Z=[];return null!==(t=a.value.exampleRows)&&void 0!==t&&t.length&&(Z=function(e){let{environment:t,transaction:o,collectionStore:n,collectionViewStore:r,collectionViewBlockStore:i,exampleRows:a,dependencyMap:l}=e;const c=new(A().A)(t);c.setContext({type:"collectionView",collectionViewBlockStore:i,collectionStore:n,collectionViewStore:r,pageVisitSourceOverride:void 0});const s=[],p=c.defaultPageTemplateStore.state,{inMemoryRecordCache:m}=i;for(const f of a){const{newStore:e}=(0,d().Q)({environment:t,collectionContextStore:c,groupsPointer:[],insertAtIndex:0,shouldCoerce:!0,transaction:o,from:{createBlock:"workflow_template"},inMemoryRecordCache:m});s.push(e);const r=D({collectionStore:n,dependencyMap:l,exampleRow:f});(0,T().L)({environment:t,store:e,properties:r.properties,transaction:o}),p&&u().n5({title:"template",environment:t,store:e,templateStore:p,isKeyboard:!1,isCreateIn:!1,transaction:o,from:"collection_template_actions"});const i=e.getIconStore();f.icon&&i&&g().KY({store:i,value:f.icon,transaction:o})}return s}({environment:o,transaction:r,collectionStore:k,collectionViewStore:q,collectionViewBlockStore:O,exampleRows:a.value.exampleRows,dependencyMap:a.dependencyMap??{}})),r.postSubmitCallbacks.push((e=>{e||p().v(o,{from:"workflow_template",type:O.getType()??"collection_view_page",creating_block_id:O.id,collection_view_block_id:O.id,collection_view_id:q.id,collection_id:k.id,view_type:q.getType()})})),{collectionStore:k,collectionViewStore:q,collectionViewBlockStore:O,examplePageStores:Z}}async function U(e){const{environment:t,parentStore:o,title:n,onFinish:r}=e,{serverCommitResult:a,performResult:{collectionViewBlockStore:l,collectionViewStore:s,collectionStore:d}}=y().createAndCommit({userAction:"workflowTemplatesOnboardingModal.addEmptyDatabase",environment:t,canUndo:!0,perform:r=>{let a=e.collectionViewBlockStore;void 0===a&&(a=z({environment:t,transaction:r,parentStore:o,collectionViewBlockType:"collection_view_page",inMemoryRecordCache:o.inMemoryRecordCache}),p().v(t,{from:"workflow_template",type:"page",new_page_id:a.id,creating_block_id:a.id}));const l=(0,w().E)({environment:t,collectionViewBlockStore:a,transaction:r,collectionValue:{name:n?(0,c().x9d)(n):void 0,schema:{title:{name:C().A.formatMessage(b().n4.namePropertyTitle),type:"title"}}}}),s=g().eC({environment:t,table:i().Gy,inMemoryRecordCache:a.inMemoryRecordCache,value:{type:"table",parent_id:a.id,parent_table:a.table,space_id:a.getSpaceId(),format:{collection_pointer:l.pointer},alive:!0},transaction:r}),d=P().pS.createChildStore(a,s.pointer);return(0,k().F)(d.id,{viewType:"table",isPlaceholderCollection:!0}),f().BC({parentStore:a.getCollectionViewsStore(),appendStore:d,transaction:r}),{collectionViewBlockStore:a,collectionViewStore:d,collectionStore:l}}});return await a,r&&r(l),{collectionViewBlockStore:l,collectionViewStore:s,collectionStore:d}}function D(e){let{exampleRow:t,dependencyMap:o,collectionStore:n}=e;const r={properties:{}};for(const[i,a]of Object.entries(t.properties))r.properties[(0,B().CB)({collectionStore:n,sourceTemplateType:"property",dependencyMap:o,sourcePrimitiveId:i})]=a;return r}function z(e){var t;let{environment:o,transaction:n,parentStore:r,collectionViewBlockType:i,inMemoryRecordCache:a}=e;const l=g().Wv({environment:o,type:i,inMemoryRecordCache:a,transaction:n});return g().zv({store:l,transaction:n,data:{parent_id:r.id,parent_table:r.table,alive:!0}}),G({environment:o,spaceViewStore:null===(t=M().default.state.currentSpaceViewStore)||void 0===t?void 0:t.clone(a),parentStore:r,collectionViewBlockStore:l,transaction:n,appendOrPrepend:"append"}),l}function G(e){let{environment:t,parentStore:o,collectionViewBlockStore:n,transaction:i,appendOrPrepend:c,spaceViewStore:p}=e;if(o.table===r().ev)v().NI({parentStore:o,childStore:n,transaction:i});else if(o.table===a().NX){if((null==p?void 0:p.getSpaceId())!==o.id)throw new Error(`spaceViewStore doesn't match parent with ID ${o.id}`);S().yM({environment:t,spaceStore:o,spaceViewStore:p,pageStore:n,isPrivate:!0,transaction:i})}else o.table===l().yK?h().sP({teamStore:o,store:n,transaction:i,location:{type:c}}):(0,s().HB)(o)}function L(e){let{currentCollectionStore:t,relationInfo:o}=e;const{type:n,collectionStore:r}=o;return"source"===n?{sourceCollectionStore:r,targetCollectionStore:t}:"target"===n?{sourceCollectionStore:t,targetCollectionStore:r}:void(0,s().HB)(n)}},775781:(e,t,o)=>{"use strict";o.d(t,{CF:()=>l,f:()=>i});o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601),o(403517);var n=()=>o(901552),r=()=>o(727528);function i(e){let{collectionStore:t,modules:o,dependencyMap:n}=e;return c({modules:o,mapper:a(t,n)})}function a(e,t){return o=>(0,r().CB)({collectionStore:e,sourceTemplateType:"property",sourcePrimitiveId:o,dependencyMap:t})}function l(e){const t=new Set;return c({modules:e,mapper:e=>(t.add((0,n().vO)({type:"property",id:e})),e)}),t}function c(e){let{modules:t,mapper:o}=e;const n=e=>e?e.map((e=>function(e){let{module:t,mapper:o}=e;switch(t.type){case"bottomControls":case"relationsGroup":case"cover":case"discussions":case"editor":case"expandedBacklinks":case"formQuestion":case"formSubmit":case"formTitle":case"inlinePageSections":case"placeholder":case"properties":case"transcript":case"viewsMain":return t;case"property":return{...t,propertyId:o(t.propertyId)};case"titleWithIcon":return{...t,propertyIds:t.propertyIds?t.propertyIds.map(o):void 0};case"views":return{...t,relation_pointer:t.relation_pointer?{...t.relation_pointer,property:o(t.relation_pointer.property)}:void 0}}return t}({module:e,mapper:o}))):void 0;return{page_layout_schema:n(t.page_layout_schema),page_info_layout_schema:n(t.page_info_layout_schema),form_layout_schema:n(t.form_layout_schema),person_profile_page_main:n(t.person_profile_page_main),person_profile_page_details:n(t.person_profile_page_details)}}},835497:()=>{},863977:(e,t,o)=>{"use strict";o.d(t,{Bi:()=>m,My:()=>u,ZM:()=>f});o(362833),o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601),o(725707),o(491955),o(500234),o(403517);var n=()=>o(505966),r=()=>o(34662),i=()=>o(521325),a=()=>o(927999),l=()=>o(448316),c=()=>o(84543),s=()=>o(259897),p=()=>o(486963),d=()=>o(727528);function u(e){var t;let{transaction:o,collectionStore:r,propertyTemplates:i}=e;const l=(null===(t=r.getParentBlockStore())||void 0===t?void 0:t.getCollectionViewStores().filter((e=>"table"===e.getType())))??[];if(0===l.length)return;const c=[];for(const a of i){const e=(0,d().S1)({collectionStore:r,templateId:a.templateId,instancePointerType:"property"});e&&c.push({property:e.id,visible:!(0,n().Sz)(a),...a.tablePropertyFormat})}if(0!==c.length)for(const n of l){var s;const e=(null===(s=n.getPropertyFormatsStore("table_properties"))||void 0===s?void 0:s.getValue())??[],t=new Set(e.map((e=>e.property))),r=c.filter((e=>!t.has(e.property)));0!==r.length&&a().zA({stores:[n],update:{table_properties:[...e,...r]},transaction:o})}}function m(e){let{transaction:t,collectionStore:o,propertyTemplates:n}=e;const r=[];for(const a of n){const e=(0,d().S1)({collectionStore:o,templateId:a.templateId,instancePointerType:"property"});e&&r.push({property:e.id,visible:!0})}const i=o.getFormat().collection_page_properties??[],l=new Set(i.map((e=>e.property))),c=r.filter((e=>!l.has(e.property)));c.length&&a().zA({stores:[o],update:{collection_page_properties:[...i,...c]},transaction:t})}function f(e){let{environment:t,userAction:o,result:n,existingCollectionViewBlockStore:a,existingCollectionStore:d}=e;if("canceled"!==n.type){if("accepted_empty_collection"===n.type&&d){const e=d.getKeyStore("name"),i=(0,r().x9d)(n.newCollectionTitle);e&&c().createAndCommit({userAction:o,environment:t,canUndo:!0,perform:o=>l().R9({environment:t,store:e,transaction:o,value:i})})}if(a){var u;const e=null===(u=(0,p().U)(a))||void 0===u?void 0:u.settingsStore;e&&i().os({collectionSettingsStore:e})}if("accepted_template"===n.type&&null!=a&&a.isCollectionView()&&(null==a||!a.hasSingleSourceAndNoLinkedCollections())){const e=(0,p().U)(a),o=a.getCollectionViewStores().find((e=>{var t;return(null===(t=e.getCollectionStore())||void 0===t?void 0:t.id)===n.collectionId}));if(!e||!o)return;(0,s().t)({environment:t,collectionContextStore:e,collectionViewId:o.id,isFullScreen:e.isFullScreenStore.state,isRootChild:e.isRootChildStore.state,isInPeekRenderer:e.isInPeekRendererStore.state})}}}},901552:(e,t,o)=>{"use strict";o.d(t,{D6:()=>_,Jp:()=>d,OU:()=>S,PT:()=>I,To:()=>g,rW:()=>h,rs:()=>f,vO:()=>v});o(725707),o(491955),o(500234),o(403517);var n=()=>o(975392),r=()=>o(76394),i=()=>o(940445),a=()=>o(540816);const l="content",c="item",s="items",p="optionalDefaultOn",d="/icons/document_gray.svg",u={collection_view:"View",layout:"Layout",collection:"Collection",property:"Property",compound:"Compound",block:"Block",automation:"Automation"},m=Symbol("BuilderKey"),f=v({type:"property",id:o(564134).rn});function v(e){return(0,r().GV)(`${e.type}:${e.id}`,m)}function g(e){if("explicit-undefined"!==e)return e}function S(e){return void 0===e?"explicit-undefined":e}function h(e,t){var o;const n=v(t),u=null===(o=e.state.builderSettings)||void 0===o?void 0:o[n],m=w(e,t),f=m?function(e,t){const o={},n=e.templateRegistryMap.get(t);if(!n)return o;o.name=(0,i().getWorkflowTemplateName)(n),"property"!==n.type&&"collection_view"!==n.type&&"block"!==n.type&&(o.description=n.description);"property"===n.type&&(o.propertyOptionsType=n.propertyOptionsType,o.relatedCollectionTemplateId=n.relatedCollectionTemplateId);if("collection"===n.type){var a;o.hasMinimalOnboarding=null===(a=n.value.onboarding)||void 0===a?void 0:a.isMinimal,o.singularItemName=n.value.targetCollection.itemName.singular,o.pluralItemName=n.value.targetCollection.itemName.plural,o.category=n.category}if("collection"!==n.type&&e.sourceCollectionTemplate){const n=e.sourceCollectionTemplate.value.templateItems.find((e=>e.pointer===t));n?(o.optionality=n.optionality,o.isInSettings=n.isInSettings):o.includeInCollectionTemplate=!1}"compound"===n.type&&(o.icon=n.icon,o.templateItems=n.value.templateItems.map((t=>{const o=e.templateIdToBuilderKeyMap.get(t.pointer);if(o)return{pointer:o,optionality:t.optionality}})).filter(r().O9));return o}(e,e.state.createCopy&&t.templateId?t.templateId:m):{};return{templateId:m,isDeleted:(null==u?void 0:u.isDeleted)??"uninstantiated_template"===t.type,description:((null==u?void 0:u.description)??f.description)||void 0,category:(null==u?void 0:u.category)??f.category,optionality:(0,a().O)(t)?"required":(null==u?void 0:u.optionality)??f.optionality??p,hasMinimalOnboarding:(null==u?void 0:u.hasMinimalOnboarding)??f.hasMinimalOnboarding??!1,singularItemName:(null==u?void 0:u.singularItemName)??f.singularItemName??c,pluralItemName:(null==u?void 0:u.pluralItemName)??f.pluralItemName??s,isInSettings:(null==u?void 0:u.isInSettings)??f.isInSettings??!1,propertyOptionsType:(null==u?void 0:u.propertyOptionsType)??(null==f?void 0:f.propertyOptionsType)??l,includeInCollectionTemplate:(null==u?void 0:u.includeInCollectionTemplate)??(null==f?void 0:f.includeInCollectionTemplate)??!0,templateItems:(null==u?void 0:u.templateItems)??(null==f?void 0:f.templateItems)??[],name:(null==u?void 0:u.name)??(null==f?void 0:f.name)??t.name??("layout"===t.type?"Layout":""),icon:(null==u?void 0:u.icon)??(null==f?void 0:f.icon)??d,bypassCreateCopy:y(u,t),relatedCollectionTemplateId:(null==u?void 0:u.relatedCollectionTemplateId)??(null==f?void 0:f.relatedCollectionTemplateId),ignore:(null==u?void 0:u.ignore)??!!(0,a().NU)(t),shouldMapToTemplate:(null==u?void 0:u.shouldMapToTemplate)??!("collection_view"!==t.type||!t.defaultBuiltinTemplateIdToMapTo)}}function y(e,t){return void 0!==(null==e?void 0:e.bypassCreateCopy)?e.bypassCreateCopy:"property"===t.type&&"relation"===t.schema.type}function w(e,t){var o;const n=v(t),r=null===(o=e.state.builderSettings)||void 0===o?void 0:o[n],i=y(r,t),l=e.state.createCopy&&!i?void 0:t.templateId;if(void 0!==(null==r?void 0:r.templateId))return null==r?void 0:r.templateId;if(void 0!==l)return l;const c="collection"===t.type?"":`${w(e,e.collectionInfo)}.`;return(0,a().O)(t)?`${c}title${u.property}`:"collection_view"===t.type&&t.defaultBuiltinTemplateIdToMapTo&&!1!==(null==r?void 0:r.shouldMapToTemplate)?t.defaultBuiltinTemplateIdToMapTo:t.name&&"uninstantiated_template"!==t.type?c+(s=t.name,p=t.type,`${I(s)}${u[p]}`):"layout"===t.type?`${c}default${u.layout}`:"automation"===t.type?`${c}${t.referrerName}${u.automation}`:void 0;var s,p}function I(e){return(0,n().xQ)(e)}function _(e,t){let o,n,r,{includeType:i=!0}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("string"==typeof t?(n=t,r=e.featureInfoMap.get(t)):(r=t,n=v(r)),r){const t=h(e,r);o=`${t.name||t.templateId}${i?` (${a=r,a.type.replace(/_/g," ")})`:""}`}var a;return o||n}},909177:(e,t,o)=>{"use strict";o.d(t,{v:()=>n});o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601),o(725707),o(244387);function n(e,t){const o=e.reduce(((e,t)=>{if(t.isType("define_variables")){var o;const n=null===(o=t.getModel())||void 0===o?void 0:o.getVariables();if(n)for(const t of Object.values(n))e.add(t.name)}return e}),new Set),n=t.replace(/\s*\d+$/,"");let r=1,i=`${n} ${r}`;for(;o.has(i);)i=`${n} ${r}`,r++;return i}},922563:(e,t,o)=>{"use strict";o.d(t,{y:()=>s,z:()=>p});o(610931);var n=()=>o(662861),r=()=>o(485966),i=()=>o(503780),a=()=>o(308265),l=()=>o(518022),c=()=>o(197562);async function s(e){const{environment:t,parentStore:o,prompt:a}=e;c().A.close({type:"opened_app_builder"});const l=r().default.state.currentSpaceStore;if(!l)throw new Error("No current space store");const s=r().default.state.currentUserStore;if(!s)throw new Error("No current user store");await(0,i().createEmptyWorkflowContainerAndBuild)({environment:t,parentStore:o??l,userStep:(0,n().Kf)({environment:t,spaceStore:l,userStore:s,value:a})})}async function p(e){let{setupGenerator:t,environment:o,parentStore:n,allowNavigateToAppBuilder:r=!0,isPhone:i}=e;if(!r||!(0,a().Yf)({environment:o})){(0,l().moveToNextOnboardingStep)(i);if(!(await t.submitPrompt({from:"initial-input"})))return;return void(0,l().moveToNextOnboardingStep)(i)}const{prompt:c}=t.store.state;c&&await s({environment:o,parentStore:n,prompt:c})}},961397:(e,t,o)=>{"use strict";o.d(t,{C8:()=>u,ET:()=>d,Ll:()=>b,OX:()=>f,QT:()=>g,Rh:()=>w,UA:()=>p,Wm:()=>S,XM:()=>s,aO:()=>y,bd:()=>m,gM:()=>v,gP:()=>_,hq:()=>h,pp:()=>I});o(610931),o(362833),o(725707),o(491955),o(500234),o(403517);var n=()=>o(505966),r=()=>o(141479),i=()=>o(3311),a=()=>o(76394),l=()=>o(940445);const c=3;function s(e){let{origin:t,parentStore:o,flowId:n}=e;return{collectionTemplate:void 0,origin:t,flowId:n??(0,i().Ay)(),collectionTemplatesSearchQuery:void 0,parentStore:o}}function p(e){let{collectionViewTemplates:t,featureTemplateSelections:o}=e;const r=[];for(const i of t)r.push(...(0,n().CA)({template:i,dependencyMap:i.dependencyMap||{}}).map((e=>e.templateId)));return o.filter((e=>"required"!==e.optionality&&!r.includes(e.template.templateId)&&g(e.template)))}function d(e){let{template:t}=e;return{recordTitles:new Array(c).fill(""),featureTemplateSelections:t.value.templateItems.map((e=>m(e.pointer,e.optionality)))}}function u(e){const{collectionTemplate:t,origin:o,flowId:n,parentStore:r}=e;return{collectionTemplate:t,userCustomizations:d({template:t}),origin:o,flowId:n??(0,i().Ay)(),parentStore:r,collectionTemplatesSearchQuery:void 0,previewCollectionInfo:void 0}}function m(e,t){const o=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:l().globalWorkflowTemplates).fromId(e);if(!(0,n().Jb)(o))throw new Error(`Template ${e} in collection template is not a feature template`);return"required"===t?{template:o,optionality:"required",selected:!0}:"optionalDefaultOn"===t?{template:o,optionality:"optionalDefaultOn",selected:!0}:"optionalDefaultOff"===t?{template:o,optionality:"optionalDefaultOff",selected:!1}:void(0,a().HB)(t)}function f(e){if(!e.collectionTemplate)throw new Error("Collection template cannot be undefined");return{collectionTemplate:e.collectionTemplate,userCustomizations:e.userCustomizations,origin:e.origin,flowId:e.flowId,collectionTemplatesSearchQuery:e.collectionTemplatesSearchQuery,parentStore:e.parentStore,previewCollectionInfo:e.previewCollectionInfo}}function v(e){var t,o,n,r;return{origin:e.origin,has_selection_modal_search_query:((null===(t=e.collectionTemplatesSearchQuery)||void 0===t?void 0:t.length)??0)>0,flow_id:e.flowId,collection_template_id:null===(o=e.collectionTemplate)||void 0===o?void 0:o.templateId,destination_type:null===(n=e.parentStore)||void 0===n?void 0:n.table,destination_id:null===(r=e.parentStore)||void 0===r?void 0:r.id}}function g(e){return"property"===e.type&&"relation"!==e.value.type||"compound"===e.type}function S(e){const{version:t}=e;return r().s[t]}function h(e){const{currentStepIndex:t}=e;return S(e)[t]}function y(e,t){const{currentStepIndex:o,collectionTemplate:n}=e,r=S(e);for(let i=o+1;i<r.length;i++){const e=r[i];if(!(n&&T({step:e,template:n,action:"next",isPhone:t})))return i}return-1}function w(e,t){return y(e,t)>=0}function I(e,t){return _(e,t)>=0}function _(e,t){const{currentStepIndex:o,collectionTemplate:n}=e,r=S(e);for(let i=o-1;i>=0;i--){const e=r[i];if(!(n&&T({step:e,template:n,action:"previous",isPhone:t})))return i}return-1}function T(e){let{step:t,template:o,action:n,isPhone:r}=e;switch(t){case"viewsSelection":return r||l().globalWorkflowTemplates.allOfType({templateIds:o.value.templateItems.map((e=>e.pointer)),type:"collection_view"}).length<=1;case"templateSelection":case"features":case"setupGeneratorInput":return!1;case"setupGeneratorBuilding":return"previous"===n;default:(0,a().HB)(t)}}function b(e){let{userCustomizations:t,templateId:o}=e;const n=t.featureTemplateSelections,r=n.find((e=>e.template.templateId===o));if(!r||"required"===r.optionality)return t;const i={...r,selected:!r.selected};return{...t,featureTemplateSelections:n.map((e=>e.template.templateId===o?i:e)),prevFeatureTemplateSelections:n}}}}]);