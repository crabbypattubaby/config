"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[55776],{431169:(e,t,o)=>{o.r(t),o.d(t,{hasAccessDefaultFn:()=>P,hasAccessToCode:()=>I,hasAccessToProperty:()=>T,hasReadPermissionsAccess:()=>x,hasSameSpaceAccess:()=>k,testOnly:()=>F});o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601),o(725707),o(491955);var n=()=>o(975392),i=()=>o(23371),r=()=>o(204132),c=()=>o(76394),s=()=>o(564134),l=()=>o(807912),p=()=>o(187058),a=()=>o(465546),d=()=>o(63430),u=()=>o(32856);function*y(e){const{collectionPointer:t,context:o,propertyId:n,propertySchema:i,visitedPointers:r,hasAccessFn:c}=e,s=(0,p().G7)({...t,propertyId:n});if(r.has(s))return!0;r.add(s);const l=c({propertySchema:i,spaceId:o.spaceId});return"boolean"==typeof l?l:yield*l}function*f(e){var t,o;const{collectionPointer:i,depth:d,collectionSchema:y,context:f,propertyId:h,propertySchema:m,visitedPointers:P,hasAccessFn:x}=e;if("v2"!==m.version||d>l().FORMULA_MAX_DEPTH)return!1;const k=(0,p().G7)({...i,propertyId:h});if(P.has(k))return!0;if(P.add(k),!(0,c().O9)(null===(t=m.formula2)||void 0===t?void 0:t.code))return!0;const T=(0,u().$t)(null===(o=m.formula2)||void 0===o?void 0:o.code);if(r().Q.isFail(T))return!1;const{spaceId:I}=f,F=(0,p().zm)({formulaTypecheckContextValues:[{kind:l().FormulaContextValueKind.ThisRow,type:{collection:i,type:"block"}}],node:T.value,spaceId:I}),S=(0,n().hS)(F,(e=>(0,p().G7)(e)));if(0===S.length)return!0;const{getRecordModel:A}=yield{collectionBlockProperties:[{blockPointers:[],collectionPointer:i,property:h,schema:y}],recordPointers:S.filter((e=>(0,a().T3)(e)))};for(const n of S)if((0,s().pq)(n)){const e=A(n);if(!(0,c().O9)(e))return!1;const t=n.propertyId,o=e.getSchema(),i=o[t];if(!i)continue;if((0,s().bT)(i)||(0,s().lb)(i)){if(!(yield*v({collectionPointer:n,collectionSchema:o,context:f,depth:d+1,propertyId:t,propertySchema:i,visitedPointers:P,hasAccessFn:x})))return!1}else if((0,s().nC)(i)){if(!(yield*v({collectionPointer:n,collectionSchema:o,context:f,depth:d,propertyId:t,propertySchema:i,visitedPointers:P,hasAccessFn:x})))return!1}}else if(!(0,c().O9)(A(n)))return!1;return!0}function*h(e){const{collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:a,hasAccessFn:u}=e;if("v2"===c.version||o>l().FORMULA_MAX_DEPTH)return!1;const y=(0,p().G7)({...t,propertyId:r});if(a.has(y))return!0;a.add(y);const f=(0,d().kh)(c.formula);if(0===f.length)return!0;for(const l of f){const e=n[l];if(e)if((0,s().bT)(e)||(0,s().lb)(e)){if(!(yield*v({collectionPointer:t,depth:o+1,collectionSchema:n,context:i,propertyId:l,propertySchema:e,visitedPointers:a,hasAccessFn:u})))return!1}else if((0,s().nC)(e)){if(!(yield*v({collectionPointer:t,collectionSchema:n,context:i,depth:o,propertyId:l,propertySchema:e,visitedPointers:a,hasAccessFn:u})))return!1}}return!0}function*m(e){const{collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:a,hasAccessFn:d}=e;if(o>l().FORMULA_MAX_DEPTH)return!1;const u=(0,p().G7)({...t,propertyId:r});if(a.has(u))return!0;if(a.add(u),!c.relation_property||!c.target_property)return!0;const y=n[c.relation_property];if(!y||"relation"!==y.type)return!0;const f=d({propertySchema:y,spaceId:i.spaceId});if(!("boolean"==typeof f?f:yield*f))return!1;const h=(0,s().Nv)(y);if(!h)return!0;const{getRecordModel:m}=yield{recordPointers:[h]},P=m(h),x=null==P?void 0:P.getNormalizedSchema();if(c.target_property_type&&x){const e=x[c.target_property];if(e&&c.target_property_type===e.type){if((0,s().lb)(e))return yield*v({collectionPointer:h,collectionSchema:x,context:i,depth:o+1,propertyId:c.target_property,propertySchema:e,visitedPointers:a,hasAccessFn:d});if((0,s().nC)(e))return yield*v({collectionPointer:h,collectionSchema:x,context:i,depth:o,propertyId:c.target_property,propertySchema:e,visitedPointers:a,hasAccessFn:d})}}return!0}function*v(e){const{collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:l,hasAccessFn:p}=e;return(0,s().nC)(c)?yield*y({collectionPointer:t,context:i,propertyId:r,propertySchema:c,visitedPointers:l,hasAccessFn:p}):(0,s().lb)(c)?"v2"===c.version?yield*f({collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:l,hasAccessFn:p}):yield*h({collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:l,hasAccessFn:p}):!(0,s().bT)(c)||(yield*m({collectionPointer:t,depth:o,collectionSchema:n,context:i,propertyId:r,propertySchema:c,visitedPointers:l,hasAccessFn:p}))}function*P(e){const{propertySchema:t,spaceId:o}=e,n=(0,s().Nv)(t);if(!(0,c().O9)(n))return!0;const{getRecordModel:i}=yield{recordPointers:[n]},r=i(n);return(0,c().O9)(r)&&k({spaceId:o,propertySchema:t})}function*x(e){const{propertySchema:t}=e,o=(0,s().Nv)(t);if(!(0,c().O9)(o))return!0;const{getRecordModel:n}=yield{recordPointers:[o]},i=n(o);return(0,c().O9)(i)}function k(e){const{propertySchema:t,spaceId:o}=e;return!(0,s().o2)(o,t)}async function T(e){const{collectionPointer:t,collectionSchema:o,context:n,propertyId:r,hasAccessFn:c}=e,s=o[r];return!s||await async function(e){const{context:t}=e;try{const o=v(e);let n=o.next();for(;!n.done;){const e=t.handleDataRequest(n.value);n=o.next((0,i().yL)(e)?await e:e)}return n.value}catch(o){return!0}}({collectionPointer:t,depth:0,collectionSchema:o,context:n,propertyId:r,propertySchema:s,visitedPointers:new Set,hasAccessFn:c})}function I(e){const{context:t}=e;try{const o=function*(e){const{collectionPointer:t,depth:o,context:i,code:d,visitedPointers:y,hasAccessFn:f}=e,h=(0,u().$t)(d);if(r().Q.isFail(h))return!1;const{spaceId:m}=i,P=i.valueTypes.filter((e=>e.kind!==l().FormulaContextValueKind.ThisRow)),x=(0,p().zm)({formulaTypecheckContextValues:t?[...P,{kind:l().FormulaContextValueKind.ThisRow,type:{collection:t,type:"block"}}]:[],node:h.value,spaceId:m}),k=(0,n().hS)(x,(e=>(0,p().G7)(e)));if(0===k.length)return!0;const{getRecordModel:T}=yield{collectionBlockProperties:[],recordPointers:k.filter((e=>(0,a().T3)(e)))};for(const n of k)if((0,s().pq)(n)){const e=T(n);if(!(0,c().O9)(e))return!1;const t=n.propertyId,r=e.getSchema(),l=r[t];if(!l)continue;if((0,s().bT)(l)||(0,s().lb)(l)){if(!(yield*v({collectionPointer:n,collectionSchema:r,context:i,depth:o+1,propertyId:t,propertySchema:l,visitedPointers:y,hasAccessFn:f})))return!1}else if((0,s().nC)(l)&&!(yield*v({collectionPointer:n,collectionSchema:r,context:i,depth:o,propertyId:t,propertySchema:l,visitedPointers:y,hasAccessFn:f})))return!1}else if(!(0,c().O9)(T(n)))return!1;return!0}(e);let i=o.next();for(;!i.done;){const e=t.handleDataRequest(i.value);i=o.next(e)}return i.value}catch(o){return!0}}const F={hasAccessDefaultFn:P,hasAccessToProperty:T,hasAccessToFormula1Property:h,hasAccessToFormula2Property:f,hasAccessToRelationProperty:y,hasAccessToRollupProperty:m}},638186:(e,t,o)=>{o.r(t),o.d(t,{getFormulaEditorInfoAtPosition:()=>I});o(362833),o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601),o(725707),o(491955),o(500234),o(771702),o(403517);var n=()=>o(129924),i=()=>o(188877),r=()=>o(23371),c=()=>o(204132),s=()=>o(489359),l=()=>o(576281),p=()=>o(807912),a=()=>o(336185),d=()=>o(376368),u=()=>o(431169),y=()=>o(530614),f=()=>o(479056),h=()=>o(465546),m=()=>o(530720);async function v(e,t,o){const n=[],i=new Set;if(void 0!==e){const c=t.handleDataRequest({recordPointers:[e]}),s=((0,r().yL)(c)?await c:c).getRecordModel(e),l=null==s?void 0:s.getNormalizedSchema();if(l)for(const[r,a]of Object.entries(l))if(void 0!==(null==a?void 0:a.type)&&p().FormulaTokenSupportedBlockSystemPropertyList.includes(null==a?void 0:a.type)&&i.add(a.type),r!==t.sourceProperty&&null!=a&&a.name&&p().FORMULAS_SUPPORTED_COLLECTION_PROPERTY_TYPES.includes(null==a?void 0:a.type)&&P(o,a.name)){let o;"cross_space_only"===t.restrictUnaccessibleProperties?o=u().hasSameSpaceAccess:"read_permissions_only"===t.restrictUnaccessibleProperties?o=u().hasReadPermissionsAccess:"cross_space_and_read_permissions"===t.restrictUnaccessibleProperties&&(o=u().hasAccessDefaultFn);(!t.restrictUnaccessibleProperties||!o||await(0,u().hasAccessToProperty)({collectionPointer:e,collectionSchema:l,context:t,propertyId:r,hasAccessFn:o}))&&n.push({kind:p().FormulaEditorInfoCompletionKind.Token,name:a.name,token:{type:p().FormulaTokenType.BlockProperty,property:(0,h().XH)(r),collection:e}})}}for(const r of Object.values(p().FormulaTokenSupportedBlockSystemProperty)){if(i.has(r))continue;const e=(0,s().i)(r);(""===o||P(o,e))&&n.push({kind:p().FormulaEditorInfoCompletionKind.Token,token:{type:p().FormulaTokenType.BlockProperty,property:r,collection:void 0},name:e})}return n}function P(e,t){return""===e||(0,i().It)(e,t)}async function x(e){const{prefix:t,context:o,receiverType:n,includeDeprecatedCompletions:r,dotMemberExpression:c}=e,s=[],l=[],a=[],d=new Set;if(void 0===n){var u;o.valueTypes.forEach((e=>{if(e.kind===p().FormulaContextValueKind.Binding){const o=e.id;!d.has(o)&&t!==e.id&&P(t,e.id)&&(s.push({kind:p().FormulaEditorInfoCompletionKind.Binding,text:o,type:e.type}),d.add(o))}}));const e=null===(u=o.valueTypes.find((e=>e.kind===p().FormulaContextValueKind.ThisRow)))||void 0===u?void 0:u.type;"block"===(null==e?void 0:e.type)&&void 0!==e.collection&&l.push(...await v(e.collection,o,t)),o.valueTypes.forEach((e=>{if(e.kind===p().FormulaContextValueKind.ContextValue&&P(t,e.name)){const t=(0,h().Bk)(e.id);l.push({kind:p().FormulaEditorInfoCompletionKind.Token,name:e.name,token:{type:p().FormulaTokenType.ContextValue,valueId:t}})}}))}else"block"===n.type&&l.push(...await v(n.collection,o,t));for(const i in m().LP)if(!d.has(i)&&P(t,i)&&(r||!i.startsWith("_"))&&("toNumber"!==i||null==n||!n.type||!m().Qi.includes(n.type))&&(!c||!m().bq.includes(i))){const e=m().LP[i];if(void 0!==n){var y,f;const t=(null===(y=e.parameters)||void 0===y||null===(y=y.expected)||void 0===y||null===(y=y[0])||void 0===y?void 0:y.type)??(null===(f=e.parameters)||void 0===f||null===(f=f.varargs)||void 0===f||null===(f=f[0])||void 0===f?void 0:f.type);if(void 0===t||!(0,h().s7)(n,t))continue}a.push({kind:p().FormulaEditorInfoCompletionKind.LibraryFunction,libraryFunction:e}),d.add(i)}return[...(0,i().Ay)(t,s,(e=>e.text)),...(0,i().Ay)(t,l,(e=>e.name??"")),...(0,i().Ay)(t,[],(e=>e.builtin)),...(0,i().Ay)(t,a,(e=>e.libraryFunction.name))]}function k(e,t){const o=[...e].reverse().find((e=>e.kind===f().NM.Call));if((null==o?void 0:o.kind)===f().NM.Call){let e=-1;if(t>o.lParenOffset&&(void 0===o.rParenOffset||t<=o.rParenOffset))for(e=0;e<o.commaOffsets.length&&!(o.commaOffsets[e]>t);e++);return{expression:o.expression,parameterIndex:e}}}const T={[p().FormulaEditorInfoCompletionKind.Binding]:0,[p().FormulaEditorInfoCompletionKind.Token]:1,[p().FormulaEditorInfoCompletionKind.Builtin]:2,[p().FormulaEditorInfoCompletionKind.LibraryFunction]:3};async function I(e){var t,o;const{formula:i,inputPosition:r,context:s,includeDeprecatedCompletions:u}=e,[v,I]=(0,a().kb)(i),S=(0,a().NZ)(I,r);let A=v.substring(0,S);const b=A[A.length-1],g=/[\s.]/.test(b);g&&(A=`${A}_`);const C=(0,d().p8)(),E=(0,d().TM)(C).tokenize(A).tokens,_=(0,d()._M)(C);_.input=E;const M=_.expression(),N=(0,l().f)(M);if(c().Q.isFail(N))return{value:void 0};const R=await(0,y()._)(N.value,s,I),{node:O}=R,U=E[E.length-1];let w=!1,K=E;void 0!==U&&(0,n().G)(U,C.IdentifierName)&&(K=[...K],K.pop(),w=!0);const L=_.computeContentAssist("expression",K),D=w?U.image.substring(0,U.image.length-(g?1:0)):void 0,B=(0,h().Kp)(O,S),V={inputPosition:r,mappedPosition:S,nodePath:B,callParameter:k(B,S)},q=[],G=k(B,S),z={handleDataRequest:s.handleDataRequest,restrictUnaccessibleProperties:s.restrictUnaccessibleProperties,sourceProperty:s.sourceProperty,spaceId:s.spaceId,valueTypes:O.valueTypes,featureGates:s.featureGates};let X;for(let n=1;n<=5;n++){const e=(0,h().Kp)(O,S-n);if(X=e[e.length-1],void 0!==X)break}(null===(t=X)||void 0===t?void 0:t.kind)===f().NM.RecoveryNode&&(X=void 0);const H=void 0!==X&&0===B.length,Q=!X||X.kind===f().NM.Unary||X.kind===f().NM.Equality||X.kind===f().NM.Identifier,$=!X||X.kind===f().NM.Equality||X.kind===f().NM.Identifier;for(const c of L){var j,Y,W,Z,J,ee,te,oe,ne;if(c.nextTokenType===C.IdentifierName){const e="dotMemberExpression"===c.ruleStack[c.ruleStack.length-1];if(e){const t=K[K.length-1];if(!(0,n().G)(t,C.Dot))return{value:void 0};const o=B[B.length-1];if(void 0!==o&&(o.kind===f().NM.UnifiedFunctionProperty||o.kind===f().NM.MemberBlockProperty)){const t=o.expression;V.completionsInfo={type:"member dot receiver",prefix:D,receiverNode:t};const n=await x({prefix:D??"",context:z,receiverType:t.type,includeDeprecatedCompletions:u,dotMemberExpression:e});q.push(...n)}}else{V.completionsInfo={type:"free identifier",prefix:D};const t=await x({prefix:D??"",context:z,includeDeprecatedCompletions:u,dotMemberExpression:e});if(q.push(...t),G&&(G.expression.kind===f().NM.UnifiedFunctionProperty&&0===G.parameterIndex||G.expression.kind===f().NM.Identifier&&1===G.parameterIndex)){const e=G.expression.kind===f().NM.UnifiedFunctionProperty?G.expression.name:G.expression.text,t=m().LP[e];if(((null==t?void 0:t.parameters)===m().Ux||(null==t?void 0:t.parameters)===m().MB)&&P(D??"",p().CURRENT_VALUE_NAME)&&D!==p().CURRENT_VALUE_NAME&&D!==`${p().CURRENT_VALUE_NAME}.`){var ie,re;const e=G.expression,t="function"===e.type.type&&"array"===(null===(ie=e.type.boundTargetType)||void 0===ie?void 0:ie.type)&&(null===(re=e.type.boundTargetType)||void 0===re?void 0:re.of)||{type:"unknown"};q.push({kind:p().FormulaEditorInfoCompletionKind.Binding,text:p().CURRENT_VALUE_NAME,type:t}),q.push({kind:p().FormulaEditorInfoCompletionKind.Binding,text:p().CURRENT_INDEX_NAME,type:{type:"number"}})}}}}else if(c.nextTokenType===C.AdditionOperator&&H&&"text"===(null===(j=X)||void 0===j?void 0:j.type.type)){const e=F(["+"],D??"");q.push(...e)}else if(c.nextTokenType===C.AdditionOperator&&H&&"number"===(null===(Y=X)||void 0===Y?void 0:Y.type.type)){const e=F(["+","-"],D??"");q.push(...e)}else if(c.nextTokenType===C.MultiplicationOperator&&H&&"number"===(null===(W=X)||void 0===W?void 0:W.type.type)){const e=F(["*","/"],D??"");q.push(...e)}else if(c.nextTokenType!==C.RelationalOperator||!H||"number"!==(null===(Z=X)||void 0===Z?void 0:Z.type.type)&&"text"!==(null===(J=X)||void 0===J?void 0:J.type.type)&&"date"!==(null===(ee=X)||void 0===ee?void 0:ee.type.type)){if(c.nextTokenType===C.EqualityOperator&&H&&null!==(te=X)&&void 0!==te&&te.type.type&&"unknown"!==(null===(oe=X)||void 0===oe?void 0:oe.type.type)){const e=F(["==","!="],D??"");q.push(...e)}else if(c.nextTokenType===C.BooleanLiteral&&Q){const e=F(["true","false"],D??"");q.push(...e)}else if(c.nextTokenType===C.And&&H&&"checkbox"===(null===(ne=X)||void 0===ne?void 0:ne.type.type)){const e=F(["and","or"],D??"");q.push(...e)}else if(c.nextTokenType===C.UnaryOperator&&$){const e=F(["not"],D??"");q.push(...e)}}else{const e=F([">",">=","<","<="],D??"");q.push(...e)}}const ce=null===(o=E[E.length-1])||void 0===o?void 0:o.tokenType;if(0===q.length&&ce===C.IdentifierName){const e=E.slice(-4).reverse(),t=[];for(let n=0;n<e.length;n++){var se;if((null===(se=e[n])||void 0===se?void 0:se.tokenType)!==C.IdentifierName)break;const o=w?e[n].image.substring(0,e[n].image.length-(g?1:0)):void 0;void 0!==o&&(0===n?t.push(o):t.push(o+t[n-1]))}let o=[];for(let n=1;n<t.length;n++){const e=t[n],i=await x({prefix:e.trim(),context:z,includeDeprecatedCompletions:u,dotMemberExpression:!1});if(i.length>0){o=i.map((t=>({...t,overridePrefixLength:e.length+n})))}}q.push(...o)}return V.completions=q.sort(((e,t)=>{const o=e.kind,n=t.kind;return T[o]-T[n]})),{value:V}}function F(e,t){return e.filter((e=>P(t,e))).map((e=>({kind:p().FormulaEditorInfoCompletionKind.Builtin,builtin:e})))}}}]);