"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[90978],{57393:(e,t,r)=>{r.d(t,{Bu:()=>_,qw:()=>f});r(725707),r(491955),r(771702);var a=()=>r(975392);const l=/[\u4E00-\u9FA5]/g,s=/[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/g,n=/[\u3041-\u3096\u30A0-\u30FF\u31F0-\u31FF\u3220-\u3243\u3280-\u337F]/g,u=/[\u1100-\u11FF\u3130-\u318F\uA960-\uA97F\uAC00-\uD7AF\uD7B0-\uD7FF]/g,o=/[-./\\()"'’‘”“，。、·～；,;<>~!@#$%^&*|+=[\]{}`~?:\s]/u;function i(e){return Boolean(e.match(l))}function c(e){return Boolean(e.match(u))}function h(e){return Boolean(e.match(s))}function f(e){return(0,a().oE)(e.split(o))}function _(e,t){const r=c(e);return i(e)||h(e)||r?r?"ko":function(e){return Boolean(e.match(n))}(e)||"ja-JP"===t?"ja":"zh":"none"}},723969:(e,t,r)=>{r.d(t,{r:()=>ee,k:()=>Q});r(725707),r(107652),r(491955),r(500234),r(324989),r(771702),r(403517),r(113085);var a=()=>r(145017),l=()=>r(57393),s=()=>r(32194),n=()=>r(188877),u=()=>r(975392),o=()=>r(3311),i=()=>r(76394),c=()=>r(141666),h=()=>r(233358),f=()=>r(137476),_=()=>r(36746),d=()=>r(471979);r(362833),r(333225),r(494367),r(516262),r(573119),r(240480),r(950443),r(619601);async function E(e){const{spaceId:t,userId:a,blocks:l,environment:s}=e,n=l.map((e=>e.blockModel.id));if(!t||!a||!(0,i().EI)(n))return;const u=await r(818369).callApi({eventName:"getPageSignals",environment:s,data:{spaceId:t,pageIds:n,includeRecords:!0,signals:[{name:"pageAuthorityV1"}]}});if("success"===u.type){const e=n.map((e=>({})));u.data.signals.forEach((t=>{if("success"===t.status){const{name:r,data:a}=t;a.forEach(((t,a)=>{e[a][r]=t}))}}));const r=(0,c().MU)(e.map(((e,t)=>[n[t],e]))),l=T.getKey(t,a);T.update((e=>{const t=e.pageSignals.get(l),a=e.pageSignals.set(l,{...t,...r});return{...e,pageSignals:a}}))}}class g extends(()=>r(129044))().default{getInitialState(){return{pageSignals:new Map}}getKey(e,t){return`${e}:${t}`}getPageSignals(e){let{spaceId:t,userId:r}=e;if(!t||!r)return;const a=this.getKey(t,r),l=this.state.pageSignals.get(a);return l||void 0}async updatePageSignals(e){const{spaceId:t,userId:r,blocks:a}=e;if(!t||!r)return;const l=this.getPageSignals(e),s=void 0===l?a:a.filter((e=>!l.hasOwnProperty(e.blockModel.id)));if(s.length>0&&await E({...e,blocks:s}),l){const e=Object.keys(l).length+s.length;if(e>2048){const s=e-2048,n=new Set(a.map((e=>e.blockModel.id)));!function(e){const{spaceId:t,userId:r,pageIds:a}=e,l=T.getKey(t,r);T.update((e=>{const t={...e.pageSignals.get(l)};a.forEach((e=>delete t[e]));const r=e.pageSignals.set(l,t);return{...e,pageSignals:r}}))}({spaceId:t,userId:r,pageIds:Object.keys(l).filter((e=>!n.has(e))).slice(0,s)})}}}}const T=new g;class v{constructor(e,t,a){var l;this.featuresets=void 0,this.queryLower=void 0,this.userId=void 0,this.spaceId=void 0,this.currentTimeMs=void 0,this.currentDateMs=void 0,this.pageSignals=void 0,this.resultsFeatureMetadata={},this.recentPagesMap=void 0,this.featuresets=e,this.queryLower=a.toLowerCase();const s=t.currentUser.id,n=null===(l=r(485966).default.state.currentSpaceStore)||void 0===l?void 0:l.id;this.userId=s,this.spaceId=n,this.currentTimeMs=Date.now(),this.currentDateMs=new Date(new Date(this.currentTimeMs).toDateString()).getTime(),this.pageSignals=T.getPageSignals({spaceId:this.spaceId,userId:this.userId}),this.recentPagesMap=u().Bj((()=>{const e=(n?r(761079).A.get(n):[])??[];return new Map(e.map((e=>[e.pageId,e.visitedAt])))}))}searchFrecencyVisits(e){const{spaceId:t,userId:a}=this;if(t&&a)return(0,r(850703).C8)({spaceId:t,userId:a,pageId:e})}searchSimilarUserVisits(e){const{spaceId:t,userId:a}=this;if(t&&a)return function(e){const{spaceId:t,userId:a,pageId:l}=e,s=r(611699).default.getUserSignals({spaceId:t,userId:a});if(!s)return;return s.similarUserRecentPages[l]}({spaceId:t,userId:a,pageId:e})}extractFeatureGroup(e){const t=[];for(const r of this.featuresets){const a={groupName:r.name,features:[]};for(const t of r.features)a.features.push(t({result:e,featureExtractor:this}));t.push(a)}return t}}var I=()=>r(840024),C=()=>r(836331),S=()=>r(638907),O=()=>r(189823),R=()=>r(184539);function m(e){return Number.isFinite(e)?e:0}const p={name:"CLIENT_FEATURESET_RELEVANCY_MODEL",features:[function(e){let{result:t,featureExtractor:r}=e;return{name:"TIME_SINCE_LAST_EDIT",value:r.currentTimeMs-t.block.blockModel.last_edited_time}},function(e){let{result:t,featureExtractor:r}=e;return{name:"IS_LAST_EDITED_BY_ME",value:r.userId&&t.block.blockModel.last_edited_by_id===r.userId?1:0}},function(e){let{result:t,featureExtractor:r}=e;return{name:"IS_CREATED_BY_ME",value:r.userId&&t.block.blockModel.created_by_id===r.userId?1:0}},...s().jp.map((e=>t=>{let{result:r}=t;return{name:`BLOCK_SOURCE_${e}`,value:r.block.source.has(e)?1:0}})),function(e){var t;let{result:r,featureExtractor:a}=e;return{name:"PAGE_AUTHORITY_V1",value:a.pageSignals?null===(t=a.pageSignals[r.block.blockModel.id])||void 0===t?void 0:t.pageAuthorityV1:void 0}},function(e){let{result:t}=e;return{name:"TITLE_LENGTH",value:t.block.text.length}},function(e){let{result:{terms:t},featureExtractor:{queryLower:r}}=e;return{name:"TERMS_COUNT_NORMALIZED",value:m(t.length/(0,R().Bj)(r).length)}},function(e){let{result:{terms:t},featureExtractor:{queryLower:r}}=e;const a=(0,R().Bj)(r),l=new Set(t);return{name:"FULL_MATCH_TERM_COUNT_NORMALIZED",value:m(a.filter((e=>l.has(e))).length/a.length)}},function(e){let{result:{terms:t,block:{text:r}}}=e;const a=(0,R().Bj)(r.toLowerCase());return{name:"MATCHING_PERCENTAGE_OF_TITLE",value:m(t.length/a.length)}}]},M={name:"CLIENT_FEATURESET_RELEVANCY_MODEL_UNIFIED",features:[function(e){let{result:t,featureExtractor:r}=e;const a=t.block.blockModel.id,l=r.recentPagesMap().get(a),s=r.currentDateMs,n=Math.max(l??-1);return n<0?{name:"RECENT_VISIT_SCORE",value:U}:{name:"RECENT_VISIT_SCORE",value:1+L({nowDateMs:s,visitedAt:n})}},function(e){let{result:t,featureExtractor:r}=e;const a=t.block.blockModel.id,l=r.searchFrecencyVisits(a),s=r.currentDateMs;if(!l)return{name:"SEARCH_FRECENCY_SCORE",value:U};const n=l.visits.map((e=>L({nowDateMs:s,visitedAt:e}))),o=(0,u().cz)(n)/n.length;return{name:"SEARCH_FRECENCY_SCORE",value:1+l.totalVisits*o}},function(e){let{result:t,featureExtractor:r}=e;const a=t.block.blockModel.id,l=r.searchSimilarUserVisits(a);return l&&l.sortedSimilarUserSignals.length?{name:"SIMILAR_USER_VISIT_SCORE",value:1+l.sortedSimilarUserSignals[0].similarity}:{name:"SIMILAR_USER_VISIT_SCORE",value:0}},function(e){let{result:t,featureExtractor:r}=e;return{name:"MINISEARCH_SCORE",value:t.minisearchScore}},function(e){let{result:t,featureExtractor:r}=e;return{name:"MINISEARCH_SCORE_BOOST",value:t.score/t.minisearchScore}}]};function L(e){let{nowDateMs:t,visitedAt:r}=e;const a=new Date(new Date(r).toDateString()).getTime(),l=Math.max(Math.round((t-a)/c().nD),0);return A[Math.min(l,119)]??0}const A=[1,.434123725,.2014437701,.1884654745,.15822173,.1422946031,.142166057,.1585730404,.104180793,.08345552147,.08087231107,.07897914664,.07896564574,.08624855475,.1008828419,.07266583529,.06040518516,.05852083656,.05753743353,.05815673014,.0642358674,.07381557067,.05695876233,.04843320955,.0470903377,.0466126019,.04746668155,.05325934739,.06307552903,.04855074175,.04160564903,.04030096372,.0391499705,.03939387352,.04339750927,.04955280165,.03917733172,.03338547498,.03209648275,.03168258564,.03227832486,.03591521672,.04128251996,.03310833841,.02833391706,.0272294016,.02689436518,.02729836191,.03046923141,.03441215965,.02831271484,.02449716514,.02354647072,.02317412649,.02358864378,.0263629034,.03012237319,.02459941584,.02126459634,.02046809053,.02030330894,.02052315898,.0228313469,.02579947184,.02105456017,.01811545682,.01734374938,.01698213336,.01714570426,.01897155626,.02136217635,.01769765159,.01529119728,.01463419502,.01431262545,.01444443674,.0159017961,.01772871671,.01474489776,.01280999558,.01220517103,.01190906906,.01197576757,.01314474565,.01475010088,.01212414472,.01051461218,.009996802444,.009711358103,.009723316362,.01077170102,.01191292066,.009778124374,.008391943098,.007831708926,.007399958434,.007365904844,.008059776794,.008782521067,.007061224987,.006022772552,.005622109974,.005249218012,.005053326649,.005458692089,.005740997442,.004543123306,.00380476497,.003402129751,.003036012596,.002836157214,.00291875208,.00288708271,.002093633442,.001635128163,.001354411665,.001031197037,.0007361583583,.0005966154595,.000366973101],U=.4558522322;r(610931),r(244387);function N(e,t){return B(e,t,0)}function B(e,t,r){const a=t[r];if("value"in a)return a.value;const{feature:l,threshold:s,left:n,right:u}=a;return e[l]<=s?B(e,t,u):B(e,t,n)}const b=[{feature:"NUMBER_OF_BLOCK_SOURCES",threshold:.9803883731365204,left:1,right:64},{feature:"NUMBER_OF_BLOCK_SOURCES",threshold:-.02051524817943573,left:2,right:33},{feature:"TITLE_LENGTH",threshold:-.9804741442203522,left:3,right:18},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:4,right:11},{feature:"PAGE_AUTHORITY_V1",threshold:.9929431676864624,left:5,right:8},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:6,right:7},{value:.055661729574773056},{value:.11489805030510493},{feature:"IS_LAST_EDITED_BY_ME",threshold:.5,left:9,right:10},{value:.1303473491773309},{value:.2761679479597871},{feature:"PAGE_AUTHORITY_V1",threshold:.7070983946323395,left:12,right:15},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:13,right:14},{value:.15403218305273927},{value:.2901420576840293},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:16,right:17},{value:.3969548667754214},{value:.5434689507494647},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:19,right:26},{feature:"PAGE_AUTHORITY_V1",threshold:-9373319335297929e-20,left:20,right:23},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:21,right:22},{value:.019246861924686193},{value:.0422577337207315},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.38750000298023224,left:24,right:25},{value:.04463445567238064},{value:.08163417730973187},{feature:"PAGE_AUTHORITY_V1",threshold:.9430259466171265,left:27,right:30},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:28,right:29},{value:.04921499627799959},{value:.11522081288769559},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:31,right:32},{value:.15812057498390902},{value:.26642904878592116},{feature:"TITLE_LENGTH",threshold:-.8644499182701111,left:34,right:49},{feature:"PAGE_AUTHORITY_V1",threshold:.7071063816547394,left:35,right:42},{feature:"TIME_SINCE_LAST_EDIT",threshold:-.9999998509883881,left:36,right:39},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.7386363744735718,left:37,right:38},{value:.5046524356869184},{value:.6139737991266375},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.9545454680919647,left:40,right:41},{value:.35265916931762176},{value:.4631217838765009},{feature:"IS_LAST_EDITED_BY_ME",threshold:.5,left:43,right:46},{feature:"BLOCK_SOURCE_teamPage",threshold:.5,left:44,right:45},{value:.5826717293752157},{value:.3459669582118562},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.9285714328289032,left:47,right:48},{value:.6696084874659657},{value:.7931906286870049},{feature:"PAGE_AUTHORITY_V1",threshold:.7071079015731812,left:50,right:57},{feature:"TIME_SINCE_LAST_EDIT",threshold:-.7071194350719452,left:51,right:54},{feature:"TITLE_LENGTH",threshold:.0027717105112969875,left:52,right:53},{value:.3084340622029064},{value:.20221830985915493},{feature:"TITLE_LENGTH",threshold:.0014528378378599882,left:55,right:56},{value:.19599360481519798},{value:.12874983418294833},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:58,right:61},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.3484848588705063,left:59,right:60},{value:.1674727932285369},{value:.2761101463656661},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.3229166716337204,left:62,right:63},{value:.31311018131101814},{value:.4333284274045184},{feature:"TITLE_LENGTH",threshold:-.8199742436408997,left:65,right:96},{feature:"PAGE_AUTHORITY_V1",threshold:.9987315237522125,left:66,right:81},{feature:"TIME_SINCE_LAST_EDIT",threshold:-.7075438499450684,left:67,right:74},{feature:"TERMS_COUNT_NORMALIZED",threshold:.7859025001525879,left:68,right:71},{feature:"NUMBER_OF_BLOCK_SOURCES",threshold:1.0080004930496216,left:69,right:70},{value:.6666666666666666},{value:.5572065378900446},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.8090909123420715,left:72,right:73},{value:.730962836028703},{value:.82483781278962},{feature:"TERMS_COUNT_NORMALIZED",threshold:.7750000059604645,left:75,right:78},{feature:"BLOCK_SOURCE_defaultRecordCache",threshold:.5,left:76,right:77},{value:.5598243688254665},{value:.3112244897959184},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:79,right:80},{value:.48986486486486486},{value:.6522655426765016},{feature:"TIME_SINCE_LAST_EDIT",threshold:-.9759486615657806,left:82,right:89},{feature:"IS_CREATED_BY_ME",threshold:.5,left:83,right:86},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:84,right:85},{value:.7596830985915493},{value:.8754666411409974},{feature:"TERMS_COUNT_NORMALIZED",threshold:.7750000059604645,left:87,right:88},{value:.8577648766328012},{value:.9412431085265464},{feature:"TERMS_COUNT_NORMALIZED",threshold:.9000000059604645,left:90,right:93},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.7083333432674408,left:91,right:92},{value:.7364085667215815},{value:.4639175257731959},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:94,right:95},{value:.7003610108303249},{value:.8495272810115048},{feature:"PAGE_AUTHORITY_V1",threshold:.9999995827674866,left:97,right:112},{feature:"TITLE_LENGTH",threshold:1.0038834810256958,left:98,right:105},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:99,right:102},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:100,right:101},{value:.18298261665141813},{value:.34929850024189646},{feature:"TIME_SINCE_LAST_EDIT",threshold:-.7071070969104767,left:103,right:104},{value:.5148422178641469},{value:.42366514623021195},{feature:"NUMBER_OF_BLOCK_SOURCES",threshold:1.3351261019706726,left:106,right:109},{feature:"TITLE_LENGTH",threshold:1.4187065362930298,left:107,right:108},{value:.2810958904109589},{value:.14157014157014158},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:110,right:111},{value:.19499105545617174},{value:.40776554596846176},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:113,right:120},{feature:"PAGE_AUTHORITY_V1",threshold:1.4150558710098267,left:114,right:117},{feature:"TITLE_LENGTH",threshold:.09616653248667717,left:115,right:116},{value:.5727355901189387},{value:.4002079002079002},{feature:"TITLE_LENGTH",threshold:.36996421217918396,left:118,right:119},{value:.3089700996677741},{value:.10194174757281553},{feature:"PAGE_AUTHORITY_V1",threshold:1.000001072883606,left:121,right:124},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.22649572789669037,left:122,right:123},{value:.6954795357361027},{value:.7911777488048675},{feature:"TITLE_LENGTH",threshold:-.2670345604419708,left:125,right:126},{value:.7278492480521833},{value:.5908471377647305}],k=["PAGE_AUTHORITY_V1"],G=["TIME_SINCE_LAST_EDIT"],y=["TIME_SINCE_LAST_EDIT","PAGE_AUTHORITY_V1","TITLE_LENGTH","NUMBER_OF_BLOCK_SOURCES"];class P extends Error{constructor(e,t){super(e),this.name="MathError",this.cause=void 0,this.cause=t}}function D(e){if(0===e.length)throw new Error("Can't compute std of an empty array.");const t=(0,u().i2)(e),r=(0,u().cz)(e.map((e=>Math.pow(e-t,2))))/e.length;return Math.sqrt(r)}const w=[function(e){return{name:"NUMBER_OF_BLOCK_SOURCES",value:e.reduce(((e,t)=>{let{name:r,value:a}=t;return void 0!==a&&r.startsWith("BLOCK_SOURCE")?e+a:e}),0)}}];function F(e){return[...e,...w.map((t=>t(e)))]}const K={TIME_SINCE_LAST_EDIT:-.17725330223424154,IS_LAST_EDITED_BY_ME:.16176141450635628,IS_CREATED_BY_ME:.0593282388860205,BLOCK_SOURCE_spacePage:-.1800298837847493,BLOCK_SOURCE_recentVisit:.38019907955270416,BLOCK_SOURCE_bookmarkedPage:.2273554336295929,BLOCK_SOURCE_sharedPage:-.11405912441003871,BLOCK_SOURCE_frecencyStore:.7303811564943883,BLOCK_SOURCE_teamPage:-.3886937481702676,BLOCK_SOURCE_defaultRecordCache:-.08630181620439217,BLOCK_SOURCE_similarUser1dRecentPages:.1516065982402135,BLOCK_SOURCE_topPages7dPageView:.04024980669809112,BLOCK_SOURCE_editedPages1d:-.12760596916369363,BLOCK_SOURCE_similarUsersEditedPages1d:-.209104241796053,BLOCK_SOURCE_offlinePage:0,BLOCK_SOURCE_unknown:0,PAGE_AUTHORITY_V1:.4303514640388112,TITLE_LENGTH:-.4316382562266375,TERMS_COUNT_NORMALIZED:-.1032745452783248,FULL_MATCH_TERM_COUNT_NORMALIZED:.18313025417928205,MATCHING_PERCENTAGE_OF_TITLE:1.0003388486917193,NUMBER_OF_BLOCK_SOURCES:.7940652678793755},H=-2.48072057;function x(e){const t=e.map((e=>{let{name:t,value:r}=e;return K[t]*(r??0)}));return r=(0,u().cz)([H,...t]),1/(1+Math.exp(-r/2));var r}function V(e){if(e.some((e=>{let{value:t}=e;return void 0===t})))return 0;const t=(0,c().MU)(e.map((e=>{let{name:t,value:r}=e;return[t,r]}))),r=[b].map((e=>N(t,e)));return(0,u().i2)([...r,x(e)])}const Y=1.25,q=[p],j=0;function $(e){const{results:t,featureGroups:r,shouldCalculateRelevancies:a}=e,l=t.map(((e,t)=>{const{block:a,score:l,personalizationBoost:n,rendered:u,terms:o}=e;return{sources:[s().Ni.Local],id:a.blockModel.id,spaceId:a.blockModel.space_id,score:l,localSource:a.source,personalizationBoost:n,terms:o,highlight:{text:u},featureGroups:r[t]}})),n=a?function(e){const t=q.map(((t,r)=>{const a=e.map((e=>{var t;let{featureGroups:a}=e;return null===(t=a[r])||void 0===t?void 0:t.features}));if(a.some((e=>void 0===e)))return;return function(e){const t=(0,u().mg)(e);for(const s of t)for(const e of s)(0,i().Xk)(k,e.name)?e.value??=0:(0,i().Xk)(G,e.name)&&(e.value=Math.log(e.value??1));const r=new Map,a=new Map,l=new Map;for(const s of t)for(const e of s)if(void 0!==e.value&&(0,i().Xk)(y,e.name)){r.has(e.name)||r.set(e.name,[]);const t=r.get(e.name);t&&t.push(e.value)}for(const[s,n]of r.entries())a.set(s,(0,u().i2)(n)),l.set(s,D(n));for(const s of t)for(const e of s)if((0,i().Xk)(y,e.name)){const t=a.get(e.name),r=l.get(e.name);if(void 0===e.value||void 0===t||void 0===r)throw new P(`Couldn't scale feature ${e.name}`);e.value=0===r?0:(e.value-t)/r}return t}(a.map(F)).map(V)}));if(!t.some((e=>void 0===e)))return(0,u().sn)(t.filter(i().O9))}(l):void 0;return l.map(((e,t)=>({...e,localRelevancies:void 0!==n?n[t]:void 0})))}function Z(e,t,r){const a=e=>r.matches(e.block),s=(0,l().qw)(t);if(1===s.length)return e.search(t,{filter:a,prefix:!0,fields:["text","inits"]});const n=e.search(t,{filter:a,combineWith:"AND",fields:["text"]});if(n.length>0)return n;const u=s.filter((e=>e.length>=R().k2)),o=(i=u.length,Math.round(.6*i+.5));var i;return e.search(t,{filter:e=>e.queryTerms.length>=o&&a(e)})}function z(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function X(e){const{block:t,score:r,terms:a}=e,{source:l,text:n}=t,u=function(e,t){const r=t.map(z).join("|"),a=new RegExp(r,"ig");return t.length>0?e.replaceAll(a,`${s().$8}$&${s()._x}`):e}(n,a);var o;return{block:t,rendered:u,score:r,personalizationBoost:(o=l).has("recentVisit")||o.has("frecencyStore")||o.has("bookmarkedPage")||o.has("defaultRecordCache")?Y:1,terms:a,minisearchScore:e.minisearchScore??r}}function W(e,t,r){const{blocks:a,getAllBlocks:l}=e,s=r.text.trim(),u=(0,o().dY)(s),i=u.length>0?u.join(" "):s,c=new(_().Zd)(t);return i.length>0?function(e){const{blocksIndex:t,queryString:r,filterMatcher:a}=e,l=Z(t,r,a),s=I().zD.isMiniSearchModalEnabled()||"search_frecency_store_new_recency_score"===C().default.getGroup("search_local_ranking_new_frecency_and_score")?{exactMatch:n().gK,prefixMatch:1.5,wordPrefixMatch:1.25,substringMatch:1}:{exactMatch:n().gK,prefixMatch:n().tb,wordPrefixMatch:n().sH,substringMatch:n().qR};return l.map((e=>{const t=(0,R().B1)(r,e.block.text,s);return{...e,score:e.score*t,minisearchScore:e.score}})).map(X)}({blocksIndex:a,queryString:i,filterMatcher:c}):l().filter((e=>c.matches(e.block))).map(X)}const J=(0,u().sg)(((e,t)=>{t[0].featureGroups.forEach(((r,a)=>{let{groupName:l}=r;const s=t.map((e=>({features:e.featureGroups[a].features,id:e.id})));(0,f().vd)(e,"search_local_result_features",{search_session_id:h().wr(),group_name:l,results_features:s})}))}),1e3,{leading:!1,trailing:!0});function Q(e){let{query:t,localCachedPages:r,userId:a,includeRecordMap:l,environment:s,shouldUseNewRerankerDebugOverrideEnabled:n}=e;const{query:o,limit:i}=t,{filters:c,sort:h}=o,f=W(r,c,o),E=I().zD.isMiniSearchModalEnabled()||"search_frecency_store_new_recency_score"===C().default.getGroup("search_local_ranking_new_frecency_and_score");if(0===f.length)return;const g=function(e,t){const{field:r}=e,a="relevance"===r||"desc"===e.direction?-1:1;switch(r){case"lastEdited":case"scroll":return(0,u().Ul)(t,(e=>{let{block:{blockModel:t}}=e;return a*(t.last_edited_time||0)}));case"created":return(0,u().Ul)(t,(e=>{let{block:{blockModel:t}}=e;return a*(t.created_time||0)}));default:return(0,u().Ul)(t,(e=>{let{score:t}=e;return a*t}))}}(h,f),T="relevance"===h.field,S=n||"on"===C().default.getEligibleGroup({experimentId:"search-use-local-reranker-layered",parameter:"shouldUseLocalReranker",defaultGroup:"control"}),R=function(e,t,r,a){const l=new v(t,e,r);return a.map((e=>l.extractFeatureGroup(e)))}(s,E?S?[p,M]:[M]:q,t.query.text,g),m=$({results:g,featureGroups:R,shouldCalculateRelevancies:S}),L=S&&m.every((e=>{let{localRelevancies:t}=e;return void 0!==t&&t.length>0&&void 0!==t[j]})),A=T?L?(U=j,m.sort(((e,t)=>{let{localRelevancies:r}=e,{localRelevancies:a}=t;return(a??[])[U]-(r??[])[U]}))):E?function(e){const t=e.map((e=>{const t=e.featureGroups.flatMap((e=>e.groupName===M.name?e.features:[])).find((e=>"SEARCH_FRECENCY_SCORE"===e.name)),r=t?t.value:void 0;return r&&(e.score*=r),e}));return(0,u().Ul)(t,(e=>{let{score:t}=e;return-1*t}))}(m):(0,_().Fj)({sort:h,currentUserId:a,unsorted:m,batchSize:O().ZK}):m;var U;const N=A.slice(0,i);return(0,d().EG)({results:N,recordMap:r.recordMap}),{total:f.length,results:N,recordMap:l??1?r.recordMap.toJson():{},trackEventProperties:void 0,allMatchingResultIds:A.map((e=>e.id))}}function ee(e){let{query:t,localCachedPages:r,parentStore:l,isOnline:n,environment:o,shouldLimitLocalResultsWhenOnline:d,canUseLtr:E,shouldUseNewRerankerDebugOverrideEnabled:g}=e;const T=Q({query:t,localCachedPages:r,userId:o.currentUser.id,environment:o,shouldUseNewRerankerDebugOverrideEnabled:g});if(!T)return;if(0===T.results.length)return{error:s().yq.NoResults};const v=T.results.map(((e,t)=>({...e,originalPosition:t,store:S().B.createChildStore(l,{table:a().ev,id:e.id}),serverEventProperties:void 0}))),I=n&&d,O=(I?e=>(0,_().kZ)(o,e):e=>e)(v);if(0===O.length)return{error:s().yq.NoResults};const R=v.map((e=>{let{localRelevancies:t}=e;return t})),m=(0,u().sn)(R.filter(i().O9)),p=m.map(u().i2),M=(0,u().sn)(O.map((e=>{let{localRelevancies:t}=e;return t})).filter(i().O9)).map(u().i2),L=R.some(i().O9)?{...(0,c().MU)(m.map(((e,t)=>[`result_relevancies_${t}`,e]))),result_relevancies_means:p,visible_result_relevancy_means:M}:{},A=t.query.text.length>1&&E;return(0,f().vd)(o,"search_local_recall_results",{results:v.map(te),search_session_id:h().wr(),num_local_results:O.length,are_results_limited:I,...L}),A&&(J(o,O),C().default.logEvent("visible_local_search_results",O.length,{resultRelevancyV1:p[0],visibleResultRelevancyV1:M[0]})),{value:{total:v.length,totalResultIds:v.map((e=>e.id)),allMatchingResultIds:T.allMatchingResultIds,results:O,debugInfo:void 0}}}function te(e){const{id:t,localSource:r}=e;return{id:t,localSource:[...r??[]]}}}}]);