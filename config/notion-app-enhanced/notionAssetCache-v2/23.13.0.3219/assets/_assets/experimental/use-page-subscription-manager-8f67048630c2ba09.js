"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[25556],{811958:(e,s,t)=>{t.r(s),t.d(s,{usePageSubscriptionManager:()=>u});t(610931);var i=t(242343),n=()=>t(237385),r=()=>t(622286),o=()=>t(698094),a=()=>t(449596),l=()=>t(376869),h=()=>t(183103);let c;function u(){const e=(0,n().v3)(),{currentUser:{id:s}}=e,t=(0,l().y)(),o=(0,r().X)("offline_push_updates");(0,i.useEffect)((()=>{t&&o&&s&&(c?c.environment=e:c=new f(e,s))}),[e,s,t,o]);const a=c&&s!==c.userId;(0,i.useEffect)((()=>{a&&c&&c.handleUserChange(s)}),[s,a]);const u=(0,i.useCallback)((()=>{var e;null===(e=c)||void 0===e||e.handleOfflinePagesChange()}),[]);(0,h().Gf)(u)}class f{constructor(e,s){this.status="stopped",this.lockAbortController=void 0,this.releaseUserLock=void 0,this.environment=e,this.userId=s,this.handleOfflinePagesChange=t(975392).nF(this.handleOfflinePagesChange.bind(this),1e3,{leading:!0}),this.trySubscribing()}trySubscribing(){if(!this.userId)throw new Error("No userId provided for subscribing");var e;this.lockAbortController=new AbortController,this.status="waiting-for-lock",navigator.locks.request((e=this.userId,`page-updates-${e}`),{signal:this.lockAbortController.signal},(()=>(this.status="subscribing",this.refreshListeners(),new Promise((e=>{this.releaseUserLock=e}))))).catch((e=>{}))}handleUserChange(e){var s;if(this.userId=e,"subscribing"===this.status)this.removeAllListeners(),this.status="stopped",null===(s=this.releaseUserLock)||void 0===s||s.call(this),this.releaseUserLock=void 0;else if("waiting-for-lock"===this.status){var t;null===(t=this.lockAbortController)||void 0===t||t.abort(),this.lockAbortController=void 0,this.status="stopped"}this.userId&&this.trySubscribing()}handleOfflinePagesChange(){"subscribing"===this.status&&this.refreshListeners()}async refreshListeners(){const{defaultRecordCache:{persistedRecordCache:e}}=this.environment;if(!e||!this.userId)return;const s=await e.getOfflineOriginPages({userId:this.userId}),i=a().A.state.offlinePageListeners,n={},r={};for(const[a,l]of s){n[a]=l;const e=null==i?void 0:i[a];if(e){r[a]=e;continue}const s=o().Ay.addListener((0,t(201430).z9)({pageId:a}),void 0,(e=>{let{value:s}=e;if("number"!=typeof s)return;const i=s;(0,t(764605).Tt)({environment:this.environment,pageId:a,lastSnapshotTime:i})}),void 0,this.environment);r[a]=s}if(i)for(const t of Object.keys(i)){const e=i[t];e&&!(t in r)&&o().Ay.removeListener(e,this.environment)}a().A.setState({...a().A.state,offlinePages:n,offlinePageListeners:r})}removeAllListeners(){const e=a().A.state.offlinePageListeners;if(e){for(const[s,i]of(0,t(76394).WP)(e))i&&o().Ay.removeListener(i,this.environment);a().A.setState({...a().A.state,offlinePageListeners:void 0})}}}}}]);