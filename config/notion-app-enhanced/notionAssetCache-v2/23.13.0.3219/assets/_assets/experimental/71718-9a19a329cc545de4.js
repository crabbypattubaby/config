"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[71718],{100851:(e,t,o)=>{o.d(t,{I:()=>v});o(725707),o(491955),o(403517),o(113085);var i=()=>o(76394),r=()=>o(975392),a=()=>o(465546),n=()=>o(769884),l=()=>o(293665),d=()=>o(385649),c=()=>o(21164),s=()=>o(889110);function p(e){const{duplicatedAction:t,mapper:o,options:p,originOptions:u,sourceSpaceId:_}=e,m=n().Bj6.fromAutomationAction(t),f=m.pointer;const v=e=>{let{requested:t,requester:i}=e;return r=t.id,Boolean((null==p?void 0:p.isTemplateInstantiation)&&p.sourceBlockIds.has(r))?t:o({requested:t,requester:i});var r};function g(e){const t=(0,a().y5)(e);if("action"===t.source){var o;const e=l().L3.fromSpaceShardRecordId({id:t.action_id,spaceId:m.space_id},d().SC),i=(null===(o=v({requested:e,requester:f}))||void 0===o?void 0:o.id)??t.action_id;return(0,a().$y)({...t,action_id:i})}if("global"===t.source)return e;(0,i().HB)(t)}const b=m.pointer,{remappedRecordPointers:I,value:y}=(0,s().G)({automationActionModel:m,baseUrl:u.baseUrl,preventClearingConfig:!1,publicDomainName:u.publicDomainName,sourceSpaceId:_,visitors:{visitCollectionProperty:void 0,visitCollectionPropertyPointer:e=>{const o=v({requested:e,requester:b});if(o){const i=o.spaceId??t.space_id;return i!==t.space_id||o.table!==c().Vl?{type:"replace",value:void 0}:{type:"replace",value:{...o,propertyId:e.propertyId,spaceId:i}}}return(e.spaceId??t.space_id)!==t.space_id?{type:"replace",value:void 0}:{type:"keep"}},visitFormulaContextValue:e=>({type:"replace",value:g(e)}),visitFormulaPageProperty:e=>{if("collection"in e&&e.collection){const o=v({requested:e.collection,requester:f});if(o&&o.table===c().Vl){const i=o.spaceId??t.space_id;return i!==t.space_id?{type:"replace",value:void 0}:{type:"replace",value:{...e,collection:{...o,spaceId:i}}}}}else if("contextValueId"in e&&e.contextValueId)return{type:"replace",value:{...e,contextValueId:g(e.contextValueId)}};return{type:"keep"}},visitRecordPointer:e=>{const o=v({requested:e,requester:b});if(o){const e=o.spaceId??t.space_id;return e!==t.space_id?{type:"replace",value:void 0}:{type:"replace",value:{...o,spaceId:e}}}return(e.spaceId??t.space_id)!==t.space_id?{type:"replace",value:void 0}:{type:"keep"}}}}),k=y.getConfig();if(t.config=k,!(0,r().Im)(k))return I}var u=()=>o(22463),_=()=>o(486540),m=()=>o(22105),f=()=>o(145017);function v(e){const{originalRecord:t,duplicateRecord:o,mapper:r,getRecordRole:a,options:n,originOptions:c,duplicateBlocks:s=!0}=e,v=t.space_id!==o.space_id,g={table:d().SC,id:t.id,spaceId:t.space_id},b=r({requested:l().L3.fromPointerLike({table:o.parent_table,id:o.parent_id,spaceId:o.space_id}),requester:g}),I=p({duplicatedAction:o,mapper:r,options:n.resolveAutomationConfig,originOptions:c,sourceSpaceId:t.space_id});let y=a;I&&(y=m().Oj.tryUntilFound(...Array.from(I).map((e=>m().Oj.constantForPointer(e,"editor"))),y));const k=(null==b?void 0:b.id)??o.parent_id;if(o.parent_id=k,v&&"http_request"===o.type&&o.config){o.config.url=void 0;for(const e of o.config.customHeaders??[])e.value=""}const q=(0,u().Mn)(o);if(q){q.some((e=>{const t=y(e.pointer);return!t||!(0,_().q_)(t,e.minimumRequiredRole)}))&&(o.config={})}const C=(o.blocks??[]).map((e=>{var t;return null===(t=r({requested:l().L3.fromPointerLike({table:f().ev,id:e,spaceId:o.space_id}),requester:g}))||void 0===t?void 0:t.id})).filter(i().O9);o.blocks=C.length>0?C:void 0,s||(o.blocks=void 0)}},262148:(e,t,o)=>{o.d(t,{i:()=>p});o(403517);var i=o.n(o(485359)),r=()=>o(76394);var a=()=>o(889110),n=()=>o(502140),l=()=>o(769884),d=()=>o(293665),c=()=>o(711659),s=()=>o(385649);function p(e){var t,o;const{originalRecord:p,duplicateRecord:u,mapper:_,options:m,actor:f}=e,v=d().L3.fromSpaceShardRecordId({id:p.id,spaceId:p.space_id},c().yB);u.copied_from_pointer=v;const g=(null===(t=_({requested:d().L3.fromPointerLike({table:u.parent_table,id:u.parent_id,spaceId:u.space_id}),requester:v}))||void 0===t?void 0:t.id)??u.parent_id;u.parent_id=g;const b=(u.action_ids??[]).map((e=>{var t;return(null===(t=_({requested:d().L3.fromPointerLike({table:s().SC,id:e,spaceId:u.space_id}),requester:v}))||void 0===t?void 0:t.id)??e}));u.action_ids=b;const I=Date.now();u.created_time=I,u.last_edited_time=I,u.last_executed_time=void 0,u.last_failed_time=void 0,(0,r().O9)(null===(o=u.properties)||void 0===o?void 0:o.schedule_id)&&(u.properties.schedule_id=void 0),(0,r().O9)(f)&&(u.created_by_id=f.id,u.created_by_table=f.table,u.last_edited_by_id=f.id,u.last_edited_by_table=f.table),"recurrence"===u.trigger.type&&m.shouldDisableRecurrenceAutomation&&(u.status="disabled_duplication"),function(e){return"event"===e.trigger.type}(u)&&function(e){var t;const{duplicateRecord:o,mapper:r,originalRecord:d}=e,s=l().Bj6.fromAutomation(o);i()(s.isEventType());const p={id:d.id,spaceId:d.space_id,table:c().yB},{value:u}=(0,a().n)({automationModel:s,visitors:{visitCollectionProperty:void 0,visitRecordPointer:e=>{const t=r({requested:e,requester:p});if(t){const e=t.spaceId??o.space_id;return e!==o.space_id?{type:"replace",value:void 0}:{type:"replace",value:{...t,spaceId:e}}}return{type:"replace",value:void 0}}}});i()(u.isEventType());const _=u.getTrigger();o.trigger=_;const m={sourceAutomationParentId:d.parent_id,sourceAutomationId:d.id,sourceAutomationName:(null===(t=d.properties)||void 0===t?void 0:t.name)??""};o.trigger.event.source||(n().log({data:{miscDataToConvertToString:m},from:"duplicateHelpers.duplicateAutomationEventValueHelper",level:"info",type:"duplicateAutomationMissingTriggerSource"}),o.status="disabled")}({duplicateRecord:u,mapper:_,originalRecord:p})}},415029:(e,t,o)=>{o.d(t,{w:()=>Se,j:()=>Ve});o(610931),o(358848),o(362833),o(91270),o(725707),o(244387);var i=()=>o(892249),r=(o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601),o(771702),o(403517),o(113085),()=>o(975392)),a=()=>o(76394),n=()=>o(762847),l=()=>o(564134),d=()=>o(492435),c=()=>o(1476),s=()=>o(214144),p=()=>o(769884),u=()=>o(582226),_=()=>o(711659),m=()=>o(385649),f=()=>o(145017),v=()=>o(34662);function g(e){var t;const{blockValue:o,factoryButtonDeprecationContext:i,source:r}=e,a=function(e){return p().Bj6.fromValue(f().ev,e).getCreatedByPointer()??{id:c().rb.id,table:c().rb.table}}(o),n=o.space_id,l=s().JW(),d=s().JW(),u=i.isRootBlockFactoryBlock&&i.isCurrentBlockRootBlock?i.rootTextContainerId:s().JW(),g=function(e){const{automationActionId:t,textContainerBlockId:o,creatorPointer:i,originalBlockValue:r,spaceId:a,blockContent:n}=e;return{table:f().ev,value:{id:o,space_id:a,alive:!0,parent_table:m().SC,parent_id:t,type:"text",version:0,content:n,created_time:r.created_time,created_by_table:i.table,created_by_id:i.id}}}({automationActionId:d,textContainerBlockId:u,creatorPointer:a,originalBlockValue:o,blockContent:"duplication"===r?null===(t=o.content)||void 0===t?void 0:t.map((t=>e.pointerMapper({id:t,table:f().ev}).id)):o.content,spaceId:n}),b=function(e){const{automationId:t,automationActionId:o,spaceId:i,textContainerBlockId:r}=e;return{table:m().SC,value:{id:o,space_id:i,alive:!0,parent_table:_().yB,parent_id:t,type:"duplicate_blocks",blocks:[r],version:0,config:void 0}}}({automationActionId:d,automationId:l,creatorPointer:a,originalBlockValue:o,spaceId:n,textContainerBlockId:u}),I=function(e){var t;const{creatorPointer:o,automationActionId:i,originalBlockValue:r,spaceId:a,automationId:n}=e,l=s().JW(),d=Date.now();return{table:_().yB,value:{id:n,space_id:a,alive:!0,trigger:{id:l,type:"button"},parent_id:r.id,parent_table:f().ev,action_ids:[i],status:"active",properties:{name:(0,v().q4_)(null===(t=r.properties)||void 0===t?void 0:t.title)},created_by_id:o.id,created_by_table:o.table,created_time:r.created_time??d,last_edited_time:r.last_edited_time??d,version:0,last_edited_by_id:r.last_edited_by_id??o.id,last_edited_by_table:r.last_edited_by_table??o.table}}}({automationActionId:d,automationId:l,creatorPointer:a,originalBlockValue:o,spaceId:n});return{textContainerBlock:g,automation:I,automationAction:b}}o(491955);class b{constructor(e,t,i){this.childToParentMap=new Map,this.unmappedContentIds=new Set,this.extraTranscludedChildren=new(o(218508).G)((()=>new Set)),this.logWarning=t,this.createCopyIndicator=i;for(const{model:o}of e)if(o instanceof p().zgg)for(const t of o.getContentPointers()){e.getModel(t)?this.childToParentMap.has(t.id)?this.extraTranscludedChildren.get(t.id).add(o.id):this.childToParentMap.set(t.id,o.pointer.id):this.unmappedContentIds.add(t.id)}!this.createCopyIndicator&&this.logWarning&&this.logWarning({type:"multiReferencedContentIds",contentIds:Array.from(this.extraTranscludedChildren.keys())})}remapDuplicateBlockParent(e){const{originalBlockPointer:t,duplicateMapper:o}=e,i=this.childToParentMap.get(t.id);if(!i)return;const r=o({requested:{table:f().ev,id:i},requester:t});return r&&r.table===f().ev?r:void 0}createCopyIndicatorBlockValue(e){const{type:t,targetSpaceId:i,sourceBlockId:r,duplicateParentId:a,createdBy:l,createOptions:d,additionalRecordsToMutate:c}=e,{model:u}=p().zgg.create({id:(0,s().JW)(),type:n().xd.copyIndicator,space_id:i,parentPointer:{id:a,table:f().ev,spaceId:i},createdBy:l},{useCrdt:o(351560).I()}),_=u.__IM_SORRY__getValue();return d.onCreate({type:t,duplicateBlockId:_.id,sourceBlockId:r,duplicateParentId:a}),c.push({table:f().ev,value:_}),_.id}remapDuplicateBlockContent(e){const{originalBlockPointer:t,duplicateMapper:o,originalBlockContent:i,originalCreatedBy:r,duplicateBlockId:n,targetSpaceId:l}=e,d=[];return{content:i.map((e=>{if(this.createCopyIndicator&&this.extraTranscludedChildren.has(e)&&this.extraTranscludedChildren.get(e).has(t.id))return this.createCopyIndicatorBlockValue({type:"multi-transcluded-content",targetSpaceId:l,sourceBlockId:e,duplicateParentId:n,createdBy:r,createOptions:this.createCopyIndicator,additionalRecordsToMutate:d});const i=o({requested:{table:f().ev,id:e},requester:t});return i?i.id:this.isUnmappedContentId(e)?this.createCopyIndicator?this.createCopyIndicatorBlockValue({type:"unmapped-content",targetSpaceId:l,sourceBlockId:e,duplicateParentId:n,createdBy:r,createOptions:this.createCopyIndicator,additionalRecordsToMutate:d}):void(null===(a=this.logWarning)||void 0===a||a.call(this,{type:"unmappedContentId",block:t,contentId:e})):e;var a})).filter(a().O9),additionalRecords:d}}isUnmappedContentId(e){return this.unmappedContentIds.has(e)}}var I=()=>o(186839);function y(e,t,o){if((0,I().A8)(e)||(0,I().Jc)(e))return[];const i=[];return o&&i.push(...o),null!=t&&t.previousViewsMainCollectionViewBlockPointer&&i.push(t.previousViewsMainCollectionViewBlockPointer.id),i}var k=()=>o(673447),q=()=>o(22105),C=()=>o(220574),B=()=>o(293665),h=()=>o(21164),w=()=>o(289765),R=()=>o(890449),T=()=>o(759260),P=()=>o(109046),x=()=>o(968410),S=()=>o(657723),V=()=>o(66460),M=()=>o(229),L=()=>o(829629);function O(e){const{mapper:t,requested:o,requester:i,table:r}=e,a=A({mapper:t,requested:o,requester:i});if(!(0,B().Yt)(a,r))throw new Error(`Expected mapped duplicate for ${o.table} ${o.id} to be a ${r}, but it is a ${a.table} (while duplicating ${i.table} ${i.id})`);return a}function A(e){const{mapper:t,requested:o,requester:i}=e,r=t({requested:o,requester:i});if(!r)throw new Error(`Unable to find mapped duplicate for ${o.table} ${o.id} while duplicating ${i.table} ${i.id}`);return r}var D=()=>o(100851),N=()=>o(262148),U=()=>o(3311),j=()=>o(204132),E=()=>o(141666),F=()=>o(118174),$=()=>o(555919),G=()=>o(543396);const W="415fc269-e68f-4da0-b3e3-b1273b741a7f";var z=()=>o(810111),Y=()=>o(446588),J=()=>o(518797),H=()=>o(26907);var Q=()=>o(130869);function K(e){var t,o,i,l,d,s,u,m,b,I,y,k,q,C,R;const{originalBlock:P,duplicateBlock:x,mapper:S,options:M,originOptions:O,rewiredUriMap:A,typedCollectionViewBlocks:D,actor:N,helperRecordMap:K,factoryButtonDeprecationContext:Z,legacyTransclusionFixer:X,installationImprint:ee,shouldExcludeBlocksFromLimit:te=!1,accessLockingValidator:oe}=e,ie={table:f().ev,id:P.id,spaceId:P.space_id};null!==(t=P.format)&&void 0!==t&&t.app_config_uri&&null!==(o=x.format)&&void 0!==o&&o.app_config_uri&&((0,z().Sn)(P.format.app_config_uri)?x.format.app_config_uri=void 0:((0,n().Ef)(x.type)&&D.push({table:f().ev,id:x.id,spaceId:x.space_id}),A[P.id]=x.id));const re=[];if(x.crdt_data&&delete x.crdt_data,x.crdt_format_version&&delete x.crdt_format_version,null!==(i=x.format)&&void 0!==i&&i.site_id&&delete x.format.site_id,null!==(l=x.format)&&void 0!==l&&l.marketplace_listing_id&&delete x.format.marketplace_listing_id,null!==(d=x.format)&&void 0!==d&&d.slug&&delete x.format.slug,null!==(s=x.format)&&void 0!==s&&s.trigger_id_to_schedule_id&&delete x.format.trigger_id_to_schedule_id,"factory"===x.type&&Z){const{automation:e,automationAction:t,textContainerBlock:o}=g({blockValue:x,source:"duplication",pointerMapper:e=>S({requested:e,requester:ie})??e,factoryButtonDeprecationContext:Z});re.push(e,t,o),Z.factoryBlockIdToNewTextContainerIdMap.set(P.id,{id:o.value.id,table:f().ev});const i=x;i.type="button",i.content=[],i.format={...i.format,automation_id:e.value.id}}let ae;if((0,U().uj)(P.id)&&(x.format||(x.format={}),x.format.copied_from_pointer={table:f().ev,id:P.id,spaceId:P.space_id},x.copied_from=P.id),P.parent_table===f().ev&&(ae=null==Z?void 0:Z.factoryBlockIdToNewTextContainerIdMap.get(P.parent_id)),ae??=(null==X?void 0:X.remapDuplicateBlockParent({originalBlockPointer:ie,duplicateMapper:S}))??S({requested:{table:x.parent_table,id:x.parent_id,spaceId:x.space_id},requester:ie}),ae&&(x.parent_id=ae.id,x.parent_table!==ae.table&&(0,$().LA)(ae)&&(x.parent_table=ae.table)),null!==(u=x.format)&&void 0!==u&&u.ai_instructions_page_pointer&&(x.format.ai_instructions_page_pointer=S({requested:x.format.ai_instructions_page_pointer,requester:ie})),null!==(m=x.format)&&void 0!==m&&m.ai_skill_pointer&&(x.format.ai_skill_pointer=S({requested:x.format.ai_skill_pointer,requester:ie})),null!==(b=x.format)&&void 0!==b&&b.ai_block_configuration_menu){if(M.resolveTemplateVariables){const e=(0,F().p8)(x.format.ai_block_configuration_menu);if(j().Q.isSuccess(e)){const t=e.value;if("context"in t){const e=(t.context??[]).map((e=>{if("currentPage"===e.type){var t;return{type:"page",pageId:(null===(t=S({requested:{table:f().ev,id:e.pageId,spaceId:x.space_id},requester:ie}))||void 0===t?void 0:t.id)??e.pageId}}if("page"===e.type||"collection"===e.type||"slack"===e.type)return e;(0,a().HB)(e)}));x.format.ai_block_configuration_menu={...t,context:e}}}}}const ne=x;ne.view_ids&&(ne.view_ids=ne.view_ids.map((e=>{var t;return(null===(t=S({requested:{table:w().Gy,id:e,spaceId:ne.space_id},requester:ie}))||void 0===t?void 0:t.id)||e})));const le=p().Bj6.fromBlock(ne).getCollectionPointers(),de=[];for(const r of le){var ce;const e=null==K?void 0:K.getValue(r);if(null==e||null===(ce=e.format)||void 0===ce?void 0:ce.bot_id)de.push(r);else{const e=S({requested:r,requester:ie})||r;if(e.table!==h().Vl)throw new Error(`Collection pointer for duplicate collection is invalid: ${JSON.stringify(e)}`);de.push(e)}}de.length>0&&(ne.collection_id=de[0].id,ne.format={...ne.format,collection_pointer:de[0],collection_pointers:de}),null!==(I=x.format)&&void 0!==I&&I.form_layout_pointer&&(x.format.form_layout_pointer=S({requested:x.format.form_layout_pointer,requester:ie}));let se=[];var pe,ue,_e,me,fe,ve;if(M.duplicateDiscussions){if("page"===x.type&&null!==(pe=x.format)&&void 0!==pe&&pe.suggestions){x.format.suggestions.filter((e=>["insert","remove"].includes(e.type))).length>0&&(se=x.format.suggestions.map((e=>e.discussionId)),delete x.format.suggestions)}}else null!==(y=x.format)&&void 0!==y&&y.suggestions&&delete x.format.suggestions;(x.discussions&&(M.duplicateDiscussions?x.discussions=x.discussions.filter((e=>!se.includes(e))).map((e=>{var t;return(null===(t=S({requested:B().L3.fromPointerLike({table:T().$Y,id:e,spaceId:x.space_id}),requester:ie}))||void 0===t?void 0:t.id)||e})):delete x.discussions),x.permissions)&&(M.duplicatePermissions?x.permissions=function(e){const{block:t,targetSpaceSettings:o,targetTeamSettings:i}=e;return(t.permissions||[]).filter((e=>!((0,Y().P3)(e)||(0,Y().Ds)(e)||(!i&&o.disablePublicAccess||i&&i.disable_public_access)&&(0,Y().FP)(e)||(!i&&o.disableGuests||i&&i.disable_guests)&&(0,Y().B2)(e)&&!o.memberUserIds.includes(e.user_id))))}({block:x,targetSpaceSettings:M.duplicatePermissions.targetSpaceSettings,targetTeamSettings:null===(ue=M.duplicatePermissions)||void 0===ue?void 0:ue.targetTeamSettings}):(delete x.permissions,"form"===x.type&&(x.permissions=(0,G().eb)())));x.content_classification&&delete x.content_classification,x.moved&&delete x.moved,x.properties||(x.properties={});for(const r in x.properties){const e=M.duplicateDiscussions?x.properties[r]:v().Uee(x.properties[r],{removeSuggestionAnnotationsAndText:!0,removeSuggestionAnnotations:!0,removeDiscussions:!0});x.properties[r]=e}if(!te||x.type===n().xd.collectionViewPage||x.content&&0!==x.content.length?x.ignore_block_count&&delete x.ignore_block_count:x.ignore_block_count=!0,x.properties)for(const r of Object.keys(x.properties)){const e=x.properties[r];e&&(x.properties[r]=(0,Q().R)({...O,text:{value:e,spaceId:(0,V().e)(x.space_id)},mapper:S,requester:ie,resolveTemplateVariables:M.resolveTemplateVariables||!1}))}if("transclusion_reference"===x.type&&M.deepCopyTransclusionContainers){const e=x;if(e.format&&e.format.transclusion_reference_pointer){const t=e.format.transclusion_reference_pointer,o=S({requested:t,requester:ie});o&&(e.format.transclusion_reference_pointer=o)}}if((0,n().$I)(x.type)&&M.shallowCopyNavigableBlock){const e=x;e.type="text";const t=v().ld4(P.id,P.space_id),o=[v().wmz(t)];e.properties={title:o},e.content=[]}if("transclusion_container"===x.type&&!M.deepCopyTransclusionContainers){const e=x;e.type="transclusion_reference",e.content=void 0;const t=e.format||{};t.transclusion_reference_pointer=ie,e.format=t}if("alias"===x.type&&x.format&&x.format.alias_pointer){const e=x.format.alias_pointer,t=S({requested:e,requester:ie});t&&(x.format.alias_pointer=t)}if(_e=x,(0,n().p7)(_e.type)&&x.format)if(ee)x.format.installation_imprint={pointer:ee};else if(x.format.installation_imprint&&oe&&oe.shouldOverwriteInstallationOnBlock(x.format.installation_imprint.pointer.id)){const e=oe.getNewInstallationForInstallationId(x.format.installation_imprint.pointer.id);e&&void 0!==e&&(x.format.installation_imprint={pointer:{id:e.id,table:H()._i}})}if((x.type===n().xd.externalObjectInstancePage&&(x.type=n().xd.externalObjectInstance),x.type===n().xd.externalObjectInstance)&&(null!==(me=x.format)&&void 0!==me&&me.related_external_object_uris_to_instance_ids&&(x.format.related_external_object_uris_to_instance_ids=(0,E().MU)((0,a().WP)(x.format.related_external_object_uris_to_instance_ids).map((e=>{var t;let[o,i]=e;return[o,(null===(t=S({requested:{table:f().ev,id:i,spaceId:ne.space_id},requester:ie}))||void 0===t?void 0:t.id)||i]})))),M.convertExternalObjectInstancesToPlaceholders&&(null===(fe=x.format)||void 0===fe||!fe.is_placeholder)&&null!==(ve=x.format)&&void 0!==ve&&ve.bot_id)){const e=null==K?void 0:K.getValue({table:J().GP,id:x.format.bot_id}),t=null==e?void 0:e.integration_id;if(t){const e={is_placeholder:!0,integration_id:t};x.format=e}}x.file_ids&&function(e){var t;const o=JSON.stringify(e.properties);e.file_ids=null==e||null===(t=e.file_ids)||void 0===t?void 0:t.filter((t=>{var i,r,a,n,l,d;return!(null===(i=e.format)||void 0===i||!i.display_source||-1===(null===(r=e.format)||void 0===r||null===(r=r.display_source)||void 0===r?void 0:r.indexOf(t)))||!(null===(a=e.format)||void 0===a||!a.page_cover||-1===(null===(n=e.format)||void 0===n||null===(n=n.page_cover)||void 0===n?void 0:n.indexOf(t)))||!(null===(l=e.format)||void 0===l||!l.page_icon||-1===(null===(d=e.format)||void 0===d||null===(d=d.page_icon)||void 0===d?void 0:d.indexOf(t)))||-1!==o.indexOf(t)}))}(x);const ge=P,be=x;if(be.format&&(null!==(k=ge.format)&&void 0!==k&&k.original_source||null!==(q=ge.format)&&void 0!==q&&q.image_edit_metadata)&&(be.format.original_source=void 0,be.format.image_edit_metadata=void 0),null!==(C=x.format)&&void 0!==C&&C.automation_id){const e=S({requested:{table:_().yB,id:x.format.automation_id,spaceId:x.space_id},requester:ie});e&&(x.format.automation_id=e.id)}var Ie;null!==(R=x.format)&&void 0!==R&&R.workflow_id&&(x.format.workflow_id=null===(Ie=S({requested:{table:L().C0,id:x.format.workflow_id,spaceId:x.space_id},requester:ie}))||void 0===Ie?void 0:Ie.id);if(x.type===n().xd.transcription&&x.format){var ye,ke,qe,Ce;if(x.format.transcription_notes_id)x.format.transcription_notes_id=null===(ke=S({requested:{table:f().ev,id:x.format.transcription_notes_id,spaceId:x.space_id},requester:ie}))||void 0===ke?void 0:ke.id;if(x.format.transcription_transcript_id)x.format.transcription_transcript_id=null===(qe=S({requested:{table:f().ev,id:x.format.transcription_transcript_id,spaceId:x.space_id},requester:ie}))||void 0===qe?void 0:qe.id;if(x.format.transcription_summary_id)x.format.transcription_summary_id=null===(Ce=S({requested:{table:f().ev,id:x.format.transcription_summary_id,spaceId:x.space_id},requester:ie}))||void 0===Ce?void 0:Ce.id;const e=null===(ye=x.format.transcription_state)||void 0===ye?void 0:ye.state;"transcribing"!==e&&"summarizing"!==e||(x.format.transcription_state={state:"paused"})}if("collection"===P.parent_table&&P.type===n().xd.copyIndicator&&x.properties&&(0,a().uv)(x.properties).length>0&&(x.type=n().xd.page),!M.preserveSourceMetadataTimestamps){const e=Date.now();x.created_time=e,x.last_edited_time=e}N&&(x.last_edited_by_id=N.id,x.last_edited_by_table=N.table,x.created_by_id=N.id,x.created_by_table=N.table),x.non_content_children&&(x.non_content_children=x.non_content_children.map((e=>{var t;return(null===(t=S({requested:{table:f().ev,id:e,spaceId:x.space_id},requester:ie}))||void 0===t?void 0:t.id)||e})));const Be=x;if(Be.content){var he;if(X){const e=X.remapDuplicateBlockContent({originalBlockPointer:ie,duplicateMapper:S,originalBlockContent:Be.content,originalCreatedBy:N||c().TI.pointer,duplicateBlockId:Be.id,targetSpaceId:x.space_id});Be.content=e.content,re.push(...e.additionalRecords)}else Be.content=Be.content.map((e=>{var t;return(null===(t=S({requested:{table:f().ev,id:e},requester:ie}))||void 0===t?void 0:t.id)||e}));if(x.space_id===W&&null!==(he=x.properties)&&void 0!==he&&he.title){var we,Re,Te;const e=(0,v().RQ)(null===(we=x.properties)||void 0===we?void 0:we.title);e&&e.length>0&&e[0].length>0&&null!==(Re=e[0][0])&&void 0!==Re&&null!==(Re=Re.trim())&&void 0!==Re&&Re.startsWith("ðŸŽ²")&&null!==(Te=e[0][0])&&void 0!==Te&&null!==(Te=Te.trim())&&void 0!==Te&&Te.endsWith("ðŸŽ²")&&(Be.content=r().k4(Be.content))}}return{duplicateRecord:x,additionalRecords:re}}var Z=()=>o(728373),X=()=>o(187058);function ee(e,t,o,i,r,n){var c,s,p,u;const m={table:h().Vl,id:e.id,spaceId:e.space_id};if(function(e,t,o){var i;if(null===(i=e.format)||void 0===i||!i.compound_workflow_template_instances)return;const r={table:h().Vl,id:e.id,spaceId:e.space_id};t.format||(t.format={});t.format.compound_workflow_template_instances=e.format.compound_workflow_template_instances.map((e=>({...e,instance_pointers:e.instance_pointers.map((e=>{const i=t.space_id;if("property"===e.type)return e;const a=e.type,n=O({table:a,mapper:o,requested:{table:a,id:e.id,spaceId:i},requester:r});return{type:n.table,id:n.id}}))})))}(e,t,o),null!==(c=e.format)&&void 0!==c&&c.app_config_uri&&(r[e.id]=t.id),(0,U().uj)(e.id)){if(t.format||(t.format={}),t.format.copied_from_pointer={table:h().Vl,id:e.id,spaceId:e.space_id},void 0!==t.format.collection_default_template&&"empty"!==t.format.collection_default_template){const e=o({requested:{table:f().ev,id:t.format.collection_default_template.template_page_id},requester:m});e&&(t.format.collection_default_template={template_page_id:e.id})}if(t.format.layout_pointer){const e=O({mapper:o,table:x().zx,requested:t.format.layout_pointer,requester:m});t.format.layout_pointer=e}t.copied_from=e.id}const v=o({requested:{table:t.parent_table,id:t.parent_id},requester:m});v&&(t.parent_id=v.id);const g=l().Dp(t);for(const a in g){const r=g[a];if(r&&"relation"===r.type&&l().Nv(r)){const e=o({requested:l().Nv(r),requester:m});if(e)r.collection_id=e.id,r.collection_pointer={id:e.id,table:h().Vl,spaceId:(0,V().e)(e.spaceId)};else if(r.property){const e=n.checkGate({gateName:"collections_xws",actor:d().S3,customIDs:{spaceId:t.space_id}});r.property=e?void 0:(0,Z().Ay)()}}var b;if(r&&"title"===r.type&&t.name&&(t.name=(0,Q().R)({...i,text:{value:t.name,spaceId:t.space_id},mapper:o,requester:m,resolveTemplateVariables:!1})),r&&"button"===r.type&&r.automation_id)r.automation_id=(null===(b=o({requested:{id:r.automation_id,spaceId:e.space_id,table:_().yB},requester:m}))||void 0===b?void 0:b.id)??r.automation_id}t.description&&(t.description=(0,Q().R)({...i,text:{value:t.description,spaceId:t.space_id},mapper:o,requester:m,resolveTemplateVariables:!1}));for(const a in g){const e=g[a];if(!e||"formula"!==e.type||"v2"!==e.version||!e.formula2)continue;const{value:r}=(0,X().RI)({baseUrl:i.baseUrl,formula:e.formula2.code,publicDomainName:i.publicDomainName,spaceId:t.space_id,visitors:{visitFormulaContextValue:void 0,visitFormulaPageProperty:e=>{if("collection"in e&&e.collection){const t=o({requested:e.collection,requester:m});if(t&&t.table===h().Vl)return{type:"replace",value:{...e,collection:t}}}return{type:"keep"}},visitRecordPointer:void 0}});e.formula2.code=r}if(t.template_pages&&(t.template_pages=t.template_pages.map((e=>{var t;return(null===(t=o({requested:{table:f().ev,id:e},requester:m}))||void 0===t?void 0:t.id)||e}))),null!==(s=t.format)&&void 0!==s&&s.collection_mode&&"page_tree"===t.format.collection_mode.type){var I;const e=t.format.collection_mode.root_page_pointer,i=(null===(I=o({requested:B().L3.fromPointerLike({table:"block",id:e.id,spaceId:t.space_id}),requester:m}))||void 0===I?void 0:I.id)||e.id;t.format.collection_mode={type:"page_tree",root_page_pointer:{id:i,table:"block",spaceId:t.space_id}}}null!==(p=t.format)&&void 0!==p&&p.related_external_object_uris_to_instance_ids&&(t.format.related_external_object_uris_to_instance_ids=(0,E().MU)((0,a().WP)(t.format.related_external_object_uris_to_instance_ids).map((e=>{var i;let[r,a]=e;return[r,(null===(i=o({requested:{table:h().Vl,id:a,spaceId:t.space_id},requester:m}))||void 0===i?void 0:i.id)||a]})))),delete t.deleted_schema,null!==(u=t.format)&&void 0!==u&&u.automation_ids&&(t.format.automation_ids=t.format.automation_ids.map((e=>{var i;return null===(i=o({requested:{id:e,table:_().yB,spaceId:t.space_id},requester:m}))||void 0===i?void 0:i.id})).filter(a().O9))}var te=()=>o(572589),oe=()=>o(296886);var ie=()=>o(655181),re=()=>o(526921);o(500234);var ae=()=>o(963002);const ne={block:!0,collection:!0,collection_view:!0,discussion:!0,comment:!0,reaction:!0,automation:!0,automation_action:!0,skill:!0,layout:!0,form_question:!0,workflow:!0};function le(e){const t=e.clone(),o=p().b4_.fromRecordMap(t);function i(e){return(0,k().Yn)(e.pointer,o).some(((e,t)=>{const o=e.table!==f().ev;return 0===t?o:o||(0,n().$I)(e.type)}))}const r=[];for(const{pointer:a,model:n}of t)n&&!i(n)||r.push(a);return r.forEach((e=>t.delete(e))),t}function de(e){return e.table in ne}function ce(e){const{sourceBlockId:t,targetBlockPointer:o,recordMap:i,options:a,baseUrl:n,publicDomainName:l,actor:c,getRecordRole:u,mapper:_,preventLegacyTransclusions:m,createLegacyTransclusionCopyIndicator:v,logWarning:g,spaceIdCreator:I,installationImprint:B,experimentService:h,isTemplateInstantiation:w}=e,P=[];let V=i;null!=a&&a.shallowCopyNavigableBlock&&(V=le(i));const M=e.recordPointerMap||C().RecordMapPolymorphic.create(),L={table:f().ev,id:t};for(const{pointer:r}of V){if(r.id===t){M.set(r,o);continue}let e=M.get(r);!e&&_&&(e=_({requested:r,requester:L})),e||(e={spaceId:o.spaceId,table:r.table,id:(null==I?void 0:I.idInSavedSpace(r.table))??s().Dt()}),M.set(r,e)}let O;m&&(O=new b(i,g,v??!1));const A=C().RecordMap.create(),D=e=>{let{requested:t}=e;return M.get(t)},N={},U=[],j=new Set,E=i.getModel({id:t,table:f().ev}),F=E?function(e){const t="duplication",o=new Map;let i;return"factory"===e.type?(i={type:t,isRootBlockFactoryBlock:!0,isCurrentBlockRootBlock:!1,factoryBlockIdToNewTextContainerIdMap:o,rootTextContainerId:s().JW()},i.factoryBlockIdToNewTextContainerIdMap.set(e.id,{id:i.rootTextContainerId,table:f().ev})):i={type:t,isRootBlockFactoryBlock:!1,factoryBlockIdToNewTextContainerIdMap:o},i}(E):void 0;for(const{pointer:r,model:s}of V){if(void 0===s)continue;if(!de(s))continue;if(!(null!=a&&a.duplicateDiscussions||r.table!==T().$Y&&r.table!==R().SN&&r.table!==S().ez))continue;const e=Boolean((null==a?void 0:a.resolveTemplateVariables)&&ue({rootSourceBlockIds:[t],childSourcePointer:r,getSourceRecordValue:q().xb.fromRecordMap(i)}))?{...a,resolveTemplateVariables:!1}:a;if(s.table===x().zx&&h.checkGate({gateName:"layouts_views_module_strip_child_cvb_of_simple_layouts",actor:d().S3})){const e=y(s.getRawModules(),s.getFormat(),s.getBlocks());for(const t of e)j.add(t)}null!=F&&F.isRootBlockFactoryBlock&&(F.isCurrentBlockRootBlock=s.id===t);const{duplicateRecord:p,additionalRecords:_}=pe({table:s.table,record:s.__IM_SORRY__getValue(),mapper:D,options:e,rewiredUriMap:N,typedCollectionViewBlocks:U,originOptions:{baseUrl:n,publicDomainName:l},actor:c,getRecordRole:u,factoryButtonDeprecationContext:F,legacyTransclusionFixer:O,installationImprint:B,experimentService:h,layoutCollectionViewBlocksToRemove:j});if(void 0!==p){if(s.table===f().ev&&p.id===o.id){const e=p;delete e.parent_id,delete e.parent_table,delete e.alive}w&&s.table===f().ev&&s.autoGenerateOnTemplateDuplication()&&P.push({table:f().ev,id:p.id,spaceId:p.space_id}),se({duplicateRecordMap:A,duplicateRecordResult:{duplicateRecord:p,additionalRecords:_,duplicateRecordTable:s.table}})}}!function(e){const{rewiredUriMap:t,typedCollectionViewBlocks:o,duplicateRecordMap:i}=e;if(r().Im(t)||0===o.length)return;const a=r().oE(o.map((e=>i.getValue(e))));a.forEach((e=>{var o;const i=null==e||null===(o=e.format)||void 0===o?void 0:o.app_uri_map;i&&Object.entries(i).forEach((e=>{let[o,r]=e;i[o]=t[r]}))}));const n=a.reduce(((e,t)=>{var o;const i=null==t||null===(o=t.format)||void 0===o?void 0:o.app_id;return i&&(e[i]=e[i]?[...e[i],t]:[t]),e}),{});Object.entries(n).forEach((e=>{let[t,o]=e;const i=s().JW();o.forEach((e=>{var t;null!=e&&null!==(t=e.format)&&void 0!==t&&t.app_id&&(e.format.app_id=i)}))}))}({rewiredUriMap:N,typedCollectionViewBlocks:U,duplicateRecordMap:A});const $=function(e,t,o,i){if(0===e.size)return t;const r=new Set;for(const c of e){const e=o({requested:{id:c,table:f().ev},requester:i});r.add((null==e?void 0:e.id)||c)}const a=t.clone(),n=p().b4_.fromRecordMap(a);function l(e){return(0,k().Yn)(e.pointer,n).some(((e,t)=>r.has(e.id)))}const d=[];for(const{pointer:c,model:s}of a)s&&!l(s)||d.push(c);return d.forEach((e=>a.delete(e))),a}(j,A,D,L);return{duplicateRecordMap:$,originalToDuplicate:M,aiBlocksToAutoGenerate:P}}function se(e){const{duplicateRecordResult:t,duplicateRecordMap:o}=e,{additionalRecords:i,duplicateRecord:r,duplicateRecordTable:a}=t;o.setValue(B().L3.fromPointerLike({table:a,id:r.id}),r);for(const n of i)o.setValue(B().L3.fromPointerLike({id:n.value.id,table:n.table}),n.value)}function pe(e){const{table:t,record:o,mapper:i,options:n,originOptions:l,actor:d,helperRecordMap:c,getRecordRole:s,rewiredUriMap:p,typedCollectionViewBlocks:u,factoryButtonDeprecationContext:v,legacyTransclusionFixer:g,installationImprint:b,accessLockingValidator:I,experimentService:y,isTemplateInstantiation:k,shouldExcludeBlocksFromLimit:q,targetBlockIds:C,layoutCollectionViewBlocksToRemove:U}=e,j=r().mg(o),E=A({mapper:i,requested:B().L3.fromPointerLike({table:t,id:o.id,spaceId:o.space_id}),requester:B().L3.fromPointerLike({table:t,id:o.id})});j.id=E.id,j.space_id=(0,V().e)(E.spaceId);const F=[];if(t===f().ev){const e=j,{additionalRecords:t}=K({originalBlock:o,duplicateBlock:e,mapper:i,options:n??{},rewiredUriMap:p,typedCollectionViewBlocks:u,originOptions:l,actor:d,helperRecordMap:c,factoryButtonDeprecationContext:v,legacyTransclusionFixer:g,installationImprint:b,shouldExcludeBlocksFromLimit:q,accessLockingValidator:I});F.push(...t)}else if(t===h().Vl){ee(o,j,i,l,p,y)}else if(t===w().Gy){!function(e,t,o,i,r,a,n){var l,d,c,s,p,u,_;const m={table:w().Gy,id:e.id,spaceId:e.space_id};null!==(l=e.format)&&void 0!==l&&l.app_config_uri&&null!==(d=t.format)&&void 0!==d&&d.app_config_uri&&((0,z().Sn)(e.format.app_config_uri)?t.format.app_config_uri=void 0:i[e.id]=t.id);const v=null===(c=t.format)||void 0===c?void 0:c.collection_pointer;if(v){const e=null==r?void 0:r.getModel(v);if(!Boolean(null==e?void 0:e.isSyncedCollection())){const e=o({requested:v,requester:m})||v;t.format={...t.format,collection_pointer:e}}}if(t.format){var g;const e=null===(g=t.format.collection_groups)||void 0===g?void 0:g.map((e=>"relation"===e.value.type&&(0,te().WO)(e.value.value)&&e.value.value?{...e,value:{type:"relation",value:o({requested:e.value.value,requester:m})}}:e));t.format.collection_groups=e;const i=t.format.collection_view_default_template;if(void 0!==i&&"empty"!==i){const e=o({requested:{table:f().ev,id:i.template_page_id},requester:m});e&&(a&&null!=n&&n.includes(e.id)||(t.format.collection_view_default_template={template_page_id:e.id}))}}const b=o({requested:{table:t.parent_table,id:t.parent_id,spaceId:t.space_id},requester:m});if(b&&(t.parent_id=b.id),t.page_sort&&(t.page_sort=t.page_sort.map((e=>{var i;return(null===(i=o({requested:{table:f().ev,id:e,spaceId:t.space_id},requester:m}))||void 0===i?void 0:i.id)||e}))),"page"===t.type&&null!==(s=t.format)&&void 0!==s&&s.page_pointer){var I;const e=t.format.page_pointer,i=(null===(I=o({requested:B().L3.fromPointerLike({table:"block",id:e.id,spaceId:t.space_id}),requester:m}))||void 0===I?void 0:I.id)||e.id;t.format.page_pointer={table:"block",id:i,spaceId:t.space_id}}if(null!==(p=t.format)&&void 0!==p&&p.property_filters){const e=t.format.property_filters;for(const t of e)t.filter&&(0,oe().w)(t.filter,(e=>{var t;return null===(t=o({requested:e,requester:m}))||void 0===t?void 0:t.id}))}if(null!==(u=t.format)&&void 0!==u&&u.filters2){const e=t.format.filters2;for(const t of e)t.filter&&(0,oe().w)(t.filter,(e=>{var t;return null===(t=o({requested:e,requester:m}))||void 0===t?void 0:t.id}))}const y=t.query2;var k;y&&y.filter&&(0,oe().w)(y.filter,(e=>{var t;return null===(t=o({requested:e,requester:m}))||void 0===t?void 0:t.id})),null!==(_=t.format)&&void 0!==_&&_.form_block_pointer&&(t.format.form_block_pointer=o({requested:null===(k=t.format)||void 0===k?void 0:k.form_block_pointer,requester:m}))}(o,j,i,p,c,k,C)}else t===T().$Y?function(e,t,o,i){const r={table:T().$Y,id:e.id,spaceId:e.space_id},a=o({requested:{table:t.parent_table,id:t.parent_id,spaceId:t.space_id},requester:r});if(a&&(t.parent_id=a.id),t.comments&&(t.comments=t.comments.map((e=>{var i;return(null===(i=o({requested:{table:R().SN,id:e,spaceId:t.space_id},requester:r}))||void 0===i?void 0:i.id)||e}))),"default"===t.type&&t.context)t.context=(0,Q().R)({...i,text:{value:t.context,spaceId:t.space_id},mapper:o,requester:r,resolveTemplateVariables:!1});else if("suggestion"===t.type)throw new Error("Not implemented")}(o,j,i,l):t===R().SN?function(e,t,o,i){const r={table:R().SN,id:e.id,spaceId:e.space_id},a=o({requested:B().L3.fromPointerLike({table:t.parent_table,id:t.parent_id,spaceId:t.space_id}),requester:r});if(a&&(t.parent_id=a.id),t.text&&(t.text=(0,Q().R)({...i,text:{value:t.text,spaceId:t.space_id},mapper:o,requester:r,resolveTemplateVariables:!1})),t.content)for(const[d,c]of t.content.entries()){var n;const e=null===(n=o({requested:B().L3.fromPointerLike({table:f().ev,id:c,spaceId:t.space_id}),requester:r}))||void 0===n?void 0:n.id;e&&(t.content[d]=e)}if(t.reactions)for(const[d,c]of t.reactions.entries()){var l;const e=null===(l=o({requested:{table:S().ez,id:c,spaceId:t.space_id},requester:r}))||void 0===l?void 0:l.id;e&&(t.reactions[d]=e)}}(o,j,i,l):t===S().ez?function(e,t,o,i){const r={table:S().ez,id:e.id,spaceId:e.space_id},a=o({requested:B().L3.fromPointerLike({table:t.parent_table,id:t.parent_id,spaceId:t.space_id}),requester:r});a&&(t.parent_id=a.id)}(o,j,i):t===_().yB?(0,N().i)({originalRecord:o,duplicateRecord:j,mapper:i,options:n??{},actor:d}):t===m().SC?(0,D().I)({originalRecord:o,duplicateRecord:j,mapper:i,getRecordRole:s,options:n??{},originOptions:l}):t===L().C0?function(e){const{original:t,duplicate:o,mapper:i}=e,r={table:L().C0,id:t.id,spaceId:t.space_id},a=i({requested:{table:f().ev,id:t.parent_id,spaceId:t.space_id},requester:r});if(a&&(o.parent_id=a.id),o.space_id=(null==a?void 0:a.spaceId)??t.space_id,o.data){o.data.runtime_actor_pointer=void 0;for(const e of(null===(n=o.data)||void 0===n?void 0:n.modules)??[]){var n;if(!e.state)continue;const t=(0,ae().jK)(e.type);e.state=t.duplicateState({original:e.state,mapper:i,requester:r})}for(const e of o.data.triggers??[]){if(e.enabled=!1,!e.state)continue;const t=(o.data.modules??[]).find((t=>t.key===e.moduleKey));if(!t)throw new Error(`Unable to find module with key "${e.moduleKey}"`);const a=ae().Nh[t.type].triggers[e.state.type];if(!a)throw new Error(`Unable to find trigger definition for "${e.state.type}" in module "${t.type}"`);const n=a.triggerDuplicator;e.state=n({original:e.state,mapper:i,requester:r})}}}({original:o,duplicate:j,mapper:i,originOptions:l}):t===M().MC?function(e){let{original:t,duplicate:o,mapper:i,originOptions:r}=e;const a={table:M().MC,id:t.id,spaceId:t.space_id},n=i({requested:B().L3.fromPointerLike({table:o.parent_table,id:o.parent_id,spaceId:o.space_id}),requester:a});n&&(o.parent_id=n.id)}({original:o,duplicate:j,mapper:i,originOptions:l}):t===x().zx?function(e){var t,o;let{original:i,duplicate:r,mapper:a,layoutCollectionViewBlocksToRemove:n}=e;const l={table:x().zx,id:i.id,spaceId:i.space_id};r.parent_id=A({mapper:a,requested:B().L3.fromPointerLike({table:r.parent_table,id:r.parent_id,spaceId:r.space_id}),requester:l}).id,r.format||(r.format={}),r.format.copied_from_pointer={table:x().zx,id:i.id,spaceId:i.space_id},r.modules=(0,ie().Pe)(r.modules);const d=(0,re().E)(r.modules,(e=>"views"===e.type||"viewsMain"===e.type?{type:e.type,id:e.id,collection_view_block_pointer:{...O({table:f().ev,mapper:a,requested:B().L3.fromPointerLike(e.collection_view_block_pointer),requester:l}),spaceId:r.space_id}}:"formQuestion"===e.type?{type:"formQuestion",id:e.id,formQuestionId:{...O({table:P().lo,mapper:a,requested:B().L3.fromPointerLike({table:P().lo,id:e.formQuestionId,spaceId:r.space_id}),requester:l}),spaceId:r.space_id}.id,parentModuleId:e.parentModuleId,parentConditionalGroupId:e.parentConditionalGroupId,conditionalGroups:e.conditionalGroups}:"placeholder"===e.type?{type:"placeholder",id:e.id,parentModuleId:e.parentModuleId,parentConditionalGroupId:e.parentConditionalGroupId}:e)),c=Object.fromEntries(Object.entries(d.form_conditional_modules??{}).filter((e=>{const[t,o]=e;return"formQuestion"===o.type||"placeholder"===o.type})));r.modules={...d,form_conditional_modules:c},null!==(t=r.format)&&void 0!==t&&t.previousViewsMainCollectionViewBlockPointer&&null!=n&&n.has(r.format.previousViewsMainCollectionViewBlockPointer.id)&&delete r.format.previousViewsMainCollectionViewBlockPointer;const s=null===(o=i.blocks)||void 0===o?void 0:o.filter((e=>!(null!=n&&n.has(e))));s&&(r.blocks=s.map((e=>A({mapper:a,requested:{table:f().ev,id:e,spaceId:r.space_id},requester:l}).id)))}({original:o,duplicate:j,mapper:i,layoutCollectionViewBlocksToRemove:U}):t===P().lo?function(e){const{original:t,duplicate:o,mapper:i}=e,r={table:P().lo,id:t.id,spaceId:t.space_id},a=i({requested:B().L3.fromPointerLike({table:o.parent_table,id:o.parent_id,spaceId:o.space_id}),requester:r});a&&(o.parent_id=a.id)}({original:o,duplicate:j,mapper:i,originOptions:l}):(0,a().HB)(t);return{duplicateRecord:j,additionalRecords:F}}function ue(e){const{rootSourceBlockIds:t,childSourcePointer:o,getSourceRecordValue:i}=e;for(const r of(0,k()._N)(o,i))if(_e({rootSourceBlockIds:t,recordWithTable:r}))return!0;return!1}function _e(e){const{recordWithTable:t,rootSourceBlockIds:o}=e;if(t.table!==f().ev)return t.table===m().SC;if(o.includes(t.value.id))return!1;if(p().Bj6.fromBlock(t.value).isTemplateVariableContainerBlock())return!0}var me=()=>o(851552),fe=()=>o(502140),ve=()=>o(427091),ge=()=>o(524118),be=()=>o(409211),Ie=()=>o(73751),ye=()=>o(927685),ke=()=>o(236907),qe=()=>o(754697),Ce=()=>o(485966),Be=()=>o(836331),he=()=>o(413871),we=()=>o(197881),Re=()=>o(839618),Te=()=>o(900635),Pe=()=>o(759625),xe=()=>o(84543);function Se(e){var t,o,i;const{environment:r,createBlockItem:a,from:n,inMemoryRecordCache:l,transaction:d,selection:c}=e;if(!a.templateRootBlockId||!a.createTemplate)throw new Error("Invalid createBlock item.");const s=(c.length>0?c[0].getSpaceId():void 0)??(null===(t=Ce().default.state.currentSpaceStore)||void 0===t?void 0:t.id)??(null===(o=Ce().default.state.mainEditorCurrentBlockStore)||void 0===o?void 0:o.getSpaceId()),p=s?r.idCreator.getSpaceIdCreatorSync(s):void 0,{targetBlockStore:u}=Ve({environment:r,sourceBlockId:a.templateRootBlockId,targetBlockPointer:(0,qe().zP)({environment:r,table:f().ev,spaceId:s}),sourceBlockSubtree:(0,C().partialRecordMapToRecordMap)(a.createTemplate(r)),targetRecordCache:l,transaction:d,deepCopyTransclusionContainers:!0,resolveTemplateVariables:!1,spaceIdCreator:p});if(null===(i=a.postCreateCallback)||void 0===i||i.call(a,u,r,d),Te().eY({environment:r,store:u,transaction:d}),n&&a.blockType){var _,m;const e=a.collectionViewType,t="full_page"===e,o=0!==c.length?null===(_=c[0])||void 0===_?void 0:_.getParentCollectionIdUpToTwoLevels():void 0;let i,l,d,s;if("chart"===e){var v,g;const e=null===(v=u.getCollectionViewStores())||void 0===v?void 0:v.at(0);i=null==e||null===(g=e.getChartConfig())||void 0===g?void 0:g.type,l=null==e?void 0:e.getChartPlaceholderType()}if("form_editor"===e){var b;const e=null===(b=u.getCollectionViewStores())||void 0===b?void 0:b.at(0),t=null==e?void 0:e.getFormBlockStore();d=null==t?void 0:t.id,s=null==e?void 0:e.id}we().v(r,{from:n,type:a.blockType,collection_id:u.getAssociatedCollectionId()??(null===(m=u.getCollectionStore())||void 0===m?void 0:m.id),view_type:"inline"===e||"full_page"===e?"table":e,is_toggleable:a.isToggleable,automation_id:u.getAutomationId(),new_page_id:"page"===a.blockType?u.id:void 0,creating_block_id:u.id,parent_collection_id:o,is_full_screen:t,chart_type:"placeholder"===i?l:i,is_chart_placeholder:"placeholder"===i,form_id:d,view_id:s})}return u}function Ve(e){const{environment:t,sourceBlockId:o,sourceBlockSubtree:r,targetBlockPointer:l,targetRecordCache:d,transaction:c,deepCopyTransclusionContainers:s,duplicateDiscussions:p,shallowCopyNavigableBlock:v,resolveTemplateVariables:g,recordPointerMap:b,preventLegacyTransclusions:I,createLegacyTransclusionCopyIndicator:y,spaceIdCreator:k,installationImprint:q,templateInstallationMetadata:C,isTemplateInstantiation:B,appendContentOnly:h}=e,w=t.currentUser.id;let R=!1;("onboarding"===(null==C?void 0:C.source)||"team_home"===(null==C?void 0:C.source)||null!=C&&C.isFirstPartyPaidTemplate&&Be().default.checkGate({gateName:"adoption_opt_templates_out_of_block_limit"}))&&(R=!0);const{duplicateRecordMap:T,originalToDuplicate:P,aiBlocksToAutoGenerate:x}=ce({sourceBlockId:o,targetBlockPointer:l,recordMap:r,recordPointerMap:b,options:{deepCopyTransclusionContainers:s,duplicateDiscussions:p,shallowCopyNavigableBlock:v,resolveTemplateVariables:!!g&&{currentUserId:w,currentTimeZone:(0,ve().P)()}},baseUrl:ye().A.domainBaseUrl,publicDomainName:ye().A.publicDomainName,actor:w?{table:be().oo,id:w}:void 0,getRecordRole:d.makeGetRecordRoleFn(w),preventLegacyTransclusions:I,createLegacyTransclusionCopyIndicator:y,installationImprint:q,logWarning:e=>{"unmappedContentId"===e.type||("multiReferencedContentIds"===e.type?fe().log({level:"warning",from:"createBlockActions",type:"multiReferencedContentIds",data:{ids:e.contentIds}}):(0,a().HB)(e))},spaceIdCreator:k,experimentService:Be().default,isTemplateInstantiation:Boolean(B)}),S=new(he().Bv)(t,l,{inMemoryRecordCache:d}),V=S.getSpaceStore(),M=(0,ke().D8)(V);c.postPerformAssertions.push((function(){if(c.isLocal)return;if(!S.getParentStore())throw new(ge().yI4)(`Initialized template was not given a parent before being committed in transaction ${c.getUserActionForAnalyticsPurposesOnly()}`)}));for(const{model:D}of T)if(D)if(D.table===f().ev){var L,O;const e=D.__IM_SORRY__getValue(),t=he().Bv.createChildStore(S,D.pointer);D.id===l.id&&B&&e.is_template&&(e.is_template=!1,e.format&&delete e.format.automation_id),!R||((A=e).type===n().xd.collectionViewPage||A.content&&0!==A.content.length)||(e.ignore_block_count=!0);const o=D.getFormat(),r=(null===(L=d.getRecord({pointer:D.pointer,userId:w}))||void 0===L||null===(L=L.value)||void 0===L?void 0:L.format)??{},s=u().op.update({pointer:D.pointer,path:["format"],args:(0,a().uv)(r).reduce(((e,t)=>t in o&&void 0!==o[t]?e:{...e,[t]:null}),{})}),p=D.pointer.table===l.table&&D.pointer.id===l.id?null===(O=d.getRecord({pointer:D.pointer,userId:w}))||void 0===O?void 0:O.value:void 0;if(p&&(delete e.created_by_id,delete e.created_by_table,delete e.created_time),p&&h&&D.id===S.id){const e=S.getContentIds()??[],o=D.getContentIds()??[];xe().applyOperation({store:t,operation:u().op.update({args:{content:[...e,...o]},pointer:D.pointer,path:[]}),transaction:c});continue}const _=p?i().mP({existingBlock:p,updatedBlock:e}).concat([s]):i().VC({block:e,useCrdt:M});for(const i of _)(0,Ie().ph)(i)?xe().applyCrdtTextOperation({store:t,operation:i,invertedOperation:void 0,transaction:c}):xe().applyOperation({store:t,operation:i,transaction:c})}else{if(B){if(D.table===_().yB&&D.parent_id===l.id)continue;if(D.table===m().SC&&D.isType("create_page")){const e=D.getConfig();if((null==e?void 0:e.template_page_id)===l.id)continue}}const e=D.__IM_SORRY__getValue(),t=(0,he().Oo)(S,D.pointer);Pe().KY({store:t,value:e,transaction:c})}var A;x.length>0&&c.postSubmitCallbacks.push((async()=>{await async function(e){const{environment:t,aiBlockPointers:o,parentPageId:i}=e,r=(0,me().Dv)("generateAiBlockTask");for(const a of o)for await(const e of(0,Re().UT)(t,r,{blockId:a.id,spaceId:a.spaceId,parentPageId:i}));}({environment:t,aiBlockPointers:x,parentPageId:S.id})}));return{targetBlockStore:S,originalToDuplicate:P,subtreeSize:T.getSize()}}}}]);