"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[83324],{425447:(e,t,a)=>{a.r(t),a.d(t,{attemptServerBackedLocalDuplicate:()=>ae,duplicateBlock:()=>oe,localDuplicate:()=>Q,serverDuplicate:()=>ee,shouldUseDuplicateAndTranslateTemplateBlock:()=>ne,shouldUseDuplicateTemplateBlock:()=>re});a(610931),a(362833),a(725707),a(107652),a(403517),a(113085);var o=()=>a(488587),r=()=>a(502140),n=()=>a(427091),c=()=>a(519423),i=()=>a(220574),s=()=>a(711659),l=()=>a(385649),d=()=>a(145017),p=()=>a(26907),u=()=>a(218357),m=()=>a(450475),g=()=>a(23371),v=()=>a(125146),_=()=>a(851552);const y=(0,_().Dv)("duplicateAndTranslateTemplateBlock"),I=(0,_().Dv)("duplicateTemplateBlock");var k=()=>a(577701),f=()=>a(197881),S=()=>a(702783),h=()=>a(818369),b=()=>a(415029),B=()=>a(145046),C=()=>a(839618),T=()=>a(900635),M=()=>a(349947),w=()=>a(448316),A=()=>a(84543),L=()=>a(868325),P=()=>a(814370),R=()=>a(754697),D=()=>a(336844),E=()=>a(708732),x=()=>a(477784),z=()=>a(53664),N=()=>a(196387);class F{constructor(e){this.environment=void 0,this.metricName=void 0,this.startMetric=void 0,this.prevLapMetric=void 0,this.extraData=void 0,this.environment=e.environment,this.metricName=e.metricName,this.startMetric=N().default.mark(e.metricName),this.prevLapMetric=N().default.mark(e.metricName),this.extraData=e.extraData??{}}mark(e){N().default.measure(this.prevLapMetric,{environment:this.environment,data:{type:e,...this.extraData},sampleDecision:"default"}),this.prevLapMetric=N().default.mark(this.metricName)}end(){N().default.measure(this.startMetric,{environment:this.environment,data:{type:"total",...this.extraData},sampleDecision:"default"})}}var U=()=>a(485966),O=()=>a(802955),V=()=>a(836331),J=()=>a(413871),j=()=>a(272553),$=(a(491955),()=>a(762847)),q=()=>a(524118),W=()=>a(76394),K=()=>a(202114),G=()=>a(759625),X=()=>a(421378);function Y(e){for(const t of e)K().L7(t.id)}function Z(e,t){for(const a of t)K().DW(e,a.id)}var H=()=>a(134549);function Q(e){var t,a,n;const{environment:c,sourceBlockId:i,targetBlockPointer:s,sourceBlockSubtree:l,targetInMemoryRecordCache:p,options:u,shallowCopyNavigableBlock:m,duplicateDiscussions:g,transaction:v,installationImprint:_,templateInstallationMetadata:y,actionStartTimestamp:I,stopwatch:k}=e;null==k||k.mark("local_duplicate_start");const f=s.spaceId,h=null===(t=l.getModel({id:i,table:d().ev}))||void 0===t?void 0:t.spaceId,C=[],T=I??performance.now(),M=f??(null===(a=U().default.state.currentSpaceStore)||void 0===a?void 0:a.id)??(null===(n=U().default.state.mainEditorCurrentBlockStore)||void 0===n?void 0:n.getSpaceId()),A=M?c.idCreator.getSpaceIdCreatorSync(M):void 0,{targetBlockStore:L,originalToDuplicate:P,subtreeSize:R}=b().j({environment:c,sourceBlockId:i,targetBlockPointer:s,sourceBlockSubtree:l,targetRecordCache:p,transaction:v,deepCopyTransclusionContainers:Boolean(u.deepCopyTransclusionContainers),duplicateDiscussions:g,shallowCopyNavigableBlock:m,resolveTemplateVariables:u.resolveTemplateVariables,preventLegacyTransclusions:u.preventLegacyTransclusions,createLegacyTransclusionCopyIndicator:{onCreate(e){C.push(e)}},installationImprint:_,templateInstallationMetadata:y,isTemplateInstantiation:u.isTemplateInstallation,spaceIdCreator:A,appendContentOnly:u.appendContentOnly});return null==k||k.mark("local_duplicate_initialize_template_success"),ce({environment:c,type:"local_duplicate_initialize_template_success",data:{message:"Successful initialize template",targetSpaceId:f,sourceSpaceId:h,targetBlockStore:L,subtreeSize:R}}),function(e){const{environment:t,userAction:a,startTime:o,succeeded:r,totalBlocks:n,isLocal:c}=e,i=V().default.checkGate({gateName:"duplicate_block_await_post_submit_transaction"}),s=V().default.checkGate({gateName:"layouts_views_module_strip_child_cvb_of_simple_layouts"});(0,j().E)({environment:t,success:r,time:performance.now()-o,user_action:a,is_duplication_local:c,is_await_post_submit_transaction:i,strip_layouts_child_collection_view_block_enabled:s,duplication_size:n})}({environment:c,userAction:v.getUserActionForAnalyticsPurposesOnly()||"",startTime:T,isLocal:!0,totalBlocks:R,succeeded:!0}),f!==h&&r().log({level:"info",from:"localDuplicate",type:"local_duplicate_across_spaces",data:{sourceSpaceId:h,targetSpaceId:f,sourceBlockId:i,subTreeSize:l.getSize()}}),u.addCopyName&&L&&L.isNavigableBlock()&&(!function(e){const{environment:t,transaction:a,targetBlockStore:r}=e,n=r.getTitleStore();if(!n)return;const c=n.getValue(),i=(0,o().g)(c);w().R9({environment:t,store:n,value:i,transaction:a}),ce({environment:t,type:"local_duplicate_text_set_value",data:{value:i,titleStoreId:n.id,targetBlockId:r.id}})}({environment:c,transaction:v,targetBlockStore:L}),null==k||k.mark("local_duplicate_add_copy_name")),C.length&&(!function(e){const{environment:t,transaction:a,targetBlockStore:o,targetRecordCache:r,sourceSpaceId:n,legacyTransclusionCopyIndicators:c,options:i,templateInstallationMetadata:s}=e,l=!O().A.state.online;l&&B().f1(x().A.formatMessage(j().V.offlineError));for(const p of c){ce({environment:t,type:"local_duplicate_legacy_transclusion_copy_indicators",data:{message:"Iterating legacyTransclusionCopyIndicators",info:p}});const e=o.getSpaceId(),c=J().Bv.createChildStore(o,{table:d().ev,id:p.duplicateBlockId});ee({environment:t,targetSpaceId:e,targetInMemoryRecordCache:r,transaction:a,userActionSuffix:" (legacy transclusion fix)",sourceBlocks:[{id:p.sourceBlockId,spaceId:n}],copyIndicators:[c],options:{...i,addCopyName:!1,convertExternalObjectInstancesToPlaceholders:i.convertExternalObjectInstancesToPlaceholders??!1},templateInstallationMetadata:s,shouldAttemptServerBackedLocalDuplication:!1})}S().hi(t,{offline:l,num_blocks_duplicated:c.length,user_action:a.getUserActionForAnalyticsPurposesOnly()})}({environment:c,transaction:v,targetBlockStore:L,targetRecordCache:p,sourceSpaceId:h,legacyTransclusionCopyIndicators:C,options:u,templateInstallationMetadata:y}),null==k||k.mark("local_duplicate_legacy_transclusion_fix")),null==k||k.mark("local_duplicate_success"),{targetBlockStore:L,originalToDuplicate:P}}function ee(e){const{environment:t,sourceBlocks:a,targetInMemoryRecordCache:o,transaction:r,options:c,targetSpaceId:s,userActionSuffix:l,installationImprint:d,templateInstallationMetadata:p={},shouldAttemptServerBackedLocalDuplication:u,shouldUseSynchronousDuplicationAPI:m,actionStartTimestamp:_,stopwatch:k}=e;if(null==k||k.mark("server_duplicate_start"),0===a.length)throw function(e){const{environment:t,type:a,data:o}=e;se({environment:t,level:"error",from:"duplicateActions",type:a,data:o})}({environment:t,type:"server_duplicate_no_source_blocks",data:{targetSpaceId:s,options:c}}),new Error("Must duplicate at least one block");const f=e.copyIndicators??function(e){const{environment:t,sourceBlocks:a,targetRecordCache:o,transaction:r,spaceId:n}=e,c=a.map(((e,a)=>G().Wv({environment:t,type:$().xd.copyIndicator,inMemoryRecordCache:o,transaction:r,spaceId:n})));if(c.length!==a.length)throw new Error("copyIndicators must be same length as source blocks");if(!(0,W().EI)(c))throw new Error("copyIndicators must cannot be empty");return c}({environment:t,sourceBlocks:a,targetRecordCache:o,transaction:r,spaceId:s});null==k||k.mark("create_copy_indicators");const S=g().yX(),b=_??performance.now();return r.postSubmitCallbacks.push((async e=>{if(null==k||k.mark("transaction_post_submit_callback"),e)return ie({environment:t,type:"server_duplicate_transaction_post_submit_callback_error",data:{copyIndicatorIds:f.map((e=>e.id)),error:e,targetSpaceId:s,options:c}}),void function(e,t){const a=(0,q().op4)(e)?(0,L().DX)(x().A.getIntl(),e):void 0;t.resolve({status:"error",errorMessage:a??x().A.formatMessage(j().V.unknownError),error:e})}(e,S);const o=`${r.getUserActionForAnalyticsPurposesOnly()}${l?` ${l}`:""}`;if(function(e){for(const t of e)K().n_(t.id)}(f),null==k||k.mark("initialize_copy_indicators_progress_state"),u&&1===a.length){const{success:e}=await ae({environment:t,sourceBlockPointer:a[0],targetBlockStore:f[0],userAction:o,options:c,templateInstallationMetadata:p,actionStartTimestamp:b,stopwatch:k});if(e)return null==k||k.mark("server_backed_local_duplicate_success"),Y(f),void S.resolve({status:"success"});null==k||k.mark("server_backed_local_duplicate_failure")}const g=await async function(e){const{environment:t,copyIndicators:a,sourceBlocks:o,targetSpaceId:r,options:c,userAction:i,templateInstallationMetadata:s,installationImprint:l,shouldUseSynchronousDuplicationAPI:d,stopwatch:p}=e,u=o[0].spaceId||r,m=o.map((e=>({...e,spaceId:e.spaceId||u}))),g=a.map((e=>({id:e.id,spaceId:e.getSpaceId()}))),_=!!c.resolveTemplateVariables&&{currentUserId:t.currentUser.id,currentTimeZone:(0,n().P)()},k={sourceBlocks:m,targetBlocks:g,userAction:i,addCopyName:c.addCopyName,deepCopyTransclusionContainers:c.deepCopyTransclusionContainers,convertExternalObjectInstancesToPlaceholders:c.convertExternalObjectInstancesToPlaceholders,duplicateOnlyCollectionSchema:c.duplicateOnlyCollectionSchema,createActivities:c.createActivities,resolveTemplateVariables:_},f=re(s.source),S=ne(c.shouldTranslate,c.sourceLanguage,c.targetLanguage);let b;if(f)if(d)b=await async function(e){const{environment:t,request:a,stopwatch:o}=e,r=await h().callApi({eventName:"duplicateTemplateBlockSynchronously",environment:t,data:a});if(null==o||o.mark("duplicate_template_synchronous_finished"),"failed"===r.type)return{success:!1,error:r.error,errorMessage:(0,L().A)(x().A.getIntl(),r.error)};return{success:!0,recordIdMapJson:r.data.recordIdMapJson}}({environment:t,request:{...k,sourceLanguage:c.sourceLanguage,targetLanguage:c.targetLanguage}}),null==p||p.mark("duplicate_template_synchronously_finished");else{const e=C().UT(t,I,{...k,source:s.source,context:s.context,isEmailShared:s.isEmailShared,isFromDuplicateParam:s.isFromDuplicateParam});b=await te({environment:t,copyIndicators:a,targetSpaceId:r,options:c,userAction:i,duplicateBlockIterator:e}),null==p||p.mark("duplicate_template_finished")}else if(S){const e=C().UT(t,y,{...k,sourceLanguage:c.sourceLanguage,targetLanguage:c.targetLanguage});b=await te({environment:t,copyIndicators:a,targetSpaceId:r,options:c,userAction:i,duplicateBlockIterator:e}),null==p||p.mark("duplicate_and_translate_template_finished")}else if(d)b=await async function(e){const{environment:t,request:a}=e,o=await h().callApi({eventName:"duplicateBlockSynchronously",environment:t,data:a});if("failed"===o.type)return{success:!1,error:o.error,errorMessage:(0,L().A)(x().A.getIntl(),o.error)};return{success:!0,recordIdMapJson:o.data.recordIdMapJson}}({environment:t,request:{...k,installationImprint:l,returnRecordIdMapJson:c.returnRecordIdMap}}),null==p||p.mark("duplicate_block_synchronously_finished");else{const e=C().UT(t,v().w,{...k,installationImprint:l,returnRecordIdMapJson:c.returnRecordIdMap});b=await te({environment:t,copyIndicators:a,targetSpaceId:r,options:c,userAction:i,duplicateBlockIterator:e}),null==p||p.mark("duplicate_block_finished")}return b}({environment:t,copyIndicators:f,sourceBlocks:a,targetSpaceId:s,options:c,userAction:o,templateInstallationMetadata:p,installationImprint:d,shouldUseSynchronousDuplicationAPI:m,stopwatch:k});if(null==k||k.mark("perform_server_duplicate_finished"),ce({environment:t,type:"server_duplicate_duplicate_block_iterator_success",data:{result:g,targetSpaceId:s,options:c}}),Y(f),!g.success)return function(e){const{environment:t,copyIndicators:a}=e;h().callApi({eventName:"deleteBlocks",environment:t,data:{blocks:a.filter((e=>e.useCrdt())).map((e=>({id:e.id,spaceId:e.pointer.spaceId}))),permanentlyDelete:!1}}),X().LS({environment:t,blocks:a.filter((e=>!e.useCrdt()))})}({environment:t,copyIndicators:f}),ie({environment:t,type:"server_duplicate_iterator_error",data:{errorMessage:g.errorMessage}}),void S.resolve({status:"error",errorMessage:g.errorMessage,error:g.error});null==k||k.mark("server_duplicate_success"),S.resolve({status:"success",recordIdMap:g.recordIdMapJson?i().RecordMapPolymorphic.create(g.recordIdMapJson):void 0})})),{blockStores:f,onComplete:S.promise}}async function te(e){var t;const{environment:a,copyIndicators:o,targetSpaceId:r,options:n,duplicateBlockIterator:c}=e;let i;try{for await(const e of c)ce({environment:a,type:"server_duplicate_duplicate_block_iterator",data:{response:e,targetSpaceId:r,options:n}}),Z(e,o),k().$2(a,e),i=e}catch(d){}if(!i||i.error){var s,l;const e=null!==(s=i)&&void 0!==s&&s.error?(0,L().A)(x().A.getIntl(),i.error):x().A.formatMessage(j().V.unknownError);return{success:!1,error:(null===(l=i)||void 0===l?void 0:l.error)??new Error(e),errorMessage:e}}return{success:!0,recordIdMapJson:null===(t=i)||void 0===t?void 0:t.value.recordIdMapJson}}async function ae(e){const{environment:t,sourceBlockPointer:a,targetBlockStore:o,userAction:n,options:d,templateInstallationMetadata:p,recordLimit:u=500,actionStartTimestamp:g,targetInMemoryRecordCache:v,stopwatch:_}=e;null==_||_.mark("attempt_server_backed_local_duplicate_start"),ce({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate",data:{sourceBlockPointer:a,targetBlockStore:o,targetSpaceId:o.getSpaceId(),options:d}});const y=(0,D().$J)(),I=await async function(e){const{environment:t,sourceBlockPointer:a,targetBlockStore:o,targetInMemoryRecordCache:n,options:s,enableLegacyTransclusionFixing:l,recordLimit:d,userAction:p}=e,u=n??o.inMemoryRecordCache,g={blockId:a.id,allowCopyCollections:!0,requireFullSubtree:!0,skipTransclusionContainerChildren:!s.deepCopyTransclusionContainers,allowCopyExternalObjectInstances:!s.convertExternalObjectInstancesToPlaceholders,includeLegacyTransclusionBlockValues:l,inMemoryRecordCache:u};let v;if(v=(0,H().loadLocalSubtree)(t,g),!v.recordMap&&u===t.defaultRecordCache.inMemoryRecordCache)try{ce({environment:t,type:"performInexactPagePreload",data:{message:"No local subtree found, performing performInexactPagePreload",loadLocalSubtreeArgs:g}}),await(0,E().A$)(t,{table:"block",id:a.id,spaceId:a.spaceId}),v=(0,H().loadLocalSubtree)(t,g)}catch(_){r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"persistedRecordCachePreloadError",error:(0,m().convertErrorToLog)(_),data:{message:"Failed to preload subtree from persisted record cache"}})}v.recordMap||(ce({environment:t,type:"loadLocalSubtreeApi",data:{message:"No local subtree found from previous attempts, attemping API call to loadBlockSubtree",currentLocalSubtreeResponse:v}}),v=await async function(e){const{environment:t,sourceBlockPointer:a,recordLimit:o,userAction:n,targetBlockStore:s,loadLocalSubtreeArgs:l}=e;try{const e=await h().callApi({eventName:"loadBlockSubtree",environment:t,data:{block:{id:a.id,spaceId:a.spaceId},shallow:!1,recordCountLimit:o},headers:(0,c().WS)({spaceId:a.spaceId})});if(ce({environment:t,type:"loadBlockSubtreeApiResult",data:{message:"Result from loadBlockSubtree API call",subtreeResult:e,apiArgs:{block:{id:a.id,spaceId:a.spaceId},shallow:!1,recordCountLimit:o}}}),"success"===e.type){const a=i().RecordMapWithRole.create(e.data.subtreeRecordMap);return await M()._O({environment:t,inMemoryRecordCache:l.inMemoryRecordCache,recordMap:a,debugSource:n}),(0,H().loadLocalSubtree)(t,l)}{const t=(0,P().V)(e);r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"loadBlockSubtreeFailure",data:{message:"Error fetching subtree",miscDataToConvertToString:{error:t,sourceBlockPointer:a,cacheSize:s.inMemoryRecordCache.size,targetBlockPointer:{id:s.id,spaceId:s.getSpaceId(),type:s.getType()},userAction:n}}})}}catch(_){r().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,m().convertErrorToLog)(_),data:{message:"Error loading subtree",miscDataToConvertToString:{sourceBlockPointer:a,cacheSize:s.inMemoryRecordCache.size,targetBlockPointer:{id:s.id,spaceId:s.getSpaceId(),type:s.getType()},userAction:n}}})}}({environment:t,sourceBlockPointer:a,recordLimit:d,userAction:p,targetBlockStore:o,loadLocalSubtreeArgs:g}));v&&!v.recordMap&&r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadFailure",data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:a,cacheSize:o.inMemoryRecordCache.size,reason:"error"===v.type?v.reason:void 0,targetBlockPointer:{id:o.id,spaceId:o.getSpaceId(),type:o.getType()},missingRecord:"error"===v.type?v.pointer:void 0,userAction:p}}});return v}({environment:t,sourceBlockPointer:a,targetBlockStore:o,targetInMemoryRecordCache:v,options:d,enableLegacyTransclusionFixing:y,recordLimit:u,userAction:n});if(null==_||_.mark("try_load_local_subtree_finished"),!I||!I.recordMap)return{success:!1,size:void 0,pageStore:o};var f;if(a.spaceId&&k().Lw({sourceSpaceId:a.spaceId,targetSpaceId:o.getSpaceId(),sourceBlockSubtree:I.recordMap}))return r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"accessLockingWarning",data:{message:"Unable to perform local duplication",miscDataToConvertToString:{sourceBlockPointer:a,targetBlockPointer:{id:o.id,spaceId:o.getSpaceId(),type:o.getType()},userAction:n}}}),null==_||_.mark("attempt_server_backed_local_duplicate_failure"),{success:!1,size:null===(f=I.recordMap)||void 0===f?void 0:f.getSize(),pageStore:o};for(const c of I.recordMap.getTables()){var S;if(c===s().yB||c===l().SC)return r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"invalidRecordType",data:{message:"Local duplication does not support automation tables",miscDataToConvertToString:{sourceBlockPointer:a,targetBlockPointer:{id:o.id,spaceId:o.getSpaceId(),type:o.getType()},userAction:n}}}),null==_||_.mark("attempt_server_backed_local_duplicate_failure"),{success:!1,size:null===(S=I.recordMap)||void 0===S?void 0:S.getSize(),pageStore:o}}try{var b;ce({environment:t,type:"server_backed_duplicate_start_transaction",data:{message:"Starting transactionActions.createAndCommit for localDuplicate",sourceBlockPointer:a,targetBlockPointer:{id:o.id,spaceId:o.getSpaceId(),type:o.getType()},userAction:n}});const{serverCommitResult:e}=A().createAndCommit({userAction:n,environment:t,canUndo:!0,isTemplateInstantiationTransaction:Boolean(p),perform:e=>Q({environment:t,sourceBlockId:a.id,targetBlockPointer:o.pointer,sourceBlockSubtree:I.recordMap,targetInMemoryRecordCache:o.inMemoryRecordCache,transaction:e,templateInstallationMetadata:p,actionStartTimestamp:g,stopwatch:_,options:{...d,preventLegacyTransclusions:y}})});return await e,null==_||_.mark("server_backed_local_duplicate_finished"),ce({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate_success",data:{targetSpaceId:o.getSpaceId(),options:d}}),{success:!0,size:null===(b=I.recordMap)||void 0===b?void 0:b.getSize(),pageStore:o,transactionPromise:e}}catch(C){var B;return r().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,m().convertErrorToLog)(C),data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:a,targetBlockPointer:{id:o.id,spaceId:o.getSpaceId(),type:o.getType()},userAction:n}}}),{success:!1,size:null===(B=I.recordMap)||void 0===B?void 0:B.getSize(),pageStore:o}}}function oe(e){const{environment:t,stores:a,transaction:o,targetSpaceId:r,preferDuplicateLocation:n,analyticsFrom:c,options:i,installationImprint:s,shouldAttemptServerBackedLocalDuplication:l,templateInstallationMetadata:m,shouldUseSynchronousDuplicationAPI:g}=e,v=performance.now(),_=new F({environment:t,metricName:"duplicate_block_stopwatch",extraData:{duplication_type:"local"===n?"local_duplication":l?"server_backed_local_duplication":g?"server_synchronous_duplication":"server_duplication",from:c}});if(0===a.length)throw new Error("Must duplicate at least one block");const y=a[0].getSpaceId();if(!a.every((e=>e.getSpaceId()===y)))throw new Error("All stores must be in the same space");if(a.length>1&&!a.every((e=>e.isTypedCollectionViewBlock())))throw new Error("Multiple source blocks only supported for grouped typed DB duplication");!function(e){const{environment:t,stores:a,analyticsFrom:o}=e;for(const n of a){const e=n.getRecordStoreAtRootPath().getValue();let a;const{currentSpaceStore:c}=U().default.getState();var r;if(c&&(null==e?void 0:e.parent_table)===u().yK&&(a=J().h4.createChildStore(c,{table:u().yK,id:e.parent_id})),e)f().v(t,{from:o??"copy",type:e.type,teamStore:a,is_toggleable:(0,z().Yt)(e.type,e.format),collection_id:n.getAssociatedCollectionId()??(null===(r=n.getCollectionStore())||void 0===r?void 0:r.id),new_page_id:"page"===e.type?n.id:void 0,creating_block_id:n.id,parent_collection_id:n.getParentCollectionIdUpToTwoLevels(),form_id:n.getFirstFormIdInCollectionViewBlock()})}}({environment:t,stores:a,analyticsFrom:c}),_.mark("track_create_blocks");const I=y!==r,S=m&&(0,p().Fe)(m.source)&&m.isListedTemplate;if("local"===n&&1===a.length&&!S){const e=function(e){const{environment:t,store:a,sourceSpaceId:o,targetSpaceId:r,transaction:n,options:c,installationImprint:i,templateInstallationMetadata:s,actionStartTimestamp:l,stopwatch:p}=e,u=(0,D().$J)(),m=(0,H().loadLocalSubtree)(t,{blockId:a.id,inMemoryRecordCache:a.inMemoryRecordCache,allowCopyCollections:!1,requireFullSubtree:!0,skipTransclusionContainerChildren:!c.deepCopyTransclusionContainers,allowCopyExternalObjectInstances:!c.convertExternalObjectInstancesToPlaceholders,includeLegacyTransclusionBlockValues:u}).recordMap;if(null==p||p.mark("load_local_subtree"),m&&!k().Lw({sourceSpaceId:o,targetSpaceId:r,sourceBlockSubtree:m})){const{targetBlockStore:e}=Q({environment:t,sourceBlockId:a.id,targetBlockPointer:(0,R().zP)({environment:t,table:d().ev,spaceId:r}),sourceBlockSubtree:m,targetInMemoryRecordCache:a.inMemoryRecordCache,options:{...c,preventLegacyTransclusions:u},transaction:n,installationImprint:i,templateInstallationMetadata:s,actionStartTimestamp:l,stopwatch:p});return"ai_block"===e.getType()&&T().EF.setState(e.pointer.id),{blockStores:[e],onComplete:Promise.resolve({status:"success"})}}}({environment:t,store:a[0],options:{...i,convertExternalObjectInstancesToPlaceholders:I},sourceSpaceId:y,targetSpaceId:r,transaction:o,installationImprint:s,templateInstallationMetadata:m,actionStartTimestamp:v,stopwatch:_});if(e)return _.mark("try_local_duplication_success"),_.end(),e;_.mark("try_local_duplication_failure")}if(a.some((e=>e.inMemoryRecordCache!==t.defaultRecordCache.inMemoryRecordCache)))throw new Error("Can only server duplicate from the environment.defaultRecordCache.inMemoryRecordCache.");const h=t.defaultRecordCache.inMemoryRecordCache;O().A.state.online||B().f1(x().A.formatMessage(j().V.offlineError));const b=ee({environment:t,sourceBlocks:a.map((e=>({id:e.id,spaceId:e.getSpaceId()}))),targetInMemoryRecordCache:h,transaction:o,targetSpaceId:r,installationImprint:s,templateInstallationMetadata:m,shouldAttemptServerBackedLocalDuplication:l,actionStartTimestamp:v,stopwatch:_,shouldUseSynchronousDuplicationAPI:g,options:{...i,convertExternalObjectInstancesToPlaceholders:I}});return async function(){const{blockStores:e,onComplete:t}=b;if("success"===(await t).status)for(const a of e)if("ai_block"===a.getType())return void T().EF.setState(a.pointer.id)}(),_.mark("duplicate_block_immediate_return"),b}function re(e){if(!e)return!1;const t=V().default.getConfigKey("enabled_installation_sources_for_duplicate_template_block",e);return Boolean(t)}function ne(e,t,a){return Boolean(e&&t&&a)&&V().default.checkGate({gateName:"translate_template_top_bar"})}function ce(e){const{environment:t,type:a,data:o}=e;se({environment:t,level:"info",from:"duplicateActions",type:a,data:o})}function ie(e){const{environment:t,type:a,data:o}=e;se({environment:t,level:"warning",from:"duplicateActions",type:a,data:o})}function se(e){const{environment:t,level:a,from:o,type:n,data:c}=e,i=V().default.getConfigKey("page_template_duplication_verbose_logging_config","userIds");t.currentUser.id&&i.includes(t.currentUser.id)&&r().log({level:a,from:o,type:n,data:c})}}}]);