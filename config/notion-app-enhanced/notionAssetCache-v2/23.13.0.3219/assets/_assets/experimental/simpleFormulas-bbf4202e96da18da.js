"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[54220],{431169:(e,t,o)=>{o.r(t),o.d(t,{hasAccessDefaultFn:()=>S,hasAccessToCode:()=>T,hasAccessToProperty:()=>P,hasReadPermissionsAccess:()=>F,hasSameSpaceAccess:()=>x,testOnly:()=>A});o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601),o(725707),o(491955);var r=()=>o(975392),c=()=>o(23371),n=()=>o(204132),s=()=>o(76394),i=()=>o(564134),l=()=>o(807912),a=()=>o(187058),u=()=>o(465546),p=()=>o(63430),d=()=>o(32856);function*y(e){const{collectionPointer:t,context:o,propertyId:r,propertySchema:c,visitedPointers:n,hasAccessFn:s}=e,i=(0,a().G7)({...t,propertyId:r});if(n.has(i))return!0;n.add(i);const l=s({propertySchema:c,spaceId:o.spaceId});return"boolean"==typeof l?l:yield*l}function*m(e){var t,o;const{collectionPointer:c,depth:p,collectionSchema:y,context:m,propertyId:h,propertySchema:f,visitedPointers:S,hasAccessFn:F}=e;if("v2"!==f.version||p>l().FORMULA_MAX_DEPTH)return!1;const x=(0,a().G7)({...c,propertyId:h});if(S.has(x))return!0;if(S.add(x),!(0,s().O9)(null===(t=f.formula2)||void 0===t?void 0:t.code))return!0;const P=(0,d().$t)(null===(o=f.formula2)||void 0===o?void 0:o.code);if(n().Q.isFail(P))return!1;const{spaceId:T}=m,A=(0,a().zm)({formulaTypecheckContextValues:[{kind:l().FormulaContextValueKind.ThisRow,type:{collection:c,type:"block"}}],node:P.value,spaceId:T}),k=(0,r().hS)(A,(e=>(0,a().G7)(e)));if(0===k.length)return!0;const{getRecordModel:I}=yield{collectionBlockProperties:[{blockPointers:[],collectionPointer:c,property:h,schema:y}],recordPointers:k.filter((e=>(0,u().T3)(e)))};for(const r of k)if((0,i().pq)(r)){const e=I(r);if(!(0,s().O9)(e))return!1;const t=r.propertyId,o=e.getSchema(),c=o[t];if(!c)continue;if((0,i().bT)(c)||(0,i().lb)(c)){if(!(yield*v({collectionPointer:r,collectionSchema:o,context:m,depth:p+1,propertyId:t,propertySchema:c,visitedPointers:S,hasAccessFn:F})))return!1}else if((0,i().nC)(c)){if(!(yield*v({collectionPointer:r,collectionSchema:o,context:m,depth:p,propertyId:t,propertySchema:c,visitedPointers:S,hasAccessFn:F})))return!1}}else if(!(0,s().O9)(I(r)))return!1;return!0}function*h(e){const{collectionPointer:t,depth:o,collectionSchema:r,context:c,propertyId:n,propertySchema:s,visitedPointers:u,hasAccessFn:d}=e;if("v2"===s.version||o>l().FORMULA_MAX_DEPTH)return!1;const y=(0,a().G7)({...t,propertyId:n});if(u.has(y))return!0;u.add(y);const m=(0,p().kh)(s.formula);if(0===m.length)return!0;for(const l of m){const e=r[l];if(e)if((0,i().bT)(e)||(0,i().lb)(e)){if(!(yield*v({collectionPointer:t,depth:o+1,collectionSchema:r,context:c,propertyId:l,propertySchema:e,visitedPointers:u,hasAccessFn:d})))return!1}else if((0,i().nC)(e)){if(!(yield*v({collectionPointer:t,collectionSchema:r,context:c,depth:o,propertyId:l,propertySchema:e,visitedPointers:u,hasAccessFn:d})))return!1}}return!0}function*f(e){const{collectionPointer:t,depth:o,collectionSchema:r,context:c,propertyId:n,propertySchema:s,visitedPointers:u,hasAccessFn:p}=e;if(o>l().FORMULA_MAX_DEPTH)return!1;const d=(0,a().G7)({...t,propertyId:n});if(u.has(d))return!0;if(u.add(d),!s.relation_property||!s.target_property)return!0;const y=r[s.relation_property];if(!y||"relation"!==y.type)return!0;const m=p({propertySchema:y,spaceId:c.spaceId});if(!("boolean"==typeof m?m:yield*m))return!1;const h=(0,i().Nv)(y);if(!h)return!0;const{getRecordModel:f}=yield{recordPointers:[h]},S=f(h),F=null==S?void 0:S.getNormalizedSchema();if(s.target_property_type&&F){const e=F[s.target_property];if(e&&s.target_property_type===e.type){if((0,i().lb)(e))return yield*v({collectionPointer:h,collectionSchema:F,context:c,depth:o+1,propertyId:s.target_property,propertySchema:e,visitedPointers:u,hasAccessFn:p});if((0,i().nC)(e))return yield*v({collectionPointer:h,collectionSchema:F,context:c,depth:o,propertyId:s.target_property,propertySchema:e,visitedPointers:u,hasAccessFn:p})}}return!0}function*v(e){const{collectionPointer:t,depth:o,collectionSchema:r,context:c,propertyId:n,propertySchema:s,visitedPointers:l,hasAccessFn:a}=e;return(0,i().nC)(s)?yield*y({collectionPointer:t,context:c,propertyId:n,propertySchema:s,visitedPointers:l,hasAccessFn:a}):(0,i().lb)(s)?"v2"===s.version?yield*m({collectionPointer:t,depth:o,collectionSchema:r,context:c,propertyId:n,propertySchema:s,visitedPointers:l,hasAccessFn:a}):yield*h({collectionPointer:t,depth:o,collectionSchema:r,context:c,propertyId:n,propertySchema:s,visitedPointers:l,hasAccessFn:a}):!(0,i().bT)(s)||(yield*f({collectionPointer:t,depth:o,collectionSchema:r,context:c,propertyId:n,propertySchema:s,visitedPointers:l,hasAccessFn:a}))}function*S(e){const{propertySchema:t,spaceId:o}=e,r=(0,i().Nv)(t);if(!(0,s().O9)(r))return!0;const{getRecordModel:c}=yield{recordPointers:[r]},n=c(r);return(0,s().O9)(n)&&x({spaceId:o,propertySchema:t})}function*F(e){const{propertySchema:t}=e,o=(0,i().Nv)(t);if(!(0,s().O9)(o))return!0;const{getRecordModel:r}=yield{recordPointers:[o]},c=r(o);return(0,s().O9)(c)}function x(e){const{propertySchema:t,spaceId:o}=e;return!(0,i().o2)(o,t)}async function P(e){const{collectionPointer:t,collectionSchema:o,context:r,propertyId:n,hasAccessFn:s}=e,i=o[n];return!i||await async function(e){const{context:t}=e;try{const o=v(e);let r=o.next();for(;!r.done;){const e=t.handleDataRequest(r.value);r=o.next((0,c().yL)(e)?await e:e)}return r.value}catch(o){return!0}}({collectionPointer:t,depth:0,collectionSchema:o,context:r,propertyId:n,propertySchema:i,visitedPointers:new Set,hasAccessFn:s})}function T(e){const{context:t}=e;try{const o=function*(e){const{collectionPointer:t,depth:o,context:c,code:p,visitedPointers:y,hasAccessFn:m}=e,h=(0,d().$t)(p);if(n().Q.isFail(h))return!1;const{spaceId:f}=c,S=c.valueTypes.filter((e=>e.kind!==l().FormulaContextValueKind.ThisRow)),F=(0,a().zm)({formulaTypecheckContextValues:t?[...S,{kind:l().FormulaContextValueKind.ThisRow,type:{collection:t,type:"block"}}]:[],node:h.value,spaceId:f}),x=(0,r().hS)(F,(e=>(0,a().G7)(e)));if(0===x.length)return!0;const{getRecordModel:P}=yield{collectionBlockProperties:[],recordPointers:x.filter((e=>(0,u().T3)(e)))};for(const r of x)if((0,i().pq)(r)){const e=P(r);if(!(0,s().O9)(e))return!1;const t=r.propertyId,n=e.getSchema(),l=n[t];if(!l)continue;if((0,i().bT)(l)||(0,i().lb)(l)){if(!(yield*v({collectionPointer:r,collectionSchema:n,context:c,depth:o+1,propertyId:t,propertySchema:l,visitedPointers:y,hasAccessFn:m})))return!1}else if((0,i().nC)(l)&&!(yield*v({collectionPointer:r,collectionSchema:n,context:c,depth:o,propertyId:t,propertySchema:l,visitedPointers:y,hasAccessFn:m})))return!1}else if(!(0,s().O9)(P(r)))return!1;return!0}(e);let c=o.next();for(;!c.done;){const e=t.handleDataRequest(c.value);c=o.next(e)}return c.value}catch(o){return!0}}const A={hasAccessDefaultFn:S,hasAccessToProperty:P,hasAccessToFormula1Property:h,hasAccessToFormula2Property:m,hasAccessToRelationProperty:y,hasAccessToRollupProperty:f}},630714:(e,t,o)=>{o.r(t),o.d(t,{analyzeSimpleFormulaOrFormulaSync:()=>i,executeSimpleFormulaAsyncWithStats:()=>y,filterTextValueToSimpleFormulaValueTokens:()=>S().LU,fromSimpleFormulaArrayValue:()=>S().FW,getDependenciesForSimpleFormula:()=>S().BT,getDependenciesForSimpleFormulaOrFormula:()=>S().MP,getReferencedContextValueIds:()=>S().yP,isAnnotationSimpleValueToken:()=>S().eU,setPropertyValueToFormulaReturnType:()=>S().qB,setPropertyValueToSimpleFormulaReturnType:()=>S().Iv,simpleFormulaValueTypeToFormulaReturnType:()=>S().BZ,simpleFormulaValueWithoutToken:()=>S().h0,singleSimpleValueTokenToTextToken:()=>S().ii,toSimpleFormulaArrayValue:()=>S().M0,toSimpleFormulaSingleValue:()=>S().fd,typecheckSimpleFormulaOrFormula:()=>l});o(362833),o(333225),o(494367),o(516262),o(573119),o(240480),o(950443),o(619601);var r=()=>o(76394),c=()=>o(34662),n=()=>o(431169),s=()=>o(539032);function i(e){const{context:t,value:o}=e;if((0,r().O9)(o)&&(0,r().O9)(o.value)){if("simple"===o.type)return function(e,t){const o=[],r=[];for(const n of e){const e=(0,c().uPN)(n);if(!(0,c().x9g)(e))continue;const i=(0,s().analyzeFormulaSync)([n],t);o.push(...i.parseErrors??[]),r.push(...i.typeErrors??[])}return{type:{type:"text"},parseErrors:o,typeErrors:r}}(o.value,t);{const e=(0,s().analyzeFormulaSync)(o.value,t);return(0,r().O9)(e.type)?e:{parseErrors:e.parseErrors,type:{type:"unknown"},typeErrors:e.typeErrors}}}return{type:{type:"unknown"}}}function l(e){const{context:t,value:o,collectionPointer:r}=e,s=performance.now(),l=i({context:t,value:o}),a=Math.trunc(performance.now()-s),u=!(l.typeErrors&&0!==l.typeErrors.length||l.parseErrors&&0!==l.parseErrors.length),p=!!u&&function(e){let{context:t,value:o,collectionPointer:r}=e;if(!t.featureGates.collections_xws||!o.value)return!1;let s=!1;if("formula"===o.type){(0,n().hasAccessToCode)({collectionPointer:r,context:t,depth:0,code:o.value,visitedPointers:new Set,hasAccessFn:n().hasSameSpaceAccess})||(s=!0)}else if("simple"===o.type)for(const i of o.value){const e=(0,c().uPN)(i);if(!(0,c().x9g)(e))continue;(0,n().hasAccessToCode)({collectionPointer:r,context:t,depth:0,code:[i],visitedPointers:new Set,hasAccessFn:n().hasSameSpaceAccess})||(s=!0)}return s}({context:t,value:o,collectionPointer:r});return{result:l,hasCrossSpaceError:p,stats:{formulaTypecheckDurationMs:void 0,formulaTypecheckSuccess:void 0,formulaExecutionDurationMs:void 0,formulaExecutionSuccess:void 0,totalFormulas:void 0,simpleFormulaTypecheckDurationMs:void 0,simpleFormulaTypecheckSuccess:void 0,simpleFormulaExecutionDurationMs:void 0,simpleFormulaExecutionSuccess:void 0,totalSimpleFormulas:void 0,..."simple"===o.type?{simpleFormulaTypecheckDurationMs:a,simpleFormulaTypecheckSuccess:u,totalSimpleFormulas:1}:{formulaTypecheckDurationMs:a,formulaTypecheckSuccess:u,totalFormulas:1}}}}o(725707),o(491955),o(403517);var a=()=>o(204132),u=()=>o(716605),p=()=>o(465546);function d(e){return!("number"===e.type||"text"===e.type||"checkbox"===e.type)}async function y(e){const{context:t,value:o}=e,c=performance.now(),n=await m(e),s=Math.trunc(performance.now()-c),i=a().Q.isSuccess(n);return"simple"===o.type?d(t.returnType)?{result:n,stats:{formulaTypecheckDurationMs:void 0,formulaTypecheckSuccess:void 0,formulaExecutionDurationMs:void 0,formulaExecutionSuccess:void 0,totalFormulas:void 0,simpleFormulaTypecheckDurationMs:void 0,simpleFormulaTypecheckSuccess:void 0,simpleFormulaExecutionDurationMs:s,simpleFormulaExecutionSuccess:i,totalSimpleFormulas:1}}:{result:n}:"formula"===o.type?{result:n,stats:{formulaTypecheckDurationMs:void 0,formulaTypecheckSuccess:void 0,formulaExecutionDurationMs:s,formulaExecutionSuccess:i,totalFormulas:1,simpleFormulaTypecheckDurationMs:void 0,simpleFormulaTypecheckSuccess:void 0,simpleFormulaExecutionDurationMs:void 0,simpleFormulaExecutionSuccess:void 0,totalSimpleFormulas:void 0}}:(0,r().HB)(o.type)}async function m(e){const{context:t,executeFormula:o,ignoreErrors:n,value:s}=e,{returnType:i}=t,l=s.value;if("simple"===s.type){let e=l;if(!d(i)&&v(e)){const r=await h({context:t,executeFormula:o,value:e});if(a().Q.isFail(r))return n?{value:{type:"undefined"}}:r;e=r.value}if("number"===i.type){const t=u().Me(e);return(0,r().O9)(t)&&!isNaN(t)?{value:{type:"number",value:t}}:{value:{type:"undefined"}}}if("text"===i.type)return{value:{type:"text",value:e??[]}};if("checkbox"===i.type){return{value:{type:"checkbox",value:"true"===c().q4_(e)}}}return o(t,e)}return"formula"===s.type?o(t,l):(0,r().HB)(s.type)}async function h(e){const{context:t,executeFormula:o,ignoreErrors:n,value:s}=e;if(!(0,r().O9)(s))return{value:void 0};const i=[];let l=[];for(const r of s)if(l=c().uPN(r),c().tVx(l)){const e=await o(t,[r]);if(a().Q.isFail(e)&&!n)return e;a().Q.isSuccess(e)&&i.push(...f((0,p().Ht)(e.value),l))}else if(c().TVE(l)){const e=await o(t,[r]);if(a().Q.isFail(e)&&!n)return e;a().Q.isSuccess(e)&&i.push(...f((0,p().Ht)(e.value),l))}else i.push(r);return{value:i}}function f(e,t){if(0===c().AhH(e))return e;const o=t.filter((e=>c().jcO(e)));return 0===o.length?e:c().__s(e.map((e=>{const t=c().uPN(e);return 0===t.length?c().Ey_(c().N8A(e),o):c().Ey_(c().N8A(e),c().RFR(t,o))})))}function v(e){if(!(0,r().O9)(e))return!1;let t;for(const o of e)if(t=c().uPN(o),0!==t.length&&c().x9g(t))return!0;return!1}var S=()=>o(830699)}}]);