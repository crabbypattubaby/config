"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[44425],{373049:(e,o,n)=>{n.r(o),n.d(o,{loadRemotePageAndImages:()=>y,loadRemotePageAndImagesBatched:()=>B});n(610931),n(362833),n(333225),n(494367),n(516262),n(573119),n(240480),n(950443),n(619601),n(725707),n(491955),n(771702),n(403517),n(474872);var t=()=>n(519423),a=()=>n(220574),r=()=>n(145017),s=()=>n(812815),i=()=>n(23371),c=()=>n(818369),d=()=>n(53664),l=()=>n(676566),g=()=>n(960715),f=()=>n(435687),u=()=>n(836331),p=()=>n(762847),h=()=>n(673447);function m(e,o,n){return n.getModelsByTable(r().ev).filter((e=>((e,n)=>{if(e.getType()!==p().xd.collectionView)return!1;const t=(0,h().MR)(e.pointer,n);for(const a of t.slice(1))if(a.id===o)return!0;return!1})(e,n))).map((e=>e.id))}var w=()=>n(145054),I=()=>n(838625);async function v(e,o){const n=[],t=[...e.getRenderableContentPointers()];for(;t.length;){const e=t.shift();if(!e)continue;const a=o.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:e,userId:o.currentUser.id});if(a){if(a.getType()===p().xd.image){const e=a.getFormatValue("display_source"),t=await(0,I().L)({url:e??"",isAuthenticated:!0,permissionRecord:a.pointer},o),r=w().MU(t);r&&n.push(r)}if(!a.isNavigableBlock())if(a.getType()===p().xd.transclusionReference){const e=a.getTransclusionReferenceTargetPointer();if(!e)continue;const n=o.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:e,userId:o.currentUser.id});if(!n)continue;t.push(...n.getRenderableContentPointers())}else t.push(...a.getRenderableContentPointers())}}return n}async function y(e){const{pageId:o,spaceId:n,environment:c,lastDownloadedVersion:l,visitedPages:f,isToggleBlock:p,abortSignal:h}=e;if(f.has(o))return s().O8(new Error("loadRemotePageAndImages tried to fetch a page that was already fetched."),{from:"loadRemotePageAndImages",type:"infiniteFetchPrevented",data:{pageId:o,visitedPages:f}}),{imageCount:0,downloadedVersion:void 0,collectionViewBlockIds:[],pageDownloadTime:0,imagesDownloadTime:0,loadPageChunkV2ForOfflineCount:0,visitedPages:f};f.add(o);const w=performance.now();let I=0;const C=await async function(e){const{pageId:o,spaceId:n,environment:r,lastDownloadedVersion:s,isToggleBlock:c,abortSignal:d}=e;let l=0;const g=[],f=(0,t().WS)({recordId:o,spaceId:n}),u=await k({cursor:void 0,headers:f,pageId:o,spaceId:n,environment:r,lastDownloadedVersion:s,isToggleBlock:c,abortSignal:d});let p=u.serverPageVersion;if(d.throwIfAborted(),l++,"clientAlreadyFresh"in u)return{serverPageVersion:p,collectionViewBlockIds:[],loadPageChunkV2ForOfflineCount:l,recordMap:a().RecordMapWithRole.create()};g.push(u.recordMap);let h=u.cursors.filter((e=>e.stack.length>0));for(;h.length>0;){const e=await i().lX(h,10,(async e=>{const a=(0,t().WS)({cellId:e.cellId}),i=await k({cursor:e,headers:a,environment:r,pageId:o,spaceId:n,lastDownloadedVersion:s,isToggleBlock:c,abortSignal:d});return d.throwIfAborted(),l++,"recordMap"in i&&g.push(i.recordMap),void 0===p&&"number"==typeof i.serverPageVersion&&(p=i.serverPageVersion),i}));h=e.filter(b).map((e=>e.cursors)).flat().filter((e=>e.stack.length>0))}const w=a().RecordMapWithRole.merge(g),I=m(0,o,w);return{serverPageVersion:p,collectionViewBlockIds:I,loadPageChunkV2ForOfflineCount:l,recordMap:w}}({pageId:o,spaceId:n,environment:c,lastDownloadedVersion:l,isToggleBlock:p,abortSignal:h});h.throwIfAborted();const P=performance.now(),V=C.recordMap.getModel({table:r().ev,id:o});if(V){const e=await v(V,c);I=e.length;for(const o of e)try{await fetch(o,{signal:h})}catch(S){throw S instanceof DOMException&&"AbortError"===S.name?new(g().f):S}}h.throwIfAborted();const R=performance.now(),M=new Set(C.collectionViewBlockIds);let{loadPageChunkV2ForOfflineCount:T}=C,B=P-w,D=R-P;if(u().default.checkGate({gateName:"offline_sync_traverse_toggle_blocks"})){const e=C.recordMap.getModelsByTable(r().ev).filter((e=>e.id!==o&&!f.has(e.id)&&d().Yt(e.getType(),e.getFormat())));await i().lX(e,5,(async e=>{const o=await y({pageId:e.id,spaceId:e.getSpaceId(),environment:c,lastDownloadedVersion:void 0,visitedPages:f,isToggleBlock:!0,abortSignal:h});I+=o.imageCount,o.collectionViewBlockIds.forEach((e=>M.add(e))),T+=o.loadPageChunkV2ForOfflineCount,B+=o.pageDownloadTime,D+=o.imagesDownloadTime}))}return{imageCount:I,downloadedVersion:C.serverPageVersion,collectionViewBlockIds:[...M],loadPageChunkV2ForOfflineCount:T,pageDownloadTime:B,imagesDownloadTime:D,visitedPages:f}}function b(e){return"cursors"in e&&"recordMap"in e}async function k(e){const{pageId:o,spaceId:n,environment:t,cursor:r,headers:s,lastDownloadedVersion:i,isToggleBlock:d,abortSignal:g}=e,u={page:{id:o,spaceId:n},cursor:r||{stack:[]},verticalColumns:t.device.isMobile,version:i,isToggleBlock:d??void 0},p=await c().callApi({eventName:"loadPageChunkV2ForOfflineSync",environment:t,data:u,headers:s,inMemoryRecordCache:l().o,abortSignal:g});if(g.throwIfAborted(),"success"===p.type)return"clientAlreadyFresh"in p.data?p.data:{recordMap:a().RecordMapWithRole.create(p.data.recordMap),cursors:p.data.cursors,serverPageVersion:p.data.serverPageVersion};var h;if("OfflineSyncPageNotFoundDuringVersionCheckError"===(null===(h=p.body)||void 0===h?void 0:h.name)){const{currentUser:{id:e},defaultRecordCache:{persistedRecordCache:n}}=t;return e&&!d&&(null==n||n.deleteOfflineActionsAndCleanUp({userId:e,originPageId:void 0,impactedPageIds:[o]})),{recordMap:a().RecordMapWithRole.create(),cursors:[]}}throw new(f().W)}function C(e){const{pageId:o,cellId:n}=e;return[o,n||"NoCellId","EmptyStack"].join("|")}function P(e){const{cursorItem:o,pageId:n,cellId:t}=e,{id:a,table:r,index:s}=o;return[n,t||"NoCellId",a,r,s].join("|")}const V=10,R=100;async function M(e){const o=await async function(e){const{requestBatch:o,environment:n,abortSignal:g}=e,f=u().default.checkGate({gateName:"offline_batched_sync_traverse_toggle_blocks_on_server"}),{trackRequests:p,filterNextRequests:h}=function(){const e=new Set([]),o=new Set([]);return{trackRequests:function(n){for(const{page:t,cellId:a,cursor:r}of n){0===r.stack.length&&e.add(C({pageId:t.id,cellId:a}));for(const e of r.stack)for(const n of e)o.add(P({cursorItem:n,pageId:t.id,cellId:a}))}},filterNextRequests:function(n){const t=[];for(const a of n){const{cellId:n,page:r}=a,s=[];0===a.cursor.stack.length&&(e.has(C({pageId:r.id,cellId:n}))||t.push(a));for(const e of a.cursor.stack){const t=[];for(const a of e){const e=P({cursorItem:a,pageId:r.id,cellId:n});o.has(e)||t.push(a)}t.length>0&&s.push(t)}s.length>0&&t.push({...a,cursor:{stack:s}})}return t}}}(),m=[],w={};let I=0,v=o.map((e=>({...e,cursor:{stack:[]}})));for(;v.length>0&&I<R;){p(v);const e=v.map((e=>({...e,headers:(0,t().WS)({recordId:e.page.id,spaceId:e.page.spaceId,cellId:e.cellId})}))),o=(0,t().E5)(e),s=await i().lX(o.entries(),V,(async e=>{let[o,t]=e;const a=u().default.getConfigKey("offline_mode_settings","download_batch_size");return await i().vA(t,a,(async e=>{const t=await c().callApi({eventName:"syncOfflinePages",environment:n,data:{requests:e.map((e=>{let{cellId:o,...n}=e;return n})),verticalColumns:n.device.isMobile,shouldTraverseToggles:f},headers:o,inMemoryRecordCache:l().o,abortSignal:g});return I++,t}))})),y=[];for(const t of s.flat()){if("failed"===t.type)throw new Error("Batch download failed");const e=a().RecordMapWithRole.create(t.data.recordMap);m.push(e);for(const[o,n]of Object.entries(t.data.serverPageVersionsByPageId))w[o]=n;for(const o of t.data.nextChunks)for(const e of o.cursors){const{cellId:n}=e;y.push({page:o.page,lastDownloadedVersion:void 0,cursor:e,cellId:n})}if(!f){const o=e.getModelsByTable(r().ev).filter((e=>d().Yt(e.getType(),e.getFormat())));y.push(...o.map((e=>({page:{id:e.id,spaceId:e.getSpaceId()},cursor:{stack:[]},lastDownloadedVersion:void 0}))))}for(const o of t.data.pagesToDelete){const{currentUser:{id:e},defaultRecordCache:{persistedRecordCache:t}}=n;e&&t&&(null==t||t.deleteOfflineActionsAndCleanUp({userId:e,originPageId:void 0,impactedPageIds:[o]}))}}v=h(y)}I>=R&&s().O8(new Error("syncOfflinePages was called too many times in one batch."),{from:"loadRemotePages",type:"infiniteFetchPrevented",data:{}});return{recordMap:a().RecordMapWithRole.merge(m),serverPageVersionsByPageId:w,syncOfflinePagesCount:I}}({environment:e[0].environment,requestBatch:e.map((e=>{let{pageId:o,spaceId:n,lastDownloadedVersion:t}=e;return{page:{id:o,spaceId:n},lastDownloadedVersion:t}})),abortSignal:AbortSignal.any(e.map((e=>e.abortSignal)))});return e.map((()=>o))}const T=n(975392).Bj((e=>new(n(945569).A)({performRequests:M,batchSize:e,maxWorkers:1,requestDelayMs:100})));async function B(e){const{pageId:o,spaceId:n,environment:t,lastDownloadedVersion:a,abortSignal:s,skipBatching:i}=e,c=performance.now();let d=0;const l=u().default.getConfigKey("offline_mode_settings","download_batch_size");if(l<1)return{imageCount:0,downloadedVersion:void 0,collectionViewBlockIds:[],pageDownloadTime:0,imagesDownloadTime:0,loadPageChunkV2ForOfflineCount:0};const f={environment:t,pageId:o,spaceId:n,lastDownloadedVersion:a,abortSignal:s},p=i||1===l?(await M([f]))[0]:await T(l).enqueue(f);s.throwIfAborted();const h=performance.now(),w=p.recordMap.getModel({table:r().ev,id:o});if(w){const e=await v(w,t);s.throwIfAborted(),d=e.length;for(const o of e)try{await fetch(o,{signal:s})}catch(b){throw b instanceof DOMException&&"AbortError"===b.name?new(g().f):b}}s.throwIfAborted();const I=h-c,y=performance.now()-h;return{imageCount:d,downloadedVersion:p.serverPageVersionsByPageId[o],collectionViewBlockIds:m(0,o,p.recordMap),pageDownloadTime:I,imagesDownloadTime:y,loadPageChunkV2ForOfflineCount:p.syncOfflinePagesCount}}}}]);