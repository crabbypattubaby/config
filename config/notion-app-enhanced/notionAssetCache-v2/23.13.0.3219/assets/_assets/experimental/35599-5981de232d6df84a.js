"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[35599],{289988:(e,r,t)=>{t.d(r,{W:()=>F});t(362833),t(333225),t(494367),t(516262),t(573119),t(240480),t(950443),t(619601),t(725707),t(491955),t(403517),t(113085);var s=t(242343),n=()=>t(660714),l=()=>t(237385),o=()=>t(803290),i=()=>t(973055),u=()=>t(919955),a=()=>t(951592),c=()=>t(214144),d=()=>t(884482),v=()=>t(21164),m=()=>t(32194),h=()=>t(653998),p=()=>t(975392),f=()=>t(204132),S=()=>t(76394),y=()=>t(141666),R=()=>t(818369),g=()=>t(855225),b=()=>t(137476),q=()=>t(877042),_=()=>t(646591),k=()=>t(92451),I=()=>t(36746),C=()=>t(471979),L=()=>t(376869),T=()=>t(196387),P=()=>t(509484),M=()=>t(359441),E=()=>t(419949),w=()=>t(485966),B=()=>t(802955),A=()=>t(836331),O=()=>t(761079),x=()=>t(271932),K=()=>t(614300),V=()=>t(413871),z=()=>t(129978),N=()=>t(622286),U=()=>t(880996);function F(e){var r;const{options:t,...c}=e,{overrideSearchSessionId:F,overrideSpaceStore:X,usePrefetch_EXPERIMENTAL:J,disable:Z}=t,{type:$,query:j="",source:D,limit:H}=c,ee=(0,l().v3)(),re=(0,h().tz)(),te=(0,a().ZC)(j),se=(0,a().ZC)(e.filters),ne=(0,s.useRef)({number:0,query:""}),le=(0,s.useCallback)((e=>{const r=ne.current.query.trim(),t=e.trim();""!==t&&r!==t&&(ne.current.number+=1,ne.current.query=t)}),[]),oe=(0,n().Y)(le,M().ab),ie=(0,s.useRef)(!0),ue=(0,o().O$)(B().e),ae=(0,o().K8)((()=>t.isLocalOnlyMode||!ue),[ue,t.isLocalOnlyMode]),ce=(0,L().y)(),[de,ve]=(0,s.useState)(G()),me=(0,o().K8)((()=>F&&F!==de.searchSessionId?(ve((e=>({...e,searchSessionId:F}))),F):de.searchSessionId),[de,F]),he=(0,N().X)("quick_find_highlights_enabled"),{searchLocalResults:pe,searchServerResults:fe,isResultsLoading:Se,numTotalLocalResults:ye,numTotalServerResults:Re}=(0,o().K8)((()=>({searchLocalResults:de.localResults,searchServerResults:de.serverResults,isResultsLoading:de.isResultsLoading,numTotalLocalResults:de.numTotalLocalResults,numTotalServerResults:de.numTotalServerResults})),[de]),ge=(0,o().K8)((()=>{if(ae||Se&&ie.current)return pe;let e=function(e){const{localResults:r,serverResults:t}=e,s=r.map((e=>e.store.id)),n=new Set(s),l=t.filter((e=>!n.has(e.store.id)));return[...r,...l]}({localResults:pe,serverResults:fe});return $===m().Vz.CollectionsInSpace&&(e=Y(e)),e}),[ae,Se,pe,$,fe]),be=(0,o().K8)((()=>X||w().default.state.currentSpaceStore),[X]),qe=(0,o().K8)((()=>"on"===A().default.getEligibleGroup({experimentId:"search-use-local-reranker-layered",parameter:"shouldUseLocalReranker",defaultGroup:"control"})),[]),_e=(0,o().K8)((()=>ae&&ue&&Boolean(J)),[ae,ue,J]),ke=(0,s.useMemo)((()=>e.sort?e.sort:{field:"relevance"}),[e.sort]),Ie="relevance"!==ke.field,Ce=(0,s.useMemo)((()=>{const r=(r=>{switch(e.type){case m().Vz.BlocksInCollection:return e.collectionId;case m().Vz.BlocksInParent:return e.parentId;default:return null===(r=e.filters)||void 0===r?void 0:r.parentId}})(),s={...e.filters,navigableBlockContentOnly:!1!==t.isTitleOnly,parentId:r};return(0,m().N2)(s)}),[t.isTitleOnly,e]),Le=(0,s.useCallback)(((e,r)=>{const{isSuccess:t,totalResultsCount:s,localCacheMetadata:n,query:l}=r;T().default.measure(e,{environment:ee,data:{start_time:e.startTime,success:t,surface:D,num_results:s,search_session_id:me,local_cache_metadata:n,local_cache_readiness_timings:(0,q().Yp)(),query_length:l.length}})}),[ee,D,me]),Te=(0,s.useCallback)(((e,r)=>{const{isSuccess:t,totalResultsCount:s,query:n}=r;T().default.measure(e,{environment:ee,data:{start_time:e.startTime,success:t,surface:D,num_results:s,search_session_id:me,search_session_flow_number:ne.current.number,query_length:n.length}})}),[ee,D,me]),Pe=(0,o().K8)((()=>x().A.state.localSearchableBlocksCache),[]),Me=(0,z().fJ)(P().T.searchActions),Ee=(0,s.useCallback)((r=>{var t;if(Ie)return;const s=T().default.mark("rum.local_quick_search_query"),{query:n,spaceStore:l}=r,o=ce&&!ue&&(0,S().Xk)(m().Iy,D);if("resolved"!==Me.status)return;const i=$===m().Vz.CollectionsInSpace,u=i&&0===n.length?function(e){const{spaceStore:r,environment:t}=e,s=(0,g().F)({currentUserId:t.currentUser.id,spaceId:r.id}).map((e=>{const t=V().md.createChildStore(r,{table:v().Vl,id:e}).getParentBlockStore();if(null==t?void 0:t.pathIsAccessibleAndAlive())return t}));return(0,p().oE)(s)}({environment:ee,spaceStore:l}).map(((e,r)=>({store:e,originalPosition:r,id:e.id,score:0,spaceId:e.getSpaceId(),sources:[m().Ni.Local],featureGroups:[],serverEventProperties:void 0}))):[],a=(0,q().PE)({environment:ee,overrideCurrentUserId:ee.currentUser.id,overrideSpaceId:l.id,overrideLocalSearchableBlocksCache:Pe}),c=(0,I().Er)(ee).hasPublicAccessPermission,d=(0,U().S6)({environment:ee,parentStore:l,isOnline:ue,requestInput:{query:{text:n,filters:{...Ce,blockTypes:Q({blockTypes:null===(t=e.filters)||void 0===t?void 0:t.blockTypes,queryType:$}),isOfflineOnly:o},sort:{field:"relevance"}},limit:ae?H:Math.min(H,5)},localSearchCache:Pe,shouldUseNewRerankerDebugOverrideEnabled:qe,shouldLimitLocalResultsWhenOnline:!ae,hasPublicAccessPermission:c}),h=_e?W({query:n,serverResults:Ge.current}):[],y=d&&f().Q.unwrapOr(d,void 0),R=(null==y?void 0:y.results)??[],b=(null==y?void 0:y.total)??0;let _=p().hS([...u,...R,...h],(e=>e.id));_=i?Y(_):_,ve((e=>e.query!==n?e:(Qe.current=_.map((e=>e.id)),Le(s,{query:n,isSuccess:Boolean(y),totalResultsCount:b,localCacheMetadata:a}),oe(n),{...e,localResults:_,isResultsLoading:!ae&&e.isResultsLoading,numTotalLocalResults:b})))}),[ce,ue,D,Me.status,$,ee,Pe,Ce,null===(r=e.filters)||void 0===r?void 0:r.blockTypes,ae,H,qe,_e,Le,oe,Ie]),we="mini_quick_find"===D?40:M().GR,Be=(0,n().Y)(Ee,we),Ae=(0,s.useCallback)((e=>{const{result:r,isMetaClick:t,context:s}=e,n=(0,k().Qe)(r.store,re,ee,!1),l=(0,E().u)({query:j,resultText:n??"",isLastQueryTermPartialMatchOK:!0}),o=w().default.state.currentSpaceStore,i=Boolean(null==o?void 0:o.getSettings().enable_ai_training);(0,b().u4)({environment:ee,event:{eventName:"select_search_item",eventProperties:{...r.serverEventProperties&&r.serverEventProperties["server-query"]?{"server-query":r.serverEventProperties["server-query"]}:{},queryText:r.serverEventProperties&&r.serverEventProperties["server-query"]&&r.serverEventProperties["server-query"].query?r.serverEventProperties["server-query"].query:j,sources:r.sources,localSources:Array.from(r.localSource||new Set),searchSessionId:me,aiSessionId:void 0,traceId:void 0,searchSessionFlowNumber:ne.current.number,context:s,queryStringLength:j.length,isTitleMatch:l,queryIfLeap:i?j:void 0,totalSearchResultCount:ye+Re,numLocalResults:pe.length,numTotalLocalResults:ye,isMobile:ee.device.isMobile,isMetaClick:t,hasFilters:Boolean(Ce),originalPosition:r.originalPosition,selectedItemIndex:r.originalPosition,selectedSearchResultMetadata:{blockId:r.id,blockType:r.store.getModel().type},searchSource:D,verificationState:(0,C().i1)(r.store)}}})}),[ee,ye,Re,pe,j,me,ne,Ce,D,re]),Oe=te===j,xe=p().n4(se,e.filters),Ke=Boolean(te&&!j),Ve=xe&&Oe,ze=!Z&&be&&!Ve,Ne=Ke||!xe,Ue=(0,s.useRef)(!1),Fe=(0,s.useRef)([]),Ge=(0,s.useRef)([]),We=(0,s.useRef)([]),Qe=(0,s.useRef)([]),Ye=(0,o().K8)((()=>{if("mention_menu"!==D)return;return K().A.getMentionedIds(ee.currentUser.id)}),[ee.currentUser.id,D]),Xe=(0,s.useCallback)((async e=>{const r=T().default.mark("rum.server_quick_search_query"),{query:t,spaceStore:s,size:n}=e,l=s.id;if(ae&&!_e)return;Ie&&ve((e=>({...e,isResultsLoading:!0})));const o=!ie.current&&xe?Fe.current:[],i=_e?W({query:t,serverResults:Ge.current}):[];if(_e&&(t.length<=1||i.length>=5||We.current.some((e=>e===t))))return;We.current.push(t),c.excludedBlockIds=p().sb([...c.excludedBlockIds??[],...o.map((e=>e.id)),...Qe.current||[],...Ge.current.map((e=>e.id))]);const a={...c,query:t,sort:ke,filters:Ce,recentlyMentionedPageIds:Ye,spaceId:l,searchSessionFlowNumber:ne.current.number,searchSessionId:me,limit:"mini_quick_find"===D?10:n,recentPagesForBoosting:(0,_().cs)(O().A.getWithoutSubscribing(l)),ignoresHighlight:!he||"mini_quick_find"!==D},v=await R().callApi({eventName:"search",environment:ee,data:a});if(!v||"failed"===v.type)return void(Ie&&ve((e=>({...e,isResultsLoading:!1}))));const m=v.data.total,h=(0,y().MU)((0,S().WP)(v.data.trackEventProperties).map((e=>{let[r,t]=e;return[`server-${r}`,t]}))),f=v.data.results.slice(0,n).map(((e,r)=>{const t=V().Bv.createChildStore(s,{id:e.id,spaceId:e.spaceId,table:"block"}),n=_e?function(e){const{result:r,store:t,environment:s}=e;if(r.terms)return r.terms;const n=t.getModel();if(!n)return[];const l=s.defaultRecordCache.inMemoryRecordCache.makeGetRecordValueFn(s.currentUser.id),o=(0,d().KM)((0,u().g)({blockValue:n,getRecordValue:l}).text);if(!o)return[];return(0,E().N)(o)}({environment:ee,store:t,result:e}):e.terms;return{store:t,originalPosition:r,...e,serverEventProperties:h,terms:n}}));Ue.current=!(m<n);const g=[...o,...f];Fe.current=g,Ge.current=p().hS([..._e?f:[],...Ge.current],(e=>e.id)),_e||(ve((e=>e.query!==t?e:(Te(r,{query:t,isSuccess:"success"===v.type,totalResultsCount:m}),{...e,serverResults:g,isResultsLoading:!1,numTotalServerResults:m}))),oe(t))}),[ae,_e,Ie,xe,c,ke,Ce,Ye,me,D,he,ee,oe,Te]),Je=(0,s.useCallback)((e=>{!Z&&be&&Ue.current&&!Se&&ue&&(ve((e=>({...e,isResultsLoading:!0}))),Ue.current=!1,ie.current=!1,Xe({query:j,spaceStore:be,size:e??20}))}),[be,Z,Xe,ue,Se,j]),Ze="mini_quick_find"===D?100:M().ab,$e=(0,i().d)(Je,Ze),je=(0,n().Y)(Xe,_e?0:M().ab),De=(0,s.useRef)(!1);return(0,s.useEffect)((()=>{!De.current&&null!=be&&be.id&&"mini_quick_find"!==D&&(De.current=!0,R().callApi({eventName:"warmSearchCache",environment:ee,data:{spaceId:be.id}}))}),[null==be?void 0:be.id,ee,D]),(0,s.useEffect)((()=>{Ne&&(ve((e=>({...G(),searchSessionId:e.searchSessionId}))),Ge.current=[],We.current=[]),ze&&(ie.current=!0,Ie||ve((e=>({...e,isResultsLoading:!0,query:j}))),Be({query:j,spaceStore:be}),je({query:j,spaceStore:be,size:H}))}),[be,Be,je,H,j,ze,Ne,D,Ie]),{results:ge,isResultsLoading:Se,searchSessionId:me,fetchAdditionalServerResultsOnChange:!Z&&!ae&&Ue.current&&Ve?$e:void 0,searchSessionFlowNumber:ne.current.number,hasMoreResults:Ue.current,searchAnalytics:{trackSelectSearchItem:Ae}}}function G(){return{query:void 0,localResults:[],numTotalLocalResults:0,serverResults:[],numTotalServerResults:0,searchSessionId:(0,c().JW)(),isResultsLoading:!1}}function W(e){const{query:r,serverResults:t}=e;return r?t.filter((e=>(0,E().u)({query:r,resultText:(e.terms??[]).join(" "),isLastQueryTermPartialMatchOK:!0}))):[]}function Q(e){const{blockTypes:r,queryType:t}=e;switch(t){case m().Vz.CollectionsInSpace:return["collection_view","collection_view_page"];case m().Vz.BlocksInCollection:return["page","collection_view_page"];case m().Vz.BlocksInSpace:default:return r??[]}}function Y(e){const r=new Set;return e.filter((e=>{const t=e.store.getCollectionViewSourceCollectionStore();return!(!t||r.has(t.id))&&(r.add(t.id),!0)}))}}}]);